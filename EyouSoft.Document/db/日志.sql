
insert into tbl_SysArea(AreaName,RouteType) values('海南专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('黄山专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('千岛湖专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('海南自由行',1)
insert into tbl_SysArea(AreaName,RouteType) values('江西专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('云南专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('婺源·三清山',3)
insert into tbl_SysArea(AreaName,RouteType) values('丽江版纳专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('庐山·井冈山',3)
insert into tbl_SysArea(AreaName,RouteType) values('北京专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('厦门专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('九华山专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('齐云山·徽州',3)
insert into tbl_SysArea(AreaName,RouteType) values('桂林专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('雁荡山·温州',3)
insert into tbl_SysArea(AreaName,RouteType) values('北海越南',1)
insert into tbl_SysArea(AreaName,RouteType) values('张家界专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('武夷山·福建',3)
insert into tbl_SysArea(AreaName,RouteType) values('杭州西湖·湿地',3)
insert into tbl_SysArea(AreaName,RouteType) values('贵州专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('余杭·临安',3)
insert into tbl_SysArea(AreaName,RouteType) values('三峡专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('湖北专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('乌镇·西塘',3)
insert into tbl_SysArea(AreaName,RouteType) values('西安专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('富阳',3)
insert into tbl_SysArea(AreaName,RouteType) values('桐庐·建德',3)
insert into tbl_SysArea(AreaName,RouteType) values('河南陕西专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('山西专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('诸暨·五泄',3)
insert into tbl_SysArea(AreaName,RouteType) values('山西内蒙',1)
insert into tbl_SysArea(AreaName,RouteType) values('横店',3)
insert into tbl_SysArea(AreaName,RouteType) values('绍兴',3)
insert into tbl_SysArea(AreaName,RouteType) values('内蒙专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('奉化溪口',3)
insert into tbl_SysArea(AreaName,RouteType) values('青岛大连',1)
insert into tbl_SysArea(AreaName,RouteType) values('普陀·舟山',3)
insert into tbl_SysArea(AreaName,RouteType) values('东北专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('北戴河专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('溧阳·天目湖',3)
insert into tbl_SysArea(AreaName,RouteType) values('象山·嵊泗',3)
insert into tbl_SysArea(AreaName,RouteType) values('四川专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('江苏专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('西藏专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('新疆专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('上海',3)
insert into tbl_SysArea(AreaName,RouteType) values('南京青奥夏令营',3)
insert into tbl_SysArea(AreaName,RouteType) values('甘肃宁夏青海',1)
insert into tbl_SysArea(AreaName,RouteType) values('广东专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('安吉·湖州',3)
insert into tbl_SysArea(AreaName,RouteType) values('莫干山·下渚湖',3)
insert into tbl_SysArea(AreaName,RouteType) values('夕阳红包船',1)
insert into tbl_SysArea(AreaName,RouteType) values('金华·义乌',3)
insert into tbl_SysArea(AreaName,RouteType) values('安徽专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('火车专列',1)
insert into tbl_SysArea(AreaName,RouteType) values('遂昌·磐安',3)
insert into tbl_SysArea(AreaName,RouteType) values('丽水·缙云',3)
insert into tbl_SysArea(AreaName,RouteType) values('天台山',3)
insert into tbl_SysArea(AreaName,RouteType) values('青岛汽车班',3)
insert into tbl_SysArea(AreaName,RouteType) values('岱山·秀山岛',3)
insert into tbl_SysArea(AreaName,RouteType) values('漂流线路',3)
insert into tbl_SysArea(AreaName,RouteType) values('钱江观潮',3)
insert into tbl_SysArea(AreaName,RouteType) values('诸暨·影视城',3)
insert into tbl_SysArea(AreaName,RouteType) values('山东枣庄',3)
insert into tbl_SysArea(AreaName,RouteType) values('台儿庄',3)
insert into tbl_SysArea(AreaName,RouteType) values('衢州专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('金兰衢专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('温泉',3)
insert into tbl_SysArea(AreaName,RouteType) values('滑雪专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('自驾游',3)
insert into tbl_SysArea(AreaName,RouteType) values('主题公园',3)
insert into tbl_SysArea(AreaName,RouteType) values('瓯越山水线',3)


insert into tbl_SysArea(AreaName,RouteType) values('三亚自由行',1)
insert into tbl_SysArea(AreaName,RouteType) values('福建专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('桂林专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('南宁北海越南',1)
insert into tbl_SysArea(AreaName,RouteType) values('四川天府之旅',1)
insert into tbl_SysArea(AreaName,RouteType) values('四川熊猫假期',1)
insert into tbl_SysArea(AreaName,RouteType) values('张家界线',1)
insert into tbl_SysArea(AreaName,RouteType) values('古都风情河南陕西',1)
insert into tbl_SysArea(AreaName,RouteType) values('山西专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('青岛大连',1)
insert into tbl_SysArea(AreaName,RouteType) values('湖北三峡重庆',1)
insert into tbl_SysArea(AreaName,RouteType) values('东北专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('陕西专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('新疆专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('新疆甘肃·金色阳光',1)
insert into tbl_SysArea(AreaName,RouteType) values('江西专线',1)
insert into tbl_SysArea(AreaName,RouteType) values('西美甘青宁线',1)
insert into tbl_SysArea(AreaName,RouteType) values('千岛湖线',3)
insert into tbl_SysArea(AreaName,RouteType) values('杭州周边一日',3)
insert into tbl_SysArea(AreaName,RouteType) values('黄山专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('三清山婺源线',3)
insert into tbl_SysArea(AreaName,RouteType) values('江西专线.',3)
insert into tbl_SysArea(AreaName,RouteType) values('漂流专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('象山专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('乌镇·西塘',3)
insert into tbl_SysArea(AreaName,RouteType) values('绍兴柯桥专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('太姥山专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('上海专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('苏州专线',3)
insert into tbl_SysArea(AreaName,RouteType) values('西湖专线',3)

insert into tbl_SysArea(AreaName,RouteType) values('东南亚',2)
insert into tbl_SysArea(AreaName,RouteType) values('港澳',2)
insert into tbl_SysArea(AreaName,RouteType) values('台湾',2)
insert into tbl_SysArea(AreaName,RouteType) values('日韩',2)
insert into tbl_SysArea(AreaName,RouteType) values('欧洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('美洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('中东非洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('澳新',2)
insert into tbl_SysArea(AreaName,RouteType) values('游轮',2)
insert into tbl_SysArea(AreaName,RouteType) values('美国游学',2)

insert into tbl_SysArea(AreaName,RouteType) values('中东',2)
insert into tbl_SysArea(AreaName,RouteType) values('非洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('大洋洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('海岛线',2)

insert into tbl_SysArea(AreaName,RouteType) values('韩国',2)
insert into tbl_SysArea(AreaName,RouteType) values('日本',2)
insert into tbl_SysArea(AreaName,RouteType) values('欧美澳非',2)
insert into tbl_SysArea(AreaName,RouteType) values('游轮',2)
insert into tbl_SysArea(AreaName,RouteType) values('自由行',2)
insert into tbl_SysArea(AreaName,RouteType) values('台湾',2)
insert into tbl_SysArea(AreaName,RouteType) values('帕劳',2)



declare @line_source int 

set @line_source=1

delete 
tbl_XianLuXingCheng
where xianluid in(select xianluid
  FROM [dbo].[tbl_XianLu]
where line_source=@line_source)

delete 
tbl_XianLuFuWu
where xianluid in(select xianluid
  FROM [dbo].[tbl_XianLu]
where line_source=@line_source)

delete 
tbl_XianLuTour
where xianluid in(select xianluid
  FROM [dbo].[tbl_XianLu]
where line_source=@line_source)

delete 
tbl_XianLuTeSeFile
where xianluid in(select xianluid
  FROM [dbo].[tbl_XianLu]
where line_source=@line_source)


delete
  FROM [dbo].[tbl_XianLu]
where line_source=@line_source

update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=1 and areaname=[tbl_XianLu].areaname)
where line_source=1
and areaname in (select areaname from tbl_sysarea where RouteType=1)

update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=3 and areaname=[tbl_XianLu].areaname)
where line_source=1
and areaname in (select areaname from tbl_sysarea where RouteType=3)


update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=2 and areaname=[tbl_XianLu].areaname)
where line_source=3
and areaname in (select areaname from tbl_sysarea where RouteType=2)

update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=2 and areaname=[tbl_XianLu].areaname)
where line_source=4
and areaname in (select areaname from tbl_sysarea where RouteType=2)


delete
  FROM [hzjalydb].[dbo].[tbl_XianLu]
where areaname=''

delete 
tbl_XianLuXingCheng
where xianluid in(select xianluid
  FROM [hzjalydb].[dbo].[tbl_XianLu]
where areaname='')

delete 
tbl_XianLuFuWu
where xianluid in(select xianluid
  FROM [hzjalydb].[dbo].[tbl_XianLu]
where areaname='')

delete 
tbl_XianLuTour
where xianluid in(select xianluid
  FROM [hzjalydb].[dbo].[tbl_XianLu]
where areaname='')

GO



--景区省份城市更新sql.txt
UPDATE  dbo.tbl_ScenicArea
SET     ProvinceId = ( SELECT TOP 1
                                P.ID
                       FROM     dbo.tbl_SysProvince P
                       WHERE    P.[Name] LIKE '%' + ProvinceName + '%'
                     ) ,
        CityId = ISNULL(( SELECT TOP 1
                                    C.Id
                          FROM      dbo.tbl_SysCity C
                                    INNER JOIN dbo.tbl_SysProvince P ON C.ProvinceId = P.ID
                                                              AND P.[Name] LIKE '%'
                                                              + ProvinceName
                                                              + '%'
                          WHERE     LTRIM(RTRIM(P.[Name]))
                                    + LTRIM(RTRIM(C.[Name])) LIKE '%'
                                    + CASE LTRIM(RTRIM(CityName)) WHEN '阿坝州' THEN '阿坝' WHEN '临夏州' THEN '临夏' WHEN '甘孜州' THEN '甘孜' WHEN '井岗山' THEN '井冈山' WHEN '黔南苗布区' THEN '黔南' WHEN '千岛湖' THEN '建德市' ELSE LTRIM(RTRIM(CityName)) END + '%'
                        ),
                        ISNULL(( SELECT TOP 1
                                        C.Id
                                 FROM   dbo.tbl_SysDistrict D
                                        INNER JOIN dbo.tbl_SysCity C ON D.CityId = C.Id
                                                              AND D.ProvinceId = C.ProvinceId
                                        INNER JOIN dbo.tbl_SysProvince P ON C.ProvinceId = P.ID
                                                              AND P.[Name] LIKE '%'
                                                              + ProvinceName
                                                              + '%'
                                 WHERE  LTRIM(RTRIM(P.[Name]))
                                        + LTRIM(RTRIM(C.[Name]))
                                        + LTRIM(RTRIM(D.[Name])) LIKE '%'
                                        + CASE LTRIM(RTRIM(CityName)) WHEN '阿坝州' THEN '阿坝' WHEN '临夏州' THEN '临夏' WHEN '甘孜州' THEN '甘孜' WHEN '井岗山' THEN '井冈山' WHEN '黔南苗布区' THEN '黔南' WHEN '千岛湖' THEN '建德市' ELSE LTRIM(RTRIM(CityName)) END + '%'
                               ), 0))
                               
GO


UPDATE  dbo.tbl_XianLu
SET     DepCityId = ISNULL(( SELECT TOP 1
                                    C.ID
                             FROM   dbo.tbl_SysCity C
                                    INNER JOIN dbo.tbl_SysProvince P ON C.ProvinceId = P.ID
                             WHERE  P.[Name] + C.[Name] LIKE '%' + CFCS + '%'
                           ), 0)
WHERE   DepCityId <= 0

UPDATE  dbo.tbl_XianLu
SET     DepProvinceId = (select top 1 ProvinceId from tbl_SysCity where tbl_SysCity.id=DepCityId)
WHERE    DepCityId<>0
GO


update [tbl_XianLu]
set cfcs=replace(cfcs,'市区','')
GO


港奥：香港 澳门 

台湾 ：台湾 

澳新：澳大利亚 新西兰 库克群岛 大溪地 汤加 新喀里多尼亚 瓦努阿图 瑙鲁共和国 所罗门群岛 萨摩亚 巴布亚新几内亚 图瓦卢 斐济 


日韩：日本 北海道 冲绳 九洲 韩国 济州岛 朝鲜 

美洲: 美国 夏威夷 关岛 加拿大 巴西 阿根廷 智利 秘鲁 古巴 墨西哥 

东南亚:  泰国 泰新马 马来西亚 新加坡 越南 柬埔寨 菲律宾 尼泊尔 印度 斯里兰卡 文莱 清迈 

中东: 阿联酋 以色列 约旦 土耳其 伊朗 

欧洲: 英国 爱尔兰 法国 意大利 德国 瑞士 荷兰 希腊 丹麦 比利时 奥地利 西班牙 葡萄牙 捷克 波兰 俄罗斯 斯洛伐克 冰岛 挪威 芬兰 瑞典 克罗地亚 爱沙尼亚 匈牙利 马耳他 

大洋洲: 澳大利亚 新西兰 库克群岛 大溪地 汤加 新喀里多尼亚 瓦努阿图 瑙鲁共和国 所罗门群岛 萨摩亚 巴布亚新几内亚 图瓦卢 斐济 

非洲:埃及 肯尼亚 南非 突尼斯 马达加斯加 埃塞俄比亚 博茨瓦纳 津巴布韦 坦桑尼亚 

海岛线:巴厘岛 普吉岛 马尔代夫 长滩岛 宿雾 岘港 沙巴 兰卡威 毛里求斯 塞班 塞舌尔 斐济 苏梅岛 民丹岛 巴淡岛 越南芽庄 



 
 
 alter table tbl_JA_ZuCheInfo add MenShiChaoShi money 
 alter table tbl_JA_ZuCheInfo add MenShiChaoCheng money 
 alter table tbl_JA_ZuCheInfo add YouHuiChaoCheng money 
 
 
 go
 
 
 ALTER PROCEDURE [dbo].[proc_JA_ZucheInfo_ADD] 
@ZuCheID char(36),
@CarName nvarchar(255),
@XianZuoRenShu int,
@MenShiJia money,
@MenShiJiaGeZuChe money,
@MenShiChaoShi money,
@MenShiJiaGeChaoShi money,
@MenShiChaoCheng money,
@MenShiJiaGeChaoCheng money,
@YouHuiJia money,
@YouHuiJiaGeZuChe money,
@YouHuiJiaGeChaoShi money,
@YouHuiChaoCheng money,
@YouHuiJiaGeChaoCheng money,
@OperatorId int,
@IssueTime datetime,
@LatestId int,
@LatestTime datetime,
@IsRecommend char(1),
@Remark nvarchar(MAX),
@State tinyint,
@FilePath nvarchar(255),
@MenShiJiaGeDanCheng money,
@YouHuiJiaGeDanCheng money,
@ZuCheImg xml,
@Result int output
AS
BEGIN
	declare @error int
	set @error=0
	
	begin transaction
	
	INSERT INTO [tbl_JA_ZuCheInfo](
	[ZuCheID],[CarName],[XianZuoRenShu],[MenShiJia],[MenShiJiaGeZuChe],[MenShiChaoShi],[MenShiJiaGeChaoShi],[MenShiChaoCheng],[MenShiJiaGeChaoCheng],[YouHuiJia],[YouHuiJiaGeZuChe],[YouHuiJiaGeChaoShi],[YouHuiChaoCheng],[YouHuiJiaGeChaoCheng],[OperatorId],[IssueTime],[LatestId],[LatestTime],[IsRecommend],[Remark],[State],[FilePath],[MenShiJiaGeDanCheng],[YouHuiJiaGeDanCheng]
	)VALUES(
	@ZuCheID,@CarName,@XianZuoRenShu,@MenShiJia,@MenShiJiaGeZuChe,@MenShiChaoShi,@MenShiJiaGeChaoShi,@MenShiChaoCheng,@MenShiJiaGeChaoCheng,@YouHuiJia,@YouHuiJiaGeZuChe,@YouHuiJiaGeChaoShi,@YouHuiChaoCheng,@YouHuiJiaGeChaoCheng,@OperatorId,@IssueTime,@LatestId,@LatestTime,@IsRecommend,@Remark,@State,@FilePath,@MenShiJiaGeDanCheng,@YouHuiJiaGeDanCheng
	)
	set @error=@error+@@error
	if(@ZuCheImg is not null)
	BEGIN
		declare @i int
		exec sp_xml_preparedocument @i output,@ZuCheImg
		set @error=@error+@@error
		INSERT INTO [tbl_JA_ZuCheImg](
		[ZuCheID],[ImgCategory],[FilePath],[Desc],[IssueTime],[OperatorId])
		select @ZuCheID,ImgCategory,FilePath,[Desc],[IssueTime],[OperatorId] from openxml(@i,'/root/info')with(ZuCheID char(36),ImgCategory tinyint,FilePath varchar(255),[Desc] nvarchar(255),IssueTime datetime,OperatorId char(36))
		set @error=@error+@@error
		exec sp_xml_removedocument @i
		set @error=@error+@@error
	END
	
	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result
END

go


ALTER PROCEDURE [dbo].[proc_JA_ZucheInfo_Update]  
@ZuCheID char(36),
@CarName nvarchar(255),
@XianZuoRenShu int,
@MenShiJia money,
@MenShiJiaGeZuChe money,
@MenShiChaoShi money,
@MenShiJiaGeChaoShi money,
@MenShiChaoCheng money,
@MenShiJiaGeChaoCheng money,
@YouHuiJia money,
@YouHuiJiaGeZuChe money,
@YouHuiJiaGeChaoShi money,
@YouHuiChaoCheng money,
@YouHuiJiaGeChaoCheng money,
@OperatorId int,
@IssueTime datetime,
@LatestId int,
@LatestTime datetime,
@IsRecommend char(1),
@Remark nvarchar(MAX),
@FilePath nvarchar(255),
@MenShiJiaGeDanCheng money,
@YouHuiJiaGeDanCheng money,
@ZuCheImg xml,
@Result int output
AS
BEGIN
	declare @error int
	set @error=0
	begin transaction
		UPDATE [tbl_JA_ZuCheInfo] SET 
	[CarName] = @CarName,[XianZuoRenShu] = @XianZuoRenShu,[MenShiJia] = @MenShiJia,[MenShiJiaGeZuChe] = @MenShiJiaGeZuChe,[MenShiChaoShi] = @MenShiChaoShi,[MenShiJiaGeChaoShi] = @MenShiJiaGeChaoShi,[MenShiChaoCheng] = @MenShiChaoCheng,[MenShiJiaGeChaoCheng] = @MenShiJiaGeChaoCheng,[YouHuiJia] = @YouHuiJia,[YouHuiJiaGeZuChe] = @YouHuiJiaGeZuChe,[YouHuiJiaGeChaoShi] = @YouHuiJiaGeChaoShi,[YouHuiChaoCheng] = @YouHuiChaoCheng,[YouHuiJiaGeChaoCheng] = @YouHuiJiaGeChaoCheng,[OperatorId] = @OperatorId,[IssueTime] = @IssueTime,[LatestId] = @LatestId,[LatestTime] = @LatestTime,[IsRecommend] = @IsRecommend,[Remark] = @Remark,[FilePath] = @FilePath,[MenShiJiaGeDanCheng] = @MenShiJiaGeDanCheng,[YouHuiJiaGeDanCheng] = @YouHuiJiaGeDanCheng
	WHERE ZuCheID=@ZuCheID 
	set @error=@error+@@error
	DELETE [tbl_JA_ZuCheImg] WHERE ZuCheID=@ZuCheID 
	set @error=@error+@@error
	if(@ZuCheImg is not null)
	BEGIN
		declare @i int
		exec sp_xml_preparedocument @i output,@ZuCheImg
		set @error=@error+@@error
		INSERT INTO [tbl_JA_ZuCheImg](
		[ZuCheID],[ImgCategory],[FilePath],[Desc],[IssueTime],[OperatorId])
		select @ZuCheID,ImgCategory,FilePath,[Desc],[IssueTime],[OperatorId] from openxml(@i,'/root/info')with(ZuCheID char(36),ImgCategory tinyint,FilePath varchar(255),[Desc] nvarchar(255),IssueTime datetime,OperatorId char(36))
		set @error=@error+@@error
		exec sp_xml_removedocument @i
		set @error=@error+@@error
	END
	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result
END


go
 
 
 alter table tbl_HotelRoomRate add Status char(1)
 
 
 GO
 
 
ALTER TABLE dbo.tbl_ScenicArea ADD
	ProvinceName nvarchar(50) NULL,
	CityName nvarchar(50) NULL,
	CountyName nvarchar(50) NULL
GO
DECLARE @v sql_variant 
SET @v = N'省份'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_ScenicArea', N'COLUMN', N'ProvinceName'
GO
DECLARE @v sql_variant 
SET @v = N'城市'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_ScenicArea', N'COLUMN', N'CityName'
GO
DECLARE @v sql_variant 
SET @v = N'县区'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_ScenicArea', N'COLUMN', N'CountyName'
GO
se
lect Has_Perms_By_Name(N'dbo.tbl_ScenicArea', 'Object', 'ALTER') as ALT_Per, Has_Perms_By_Name(N'dbo.tbl_ScenicArea', 'Object', 'VIEW DEFINITION') as View_def_Per, Has_Perms_By_Name(N'dbo.tbl_ScenicArea', 'Object', 'CONTROL') as Contr_Per 
GO


alter  proc [dbo].[proc_ScenicArea_Update]
@ScenicId char(36), 
@IsRecommend char(1), 
@ScenicName nvarchar(100), 
@EnName varchar(100), 
@X varchar(100), 
@Y varchar(100), 
@ServiceTel nvarchar(50),
@Contact nvarchar(50), 
@ContactTel nvarchar(50), 
@ContactMobile nvarchar(50), 
@ContactFax char(10), 
@ProvinceId int, 
@CityId int, 
@CountyId int, 
@CnAddress nvarchar(100), 
@EnAddress varchar(100), 
@ScenicLevel tinyint, 
@Year int,
@OpenTime nvarchar(max), 
@Description nvarchar(max), 
@Traffic nvarchar(max), 
@Facilities nvarchar(max), 
@Notes nvarchar(max), 
@OperatorId char(36), 
@ScenicRelationLandMark xml,
@JieSuanType char(1),
@NetAddress nvarchar(500),
@Result int output
as
begin
	declare @error int
	set @error=0	
	
	begin transaction
	UPDATE tbl_ScenicArea
    SET IsRecommend = @IsRecommend,ScenicName = @ScenicName,
        EnName = @EnName,X = @X,Y = @Y,ServiceTel=@ServiceTel,Contact = @Contact, ContactTel = @ContactTel, 
        ContactMobile = @ContactMobile,ContactFax = @ContactFax,ProvinceId = @ProvinceId, 
        CityId = @CityId,CountyId = @CountyId,CnAddress = @CnAddress,EnAddress = @EnAddress, 
        ScenicLevel = @ScenicLevel,[Year]=@Year,OpenTime = @OpenTime,Description = @Description, 
	    Traffic = @Traffic,Facilities = @Facilities,Notes = @Notes,OperatorId = @OperatorId, 
       JieSuanType=@JieSuanType, LastUpdateTime = getdate(), NetAddress=@NetAddress
    WHERE ScenicId = @ScenicId
	set @error=@error+@@error

	delete from tbl_ScenicRelationLandMark where ScenicId=@ScenicId
	set @error=@error+@@error

	if(@ScenicRelationLandMark is not null)
	begin
		declare @iMark int
		exec sp_xml_preparedocument @iMark output,@ScenicRelationLandMark

		INSERT INTO tbl_ScenicRelationLandMark(ScenicId,LandMarkId)
		select @ScenicId,LandMarkId from openxml(@iMark,'/Root/ScenicRelationLandMark')
		with(LandMarkId int)	
		set @error=@error+@@error

		exec sp_xml_removedocument @iMark
		set @error=@error+@@error
	end

	set @error=@error+@@error

	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end	
	else
	begin
		set @Result=0
		rollback transaction
	end

	return @Result

end



go

ALTER PROC [dbo].[proc_ScenicArea_Add]
@ScenicId char(36), 
@IsRecommend char(1), 
@ScenicName nvarchar(100), 
@EnName varchar(100), 
@X varchar(100), 
@Y varchar(100), 
@ServiceTel varchar(50),
@Contact nvarchar(50), 
@ContactTel nvarchar(50), 
@ContactMobile nvarchar(50), 
@ContactFax NVARCHAR(50), 
@ProvinceId int, 
@CityId int, 
@CountyId int, 
@CnAddress nvarchar(100), 
@EnAddress varchar(100), 
@ScenicLevel tinyint, 
@Year int,
@OpenTime nvarchar(max), 
@Description nvarchar(max), 
@Traffic nvarchar(max), 
@Facilities nvarchar(max), 
@Notes nvarchar(max), 
@OperatorId char(36), 
@ScenicRelationLandMark xml,
@JieSuanType char(1),
@ChanPinSource int,
@InterfaceID varchar(50),
@NetAddress nvarchar(500),
@Result int output
as
begin
	declare @error int
	set @error=0	
	
	begin transaction
	INSERT INTO tbl_ScenicArea(ScenicId,IsRecommend,ScenicName,EnName,X,Y,ServiceTel,Contact,ContactTel,ContactMobile,
      ContactFax,ProvinceId,CityId,CountyId,CnAddress,EnAddress,ScenicLevel,[Year],
      OpenTime,Description,Traffic,Facilities,Notes,OperatorId,JieSuanType,ChanPinSource,InterfaceID,NetAddress)
     VALUES(@ScenicId,@IsRecommend,@ScenicName,@EnName,@X,@Y,@ServiceTel,@Contact,@ContactTel,@ContactMobile, 
      @ContactFax,@ProvinceId,@CityId,@CountyId,@CnAddress,@EnAddress,@ScenicLevel,@Year,
      @OpenTime,@Description,@Traffic,@Facilities,@Notes,@OperatorId,@JieSuanType,@ChanPinSource,@InterfaceID,@NetAddress)
	set @error=@error+@@error


	if(@ScenicRelationLandMark is not null)
	begin
		declare @iMark int
		exec sp_xml_preparedocument @iMark output,@ScenicRelationLandMark

		INSERT INTO tbl_ScenicRelationLandMark(ScenicId,LandMarkId)
		select @ScenicId,LandMarkId from openxml(@iMark,'/Root/ScenicRelationLandMark')
		with(LandMarkId int)	
		set @error=@error+@@error

		exec sp_xml_removedocument @iMark
		set @error=@error+@@error
	end

	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end	
	else
	begin
		set @Result=0
		rollback transaction
	end

	return @Result

end

go




alter  proc [dbo].[proc_ScenicArea_Update]
@ScenicId char(36), 
@IsRecommend char(1), 
@ScenicName nvarchar(100), 
@EnName varchar(100), 
@X varchar(100), 
@Y varchar(100), 
@ServiceTel nvarchar(50),
@Contact nvarchar(50), 
@ContactTel nvarchar(50), 
@ContactMobile nvarchar(50), 
@ContactFax varchar(50), 
@ProvinceId int, 
@CityId int, 
@CountyId int, 
@CnAddress nvarchar(100), 
@EnAddress varchar(100), 
@ScenicLevel tinyint, 
@Year int,
@OpenTime nvarchar(max), 
@Description nvarchar(max), 
@Traffic nvarchar(max), 
@Facilities nvarchar(max), 
@Notes nvarchar(max), 
@OperatorId char(36), 
@ScenicRelationLandMark xml,
@JieSuanType char(1),
@NetAddress nvarchar(500),
@Result int output
as
begin
	declare @error int
	set @error=0	
	
	begin transaction
	UPDATE tbl_ScenicArea
    SET IsRecommend = @IsRecommend,ScenicName = @ScenicName,
        EnName = @EnName,X = @X,Y = @Y,ServiceTel=@ServiceTel,Contact = @Contact, ContactTel = @ContactTel, 
        ContactMobile = @ContactMobile,ContactFax = @ContactFax,ProvinceId = @ProvinceId, 
        CityId = @CityId,CountyId = @CountyId,CnAddress = @CnAddress,EnAddress = @EnAddress, 
        ScenicLevel = @ScenicLevel,[Year]=@Year,OpenTime = @OpenTime,Description = @Description, 
	    Traffic = @Traffic,Facilities = @Facilities,Notes = @Notes,OperatorId = @OperatorId, 
       JieSuanType=@JieSuanType, LastUpdateTime = getdate(), NetAddress=@NetAddress
    WHERE ScenicId = @ScenicId
	set @error=@error+@@error

	delete from tbl_ScenicRelationLandMark where ScenicId=@ScenicId
	set @error=@error+@@error

	if(@ScenicRelationLandMark is not null)
	begin
		declare @iMark int
		exec sp_xml_preparedocument @iMark output,@ScenicRelationLandMark

		INSERT INTO tbl_ScenicRelationLandMark(ScenicId,LandMarkId)
		select @ScenicId,LandMarkId from openxml(@iMark,'/Root/ScenicRelationLandMark')
		with(LandMarkId int)	
		set @error=@error+@@error

		exec sp_xml_removedocument @iMark
		set @error=@error+@@error
	end

	set @error=@error+@@error

	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end	
	else
	begin
		set @Result=0
		rollback transaction
	end

	return @Result

end

go

alter table tbl_ScenicTickets 
add column InterafaceScenicId varchar(50) null


go


 alter table tbl_QianZhengDingDan add AgencyId char(36) 
 alter table tbl_QianZhengDingDan add AgencyJinE money 
 
 go
 
 CREATE TABLE dbo.tmp_tbl_ChongZhi(
	OrderID char(36)  NOT NULL PRIMARY KEY,
	OrderCode nvarchar(50)  NOT NULL,
	OperatorID char(36)  NOT NULL,
	OptMoney money NOT NULL DEFAULT ((0)),
	Issuetime datetime NOT NULL DEFAULT (getdate()),
	PayState tinyint NOT NULL DEFAULT ((1)),
)
go

alter table tbl_hotelRoomType
add HotelCode varchar(50)

go


CREATE FUNCTION f_GetPY(@str nvarchar(4000))
RETURNS nvarchar(4000)
AS
BEGIN
    DECLARE @py TABLE(ch char(1),hz1 nchar(1) COLLATE Chinese_PRC_CS_AS_KS_WS,hz2 nchar(1) COLLATE Chinese_PRC_CS_AS_KS_WS)
    INSERT @py SELECT 'A',N'吖',N'鏊'
    UNION  ALL SELECT 'B',N'八',N'簿'
    UNION  ALL SELECT 'C',N'嚓',N'错'
    UNION  ALL SELECT 'D',N'哒',N'跺'
    UNION  ALL SELECT 'E',N'屙',N'贰'
    UNION  ALL SELECT 'F',N'发',N'馥'
    UNION  ALL SELECT 'G',N'旮',N'过'
    UNION  ALL SELECT 'H',N'铪',N'蠖'
    UNION  ALL SELECT 'J',N'丌',N'竣'
    UNION  ALL SELECT 'K',N'咔',N'廓'
    UNION  ALL SELECT 'L',N'垃',N'雒'
    UNION  ALL SELECT 'M',N'妈',N'穆'
    UNION  ALL SELECT 'N',N'拿',N'糯'
    UNION  ALL SELECT 'O',N'噢',N'沤'
    UNION  ALL SELECT 'P',N'趴',N'曝'
    UNION  ALL SELECT 'Q',N'七',N'群'
    UNION  ALL SELECT 'R',N'蚺',N'箬'
    UNION  ALL SELECT 'S',N'仨',N'锁'
    UNION  ALL SELECT 'T',N'他',N'箨'
    UNION  ALL SELECT 'W',N'哇',N'鋈'
    UNION  ALL SELECT 'X',N'夕',N'蕈'
    UNION  ALL SELECT 'Y',N'丫',N'蕴'
    UNION  ALL SELECT 'Z',N'匝',N'做'
    DECLARE @i int
  
  
    SET @i=PATINDEX('%[吖-做]%' COLLATE Chinese_PRC_CS_AS_KS_WS,@str)
    WHILE @i>0
    SELECT @str=REPLACE(@str,SUBSTRING(@str,@i,1),ch),@i=PATINDEX('%[吖-做]%' COLLATE Chinese_PRC_CS_AS_KS_WS,@str) FROM @py WHERE SUBSTRING(@str,@i,1) BETWEEN hz1 AND hz2
    
    RETURN(@str)
END
GO



ALTER TABLE dbo.tbl_XianLuTourOrder ADD
	Traffice nvarchar(50) NULL
GO
ALTER TABLE dbo.tbl_XianLu ADD
	CFCS nvarchar(50) NULL
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_XianLuTourTraffice](
	[IdentityId] [int] IDENTITY(1,1) NOT NULL,
	[XianLuId] [char](36) NOT NULL,
	[TrafficId] [nvarchar](50) NULL,
	[Traffic_01] [nvarchar](100) NULL,
	[Traffic_02] [nvarchar](100) NULL
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'去程信息' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_XianLuTourTraffice', @level2type=N'COLUMN',@level2name=N'Traffic_01'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'回程信息' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_XianLuTourTraffice', @level2type=N'COLUMN',@level2name=N'Traffic_02'
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	写入线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- 1.2014-08-05 刘树超 tbl_XianLuTourTraffice 添加航班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLu_Insert]
	 @XianLuId CHAR(36)--线路编号
	,@AreaName NVARCHAR(50)
	,@InterfaceID INT 
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>
	,@Line_Source  TINYINT
	,@LineType TINYINT 
	,@TourTraffice NVARCHAR(MAX)
	,@CFCS NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	INSERT INTO [tbl_XianLu]([XianLuId],[AreaId],[RouteName]
		,[TianShu],[DepProvinceId],[DepCityId]
		,[ArrProvinceId],[ArrCityId],[JiHuaRenShu]
		,[SCJCR],[SCJET],[JSJCR]
		,[JSJET],[TingTianShu],[ChuFaJiaoTong]
		,[FanChengJiaoTong],[JiHeFangShi],[TeSe]
		,[TeSeFilePath],[TuJing],[QianZheng]
		,[QianZhengFilePath],[GuanZhuShu],[LxrName]
		,[LxrTelephone],[LxrQQ],[LxrMobile]
		,[Description],[Keywords],[OperatorId]
		,[IssueTime],[LatestId],[LatestTime],[AreaName],[InterfaceID],[Line_Source],[LineType],[CFCS])
	VALUES (@XianLuId,@AreaId,@RouteName
		,@TianShu,@DepProvinceId,@DepCityId
		,@ArrProvinceId,@ArrCityId,@JiHuaRenShu
		,@SCJCR,@SCJET,@JSJCR
		,@JSJET,@TingTianShu,@ChuFaJiaoTong
		,@FanChengJiaoTong,@JiHeFangShi,@TeSe
		,@TeSeFilePath,@TuJing,@QianZheng
		,@QianZhengFilePath,@GuanZhuShu,@LxrName
		,@LxrTelephone,@LxrQQ,@LxrMobile
		,@Description,@Keywords,@OperatorId
		,@IssueTime,@LatestId,@LatestTime,@AreaName,@InterfaceID,@Line_Source,@LineType,@CFCS)
	SET @errorcount=@errorcount+@@ERROR

		IF(@errorcount=0 AND @TourTraffice IS NOT NULL AND LEN(@TourTraffice)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourTraffice
		INSERT INTO tbl_XianLuTourTraffice(XianLuId,TrafficId,Traffic_01
			,Traffic_02)
		SELECT @XianLuId,T.TrafficId,T.Traffic_01,T.Traffic_02
		FROM OPENXML(@hdoc,'/root/info')
		WITH(TrafficId NVARCHAR(60),Traffic_01 NVARCHAR(100),Traffic_02 NVARCHAR(100)) AS T
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
		INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
			,[ZhuSu],[YongCan],[XingCheng]
			,[FilePath])
		SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
			,A.[ZhuSu],A.[YongCan],A.[XingCheng]
			,A.[FilePath]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
		INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
		INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
		SELECT @XianLuId,A.[ZhuTiId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([ZhuTiId] INT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
		INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
		SELECT @XianLuId,A.[Status]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([Status] TINYINT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TourXml IS NOT NULL AND LEN(@TourXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml
		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR]
			,[JSJET],[SYRS],[TrafficId])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],@JSJCR
			,@JSJET,A.[SYRS],A.[TrafficId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[SYRS]INT,[TrafficId] NVARCHAR(50) ) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
		INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
		SELECT @XianLuId,A.FilePath,A.MiaoShu
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO

/* =============================================
 Author:		汪奇志
 Create date: 2013-03-16
 Description: 线路信息,含最近发班信息
 =============================================*/
ALTER VIEW [dbo].[view_XianLu]
AS
SELECT     A.XianLuId, A.AreaId, A.RouteName, A.TianShu, A.DepProvinceId, A.DepCityId, A.ArrProvinceId, A.ArrCityId, A.JiHuaRenShu, A.SCJCR, A.SCJET, A.JSJCR, 
                      A.JSJET, A.TingTianShu, A.ChuFaJiaoTong, A.FanChengJiaoTong, A.JiHeFangShi, A.TeSe, A.TeSeFilePath, A.TuJing, A.QianZheng, A.QianZhengFilePath, 
                      A.GuanZhuShu, A.LxrName, A.LxrTelephone, A.LxrQQ, A.LxrMobile, A.Description, A.Keywords, A.OperatorId, A.IssueTime, A.LatestId, A.LatestTime, 
                      A.Line_Source, A.LineType, A.IdentityId, A.AreaName, A.InterfaceID, B.TourId, B.LDate, B.RDate, B.Status,
                          (SELECT     AVG(ManYiDu) AS ManYiDu
                            FROM          dbo.tbl_XianLuDianPing
                            WHERE      (XianLuId = A.XianLuId)) AS ManYiDu,
                          (SELECT     COUNT(1) AS Expr1
                            FROM          dbo.tbl_XianLuDianPing AS tbl_XianLuDianPing_1
                            WHERE      (XianLuId = A.XianLuId)) AS DianPingShu, B.JSJCR AS JSJCR1, B.JSJET AS JSJET1, A.CFCS
FROM         dbo.tbl_XianLu AS A LEFT OUTER JOIN
                      dbo.view_XianLuTour_ZuiJinFaBan AS B ON A.XianLuId = B.XianLuId
GO


 alter table tbl_ShangChengChanPin add GYSid char(36)
 go
 
 
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_ShangChengOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_ShangChengChanPin AS p WHERE p.ProductID=s.ProductID ) as ProductName
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,ContactID
      ,ContactName
      ,ContactPhone
      ,IssueTime
      ,Remark
      ,ProvinceID
      ,(SELECT [GYSid] FROM tbl_ShangChengChanPin chanpin WHERE chanpin.ProductID=s.ProductID )AS  GYSid
      ,(SELECT [Name] FROM tbl_SysProvince prov WHERE prov.ID=s.ProvinceID )AS  ProvinceName
      ,CityID
      ,(SELECT [Name] FROM tbl_SysCity city WHERE city.ID=s.CityID ) as CityName 
      ,DistrictID
      ,(SELECT [Name] FROM tbl_SysDistrict dist WHERE dist.ID=s.DistrictID) AS DistrictName
      ,Addressinfo
      ,SupplierID
      ,SupplierMoney
  FROM tbl_ShangChengDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-08
-- Description:	写入商城产品
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangCheng_Insert]
	   @ProductID CHAR(36)
      ,@TypeID  int
      ,@GYSid  char(36)
      ,@ProductName nvarchar(50)
      ,@ProductNum INT
      ,@MarketPrice MONEY
      ,@SalePrice MONEY
      ,@ContentService NVARCHAR(max)
      ,@UnContentService  NVARCHAR(max)
      ,@UseRule  NVARCHAR(max)
      ,@NoticeKnow  NVARCHAR(max)
      ,@ProductionDate DATETIME
      ,@EffectDate DATETIME
      ,@ShelfDate  INT
      ,@IssueTime DATETIME
      ,@Remark  NVARCHAR(max)
      ,@ModelDesc  NVARCHAR(max)
      ,@ColorDesc  NVARCHAR(max)
      ,@StylesDesc  NVARCHAR(max)
      ,@MailWay  NVARCHAR(100)
	  ,@ProductImgs NVARCHAR(max)
	  ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
 

	SET @errorcount=0
 
 BEGIN TRAN
 INSERT INTO tbl_ShangChengChanPin(ProductID,TypeID,GYSid,ProductName,ProductNum,MarketPrice,SalePrice,ContentService,UnContentService,UseRule,NoticeKnow,ProductionDate,EffectDate,ShelfDate,IssueTime,Remark,ModelDesc,ColorDesc,StylesDesc,MailWay)
     VALUES
(@ProductID,@TypeID,@GYSid,@ProductName,@ProductNum,@MarketPrice,@SalePrice
,@ContentService,@UnContentService,@UseRule,@NoticeKnow,@ProductionDate,@EffectDate,@ShelfDate,@IssueTime,@Remark,@ModelDesc,@ColorDesc,@StylesDesc,@MailWay)

    delete from tbl_ShangChengTuPian where ProductID=@ProductID
	set @errorcount=@errorcount+@@error
     IF(@errorcount=0 AND @ProductImgs IS NOT NULL AND LEN(@ProductImgs)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ProductImgs
		INSERT INTO tbl_ShangChengTuPian(ProductID,FilePath,FileDesc)
		SELECT @ProductID,FilePath,FileDesc 
		FROM OPENXML(@hdoc,'/root/info')
		WITH(FilePath NVARCHAR(255),FileDesc NVARCHAR(255)) 
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END
 
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END

 
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,(a.ProductNum- (SELECT COUNT(OrderID) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)   ) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       
  FROM tbl_ShangChengChanPin as a
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-15
-- Description:	写入订单信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号

	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@YiShouRenShu=SYRS FROM [tbl_XianLuTour] WHERE TourId=@TourId 
	
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=[JiHuaRenShu] FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId

	IF(@YiShouRenShu<@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode=CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice)
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc

	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

ALTER VIEW [dbo].[view_XianLuTour_ZuiJinFaBan]
AS
select * from(
SELECT A.*,ROW_NUMBER()  over (PARTITION  by A.xianluid order by ldate asc) as no FROM [tbl_XianLuTour] AS A INNER JOIN (SELECT XianLuId,MIN([LDate]) AS ZuiJinQuTuanRiQi FROM tbl_XianLuTour   WHERE LDate>=GETDATE() GROUP BY XianLuId)B
ON A.XianLuId=B.XianLuId AND A.Ldate=b.ZuiJinQuTuanRiQi

) a
where no=1
GO

alter table Hotel_HotelInfo alter column tel varchar(500)
GO

ALTER TABLE dbo.tbl_QianZheng
	DROP CONSTRAINT FK_TBL_QIANZHENG_REFERENCE_TBL_QIANZHENGGYS
GO


 alter table tbl_JA_ZuCheInfo add YouHuiChaoShi money 
 go
 
 ALTER PROCEDURE [dbo].[proc_JA_ZucheInfo_Update]  
@ZuCheID char(36),
@CarName nvarchar(255),
@XianZuoRenShu int,
@MenShiJia money,
@MenShiJiaGeZuChe money,
@MenShiChaoShi money,
@MenShiJiaGeChaoShi money,
@MenShiChaoCheng money,
@MenShiJiaGeChaoCheng money,
@YouHuiJia money,
@YouHuiJiaGeZuChe money,
@YouHuiChaoShi money,
@YouHuiJiaGeChaoShi money,
@YouHuiChaoCheng money,
@YouHuiJiaGeChaoCheng money,
@OperatorId int,
@IssueTime datetime,
@LatestId int,
@LatestTime datetime,
@IsRecommend char(1),
@Remark nvarchar(MAX),
@FilePath nvarchar(255),
@MenShiJiaGeDanCheng money,
@YouHuiJiaGeDanCheng money,
@ZuCheImg xml,
@Result int output
AS
BEGIN
	declare @error int
	set @error=0
	begin transaction
		UPDATE [tbl_JA_ZuCheInfo] SET 
	[CarName] = @CarName,[XianZuoRenShu] = @XianZuoRenShu,[MenShiJia] = @MenShiJia,[MenShiJiaGeZuChe] = @MenShiJiaGeZuChe,[MenShiChaoShi] = @MenShiChaoShi,[MenShiJiaGeChaoShi] = @MenShiJiaGeChaoShi,[MenShiChaoCheng] = @MenShiChaoCheng,[MenShiJiaGeChaoCheng] = @MenShiJiaGeChaoCheng,[YouHuiJia] = @YouHuiJia,[YouHuiJiaGeZuChe] = @YouHuiJiaGeZuChe,[YouHuiChaoShi]=@YouHuiChaoShi,[YouHuiJiaGeChaoShi] = @YouHuiJiaGeChaoShi,[YouHuiChaoCheng] = @YouHuiChaoCheng,[YouHuiJiaGeChaoCheng] = @YouHuiJiaGeChaoCheng,[OperatorId] = @OperatorId,[IssueTime] = @IssueTime,[LatestId] = @LatestId,[LatestTime] = @LatestTime,[IsRecommend] = @IsRecommend,[Remark] = @Remark,[FilePath] = @FilePath,[MenShiJiaGeDanCheng] = @MenShiJiaGeDanCheng,[YouHuiJiaGeDanCheng] = @YouHuiJiaGeDanCheng
	WHERE ZuCheID=@ZuCheID 
	set @error=@error+@@error
	DELETE [tbl_JA_ZuCheImg] WHERE ZuCheID=@ZuCheID 
	set @error=@error+@@error
	if(@ZuCheImg is not null)
	BEGIN
		declare @i int
		exec sp_xml_preparedocument @i output,@ZuCheImg
		set @error=@error+@@error
		INSERT INTO [tbl_JA_ZuCheImg](
		[ZuCheID],[ImgCategory],[FilePath],[Desc],[IssueTime],[OperatorId])
		select @ZuCheID,ImgCategory,FilePath,[Desc],[IssueTime],[OperatorId] from openxml(@i,'/root/info')with(ZuCheID char(36),ImgCategory tinyint,FilePath varchar(255),[Desc] nvarchar(255),IssueTime datetime,OperatorId char(36))
		set @error=@error+@@error
		exec sp_xml_removedocument @i
		set @error=@error+@@error
	END
	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result
END

GO


ALTER PROCEDURE [dbo].[proc_JA_ZucheInfo_ADD] 
@ZuCheID char(36),
@CarName nvarchar(255),
@XianZuoRenShu int,
@MenShiJia money,
@MenShiJiaGeZuChe money,
@MenShiChaoShi money,
@MenShiJiaGeChaoShi money,
@MenShiChaoCheng money,
@MenShiJiaGeChaoCheng money,
@YouHuiJia money,
@YouHuiJiaGeZuChe money,
@YouHuiChaoShi money,
@YouHuiJiaGeChaoShi money,
@YouHuiChaoCheng money,
@YouHuiJiaGeChaoCheng money,
@OperatorId int,
@IssueTime datetime,
@LatestId int,
@LatestTime datetime,
@IsRecommend char(1),
@Remark nvarchar(MAX),
@State tinyint,
@FilePath nvarchar(255),
@MenShiJiaGeDanCheng money,
@YouHuiJiaGeDanCheng money,
@ZuCheImg xml,
@Result int output
AS
BEGIN
	declare @error int
	set @error=0
	
	begin transaction
	
	INSERT INTO [tbl_JA_ZuCheInfo](
	[ZuCheID],[CarName],[XianZuoRenShu],[MenShiJia],[MenShiJiaGeZuChe],[MenShiChaoShi],[MenShiJiaGeChaoShi],[MenShiChaoCheng],[MenShiJiaGeChaoCheng],[YouHuiJia],[YouHuiJiaGeZuChe],[YouHuiChaoShi],[YouHuiJiaGeChaoShi],[YouHuiChaoCheng],[YouHuiJiaGeChaoCheng],[OperatorId],[IssueTime],[LatestId],[LatestTime],[IsRecommend],[Remark],[State],[FilePath],[MenShiJiaGeDanCheng],[YouHuiJiaGeDanCheng]
	)VALUES(
	@ZuCheID,@CarName,@XianZuoRenShu,@MenShiJia,@MenShiJiaGeZuChe,@MenShiChaoShi,@MenShiJiaGeChaoShi,@MenShiChaoCheng,@MenShiJiaGeChaoCheng,@YouHuiJia,@YouHuiJiaGeZuChe,@YouHuiChaoShi,@YouHuiJiaGeChaoShi,@YouHuiChaoCheng,@YouHuiJiaGeChaoCheng,@OperatorId,@IssueTime,@LatestId,@LatestTime,@IsRecommend,@Remark,@State,@FilePath,@MenShiJiaGeDanCheng,@YouHuiJiaGeDanCheng
	)
	set @error=@error+@@error
	if(@ZuCheImg is not null)
	BEGIN
		declare @i int
		exec sp_xml_preparedocument @i output,@ZuCheImg
		set @error=@error+@@error
		INSERT INTO [tbl_JA_ZuCheImg](
		[ZuCheID],[ImgCategory],[FilePath],[Desc],[IssueTime],[OperatorId])
		select @ZuCheID,ImgCategory,FilePath,[Desc],[IssueTime],[OperatorId] from openxml(@i,'/root/info')with(ZuCheID char(36),ImgCategory tinyint,FilePath varchar(255),[Desc] nvarchar(255),IssueTime datetime,OperatorId char(36))
		set @error=@error+@@error
		exec sp_xml_removedocument @i
		set @error=@error+@@error
	END
	
	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result
END



GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* 新增订单所属单位*/
ALTER VIEW [dbo].[view_ScenicAreaOrder]
AS
SELECT     A.OrderId, A.OrderCode, A.ScenicId, A.TicketsId, A.Price, A.Num, A.Status, A.Source, A.FuKuanStatus, A.OperatorId, A.IssueTime, A.ChuFaRiQi, 
                      A.AgencyJinE, A.SellerID, A.ContactName, A.ContactTel, A.Remark, B.ScenicName, C.TypeName, A.BuyCompanyName, A.OperatorName
FROM         dbo.tbl_ScenicAreaOrder AS A INNER JOIN
                      dbo.tbl_ScenicArea AS B ON A.ScenicId = B.ScenicId INNER JOIN
                      dbo.tbl_ScenicTickets AS C ON A.TicketsId = C.TicketsId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


 alter table tbl_QianZheng add FileUpLoad nvarchar(100) 
 go
 
 set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go







-- =============================================
-- Author:		邹磊
-- Create date: 2014-08-12
-- Description:	租车订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_JA_ZuCheOrder_ADD] 
	@OrderId char(36),
@OrderCode varchar(50) OUTPUT,
@ZuCheID char(36),
@ZuCheType int,
@CarType int,
@GongLiShu numeric(10,3),
@ZuCheTianShu int,
@ZuJin money,
@Status tinyint,
@FuKuanStatus tinyint,
@LDate datetime,
@XiaDanBeiZhu nvarchar(MAX),
@LxrName nvarchar(50),
@LxrTelephone nvarchar(100),
@OperatorId char(36),
@IssueTime datetime,
@TuanGouId char(36),
@ZuCheXingCheng xml,
@EDate datetime,
@Number int,
@YuDingRName nvarchar(50),
@YuDingRTelephone nvarchar(100),
@AgencyId char(36),
@AgencyJinE money,
@Result int output
AS
BEGIN TRANSACTION
	declare @ErrorNum int
	set @ErrorNum=0
	
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_JA_ZuCheOrder]
	SET @OrderCode='ZC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)	

	INSERT INTO [tbl_JA_ZuCheOrder](
	[OrderId],[OrderCode],[ZuCheID],[ZuCheType],[CarType],[GongLiShu],[ZuCheTianShu],[ZuJin],[Status],[FuKuanStatus],[LDate],[XiaDanBeiZhu],[LxrName],[LxrTelephone],[OperatorId],[IssueTime],[TuanGouId],[EDate],[Number],[YuDingRName],[YuDingRTelephone],AgencyId,AgencyJinE
	)VALUES(
	@OrderId,@OrderCode,@ZuCheID,@ZuCheType,@CarType,@GongLiShu,@ZuCheTianShu,@ZuJin,@Status,@FuKuanStatus,@LDate,@XiaDanBeiZhu,@LxrName,@LxrTelephone,@OperatorId,@IssueTime,@TuanGouId,@EDate,@Number,@YuDingRName,@YuDingRTelephone,@AgencyId,@AgencyJinE
	)
	set @ErrorNum=@@error
	if(@ZuCheXingCheng is not null)
	BEGIN
		declare @i int
		exec sp_xml_preparedocument @i output,@ZuCheXingCheng
		set @ErrorNum=@ErrorNum+@@error
		INSERT INTO tbl_JA_ZuCheXingCheng(OrderId,LPlace,EPlace,GongLiShu)
		select @OrderId,LPlace,EPlace,GongLiShu from openxml(@i,'/root/info')
		with(OrderId char(36),LPlace nvarchar(255),EPlace nvarchar(255),GongLiShu numeric(10,3))
		set @ErrorNum=@ErrorNum+@@error
		
		exec sp_xml_removedocument @i
		set @ErrorNum=@ErrorNum+@@error
	END
	if(@ErrorNum=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	
	
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[view_JA_ZuCheOrder]
AS
SELECT     dbo.tbl_JA_ZuCheOrder.OrderId, 
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_JA_ZuCheOrder.OperatorId ) as UserType,
dbo.tbl_JA_ZuCheOrder.ZuCheID, dbo.tbl_JA_ZuCheOrder.ZuCheType, dbo.tbl_JA_ZuCheOrder.CarType, 
                      dbo.tbl_JA_ZuCheOrder.GongLiShu, dbo.tbl_JA_ZuCheOrder.ZuCheTianShu, dbo.tbl_JA_ZuCheOrder.ZuJin, dbo.tbl_JA_ZuCheOrder.Status, 
                      dbo.tbl_JA_ZuCheOrder.FuKuanStatus, dbo.tbl_JA_ZuCheOrder.LDate, dbo.tbl_JA_ZuCheOrder.XiaDanBeiZhu, dbo.tbl_JA_ZuCheOrder.LxrName, 
                      dbo.tbl_JA_ZuCheOrder.LxrTelephone, dbo.tbl_JA_ZuCheOrder.OperatorId, dbo.tbl_JA_ZuCheOrder.IssueTime, dbo.tbl_JA_ZuCheOrder.TuanGouId, 
                      dbo.tbl_JA_ZuCheOrder.OrderCode, dbo.tbl_JA_ZuCheInfo.CarName, dbo.tbl_JA_ZuCheOrder.EDate, dbo.tbl_JA_ZuCheOrder.Number, 
                      dbo.tbl_JA_ZuCheOrder.YuDingRName, dbo.tbl_JA_ZuCheOrder.YuDingRTelephone, dbo.tbl_JA_ZuCheOrder.AgencyJinE, 
                      dbo.tbl_JA_ZuCheOrder.AgencyId
FROM         dbo.tbl_JA_ZuCheOrder INNER JOIN
                      dbo.tbl_JA_ZuCheInfo ON dbo.tbl_JA_ZuCheOrder.ZuCheID = dbo.tbl_JA_ZuCheInfo.ZuCheID
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


	
	
	
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId, 
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as UserType,
(SELECT MemberName  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as MemberName,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as Mobile,
(SELECT RouteType  FROM  dbo.tbl_SysArea AS p WHERE p.ID=B.AreaId ) as RouteType,
A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JSJCR, A.JSJER, A.JinE, A.FuKuanStatus, A.LDate, 
                      A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, A.IssueTime, 
                      A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* 新增订单所属单位*/
ALTER VIEW [dbo].[view_HotelOrder]
AS
SELECT     OrderId, HotelId,
                          (SELECT     HotelName
                            FROM          dbo.tbl_Hotel
                            WHERE      (HotelId = dbo.tbl_HotelOrder.HotelId)) AS HotelName, RoomTypeId,
                          (SELECT     RoomName
                            FROM          dbo.tbl_HotelRoomType
                            WHERE      (RoomTypeId = dbo.tbl_HotelOrder.RoomTypeId)) AS RoomName, OrderCode, RoomCount, CheckInDate, CheckOutDate, TotalAmount, 
                      ContactName, ContactMobile, Remark, PaymentType, PaymentState, OrderState, Source, OperatorId,
                          (SELECT     MemberName
                            FROM          dbo.tbl_Member
                            WHERE      (MemberID = dbo.tbl_HotelOrder.OperatorId)) AS OperatorName,
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as UserType,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as OperatorMobile,
 IssueTime, JiaGeId, DanJia, BuyCompanyName, SellerID, 
                      AgencyJinE
FROM         dbo.tbl_HotelOrder
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* 新增订单所属单位*/
ALTER VIEW [dbo].[view_ScenicAreaOrder]
AS
SELECT     A.OrderId, A.OrderCode, A.ScenicId, A.TicketsId, A.Price, A.Num, A.Status, A.Source, A.FuKuanStatus, A.OperatorId, A.IssueTime, A.ChuFaRiQi, 
                      A.AgencyJinE, A.SellerID, A.ContactName, A.ContactTel, A.Remark, B.ScenicName, C.TypeName, A.BuyCompanyName, A.OperatorName,
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as UserType,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as OperatorMobile
FROM         dbo.tbl_ScenicAreaOrder AS A INNER JOIN
                      dbo.tbl_ScenicArea AS B ON A.ScenicId = B.ScenicId INNER JOIN
                      dbo.tbl_ScenicTickets AS C ON A.TicketsId = C.TicketsId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_ShangChengOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_ShangChengChanPin AS p WHERE p.ProductID=s.ProductID ) as ProductName
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,ContactID
      ,ContactName
      ,ContactPhone
,(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as UserType
,(SELECT MemberName  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorName
,(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorMobile
      ,IssueTime
      ,Remark
      ,ProvinceID
      ,(SELECT [GYSid] FROM tbl_ShangChengChanPin chanpin WHERE chanpin.ProductID=s.ProductID )AS  GYSid
      ,(SELECT [Name] FROM tbl_SysProvince prov WHERE prov.ID=s.ProvinceID )AS  ProvinceName
      ,CityID
      ,(SELECT [Name] FROM tbl_SysCity city WHERE city.ID=s.CityID ) as CityName 
      ,DistrictID
      ,(SELECT [Name] FROM tbl_SysDistrict dist WHERE dist.ID=s.DistrictID) AS DistrictName
      ,Addressinfo
      ,SupplierID
      ,SupplierMoney
  FROM tbl_ShangChengDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId, 
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as UserType,
(SELECT MemberName  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as MemberName,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as Mobile,
(SELECT RouteType  FROM  dbo.tbl_SysArea AS p WHERE p.ID=B.AreaId ) as RouteType,
A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JinE, A.FuKuanStatus, A.LDate, 
                      A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, A.IssueTime, 
                      A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source,B.SCJCR,B.SCJET, B.JSJCR, B.JSJET
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[view_Hotel]
AS
SELECT     A.HotelId, A.HotelCode, A.HotelName, A.HotelNameEn, A.Latitude, A.Longitude, A.ServiceTel, A.ProvinceId, A.CityId, A.CountyId, A.Address, 
                      A.EnAddress, A.Star, A.PostalCode, A.OpenDate, A.Fitment, A.RoomQuantity, A.Floor, A.LongDesc, A.Transport, A.AdditionalCost, A.Status, A.IssueTime, 
                      A.IsDelete, A.IsHot, A.IsRecommend, A.CityCode,
                          (SELECT     B.RoomTypeId, B.HotelId, B.RoomName, B.TotalNumber, B.RoomType, B.RoomArea, B.Floor, B.BedType, B.BedHeight, B.BedWidth, 
                                                   B.MaxGuestNum, B.IsSmoking, B.IsInternet, B.IsInternetPrice, B.Orientation, B.IsBreakfast, B.IsBreakfastPrice, B.IsWindow, B.IsAddBed, 
                                                   B.IsAddBedPrice, B.Payment, B.[Desc], B.IssueTime, B.OperatorId, B.SortId, B.RoomStatus, B.BedTypeDescription, C.AmountPrice, 
                                                   C.PreferentialPrice, C.SettlementPrice
                            FROM          tbl_HotelRoomType AS B LEFT JOIN
                                                   tbl_HotelRoomRate AS C ON B.RoomTypeId = C.RoomTypeId AND datediff(day, C.StartDate, getdate()) >= 0 AND datediff(day, C.EndDate, 
                                                   getdate()) <= 0
                            WHERE      B.HotelId = A.HotelId AND B.IsDelete = '0' FOR xml raw, root('Root')) AS HotelRoomType,
                          (SELECT     D .ImgId, D .HotelId, D .ImgCategory, D .FilePath, D .[Desc], D .IssueTime, D .OperatorId
                            FROM          tbl_HotelImg AS D
                            WHERE      D .HotelId = A.HotelId FOR xml raw, root('Root')) AS HotelImg/*		as HotelLandMark	*/ ,
                          (SELECT     A1.HotelId, A1.LandMarkId,
                                                       (SELECT     Name
                                                         FROM          tbl_SysDiBiao
                                                         WHERE      Id = A1.LandMarkId) AS Por
                            FROM          tbl_HotelLandMark AS A1
                            WHERE      A1.HotelId = A.HotelId FOR XML RAW, ROOT('Root')) AS HotelLandMark, A.Mobile, A.JieSuanType
FROM         tbl_Hotel AS A
WHERE     A.hotelid IN
                          (SELECT     hotelid
                            FROM          tbl_HotelImg
                            WHERE      filepath <> '')
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	写入线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- 1.2014-08-05 刘树超 tbl_XianLuTourTraffice 添加航班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLu_Insert]
	 @XianLuId CHAR(36)--线路编号
	,@AreaName NVARCHAR(50)
	,@InterfaceID INT 
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" SYRS="" TrafficId="" JSJCR="" JSJET="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>
	,@Line_Source  TINYINT
	,@LineType TINYINT 
	,@TourTraffice NVARCHAR(MAX)
	,@CFCS NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	INSERT INTO [tbl_XianLu]([XianLuId],[AreaId],[RouteName]
		,[TianShu],[DepProvinceId],[DepCityId]
		,[ArrProvinceId],[ArrCityId],[JiHuaRenShu]
		,[SCJCR],[SCJET],[JSJCR]
		,[JSJET],[TingTianShu],[ChuFaJiaoTong]
		,[FanChengJiaoTong],[JiHeFangShi],[TeSe]
		,[TeSeFilePath],[TuJing],[QianZheng]
		,[QianZhengFilePath],[GuanZhuShu],[LxrName]
		,[LxrTelephone],[LxrQQ],[LxrMobile]
		,[Description],[Keywords],[OperatorId]
		,[IssueTime],[LatestId],[LatestTime],[AreaName],[InterfaceID],[Line_Source],[LineType],[CFCS])
	VALUES (@XianLuId,@AreaId,@RouteName
		,@TianShu,@DepProvinceId,@DepCityId
		,@ArrProvinceId,@ArrCityId,@JiHuaRenShu
		,@SCJCR,@SCJET,@JSJCR
		,@JSJET,@TingTianShu,@ChuFaJiaoTong
		,@FanChengJiaoTong,@JiHeFangShi,@TeSe
		,@TeSeFilePath,@TuJing,@QianZheng
		,@QianZhengFilePath,@GuanZhuShu,@LxrName
		,@LxrTelephone,@LxrQQ,@LxrMobile
		,@Description,@Keywords,@OperatorId
		,@IssueTime,@LatestId,@LatestTime,@AreaName,@InterfaceID,@Line_Source,@LineType,@CFCS)
	SET @errorcount=@errorcount+@@ERROR

		IF(@errorcount=0 AND @TourTraffice IS NOT NULL AND LEN(@TourTraffice)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourTraffice
		INSERT INTO tbl_XianLuTourTraffice(XianLuId,TrafficId,Traffic_01
			,Traffic_02)
		SELECT @XianLuId,T.TrafficId,T.Traffic_01,T.Traffic_02
		FROM OPENXML(@hdoc,'/root/info')
		WITH(TrafficId NVARCHAR(60),Traffic_01 NVARCHAR(100),Traffic_02 NVARCHAR(100)) AS T
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
		INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
			,[ZhuSu],[YongCan],[XingCheng]
			,[FilePath])
		SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
			,A.[ZhuSu],A.[YongCan],A.[XingCheng]
			,A.[FilePath]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
		INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
		INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
		SELECT @XianLuId,A.[ZhuTiId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([ZhuTiId] INT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
		INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
		SELECT @XianLuId,A.[Status]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([Status] TINYINT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TourXml IS NOT NULL AND LEN(@TourXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml
		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR]
			,[JSJET],[SYRS],[TrafficId])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],A.[JSJCR]
			,A.[JSJET],A.[SYRS],A.[TrafficId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[JSJCR] MONEY,[JSJET] MONEY,[SYRS]INT,[TrafficId] NVARCHAR(50) ) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
		INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
		SELECT @XianLuId,A.FilePath,A.MiaoShu
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO


 alter table tbl_JA_Account add TranUserId char(36)
 go 
 
/************************************************修改存储过程各订单编号**************************************************/

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-15
-- Description:	写入订单信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号

	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@YiShouRenShu=SYRS FROM [tbl_XianLuTour] WHERE TourId=@TourId 
	
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=[JiHuaRenShu] FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId

	IF(@YiShouRenShu<@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice)
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc

	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO
-- 线路

-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-28
-- Description:	写入团购订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_TuanGouDingDan_Insert]
	 @ProductID INT
	,@OrderCode NVARCHAR(50) OUTPUT
	,@ProductNum INT
	,@OrderPrice MONEY
	,@PeopleID CHAR(36)
	,@PeopleName NVARCHAR(50)
	,@PeopleMobile NVARCHAR(50)
	,@IssueTime DATETIME
	,@OrderState TINYINT
	,@PayState TINYINT
	,@SupplierID CHAR(36)
	,@RetCode INT OUTPUT--OUTPUT CODE
	,@OrderID INT OUTPUT
AS
BEGIN
	DECLARE @errorcount INT
	SET @errorcount=0
 
 BEGIN TRAN
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_TuanGouDingDan
	SET @OrderCode='TG'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)

  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_TuanGouDingDan (ProductID ,OrderCode ,ProductNum ,OrderPrice ,PeopleID ,PeopleName ,PeopleMobile ,IssueTime ,OrderState ,PayState ,SupplierID)     VALUES (@ProductID ,@OrderCode ,@ProductNum ,@OrderPrice ,@PeopleID ,@PeopleName ,@PeopleMobile ,@IssueTime ,@OrderState ,@PayState ,@SupplierID)
	SET @OrderID=@@IDENTITY
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO
--团购

-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-09
-- Description:	写入商城订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangChengDingDan_Insert]
		@OrderID  CHAR(36)
	   ,@ProductID CHAR(36)
	   ,@ProductNum INT
	   ,@OrderCode NVARCHAR(50) OUTPUT
	   ,@OrderPrice  MONEY
	   ,@OrderState TINYINT
	   ,@PayState TINYINT
	   ,@ContactID CHAR(36)
	   ,@ContactName NVARCHAR(50)
	   ,@ContactPhone NVARCHAR(50)
	   ,@IssueTime DATETIME
	   ,@Remark NVARCHAR(MAX)
	   ,@AddressID INT
	   ,@ProvinceID INT
	   ,@CityID INT
	   ,@DistrictID INT
	   ,@AddressInfo NVARCHAR(255)
	   ,@UserID CHAR(36)
	   ,@UserName NVARCHAR(50)
	   ,@IsDefault CHAR(1)
	   ,@SupplierID CHAR(36)
	   ,@SupplierMoney MONEY
	   ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
    DECLARE @Address INT
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0
	SET @Address=@AddressID
 
 BEGIN TRAN
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ShangChengDingDan
	SET @OrderCode='SC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
 IF(@AddressID=0)
 BEGIN
	 --写入地址信息
	 IF(@IsDefault=0)
		 BEGIN
			INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
	  ELSE
		  BEGIN
		  UPDATE tbl_DiZhi SET IsDefault=0 WHERE UserID=@UserID
		  INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
		  SET @Address=@@IDENTITY
 END
 ELSE
 BEGIN
		UPDATE tbl_DiZhi SET ProvinceID=@ProvinceID,CityID=@CityID,DistrictID=@DistrictID,AddressInfo=@AddressInfo WHERE AddressID=@AddressID
 END
  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_ShangChengDingDan (OrderID ,ProductID ,ProductNum ,OrderCode ,OrderPrice ,OrderState ,PayState ,ContactID ,ContactName ,ContactPhone ,IssueTime ,Remark,ProvinceID,CityID,DistrictID,AddressInfo,SupplierID,SupplierMoney)
		 VALUES (@OrderID ,@ProductID ,@ProductNum ,@OrderCode ,@OrderPrice ,@OrderState ,@PayState ,@ContactID ,@ContactName ,@ContactPhone ,@IssueTime ,@Remark,@ProvinceID,@CityID,@DistrictID,@AddressInfo,@SupplierID,@SupplierMoney)
		 
 
	   
	   
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO
--商城

-- 新增订单所属单位
-- =============================================
ALTER proc [dbo].[proc_ScenicAreaOrder_Add]
@OrderId char(36),
@ScenicId char(36),
@TicketsId char(36),
@Price decimal(18,0),
@Num int,
@Status tinyint,
@Source tinyint,
@FuKuanStatus tinyint,
@OperatorId char(36),
@ContactName NVARCHAR(255),
@ContactTel NVARCHAR(255),
@Remark NVARCHAR(max),
@Result int output,
@BuyCompanyName nvarchar(100)=''
,@OrderCode nvarchar(50) OUTPUT
as
begin
	declare @error int
	set @error=0
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ScenicAreaOrder
	SET @OrderCode='JQ'+CONVERT(VARCHAR(8),GETDATE(),112)+'J'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	SELECT @YiShouRenShu=SUM([Num]) FROM [tbl_ScenicAreaOrder] WHERE [TicketsId]=@TicketsId AND [Status] IN(0,3,4,5)
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)
	set @Status =4
	SELECT @JiHuaRenShu=[Number] FROM [tbl_ScenicTickets] WHERE [TicketsId]=@TicketsId
	IF(@JiHuaRenShu<@YiShouRenShu+@Num)
	BEGIN
		SET @Result=0
		return @Result
	END
	
	INSERT INTO tbl_ScenicAreaOrder
           (OrderId,OrderCode,ScenicId,TicketsId,Price,Num,Status,Source,FuKuanStatus,OperatorId,IssueTime,ContactName,ContactTel,Remark,BuyCompanyName)
     VALUES
           (@OrderId,@OrderCode,@ScenicId,@TicketsId,@Price,@Num,@Status,@Source,@FuKuanStatus,@OperatorId,getdate(),@ContactName,@ContactTel,@Remark,@BuyCompanyName)

	if(1 = 1)
	begin
		set @Result=1
	end
	else
	begin
		set @Result=0
	end

	return @Result
end
GO
--景区 

-- 新增订单所属单位
-- =============================================
ALTER PROCEDURE [dbo].[proc_HotelOrder_Add]
@OrderId char(36),
@HotelId char(36),
@RoomTypeId char(36),
@OrderCode varchar(50) OUTPUT,
@RoomCount int,
@CheckInDate datetime,
@CheckOutDate datetime,
@TotalAmount money,
@ContactName nvarchar(50),
@ContactMobile nvarchar(50),
@Remark nvarchar(max),
@PaymentType tinyint,
@PaymentState tinyint,
@OrderState tinyint,
@Source tinyint,
@OperatorId char(36),
@Result int output
,@JiaGeId INT
,@DanJia MONEY
,@BuyCompanyName nvarchar(100)=''
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	
	if exists(select 1 from tbl_Hotel where HotelId=@HotelId and (IsDelete='1' or Status=1))
	begin
		set @Result=-1 --酒店已删除或下架
		return @Result
	end

	if exists(select 1 from tbl_HotelRoomType where RoomTypeId=@RoomTypeId and (IsDelete='1' or RoomStatus=1))
	begin
		set @Result=-2 --房型已删除或下架
		return @Result
	end
	DECLARE @ShuLiang INT
	DECLARE @YiYuDingShuLiang INT

	SELECT @ShuLiang=ShuLiang FROM tbl_HotelRoomRate WHERE RoomRateId=@JiaGeId
	SELECT @YiYuDingShuLiang=ISNULL(SUM(A1.RoomCount),0) FROM tbl_HotelOrder AS A1 WHERE A1.JiaGeId=@JiaGeId AND A1.OrderState IN(0,3,4,5)
	IF(@YiYuDingShuLiang+@RoomCount>@ShuLiang)
	BEGIN
		SET @Result=-99
		RETURN @Result
	END	

	BEGIN TRANSACTION
	
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_HotelOrder]
	SET @OrderCode='JD'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	set @OrderState=4

	INSERT INTO tbl_HotelOrder(OrderId,HotelId,RoomTypeId,OrderCode,RoomCount,
	CheckInDate,CheckOutDate,TotalAmount,ContactName,ContactMobile,Remark
	,PaymentType,PaymentState,OrderState,Source,OperatorId,IssueTime,JiaGeId
	,DanJia,BuyCompanyName)
	VALUES(@OrderId,@HotelId,@RoomTypeId,@OrderCode,@RoomCount,@CheckInDate,
	@CheckOutDate,@TotalAmount,@ContactName,@ContactMobile,@Remark,
	@PaymentType,@PaymentState,@OrderState,@Source,@OperatorId,getdate(),@JiaGeId
	,@DanJia,@BuyCompanyName)
	SET @error=@error+@@ERROR
	
	IF(@error=0)
	BEGIN
		SET @Result=1
		COMMIT TRANSACTION
	END
	ELSE
	BEGIN
		SET @Result=0
		ROLLBACK TRANSACTION
	END
	return @Result
END
GO
--酒店




 alter table tbl_JA_Sellers add JinAoLXR varchar(50)
 alter table tbl_JA_Sellers add JinAoTel varchar(50)
 alter table tbl_JA_Sellers add JinAoMobile varchar(13)
 alter table tbl_JA_Sellers add JinAoWeiXin varchar(50)
 alter table tbl_JA_Sellers add JinAoQQ varchar(15)
 go 
 
 
 alter table tbl_Member add WeiXin varchar(50)
 

GO
ALTER TABLE dbo.tbl_XianLuFuWu ADD
	ZengSongXiangMu nvarchar(MAX) NULL,
	QiTaShiXiang nvarchar(MAX) NULL
GO


-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	写入线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- 1.2014-08-05 刘树超 tbl_XianLuTourTraffice 添加航班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLu_Insert]
	 @XianLuId CHAR(36)--线路编号
	,@AreaName NVARCHAR(50)
	,@InterfaceID INT 
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" SYRS="" TrafficId="" JSJCR="" JSJET="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>
	,@Line_Source  TINYINT
	,@LineType TINYINT 
	,@TourTraffice NVARCHAR(MAX)
	,@CFCS NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	INSERT INTO [tbl_XianLu]([XianLuId],[AreaId],[RouteName]
		,[TianShu],[DepProvinceId],[DepCityId]
		,[ArrProvinceId],[ArrCityId],[JiHuaRenShu]
		,[SCJCR],[SCJET],[JSJCR]
		,[JSJET],[TingTianShu],[ChuFaJiaoTong]
		,[FanChengJiaoTong],[JiHeFangShi],[TeSe]
		,[TeSeFilePath],[TuJing],[QianZheng]
		,[QianZhengFilePath],[GuanZhuShu],[LxrName]
		,[LxrTelephone],[LxrQQ],[LxrMobile]
		,[Description],[Keywords],[OperatorId]
		,[IssueTime],[LatestId],[LatestTime],[AreaName],[InterfaceID],[Line_Source],[LineType],[CFCS])
	VALUES (@XianLuId,@AreaId,@RouteName
		,@TianShu,@DepProvinceId,@DepCityId
		,@ArrProvinceId,@ArrCityId,@JiHuaRenShu
		,@SCJCR,@SCJET,@JSJCR
		,@JSJET,@TingTianShu,@ChuFaJiaoTong
		,@FanChengJiaoTong,@JiHeFangShi,@TeSe
		,@TeSeFilePath,@TuJing,@QianZheng
		,@QianZhengFilePath,@GuanZhuShu,@LxrName
		,@LxrTelephone,@LxrQQ,@LxrMobile
		,@Description,@Keywords,@OperatorId
		,@IssueTime,@LatestId,@LatestTime,@AreaName,@InterfaceID,@Line_Source,@LineType,@CFCS)
	SET @errorcount=@errorcount+@@ERROR

		IF(@errorcount=0 AND @TourTraffice IS NOT NULL AND LEN(@TourTraffice)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourTraffice
		INSERT INTO tbl_XianLuTourTraffice(XianLuId,TrafficId,Traffic_01
			,Traffic_02)
		SELECT @XianLuId,T.TrafficId,T.Traffic_01,T.Traffic_02
		FROM OPENXML(@hdoc,'/root/info')
		WITH(TrafficId NVARCHAR(60),Traffic_01 NVARCHAR(100),Traffic_02 NVARCHAR(100)) AS T
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
		INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
			,[ZhuSu],[YongCan],[XingCheng]
			,[FilePath])
		SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
			,A.[ZhuSu],A.[YongCan],A.[XingCheng]
			,A.[FilePath]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
		INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi],[ZengSongXiangMu],[QiTaShiXiang])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi],A.[ZengSongXiangMu],A.[QiTaShiXiang]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX),[ZengSongXiangMu] VARCHAR(MAX),[QiTaShiXiang] NVARCHAR(MAX)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
		INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
		SELECT @XianLuId,A.[ZhuTiId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([ZhuTiId] INT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
		INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
		SELECT @XianLuId,A.[Status]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([Status] TINYINT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TourXml IS NOT NULL AND LEN(@TourXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml
		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR]
			,[JSJET],[SYRS],[TrafficId])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],A.[JSJCR]
			,A.[JSJET],A.[SYRS],A.[TrafficId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[JSJCR] MONEY,[JSJET] MONEY,[SYRS]INT,[TrafficId] NVARCHAR(50) ) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
		INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
		SELECT @XianLuId,A.FilePath,A.MiaoShu
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO

--添加线路新增“其他事项，赠送项目”

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	修改线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLu_Update]
	 @XianLuId CHAR(36)--线路编号
	,@InterfaceID int
	,@AreaName NVARCHAR(255)
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>

	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	UPDATE [tbl_XianLu] SET [AreaId]=@AreaId,[RouteName]=@RouteName,[TianShu]=@TianShu
		,[DepProvinceId]=@DepProvinceId,[DepCityId]=@DepCityId,[ArrProvinceId]=@ArrProvinceId
		,[ArrCityId]=@ArrCityId,[JiHuaRenShu]=@JiHuaRenShu,[SCJCR]=@SCJCR
		,[SCJET]=@SCJET,[JSJCR]=@JSJCR,[JSJET]=@JSJET
		,[TingTianShu]=@TingTianShu,[ChuFaJiaoTong]=@ChuFaJiaoTong,[FanChengJiaoTong]=@FanChengJiaoTong
		,[JiHeFangShi]=@JiHeFangShi,[TeSe]=@TeSe,[TeSeFilePath]=@TeSeFilePath
		,[TuJing]=@TuJing,[QianZheng]=@QianZheng,[QianZhengFilePath]=@QianZhengFilePath
		,[GuanZhuShu]=[GuanZhuShu],[LxrName]=@LxrName,[LxrTelephone]=@LxrTelephone
		,[LxrQQ]=@LxrQQ,[LxrMobile]=@LxrMobile,[Description]=@Description
		,[Keywords]=@Keywords,[LatestId]=@LatestId,[LatestTime]=@LatestTime
		,[InterfaceID]=@InterfaceID,[AreaName]=@AreaName
	WHERE [XianLuId]=@XianLuId

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuXingCheng] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
			INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
				,[ZhuSu],[YongCan],[XingCheng]
				,[FilePath])
			SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
				,A.[ZhuSu],A.[YongCan],A.[XingCheng]
				,A.[FilePath]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END		
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuFuWu] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
			INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi],[ZengSongXiangMu],[QiTaShiXiang])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi],A.[ZengSongXiangMu],A.[QiTaShiXiang]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX),[ZengSongXiangMu] VARCHAR(MAX),[QiTaShiXiang] NVARCHAR(MAX)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuTi] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
			INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
			SELECT @XianLuId,A.[ZhuTiId]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([ZhuTiId] INT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuangTai] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
			INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
			SELECT @XianLuId,A.[Status]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([Status] TINYINT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0 AND @TourXml IS NOT NULL AND LEN(@TourXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml

		UPDATE [tbl_XianLuTour] SET [LDate]=B.LDate,[RDate]=B.RDate,[SYRS]=b.SYRS
		FROM [tbl_XianLuTour] AS A INNER JOIN (SELECT [TourId],[LDate],[RDate],[Status],[SYRS] FROM OPENXML(@hdoc,'/root/info') WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[SYRS] INT)) AS B
		ON A.TourId=B.TourId
		WHERE A.XianLuId=@XianLuId
		SET @errorcount=@errorcount+@@ERROR

		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR]
			,[JSJET])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],@JSJCR
			,@JSJET
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT) AS A
		WHERE A.TourId NOT IN(SELECT TourId FROM [tbl_XianLuTour] AS B WHERE B.XianLuId=@XianLuId)
		SET @errorcount=@errorcount+@@ERROR

		DELETE FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId 
		AND [TourId] NOT IN(SELECT A.[TourId] FROM OPENXML(@hdoc,'/root/info') WITH([TourId] CHAR(36)) AS A) 
		AND [TourId] NOT IN(SELECT A.[TourId] FROM [tbl_XianLuTourOrder] AS A WHERE A.XianLuId=@XianLuId)
		SET @errorcount=@errorcount+@@ERROR

		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuTeSeFile] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
			INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
			SELECT @XianLuId,A.FilePath,A.MiaoShu
			FROM OPENXML(@hdoc,'/root/info')
			WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO
--修改线路新增“其他事项，赠送项目”



 alter table tbl_JA_Sellers add JinAoPhoto nvarchar(250)
 go 


 alter table tbl_JA_Sellers add ShowOrHidden tinyint default 0
 go 
 
 
 
 
	
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[view_JA_ZuCheOrder]
AS
SELECT     dbo.tbl_JA_ZuCheOrder.OrderId, 
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_JA_ZuCheOrder.OperatorId ) as UserType,
dbo.tbl_JA_ZuCheOrder.ZuCheID, dbo.tbl_JA_ZuCheOrder.ZuCheType, dbo.tbl_JA_ZuCheOrder.CarType, 
                      dbo.tbl_JA_ZuCheOrder.GongLiShu, dbo.tbl_JA_ZuCheOrder.ZuCheTianShu, dbo.tbl_JA_ZuCheOrder.ZuJin, dbo.tbl_JA_ZuCheOrder.Status, 
                      dbo.tbl_JA_ZuCheOrder.FuKuanStatus, dbo.tbl_JA_ZuCheOrder.LDate, dbo.tbl_JA_ZuCheOrder.XiaDanBeiZhu, dbo.tbl_JA_ZuCheOrder.LxrName, 
                      dbo.tbl_JA_ZuCheOrder.LxrTelephone, dbo.tbl_JA_ZuCheOrder.OperatorId, dbo.tbl_JA_ZuCheOrder.IssueTime, dbo.tbl_JA_ZuCheOrder.TuanGouId, 
                      dbo.tbl_JA_ZuCheOrder.OrderCode, dbo.tbl_JA_ZuCheInfo.CarName, dbo.tbl_JA_ZuCheOrder.EDate, dbo.tbl_JA_ZuCheOrder.Number, 
                      dbo.tbl_JA_ZuCheOrder.YuDingRName, dbo.tbl_JA_ZuCheOrder.YuDingRTelephone, dbo.tbl_JA_ZuCheOrder.AgencyJinE, 
                      dbo.tbl_JA_ZuCheOrder.AgencyId
FROM         dbo.tbl_JA_ZuCheOrder INNER JOIN
                      dbo.tbl_JA_ZuCheInfo ON dbo.tbl_JA_ZuCheOrder.ZuCheID = dbo.tbl_JA_ZuCheInfo.ZuCheID
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



ALTER FUNCTION [dbo].[fn_CreateQianZhengDingDanHao]
(
	
)
RETURNS NVARCHAR(50)
AS
BEGIN
	DECLARE @LiuShuiHao INT
	DECLARE @DingDanHao NVARCHAR(50)
	SELECT @LiuShuiHao=COUNT(*)+1 FROM [tbl_QianZhengDingDan]
	SET @DingDanHao= 'QZ'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHao,'0',4)
	RETURN @DingDanHao
END



GO
-- =============================================
-- Author:		刘树超
-- Create date: 2014-08-19
-- Description:	更新线路发班信息
-- =============================================
CREATE PROCEDURE proc_UpdateTours
 @TourId CHAR(36)
,@XianLuId CHAR(36)
,@LDate DATETIME  
,@RDate DATETIME 
,@STATUS TINYINT 
,@JSJCR MONEY
,@JSJET MONEY
,@SYRS INT
,@TrafficId NVARCHAR(50)
,@RetCode INT OUTPUT
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	IF EXISTS(SELECT 1 FROM tbl_XianLuTour WHERE XianLuId=@xianluid AND LDate=@LDate AND TrafficId=@TrafficId)
		BEGIN
			UPDATE tbl_XianLuTour   SET TourId =@TourId,RDate =@RDate,Status =@Status,JSJCR =@JSJCR,JSJET = JSJET,SYRS = SYRS WHERE XianLuId=@XianLuId AND LDate=@LDate AND TrafficId=@TrafficId
			SET @error=@error+@@ERROR
		END
	ELSE
		BEGIN
			INSERT INTO tbl_XianLuTour (TourId ,XianLuId ,LDate ,RDate ,Status ,JSJCR ,JSJET ,SYRS ,TrafficId) VALUES (@TourId,@XianLuId,@LDate,@RDate,@Status,@JSJCR,@JSJET,@SYRS,@TrafficId)
			SET @error=@error+@@ERROR
		END
	IF(@error<>0)
		BEGIN
			SET @RetCode=0
			RETURN @RetCode
		END
	ELSE 
		BEGIN
			SET @RetCode=1
			RETURN @RetCode
		END

END
GO
GO
-- =============================================
-- Author:		刘树超
-- Create date: 2014-08-19
-- Description:	更新线路发班信息
-- =============================================
CREATE PROCEDURE proc_UpdateToursTraffice
 @XianLuId CHAR(36)
,@TrafficId NVARCHAR(50)  
,@Traffic_01 NVARCHAR(100) 
,@Traffic_02 NVARCHAR(100)
,@RetCode INT OUTPUT
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	IF EXISTS(SELECT 1 FROM tbl_XianLuTourTraffice WHERE XianLuId=@XianLuId AND TrafficId=@TrafficId)
		BEGIN
			UPDATE tbl_XianLuTourTraffice   SET Traffic_01=@Traffic_01,Traffic_02=@Traffic_02 WHERE XianLuId=@XianLuId AND TrafficId=@TrafficId
			SET @error=@error+@@ERROR
		END
	ELSE
		BEGIN
			INSERT INTO tbl_XianLuTourTraffice (XianLuId ,TrafficId ,Traffic_01 ,Traffic_02) VALUES (@XianLuId ,@TrafficId ,@Traffic_01 ,@Traffic_02)
			SET @error=@error+@@ERROR
		END
	IF(@error<>0)
		BEGIN
			SET @RetCode=0
			RETURN @RetCode
		END
	ELSE 
		BEGIN
			SET @RetCode=1
			RETURN @RetCode
		END

END
GO

GO

-- =============================================
-- Author:		刘树超
-- Create date: 2014-08-19
-- Description:	更新线路发班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_UpdateTours]
 @TourId CHAR(36)
,@XianLuId CHAR(36)
,@LDate DATETIME  
,@RDate DATETIME 
,@STATUS TINYINT 
,@JSJCR MONEY
,@JSJET MONEY
,@SYRS INT
,@TrafficId NVARCHAR(50)
,@RetCode INT OUTPUT
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	IF EXISTS(SELECT 1 FROM tbl_XianLuTour WHERE XianLuId=@xianluid AND LDate=@LDate AND TrafficId=@TrafficId)
		BEGIN
			UPDATE tbl_XianLuTour   SET  RDate =@RDate,Status =@Status,JSJCR =@JSJCR,JSJET = JSJET,SYRS = SYRS WHERE XianLuId=@XianLuId AND LDate=@LDate AND TrafficId=@TrafficId
			SET @error=@error+@@ERROR
		END
	ELSE
		BEGIN
			INSERT INTO tbl_XianLuTour (TourId ,XianLuId ,LDate ,RDate ,Status ,JSJCR ,JSJET ,SYRS ,TrafficId) VALUES (@TourId,@XianLuId,@LDate,@RDate,@Status,@JSJCR,@JSJET,@SYRS,@TrafficId)
			SET @error=@error+@@ERROR
		END
	IF(@error<>0)
		BEGIN
			SET @RetCode=0
			RETURN @RetCode
		END
	ELSE 
		BEGIN
			SET @RetCode=1
			RETURN @RetCode
		END

END
GO





-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-15
-- Description:	写入订单信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号

	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@YiShouRenShu=SYRS FROM [tbl_XianLuTour] WHERE TourId=@TourId 
	
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=[JiHuaRenShu] FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId

	IF(@YiShouRenShu<@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice)
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc
	
	IF(@errorcount=0)
		BEGIN
			UPDATE dbo.tbl_XianLuTour SET SYRS=SYRS-@ChengRenShu-@ErTongShu WHERE TourId=@TourId
			SET @errorcount=@errorcount+@@ERROR
		END
	
	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO
 
ALTER TABLE dbo.tbl_XianLuTour ADD
	CRSCJ money NOT NULL   DEFAULT 0,
	ETSCJ money NOT NULL   DEFAULT 0
GO


-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	写入线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- 1.2014-08-05 刘树超 tbl_XianLuTourTraffice 添加航班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLu_Insert]
	 @XianLuId CHAR(36)--线路编号
	,@AreaName NVARCHAR(50)
	,@InterfaceID INT 
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" SYRS="" TrafficId="" JSJCR="" JSJET="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>
	,@Line_Source  TINYINT
	,@LineType TINYINT 
	,@TourTraffice NVARCHAR(MAX)
	,@CFCS NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	INSERT INTO [tbl_XianLu]([XianLuId],[AreaId],[RouteName]
		,[TianShu],[DepProvinceId],[DepCityId]
		,[ArrProvinceId],[ArrCityId],[JiHuaRenShu]
		,[SCJCR],[SCJET],[JSJCR]
		,[JSJET],[TingTianShu],[ChuFaJiaoTong]
		,[FanChengJiaoTong],[JiHeFangShi],[TeSe]
		,[TeSeFilePath],[TuJing],[QianZheng]
		,[QianZhengFilePath],[GuanZhuShu],[LxrName]
		,[LxrTelephone],[LxrQQ],[LxrMobile]
		,[Description],[Keywords],[OperatorId]
		,[IssueTime],[LatestId],[LatestTime],[AreaName],[InterfaceID],[Line_Source],[LineType],[CFCS])
	VALUES (@XianLuId,@AreaId,@RouteName
		,@TianShu,@DepProvinceId,@DepCityId
		,@ArrProvinceId,@ArrCityId,@JiHuaRenShu
		,@SCJCR,@SCJET,@JSJCR
		,@JSJET,@TingTianShu,@ChuFaJiaoTong
		,@FanChengJiaoTong,@JiHeFangShi,@TeSe
		,@TeSeFilePath,@TuJing,@QianZheng
		,@QianZhengFilePath,@GuanZhuShu,@LxrName
		,@LxrTelephone,@LxrQQ,@LxrMobile
		,@Description,@Keywords,@OperatorId
		,@IssueTime,@LatestId,@LatestTime,@AreaName,@InterfaceID,@Line_Source,@LineType,@CFCS)
	SET @errorcount=@errorcount+@@ERROR

		IF(@errorcount=0 AND @TourTraffice IS NOT NULL AND LEN(@TourTraffice)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourTraffice
		INSERT INTO tbl_XianLuTourTraffice(XianLuId,TrafficId,Traffic_01
			,Traffic_02)
		SELECT @XianLuId,T.TrafficId,T.Traffic_01,T.Traffic_02
		FROM OPENXML(@hdoc,'/root/info')
		WITH(TrafficId NVARCHAR(60),Traffic_01 NVARCHAR(100),Traffic_02 NVARCHAR(100)) AS T
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
		INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
			,[ZhuSu],[YongCan],[XingCheng]
			,[FilePath])
		SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
			,A.[ZhuSu],A.[YongCan],A.[XingCheng]
			,A.[FilePath]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
		INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi],[ZengSongXiangMu],[QiTaShiXiang])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi],A.[ZengSongXiangMu],A.[QiTaShiXiang]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX),[ZengSongXiangMu] VARCHAR(MAX),[QiTaShiXiang] NVARCHAR(MAX)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
		INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
		SELECT @XianLuId,A.[ZhuTiId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([ZhuTiId] INT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
		INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
		SELECT @XianLuId,A.[Status]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([Status] TINYINT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TourXml IS NOT NULL AND LEN(@TourXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml
		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR]
			,[JSJET],[SYRS],[TrafficId],[CRSCJ],[ETSCJ])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],A.[JSJCR]
			,A.[JSJET],A.[SYRS],A.[TrafficId],A.[CRSCJ],A.[ETSCJ]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[JSJCR] MONEY,[JSJET] MONEY,[SYRS]INT,[TrafficId] NVARCHAR(50),[CRSCJ] MONEY,[ETSCJ] MONEY ) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
		INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
		SELECT @XianLuId,A.FilePath,A.MiaoShu
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-16
-- Description:线路发班信息视图,含订单数、收客数等信息
-- =============================================
ALTER VIEW [dbo].[view_XianLuTour]
AS
SELECT A.*
	,(SELECT COUNT(*) FROM [tbl_XianLuTourOrder] AS A1 WHERE A1.TourId=A.TourId) AS DingDanShu 
	,(SELECT ISNULL(SUM(ChengRenShu+ErTongShu),0) FROM [tbl_XianLuTourOrder] AS A1 WHERE A1.TourId=A.TourId AND A1.Status=4) AS ShiShouRenShu
	,(SELECT ISNULL(SUM(ChengRenShu+ErTongShu),0) FROM [tbl_XianLuTourOrder] AS A1 WHERE A1.TourId=A.TourId AND A1.Status IN(0,3,4)) AS YiShouRenShu
FROM [tbl_XianLuTour] AS A
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* =============================================
 Author:		汪奇志
 Create date: 2013-03-23
 Description:线路订单信息业务实体
 =============================================*/
ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId,
                          (SELECT     UserType
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS UserType,
                          (SELECT     MemberName
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS MemberName,
                          (SELECT     Mobile
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS Mobile,
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p
                            WHERE      (ID = B.AreaId)) AS RouteType, A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JinE, A.FuKuanStatus, 
                      A.LDate, A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, 
                      A.IssueTime, A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source, B.SCJCR, B.SCJET, B.JSJCR, B.JSJET, 
                      A.Traffice
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* 新增订单所属单位*/
ALTER VIEW [dbo].[view_HotelOrder]
AS
SELECT     OrderId, HotelId,
                          (SELECT     HotelName
                            FROM          dbo.tbl_Hotel
                            WHERE      (HotelId = dbo.tbl_HotelOrder.HotelId)) AS HotelName,
(SELECT     Star
                            FROM          dbo.tbl_Hotel
                            WHERE      (HotelId = dbo.tbl_HotelOrder.HotelId)) AS Star, RoomTypeId,
                          (SELECT     RoomName
                            FROM          dbo.tbl_HotelRoomType
                            WHERE      (RoomTypeId = dbo.tbl_HotelOrder.RoomTypeId)) AS RoomName, OrderCode, RoomCount, CheckInDate, CheckOutDate, TotalAmount, 
                      ContactName, ContactMobile, Remark, PaymentType, PaymentState, OrderState, Source, OperatorId,
                          (SELECT     MemberName
                            FROM          dbo.tbl_Member
                            WHERE      (MemberID = dbo.tbl_HotelOrder.OperatorId)) AS OperatorName,
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as UserType,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as OperatorMobile,
 IssueTime, JiaGeId, DanJia, BuyCompanyName, SellerID, 
                      AgencyJinE
FROM         dbo.tbl_HotelOrder
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO







go

--修改酒店查询
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[view_Hotel]
AS
SELECT     A.HotelId, A.HotelCode, A.HotelName, A.HotelNameEn, A.Latitude, A.Longitude, A.ServiceTel, A.ProvinceId, A.CityId, A.CountyId, A.Address, 
                      A.EnAddress, A.Star, A.PostalCode, A.OpenDate, A.Fitment, A.RoomQuantity, A.Floor, A.LongDesc, A.Transport, A.AdditionalCost, A.Status, A.IssueTime, 
                      A.IsDelete, A.IsHot, A.IsRecommend, A.CityCode, A.InterfaceId,
                          (SELECT     B.RoomTypeId, B.HotelId, B.RoomName, B.TotalNumber, B.RoomType, B.RoomArea, B.Floor, B.BedType, B.BedHeight, B.BedWidth, 
                                                   B.MaxGuestNum, B.IsSmoking, B.IsInternet, B.IsInternetPrice, B.Orientation, B.IsBreakfast, B.IsBreakfastPrice, B.IsWindow, B.IsAddBed, 
                                                   B.IsAddBedPrice, B.Payment, B.[Desc], B.IssueTime, B.OperatorId, B.SortId, B.RoomStatus, B.BedTypeDescription, C.AmountPrice, 
                                                   C.PreferentialPrice, C.SettlementPrice
                            FROM          tbl_HotelRoomType AS B LEFT JOIN
                                                   tbl_HotelRoomRate AS C ON B.RoomTypeId = C.RoomTypeId AND datediff(day, C.StartDate, getdate()) >= 0 AND datediff(day, C.EndDate, 
                                                   getdate()) <= 0
                            WHERE      B.HotelId = A.HotelId AND B.IsDelete = '0' FOR xml raw, root('Root')) AS HotelRoomType,
                          (SELECT     D .ImgId, D .HotelId, D .ImgCategory, D .FilePath, D .[Desc], D .IssueTime, D .OperatorId
                            FROM          tbl_HotelImg AS D
                            WHERE      D .HotelId = A.HotelId FOR xml raw, root('Root')) AS HotelImg/*		as HotelLandMark	*/ ,
                          (SELECT     A1.HotelId, A1.LandMarkId,
                                                       (SELECT     Name
                                                         FROM          tbl_SysDiBiao
                                                         WHERE      Id = A1.LandMarkId) AS Por
                            FROM          tbl_HotelLandMark AS A1
                            WHERE      A1.HotelId = A.HotelId FOR XML RAW, ROOT('Root')) AS HotelLandMark, A.Mobile, A.JieSuanType
FROM         tbl_Hotel AS A
WHERE     A.hotelid IN
                          (SELECT     hotelid
                            FROM          tbl_HotelImg
                            WHERE      filepath <> '')
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




 alter table tbl_JA_Sellers add ErWeiMaUrl varchar(250)
 go 



create table tbl_LianMengLeiBie (
   LieBieID             int                  IDENTITY PRIMARY  KEY ,
   MingCheng            nvarchar(50)         not null
)
GO
create table tbl_LianMeng (
   ID                   INT                  IDENTITY  primary key ,
   LieBieID             int                  NOT NULL ,
   SiteName             nvarchar(50)         NOT NULL ,
   SiteUrl              nvarchar(200)        not null,
   ImgFile              nvarchar(200)        null,
   IssueTime            datetime             not null,
   OperatorID           char(36)             not null,
   KeyWord              nvarchar(50)         NULL,
    foreign KEY (LieBieID)  references tbl_LianMengLeiBie (LieBieID) 
)

GO

CREATE VIEW [dbo].[View_LianMeng]
AS
SELECT     dbo.tbl_LianMengLeiBie.LieBieID, dbo.tbl_LianMengLeiBie.MingCheng, dbo.tbl_LianMeng.ID, dbo.tbl_LianMeng.SiteName, dbo.tbl_LianMeng.SiteUrl, 
                      dbo.tbl_LianMeng.ImgFile, dbo.tbl_LianMeng.IssueTime, dbo.tbl_LianMeng.OperatorID, dbo.tbl_LianMeng.KeyWord
FROM         dbo.tbl_LianMeng INNER JOIN
                      dbo.tbl_LianMengLeiBie ON dbo.tbl_LianMeng.LieBieID = dbo.tbl_LianMengLeiBie.LieBieID

GO


-- =============================================
-- Author:		刘树超
-- Create date: 2014-08-19
-- Description:	更新线路发班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_UpdateTours]
 @TourId CHAR(36)
,@XianLuId CHAR(36)
,@LDate DATETIME  
,@RDate DATETIME 
,@STATUS TINYINT 
,@JSJCR MONEY
,@JSJET MONEY
,@SYRS INT
,@TrafficId NVARCHAR(50)
,@RetCode INT OUTPUT
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	IF EXISTS(SELECT 1 FROM tbl_XianLuTour WHERE XianLuId=@xianluid AND LDate=@LDate AND TrafficId=@TrafficId)
		BEGIN
			UPDATE tbl_XianLuTour   SET  RDate =@RDate,Status =@Status,JSJCR =@JSJCR,JSJET = @JSJET,SYRS = @SYRS WHERE XianLuId=@XianLuId AND LDate=@LDate AND TrafficId=@TrafficId
			SET @error=@error+@@ERROR
		END
	ELSE
		BEGIN
			INSERT INTO tbl_XianLuTour (TourId ,XianLuId ,LDate ,RDate ,Status ,JSJCR ,JSJET ,SYRS ,TrafficId) VALUES (@TourId,@XianLuId,@LDate,@RDate,@Status,@JSJCR,@JSJET,@SYRS,@TrafficId)
			SET @error=@error+@@ERROR
		END
	IF(@error<>0)
		BEGIN
			SET @RetCode=0
			RETURN @RetCode
		END
	ELSE 
		BEGIN
			SET @RetCode=1
			RETURN @RetCode
		END

END
GO


-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	修改线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- =============================================
CREATE PROCEDURE [dbo].[proc_XianLu_OutUpdate]
	 @XianLuId CHAR(36)--线路编号
	,@InterfaceID int
	,@AreaName NVARCHAR(255)
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>
	,@TourTraffice NVARCHAR(MAX)--航班
	,@CFCS NVARCHAR(50)--出发城市
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	UPDATE [tbl_XianLu] SET [AreaId]=@AreaId,[RouteName]=@RouteName,[TianShu]=@TianShu
		,[DepProvinceId]=@DepProvinceId,[DepCityId]=@DepCityId,[ArrProvinceId]=@ArrProvinceId
		,[ArrCityId]=@ArrCityId,[JiHuaRenShu]=@JiHuaRenShu,[SCJCR]=@SCJCR
		,[SCJET]=@SCJET,[JSJCR]=@JSJCR,[JSJET]=@JSJET
		,[TingTianShu]=@TingTianShu,[ChuFaJiaoTong]=@ChuFaJiaoTong,[FanChengJiaoTong]=@FanChengJiaoTong
		,[JiHeFangShi]=@JiHeFangShi,[TeSe]=@TeSe,[TeSeFilePath]=@TeSeFilePath
		,[TuJing]=@TuJing,[QianZheng]=@QianZheng,[QianZhengFilePath]=@QianZhengFilePath
		,[GuanZhuShu]=[GuanZhuShu],[LxrName]=@LxrName,[LxrTelephone]=@LxrTelephone
		,[LxrQQ]=@LxrQQ,[LxrMobile]=@LxrMobile,[Description]=@Description
		,[Keywords]=@Keywords,[LatestId]=@LatestId,[LatestTime]=@LatestTime
		,[InterfaceID]=@InterfaceID,[AreaName]=@AreaName,[CFCS]=@CFCS
	WHERE [XianLuId]=@XianLuId

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuXingCheng] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
			INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
				,[ZhuSu],[YongCan],[XingCheng]
				,[FilePath])
			SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
				,A.[ZhuSu],A.[YongCan],A.[XingCheng]
				,A.[FilePath]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END		
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuFuWu] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
			INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi],[ZengSongXiangMu],[QiTaShiXiang])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi],A.[ZengSongXiangMu],A.[QiTaShiXiang]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX),[ZengSongXiangMu] VARCHAR(MAX),[QiTaShiXiang] NVARCHAR(MAX)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuTi] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
			INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
			SELECT @XianLuId,A.[ZhuTiId]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([ZhuTiId] INT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuangTai] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
			INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
			SELECT @XianLuId,A.[Status]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([Status] TINYINT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@TourXml IS NOT NULL AND LEN(@TourXml)>0)
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml

		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR],[JSJET],[SYRS],[TrafficId],[CRSCJ],[ETSCJ])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],A.[JSJCR],A.[JSJET],A.[SYRS],A.[TrafficId],A.[CRSCJ],A.[ETSCJ]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[JSJCR] MONEY,[JSJET] MONEY,[SYRS] INT,[TrafficId] NVARCHAR(50),[CRSCJ] MONEY,[ETSCJ] MONEY) AS A
		
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuTeSeFile] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
			INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
			SELECT @XianLuId,A.FilePath,A.MiaoShu
			FROM OPENXML(@hdoc,'/root/info')
			WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END
	IF(@errorcount=0)
	BEGIN
		DELETE FROM tbl_XianLuTourTraffice WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @TourTraffice IS NOT NULL AND LEN(@TourTraffice)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourTraffice
			 
			INSERT INTO tbl_XianLuTourTraffice(XianLuId,TrafficId,Traffic_01
				,Traffic_02)
			SELECT @XianLuId,T.TrafficId,T.Traffic_01,T.Traffic_02
			FROM OPENXML(@hdoc,'/root/info')
			WITH(TrafficId NVARCHAR(60),Traffic_01 NVARCHAR(100),Traffic_02 NVARCHAR(100)) AS T
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END



GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-16
-- Description: 线路发班周期最近发班
-- =============================================
ALTER VIEW [dbo].[view_XianLuTour_ZuiJinFaBan]
AS
SELECT A.* FROM [tbl_XianLuTour] AS A INNER JOIN (SELECT XianLuId,MIN([LDate]) AS ZuiJinQuTuanRiQi,ROW_NUMBER()  over (PARTITION  by tbl_XianLuTour.xianluid order by ldate asc) as no FROM tbl_XianLuTour   WHERE LDate>DATEADD(dd,1,GETDATE()) GROUP BY XianLuId,ldate)B
ON A.XianLuId=B.XianLuId AND A.Ldate=b.ZuiJinQuTuanRiQi and  no=1
GO
-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-09
-- Description:	写入商城订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangChengDingDan_Insert]
		@OrderID  CHAR(36)
	   ,@ProductID CHAR(36)
	   ,@ProductNum INT
	   ,@OrderCode NVARCHAR(50) OUTPUT
	   ,@OrderPrice  MONEY
	   ,@OrderState TINYINT
	   ,@PayState TINYINT
	   ,@ContactID CHAR(36)
	   ,@ContactName NVARCHAR(50)
	   ,@ContactPhone NVARCHAR(50)
	   ,@IssueTime DATETIME
	   ,@Remark NVARCHAR(MAX)
	   ,@AddressID INT
	   ,@ProvinceID INT
	   ,@CityID INT
	   ,@DistrictID INT
	   ,@AddressInfo NVARCHAR(255)
	   ,@UserID CHAR(36)
	   ,@UserName NVARCHAR(50)
	   ,@IsDefault CHAR(1)
	   ,@SupplierID CHAR(36)
	   ,@SupplierMoney MONEY
	   ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
    DECLARE @Address INT
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0
	SET @Address=@AddressID
 	DECLARE @ShengYu INT
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ShangChengDingDan
	SET @OrderCode='SC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	SELECT @ShengYu=stocknum FROM dbo.view_ShangCheng

 IF(@shengyu<@ProductNum)
 BEGIN
	SET @RetCode=-99
	RETURN @RetCode
 END
 BEGIN TRAN
 IF(@AddressID=0)
 BEGIN
	 --写入地址信息
	 IF(@IsDefault=0)
		 BEGIN
			INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
	  ELSE
		  BEGIN
		  UPDATE tbl_DiZhi SET IsDefault=0 WHERE UserID=@UserID
		  INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
		  SET @Address=@@IDENTITY
 END
 ELSE
 BEGIN
		UPDATE tbl_DiZhi SET ProvinceID=@ProvinceID,CityID=@CityID,DistrictID=@DistrictID,AddressInfo=@AddressInfo WHERE AddressID=@AddressID
 END
  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_ShangChengDingDan (OrderID ,ProductID ,ProductNum ,OrderCode ,OrderPrice ,OrderState ,PayState ,ContactID ,ContactName ,ContactPhone ,IssueTime ,Remark,ProvinceID,CityID,DistrictID,AddressInfo,SupplierID,SupplierMoney)
		 VALUES (@OrderID ,@ProductID ,@ProductNum ,@OrderCode ,@OrderPrice ,@OrderState ,@PayState ,@ContactID ,@ContactName ,@ContactPhone ,@IssueTime ,@Remark,@ProvinceID,@CityID,@DistrictID,@AddressInfo,@SupplierID,@SupplierMoney)
		 
 
	   
	   
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO




alter table tbl_JA_Account alter column Amounts decimal(18, 2) not null
alter table tbl_JA_Account alter column balance decimal(18, 2) not null

go
alter table tbl_HotelOrderContact
add CardNum varchar(20) null
GO
ALTER TABLE dbo.tbl_ShangChengChanPin ADD
	Unit nvarchar(20) NULL
GO
ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,(a.ProductNum- (SELECT COUNT(OrderID) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)   ) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       ,a.Unit
  FROM tbl_ShangChengChanPin as a
GO	

-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-08
-- Description:	写入商城产品
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangCheng_Insert]
	   @ProductID CHAR(36)
      ,@TypeID  int
      ,@GYSid  char(36)
      ,@ProductName nvarchar(50)
      ,@ProductNum INT
      ,@MarketPrice MONEY
      ,@SalePrice MONEY
      ,@ContentService NVARCHAR(max)
      ,@UnContentService  NVARCHAR(max)
      ,@UseRule  NVARCHAR(max)
      ,@NoticeKnow  NVARCHAR(max)
      ,@ProductionDate DATETIME
      ,@EffectDate DATETIME
      ,@ShelfDate  INT
      ,@IssueTime DATETIME
      ,@Remark  NVARCHAR(max)
      ,@ModelDesc  NVARCHAR(max)
      ,@ColorDesc  NVARCHAR(max)
      ,@StylesDesc  NVARCHAR(max)
      ,@MailWay  NVARCHAR(100)
	  ,@ProductImgs NVARCHAR(max)
	  ,@Unit NVARCHAR(20)
	  ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
 

	SET @errorcount=0
 
 BEGIN TRAN
 INSERT INTO tbl_ShangChengChanPin(ProductID,TypeID,GYSid,ProductName,ProductNum,MarketPrice,SalePrice,ContentService,UnContentService,UseRule,NoticeKnow,ProductionDate,EffectDate,ShelfDate,IssueTime,Remark,ModelDesc,ColorDesc,StylesDesc,MailWay,Unit)
     VALUES
(@ProductID,@TypeID,@GYSid,@ProductName,@ProductNum,@MarketPrice,@SalePrice
,@ContentService,@UnContentService,@UseRule,@NoticeKnow,@ProductionDate,@EffectDate,@ShelfDate,@IssueTime,@Remark,@ModelDesc,@ColorDesc,@StylesDesc,@MailWay,@Unit)

    delete from tbl_ShangChengTuPian where ProductID=@ProductID
	set @errorcount=@errorcount+@@error
     IF(@errorcount=0 AND @ProductImgs IS NOT NULL AND LEN(@ProductImgs)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ProductImgs
		INSERT INTO tbl_ShangChengTuPian(ProductID,FilePath,FileDesc)
		SELECT @ProductID,FilePath,FileDesc 
		FROM OPENXML(@hdoc,'/root/info')
		WITH(FilePath NVARCHAR(255),FileDesc NVARCHAR(255)) 
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END
 
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-08
-- Description:	修改商城产品
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangCheng_Update]
	   @ProductID CHAR(36)
      ,@TypeID  int
      ,@ProductName nvarchar(50)
      ,@ProductNum INT
      ,@MarketPrice MONEY
      ,@SalePrice MONEY
      ,@ContentService NVARCHAR(max)
      ,@UnContentService  NVARCHAR(max)
      ,@UseRule  NVARCHAR(max)
      ,@NoticeKnow  NVARCHAR(max)
      ,@ProductionDate DATETIME
      ,@EffectDate DATETIME
      ,@ShelfDate  INT
      ,@Remark  NVARCHAR(max)
      ,@ModelDesc  NVARCHAR(max)
      ,@ColorDesc  NVARCHAR(max)
      ,@StylesDesc  NVARCHAR(max)
      ,@MailWay  NVARCHAR(100)
	  ,@ProductImgs NVARCHAR(max)
	  ,@Unit NVARCHAR(20)
	  ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
 

	SET @errorcount=0
 
 BEGIN TRAN
UPDATE  tbl_ShangChengChanPin 
   SET TypeID=@TypeID,ProductName=@ProductName,ProductNum=@ProductNum, MarketPrice=@MarketPrice, SalePrice  =    @SalePrice,ContentService=@ContentService,UnContentService=@UnContentService,UseRule=@UseRule,NoticeKnow=@NoticeKnow,ProductionDate=@ProductionDate,EffectDate=@EffectDate,ShelfDate=@ShelfDate,Remark=@Remark,ModelDesc=@ModelDesc, ColorDesc  =  @ColorDesc, StylesDesc  =  @StylesDesc, MailWay  =   @MailWay,Unit=@Unit WHERE  ProductID  = @ProductID

    delete from tbl_ShangChengTuPian where ProductID=@ProductID
	set @errorcount=@errorcount+@@error
     IF(@errorcount=0 AND @ProductImgs IS NOT NULL AND LEN(@ProductImgs)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ProductImgs
		INSERT INTO tbl_ShangChengTuPian(ProductID,FilePath,FileDesc)
		SELECT @ProductID,FilePath,FileDesc 
		FROM OPENXML(@hdoc,'/root/info')
		WITH(FilePath NVARCHAR(255),FileDesc NVARCHAR(255)) 
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END
 
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO


-- =============================================
-- Author:		刘树超
-- Create date: 2014-08-19
-- Description:	更新线路发班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_UpdateTours]
 @TourId CHAR(36)
,@XianLuId CHAR(36)
,@LDate DATETIME  
,@RDate DATETIME 
,@STATUS TINYINT 
,@JSJCR MONEY
,@JSJET MONEY
,@CRSCJ MONEY
,@ETSCJ MONEY
,@SYRS INT
,@TrafficId NVARCHAR(50)
,@RetCode INT OUTPUT
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	IF EXISTS(SELECT 1 FROM tbl_XianLuTour WHERE XianLuId=@xianluid AND LDate=@LDate AND TrafficId=@TrafficId)
		BEGIN
			UPDATE tbl_XianLuTour   SET  RDate =@RDate,Status =@Status,JSJCR =@JSJCR,JSJET = @JSJET,SYRS = @SYRS,CRSCJ=@CRSCJ,ETSCJ=@ETSCJ WHERE XianLuId=@XianLuId AND LDate=@LDate AND TrafficId=@TrafficId
			SET @error=@error+@@ERROR
		END
	ELSE
		BEGIN
			INSERT INTO tbl_XianLuTour (TourId ,XianLuId ,LDate ,RDate ,Status ,JSJCR ,JSJET ,SYRS ,TrafficId,CRSCJ,ETSCJ) VALUES (@TourId,@XianLuId,@LDate,@RDate,@Status,@JSJCR,@JSJET,@SYRS,@TrafficId,@CRSCJ,@ETSCJ)
			SET @error=@error+@@ERROR
		END
	IF(@error<>0)
		BEGIN
			SET @RetCode=0
			RETURN @RetCode
		END
	ELSE 
		BEGIN
			SET @RetCode=1
			RETURN @RetCode
		END

END
GO

	-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-16
-- Description: 线路发班周期最近发班
-- =============================================
ALTER VIEW [dbo].[view_XianLuTour_ZuiJinFaBan]
AS
SELECT A.* FROM [tbl_XianLuTour] AS A INNER JOIN (SELECT XianLuId, MIN([LDate]) AS ZuiJinQuTuanRiQi,TourId ,ROW_NUMBER()  over (PARTITION  by tbl_XianLuTour.xianluid order by ldate ASC,TourId ASC) as no FROM tbl_XianLuTour WHERE LDate>DATEADD(dd,1,GETDATE())   GROUP BY XianLuId,ldate,TourId)B
ON A.XianLuId=B.XianLuId AND A.Ldate=b.ZuiJinQuTuanRiQi and  no=1 AND A.TourId=B.TourId
GO



alter table tbl_Member alter column TotalMoney money





 alter table tbl_TuanGouDingDan add Peopleaddress nvarchar(255)
 go 
 
 
 
 set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-28
-- Description:	写入团购订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_TuanGouDingDan_Insert]
	 @ProductID INT
	,@OrderCode NVARCHAR(50) OUTPUT
	,@ProductNum INT
	,@OrderPrice MONEY
	,@PeopleID CHAR(36)
	,@PeopleName NVARCHAR(50)
	,@PeopleMobile NVARCHAR(50)
	,@IssueTime DATETIME
	,@OrderState TINYINT
	,@PayState TINYINT
    ,@Peopleaddress nvarchar(255)
	,@SupplierID CHAR(36)
	,@RetCode INT OUTPUT--OUTPUT CODE
	,@OrderID INT OUTPUT
AS
BEGIN
	DECLARE @errorcount INT
	SET @errorcount=0
 
 BEGIN TRAN
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_TuanGouDingDan
	SET @OrderCode='TG'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)

  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_TuanGouDingDan (ProductID ,OrderCode ,ProductNum ,OrderPrice ,PeopleID ,PeopleName ,PeopleMobile ,IssueTime ,OrderState ,PayState ,SupplierID ,Peopleaddress)     VALUES (@ProductID ,@OrderCode ,@ProductNum ,@OrderPrice ,@PeopleID ,@PeopleName ,@PeopleMobile ,@IssueTime ,@OrderState ,@PayState ,@SupplierID ,@Peopleaddress)
	SET @OrderID=@@IDENTITY
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_TuanGouOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_TuanGouChanPin AS p WHERE p.ID=s.ProductID ) as ProductName
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,PeopleID
      ,PeopleName
      ,PeopleMobile
      ,IssueTime
      ,SupplierID
      ,Peopleaddress
  FROM tbl_TuanGouDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-09
-- Description:	写入商城订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangChengDingDan_Insert]
		@OrderID  CHAR(36)
	   ,@ProductID CHAR(36)
	   ,@ProductNum INT
	   ,@OrderCode NVARCHAR(50) OUTPUT
	   ,@OrderPrice  MONEY
	   ,@OrderState TINYINT
	   ,@PayState TINYINT
	   ,@ContactID CHAR(36)
	   ,@ContactName NVARCHAR(50)
	   ,@ContactPhone NVARCHAR(50)
	   ,@IssueTime DATETIME
	   ,@Remark NVARCHAR(MAX)
	   ,@AddressID INT
	   ,@ProvinceID INT
	   ,@CityID INT
	   ,@DistrictID INT
	   ,@AddressInfo NVARCHAR(255)
	   ,@UserID CHAR(36)
	   ,@UserName NVARCHAR(50)
	   ,@IsDefault CHAR(1)
	   ,@SupplierID CHAR(36)
	   ,@SupplierMoney MONEY
	   ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
    DECLARE @Address INT
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0
	SET @Address=@AddressID
 	DECLARE @ShengYu INT
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ShangChengDingDan
	SET @OrderCode='SC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	SELECT @ShengYu=stocknum FROM dbo.view_ShangCheng WHERE ProductID=@ProductID

 IF(@shengyu<@ProductNum)
 BEGIN
	SET @RetCode=-99
	RETURN @RetCode
 END
 BEGIN TRAN
 IF(@AddressID=0)
 BEGIN
	 --写入地址信息
	 IF(@IsDefault=0)
		 BEGIN
			INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
	  ELSE
		  BEGIN
		  UPDATE tbl_DiZhi SET IsDefault=0 WHERE UserID=@UserID
		  INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
		  SET @Address=@@IDENTITY
 END
 ELSE
 BEGIN
		UPDATE tbl_DiZhi SET ProvinceID=@ProvinceID,CityID=@CityID,DistrictID=@DistrictID,AddressInfo=@AddressInfo WHERE AddressID=@AddressID
 END
  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_ShangChengDingDan (OrderID ,ProductID ,ProductNum ,OrderCode ,OrderPrice ,OrderState ,PayState ,ContactID ,ContactName ,ContactPhone ,IssueTime ,Remark,ProvinceID,CityID,DistrictID,AddressInfo,SupplierID,SupplierMoney)
		 VALUES (@OrderID ,@ProductID ,@ProductNum ,@OrderCode ,@OrderPrice ,@OrderState ,@PayState ,@ContactID ,@ContactName ,@ContactPhone ,@IssueTime ,@Remark,@ProvinceID,@CityID,@DistrictID,@AddressInfo,@SupplierID,@SupplierMoney)
		 
 
	   
	   
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

ALTER TABLE dbo.tbl_LianMengLeiBie ADD
	ModelType tinyint NOT NULL CONSTRAINT DF_tbl_LianMengLeiBie_ModelType DEFAULT 1
GO

ALTER VIEW [dbo].[View_LianMeng]
AS
SELECT     dbo.tbl_LianMengLeiBie.LieBieID, dbo.tbl_LianMengLeiBie.MingCheng, dbo.tbl_LianMeng.ID, dbo.tbl_LianMeng.SiteName, dbo.tbl_LianMeng.SiteUrl, 
                      dbo.tbl_LianMeng.ImgFile, dbo.tbl_LianMeng.IssueTime, dbo.tbl_LianMeng.OperatorID, dbo.tbl_LianMeng.KeyWord, 
                      dbo.tbl_LianMengLeiBie.ModelType
FROM         dbo.tbl_LianMeng INNER JOIN
                      dbo.tbl_LianMengLeiBie ON dbo.tbl_LianMeng.LieBieID = dbo.tbl_LianMengLeiBie.LieBieID
GO


-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-08
-- Description:	删除商城产品
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangChengLeiXing_Delete]
	   @TypeID INT
	  ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	SET @errorcount=0
 

 	IF  EXISTS(SELECT 1 FROM tbl_ShangChengChanPin WHERE TypeID=@TypeID)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	 
 	IF  EXISTS(SELECT 1 FROM tbl_ShangChengLeiBie WHERE ParentID=@TypeID)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	BEGIN TRAN
	DELETE FROM tbl_ShangChengLeiBie WHERE TypeID=@TypeID
	SET @errorcount=@errorcount+@@ERROR
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

		COMMIT TRAN
		SET @RetCode=1
		RETURN @RetCode	
END
GO

alter table tbl_HotelOrderRoomRateId
drop column RoomRateId
go
alter table tbl_HotelOrderRoomRateId
add RoomRateIds varchar(1000) not null default ''
go

alter table tbl_hotel
alter column ServiceTel nvarchar(200) null
go
alter table tbl_HotelImg
alter column FilePath varchar(1000) null
go

alter table tbl_Hotel
alter column Address nvarchar(500) null
go

alter table tbl_hotel
alter column Mobile nvarchar(200) null

go

alter table tbl_hotel 
alter column PostalCode nvarchar(15) null
go

/****** 对象:  View [dbo].[view_Hotel]    脚本日期: 09/15/2014 16:04:19 ******/
GO
CREATE VIEW [dbo].[view_Hotel2]
AS
SELECT     A.HotelId, A.HotelCode, A.HotelName, A.HotelNameEn, A.Latitude, A.Longitude, A.ServiceTel, A.ProvinceId, A.CityId, A.CountyId, A.Address, 
                      A.EnAddress, A.Star, A.PostalCode, A.OpenDate, A.Fitment, A.RoomQuantity, A.Floor, A.LongDesc, A.Transport, A.AdditionalCost, A.Status, A.IssueTime, 
                      A.IsDelete, A.IsHot, A.IsRecommend, A.CityCode, A.InterfaceId,
                          (SELECT     B.RoomTypeId, B.HotelId, B.RoomName, B.TotalNumber, B.RoomType, B.RoomArea, B.Floor, B.BedType, B.BedHeight, B.BedWidth, 
                                                   B.MaxGuestNum, B.IsSmoking, B.IsInternet, B.IsInternetPrice, B.Orientation, B.IsBreakfast, B.IsBreakfastPrice, B.IsWindow, B.IsAddBed, 
                                                   B.IsAddBedPrice, B.Payment, B.[Desc], B.IssueTime, B.OperatorId, B.SortId, B.RoomStatus, B.BedTypeDescription, C.AmountPrice, 
                                                   C.PreferentialPrice, C.SettlementPrice
                            FROM          tbl_HotelRoomType AS B LEFT JOIN
                                                   tbl_HotelRoomRate AS C ON B.RoomTypeId = C.RoomTypeId AND datediff(day, C.StartDate, getdate()) >= 0 AND datediff(day, C.EndDate, 
                                                   getdate()) <= 0
                            WHERE      B.HotelId = A.HotelId AND B.IsDelete = '0' FOR xml raw, root('Root')) AS HotelRoomType,
                          (SELECT     D .ImgId, D .HotelId, D .ImgCategory, D .FilePath, D .[Desc], D .IssueTime, D .OperatorId
                            FROM          tbl_HotelImg AS D
                            WHERE      D .HotelId = A.HotelId FOR xml raw, root('Root')) AS HotelImg/*		as HotelLandMark	*/ ,
                          (SELECT     A1.HotelId, A1.LandMarkId,
                                                       (SELECT     Name
                                                         FROM          tbl_SysDiBiao
                                                         WHERE      Id = A1.LandMarkId) AS Por
                            FROM          tbl_HotelLandMark AS A1
                            WHERE      A1.HotelId = A.HotelId FOR XML RAW, ROOT('Root')) AS HotelLandMark, A.Mobile, A.JieSuanType
FROM         tbl_Hotel AS A

GO


/****** 对象:  View [dbo].[view_XianLuTour_ZuiJinFaBan]    脚本日期: 09/18/2014 13:47:44 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
	-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-16
-- Description: 线路发班周期最近发班
-- =============================================
ALTER VIEW [dbo].[view_XianLuTour_ZuiJinFaBan]
AS
SELECT A.* FROM [tbl_XianLuTour] AS A INNER JOIN (SELECT XianLuId, MIN([LDate]) AS ZuiJinQuTuanRiQi,TourId ,ROW_NUMBER()  over (PARTITION  by tbl_XianLuTour.xianluid order by ldate ASC,TourId ASC) as no FROM tbl_XianLuTour WHERE LDate>DATEADD(dd,1,GETDATE())   GROUP BY XianLuId,ldate,TourId)B
ON A.XianLuId=B.XianLuId AND A.Ldate=b.ZuiJinQuTuanRiQi and  no=1 AND A.TourId=B.TourId and a.Status=0

GO

/****** 对象:  Index [IX_HotelRoomRateForInterface_1]    脚本日期: 09/28/2014 08:55:43 ******/
CREATE NONCLUSTERED INDEX [IX_HotelRoomRateForInterface_1] ON [dbo].[Hotel_RoomRate] 
(
	[PAYMENT_METHOD] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO
/****** 对象:  Index [IX_HotelRoomRateForInterface_2]    脚本日期: 09/28/2014 08:55:43 ******/
CREATE NONCLUSTERED INDEX [IX_HotelRoomRateForInterface_2] ON [dbo].[Hotel_RoomRate] 
(
	[START_DATE] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO
/****** 对象:  Index [IX_HotelRoomRateForInterface_3]    脚本日期: 09/28/2014 08:55:43 ******/
CREATE NONCLUSTERED INDEX [IX_HotelRoomRateForInterface_3] ON [dbo].[Hotel_RoomRate] 
(
	[END_DATE] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

/****** 对象:  Index [IX_tbl_HotelRoomType_HotelId]    脚本日期: 09/28/2014 09:01:08 ******/
CREATE NONCLUSTERED INDEX [IX_tbl_HotelRoomType_HotelId] ON [dbo].[tbl_HotelRoomType] 
(
	[HotelId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO
/****** 对象:  Index [IX_tbl_HotelRoomTypeForInterface]    脚本日期: 09/28/2014 09:01:08 ******/
CREATE NONCLUSTERED INDEX [IX_tbl_HotelRoomTypeForInterface] ON [dbo].[tbl_HotelRoomType] 
(
	[InterfaceID] ASC,
	[HotelCode] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

CREATE UNIQUE CLUSTERED INDEX [IX_tbl_HotelRoomRateForInterface] ON [dbo].[tbl_HotelRoomRate] 
(
	[HotelCode] ASC,
	[RoomTypeCode] ASC,
	[InterfaceID] ASC,
	[StartDate] ASC,
	[VenderCode] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[view_Hotel]
AS
SELECT     A.HotelId, A.HotelCode, A.HotelName, A.HotelNameEn, A.Latitude, A.Longitude, A.ServiceTel, A.ProvinceId, A.CityId, A.CountyId, A.Address, 
                      A.EnAddress, A.Star, A.PostalCode, A.OpenDate, A.Fitment, A.RoomQuantity, A.Floor, A.LongDesc, A.Transport, A.AdditionalCost, A.Status, A.IssueTime, 
                      A.IsDelete, A.IsHot, A.IsRecommend, A.CityCode, A.InterfaceId,
                          (SELECT     B.RoomTypeId, B.HotelId, B.RoomName, B.TotalNumber, B.RoomType, B.RoomArea, B.Floor, B.BedType, B.BedHeight, B.BedWidth, 
                                                   B.MaxGuestNum, B.IsSmoking, B.IsInternet, B.IsInternetPrice, B.Orientation, B.IsBreakfast, B.IsBreakfastPrice, B.IsWindow, B.IsAddBed, 
                                                   B.IsAddBedPrice, B.Payment, B.[Desc], B.IssueTime, B.OperatorId, B.SortId, B.RoomStatus, B.BedTypeDescription, C.AmountPrice, 
                                                   C.PreferentialPrice, C.SettlementPrice
                            FROM          tbl_HotelRoomType AS B LEFT JOIN
                                                   tbl_HotelRoomRate AS C ON B.RoomTypeId = C.RoomTypeId AND datediff(day, C.StartDate, getdate()) >= 0 AND datediff(day, C.EndDate, 
                                                   getdate()) <= 0
                            WHERE      B.HotelId = A.HotelId AND B.IsDelete = '0' FOR xml raw, root('Root')) AS HotelRoomType,
                          (SELECT     D .ImgId, D .HotelId, D .ImgCategory, D .FilePath, D .[Desc], D .IssueTime, D .OperatorId
                            FROM          tbl_HotelImg AS D
                            WHERE      D .HotelId = A.HotelId FOR xml raw, root('Root')) AS HotelImg/*		as HotelLandMark	*/ ,
                          (SELECT     A1.HotelId, A1.LandMarkId,
                                                       (SELECT     Name
                                                         FROM          tbl_SysDiBiao
                                                         WHERE      Id = A1.LandMarkId) AS Por
                            FROM          tbl_HotelLandMark AS A1
                            WHERE      A1.HotelId = A.HotelId FOR XML RAW, ROOT('Root')) AS HotelLandMark, A.Mobile, A.JieSuanType
FROM         tbl_Hotel AS A
GO







GO
/****** 对象:  Table [dbo].[tbl_JA_ApplyTiXian]    脚本日期: 09/22/2014 16:42:33 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_JA_ApplyTiXian](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[UserId] [char](36) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[KaiHuBank] [varchar](100) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[KaiHuName] [varchar](50) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[BankNum] [varchar](25) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[JinE] [money] NOT NULL,
	[TiXianStatus] [smallint] NULL,
	[TiXianTime] [datetime] NULL,
	[ApplyStatus] [smallint] NULL,
	[ShenHeBeiZhu] [nvarchar](500) COLLATE Chinese_PRC_CI_AS NULL,
	[BeiZhu] [nvarchar](500) COLLATE Chinese_PRC_CI_AS NULL,
 CONSTRAINT [PK_tbl_JA_ApplyTiXian] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'会员id' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'UserId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'开户银行' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'KaiHuBank'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'开户名' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'KaiHuName'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'银行卡帐号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'BankNum'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提现金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'JinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提现状态' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'TiXianStatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提现时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'TiXianTime'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'申请状态' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'ApplyStatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'审核备注' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'ShenHeBeiZhu'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'备注' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_JA_ApplyTiXian', @level2type=N'COLUMN',@level2name=N'BeiZhu'


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		邹磊<Author,,Name>
-- Create date: 2014-09-22<Create Date,,>
-- Description:	提现申请<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[proc_JA_ApplyTiXian_ADD] 
	@ApplyStatus smallint,
	@BankNum varchar(25),
    @JinE money,
	@KaiHuBank varchar(100),
	@KaiHuName varchar(50),
	@TiXianStatus smallint,
	@TiXianTime  datetime,
    @UserId char(36),
    @BeiZhu nvarchar(250),
	@Result int output
    
AS
BEGIN
	declare @error int
	set @error=0
	
	begin transaction
	
	INSERT INTO [tbl_JA_ApplyTiXian](
	[UserId],[KaiHuBank],[KaiHuName],[BankNum],[JinE],[TiXianStatus],[TiXianTime],[ApplyStatus],[BeiZhu]
	)VALUES(
	@UserId,@KaiHuBank,@KaiHuName,@BankNum,@JinE,@TiXianStatus,@TiXianTime,@ApplyStatus,@BeiZhu
	)
	set @error=@error+@@error

if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result

END
GO



 alter table tbl_JA_ApplyTiXian add TransactionID char(20)
go 

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go




-- =============================================
-- Author:		邹磊<Author,,Name>
-- Create date: 2014-09-22<Create Date,,>
-- Description:	提现申请<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_JA_ApplyTiXian_ADD] 
	@ApplyStatus smallint,
	@BankNum varchar(25),
    @JinE money,
	@KaiHuBank varchar(100),
	@KaiHuName varchar(50),
	@TiXianStatus smallint,
	@TiXianTime  datetime,
    @UserId char(36),
    @BeiZhu nvarchar(250),
	@Result int output,
    @TransactionID varchar(50)
    
AS
BEGIN 
	declare @error int
	set @error=0
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_JA_ApplyTiXian]
	SET @TransactionID='TX'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	begin transaction
	
	INSERT INTO [tbl_JA_ApplyTiXian](
	[UserId],[KaiHuBank],[KaiHuName],[BankNum],[JinE],[TiXianStatus],[TiXianTime],[ApplyStatus],[BeiZhu],[TransactionID]
	)VALUES(
	@UserId,@KaiHuBank,@KaiHuName,@BankNum,@JinE,@TiXianStatus,@TiXianTime,@ApplyStatus,@BeiZhu,@TransactionID
	)
	set @error=@error+@@error

if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result

END
GO

alter table tbl_JA_ApplyTiXian alter column TiXianStatus tinyint
alter table tbl_JA_ApplyTiXian alter column ApplyStatus tinyint
go

set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go





-- =============================================
-- Author:		邹磊<Author,,Name>
-- Create date: 2014-09-22<Create Date,,>
-- Description:	提现申请<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_JA_ApplyTiXian_ADD] 
	@ApplyStatus tinyint,
	@BankNum varchar(25),
    @JinE money,
	@KaiHuBank varchar(100),
	@KaiHuName varchar(50),
	@TiXianStatus tinyint,
	@TiXianTime  datetime,
    @UserId char(36),
    @BeiZhu nvarchar(250),
	@Result int output
    
AS
BEGIN 
	declare @error int
	set @error=0
	declare @LiuShuiHiao int , @TransactionID varchar(50)
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_JA_ApplyTiXian]
	SET @TransactionID='TX'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	begin transaction
	
	INSERT INTO [tbl_JA_ApplyTiXian](
	[UserId],[KaiHuBank],[KaiHuName],[BankNum],[JinE],[TiXianStatus],[TiXianTime],[ApplyStatus],[BeiZhu],[TransactionID]
	)VALUES(
	@UserId,@KaiHuBank,@KaiHuName,@BankNum,@JinE,@TiXianStatus,@TiXianTime,@ApplyStatus,@BeiZhu,@TransactionID
	)
	set @error=@error+@@error

if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result

END
GO

-- =============================================
-- tbl_member 新增字段 有效日期
-- =============================================
ALTER TABLE dbo.tbl_Member ADD
	ValidDate datetime NULL
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		刘树超
-- Create date: 2014-08-19
-- Description:	更新线路发班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_UpdateTours]
 @TourId CHAR(36)
,@XianLuId CHAR(36)
,@LDate DATETIME  
,@RDate DATETIME 
,@STATUS TINYINT 
,@JSJCR MONEY
,@JSJET MONEY
,@CRSCJ MONEY
,@ETSCJ MONEY
,@SYRS INT
,@TrafficId NVARCHAR(50)
,@RetCode INT OUTPUT
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	IF EXISTS(SELECT 1 FROM tbl_XianLuTour WHERE XianLuId=@xianluid AND datediff(dd,LDate,@LDate)=0 AND TrafficId=@TrafficId)
		BEGIN
			UPDATE tbl_XianLuTour   SET  RDate =@RDate,Status =@Status,JSJCR =@JSJCR,JSJET = @JSJET,SYRS = @SYRS,CRSCJ=@CRSCJ,ETSCJ=@ETSCJ WHERE XianLuId=@XianLuId AND datediff(dd,LDate,@LDate)=0 AND TrafficId=@TrafficId
			SET @error=@error+@@ERROR
		END
	ELSE
		BEGIN
			INSERT INTO tbl_XianLuTour (TourId ,XianLuId ,LDate ,RDate ,Status ,JSJCR ,JSJET ,SYRS ,TrafficId,CRSCJ,ETSCJ) VALUES (@TourId,@XianLuId,@LDate,@RDate,@Status,@JSJCR,@JSJET,@SYRS,@TrafficId,@CRSCJ,@ETSCJ)
			SET @error=@error+@@ERROR
		END
	IF(@error<>0)
		BEGIN
			SET @RetCode=0
			RETURN @RetCode
		END
	ELSE 
		BEGIN
			SET @RetCode=1
			RETURN @RetCode
		END

END
GO


/*****************会员供销商城视图修改（库存数量bug）********************************/

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,isnull((a.ProductNum- (SELECT sum(ProductNum) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)),0) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       ,a.Unit
  FROM tbl_ShangChengChanPin as a
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



/*****************会员供销商城视图修改（新增字段：供应商名称）********************************/

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT SupplierName  FROM [tbl_Supplier] where ID=a.GYSid ) as SupplierName
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,isnull((a.ProductNum- (SELECT sum(ProductNum) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)),0) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       ,a.Unit
  FROM tbl_ShangChengChanPin as a
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



GO
/****** 对象:  View [dbo].[View_DingDan]    脚本日期: 10/21/2014 14:55:32 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[View_DingDan]
AS
SELECT     a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT     b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT     c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT     d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT     e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT     f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT     g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType
FROM         tbl_ShangChengDingDan AS g

GO

GO
/****** 对象:  View [dbo].[view_XianLuTour_ZuiJinFaBan]    脚本日期: 10/21/2014 17:30:48 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
	-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-16
-- Description: 线路发班周期最近发班
-- =============================================
ALTER VIEW [dbo].[view_XianLuTour_ZuiJinFaBan]
AS
SELECT A.* FROM [tbl_XianLuTour] AS A INNER JOIN (SELECT XianLuId, MIN([LDate]) AS ZuiJinQuTuanRiQi,TourId ,ROW_NUMBER()  over (PARTITION  by tbl_XianLuTour.xianluid order by ldate ASC,TourId ASC) as no FROM tbl_XianLuTour WHERE  Status=0 and LDate>DATEADD(dd,1,GETDATE())   GROUP BY XianLuId,ldate,TourId)B
ON A.XianLuId=B.XianLuId AND A.Ldate=b.ZuiJinQuTuanRiQi and  no=1 AND A.TourId=B.TourId and a.Status=0
GO


 alter table tbl_ShangChengChanPin add IsTrue tinyint default 1
go 



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT SupplierName  FROM [tbl_Supplier] where ID=a.GYSid ) as SupplierName
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,isnull((a.ProductNum- (SELECT sum(ProductNum) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)),0) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       ,a.Unit,a.IsTrue
  FROM tbl_ShangChengChanPin as a
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT     a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT     b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT     c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT     d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT     e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT     f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT     g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID
FROM         tbl_ShangChengDingDan AS g
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





alter table tbl_JA_Sellers add XuKeZhengHao varchar(50)
go 




/*************************新增存储过程，每天定时写入会员E额宝增值记录*********************************/




---每天定时执行，写入收益记录表,更新会员表TotalMoney字段
Create Procedure Proc_Add_Payments

as 

begin

declare @Rate decimal(18,4)

if Exists(Select 1 From sysObjects Where Name ='tbl_InterestRate' And Type In ('S','U'))
select @rate=interest from tbl_InterestRate

insert into tbl_payments
select memberID,TotalMoney,@rate,TotalMoney*@rate as DayInCome,getdate() from tbl_member where totalMoney>0

---更新用户表 总金额=总金额+每日收益
update a set a.TotalMoney=a.TotalMoney+b.dayIncome
from tbl_member a
inner join tbl_payments b on a.memberID=b.MemID where datediff(day,b.DealDate,getdate())=0

end


/*************************新增E额宝利率表，E额宝增值记录表*********************************/

    


/*==============================================================*/
/* Table: E额宝增值记录表                                         */
/*==============================================================*/
create table tbl_PayMents 
(
   PayID                int identity(1,1)                     not null,
   MemID                char(36)                       null,
   Account              money                          null,
   InterestRate         decimal(18,4)                  null,
   DayInCome            decimal(18,2)                  null,
   DealDate             datetime                       null
 
);

/*==============================================================*/
/* Table: E额宝利率表                                      */
/*==============================================================*/
create table tbl_InterestRate 
(
   RateID               int   identity(1,1)                            not null,
   Interest             decimal(18,4)                  null
);






GO
ALTER TABLE dbo.tbl_Member ADD
	ShangJiDaiLiShangId char(36) NOT NULL CONSTRAINT DF_tbl_Member_ShangJiDaiLiShangId DEFAULT ''
GO
DECLARE @v sql_variant 
SET @v = N'上级代理商编号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_Member', N'COLUMN', N'ShangJiDaiLiShangId'
GO

ALTER TABLE dbo.tbl_Member ADD
	ShangJiDaiLiShangHuiYuanId char(36) NOT NULL CONSTRAINT DF_tbl_Member_ShangJiDaiLiShangHuiYuanId DEFAULT ''
GO
DECLARE @v sql_variant 
SET @v = N'上级代理商会员编号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_Member', N'COLUMN', N'ShangJiDaiLiShangHuiYuanId'
GO

/*==============================================================*/
/* Table: 修改E额宝收益记录存储过程                                     */
/*==============================================================*/

GO
  
  
alter Procedure Proc_Add_Payments  
  
as   
  
begin  
  
declare @Rate decimal(18,4)  
declare @dayCount int 
  
if Exists(Select 1 From sysObjects Where Name ='tbl_InterestRate' And Type In ('S','U'))
----判断利率是否设置，是否大于0，如果没设置或者利率小于0，则不执行  
select @rate=isnull(interest,0) from tbl_InterestRate  
select @dayCount=Count(0) from tbl_payments where datediff(day,DealDate,getdate())=0  

---如果当天没有执行收益,则生成收益记录,避免重复记录
 if @rate>0 and @dayCount=0
begin
---每天定时执行，写入收益记录表  

insert into tbl_payments  
select memberID,TotalMoney,@rate,TotalMoney*@rate as DayInCome,getdate() from tbl_member where totalMoney>0  
  
---更新用户表 总金额=总金额+每日收益  
update a set a.TotalMoney=a.TotalMoney+isnull(b.dayIncome,0)  
from tbl_member a  
inner join tbl_payments b on a.memberID=b.MemID where a.totalMoney>0 and datediff(day,b.DealDate,getdate())=0 
end 
end  

GO
  
 -- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝信息
-- =============================================
CREATE VIEW view_FenSi
AS
SELECT A.MemberID AS HuiYuanId
	,A.Account AS HuiYuanYongHuMing
	,A.MemberName AS HuiYuanXingMing
	,A.ShangJiDaiLiShangId
	,A.ShangJiDaiLiShangHuiYuanId
	,A.RegisterTime
	,B.WebsiteName AS ShangJiDaiLiShangWangZhanName
	,B.WebSite AS ShangJiDaiLiShangYuMing
	,C.WebsiteName AS HuiYuanWangZhanName
	,C.WebSite AS HuiYuanYuMing
FROM tbl_Member AS A LEFT OUTER JOIN tbl_JA_Sellers AS B
ON A.ShangJiDaiLiShangId=B.Id AND A.ShangJiDaiLiShangHuiYuanId=B.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS C
ON A.MemberId=C.MemberID
GO



alter table tbl_JA_Sellers add CompanyContent text
go 

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝交易信息
-- =============================================
CREATE VIEW view_FenSiJiaoYi
AS
--线路订单
SELECT A.OrderId AS DingDanId--订单编号
	,A.IssueTime AS XiaDanShiJian--下单时间
	,A.OperatorId AS XianDanRenId--下单人编号
	,A.JinE AS DingDanJinE--订单金额
	,A.Status AS DingDanStatus--订单状态
	,A.FuKuanStatus AS FuKuanStatus--付款状态
	,A.AgencyId AS DaiLiShangId--代理商编号
	,A.AgencyJinE AS DaiLiShangJinE--代理商金额
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号
	,(SELECT TOP 1 A1.Name FROM tbl_XianLuTourOrderYouKe AS A1 WHERE A1.OrderId=A.OrderId) AS KeRenName--客人姓名
	,C.RouteName AS CPName--产品名称
	,(CASE D.RouteType WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END) AS DingDanLeiXing--订单类型
	,E.MemberName AS XiaDanRenName--下单人姓名
FROM tbl_XianLuTourOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_XianLu AS C
ON A.XianLuId=C.XianLuId LEFT OUTER JOIN tbl_SysArea AS D
ON C.AreaId=D.ID LEFT OUTER JOIN tbl_Member AS E
ON A.OperatorId=E.MemberID

UNION ALL
--签证订单
SELECT A.DingDanId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.XiaDanRenId  AS XianDanRenId
	,A.JinE AS DingDanJinE
	,A.DingDanStatus AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrXingMing AS KeRenName
	,C.[Name] AS CPName
	,6 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_QianZhengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.XiaDanRenId=B.MemberID LEFT OUTER JOIN tbl_QianZheng AS C
ON A.QianZhengId=C.QianZhengId LEFT OUTER JOIN tbl_Member AS D
ON A.XiaDanRenId=D.MemberID

UNION ALL
--门票订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.Price AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,A.AgencyJinE AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.EnName AS CPName
	,4 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_ScenicAreaOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_ScenicTickets AS C
ON A.TicketsId=C.TicketsId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID

UNION ALL
--酒店订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.TotalAmount AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PaymentState AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.HotelName AS CPName
	,5 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_HotelOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_Hotel AS C
ON A.HotelId=C.HotelId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID

UNION ALL
--租车订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,ISNULL(A.ZuJin,0) AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrName AS KeRenName
	,C.CarName AS CPName
	,8 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_JA_ZuCheOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_JA_ZuCheInfo AS C
ON A.ZuCheID=C.ZuCheID LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID

UNION ALL
--商城订单
SELECT A.OrderID AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.ContactID AS XiaDanRenId
	,ISNULL(A.OrderPrice,0) AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,A.SupplierMoney AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.ProductName AS CPName
	,3 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_ShangChengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.ContactID=B.MemberID LEFT OUTER JOIN tbl_ShangChengChanPin AS C
ON A.ProductId=C.ProductID LEFT OUTER JOIN tbl_Member AS D
ON A.ContactID=D.MemberID

UNION ALL
--团购订单
SELECT CAST(A.OrderId AS CHAR(36)) AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.PeopleID AS XiaDanRenId
	,A.OrderPrice AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,0 AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.PeopleName AS KeRenName
	,C.ProductName AS CPName
	,7 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_TuanGouDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.PeopleID=B.MemberID LEFT OUTER JOIN tbl_TuanGouChanPin AS C
ON A.ProductID=C.Id LEFT OUTER JOIN tbl_Member AS D
ON A.PeopleID=D.MemberID
GO
  
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-30
-- Description:	设置会员上级代理商
-- =============================================
CREATE PROCEDURE proc_HuiYuan_SheZhiShangJiDaiLiShang
	@HuiYuanId CHAR(36)
	,@ShangJiDaiLiShangId CHAR(36)
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @ShangJiDaiLiShangHuiYuanId CHAR(36)
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JA_Sellers WHERE ID=@ShangJiDaiLiShangId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId AND ShangJiDaiLiShangId>'')
	BEGIN
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	SELECT @ShangJiDaiLiShangHuiYuanId=ISNULL(MemberID,'') FROM tbl_JA_Sellers WHERE ID=@ShangJiDaiLiShangId
	
	IF(LEN(@ShangJiDaiLiShangHuiYuanId)<1)
	BEGIN
		SET @RetCode=-96
		RETURN @RetCode
	END
	
	UPDATE tbl_Member SET ShangJiDaiLiShangId=@ShangJiDaiLiShangId,ShangJiDaiLiShangHuiYuanId=@ShangJiDaiLiShangHuiYuanId WHERE MemberID=@HuiYuanId
	
	SET @RetCode=1
	RETURN @RetCode	
END
GO

/*CREATE TABLE 会员下级分销提成信息 2014-10-30 汪奇志*/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng](
	[TiChengId] [char](36) NOT NULL,
	[HuiYuanId] [char](36) NOT NULL,
	[YongJinJinE] [money] NOT NULL,
	[BiLi] [money] NOT NULL,
	[JinE] [money] NOT NULL,
	[ShiJian] [datetime] NOT NULL,
	[Status] [tinyint] NOT NULL,
	[ZhuanZhangShiJian] [datetime] NOT NULL,
	[ZhuanZhangCaoZuoRenId] [int] NOT NULL,
	[IdentityId] [int] IDENTITY(1,1) NOT NULL,
 CONSTRAINT [PK_TBL_HUIYUANXIAJIFENXIAOTICH] PRIMARY KEY CLUSTERED 
(
	[TiChengId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提成编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'TiChengId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'会员编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'HuiYuanId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'下级分销佣金金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'YongJinJinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提成比例' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'BiLi'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提成金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'JinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提成时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'ShiJian'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'提成状态' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'Status'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'转账时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'ZhuanZhangShiJian'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'转账操作人编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'ZhuanZhangCaoZuoRenId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'自增编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng', @level2type=N'COLUMN',@level2name=N'IdentityId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'会员下级分销提成信息' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_HuiYuanXiaJiFenXiaoTiCheng'
GO
/****** Object:  Default [DF__tbl_HuiYu__YongJ__2E66C05C]    Script Date: 10/30/2014 17:17:06 ******/
ALTER TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng] ADD  CONSTRAINT [DF__tbl_HuiYu__YongJ__2E66C05C]  DEFAULT ((0)) FOR [YongJinJinE]
GO
/****** Object:  Default [DF__tbl_HuiYua__BiLi__2F5AE495]    Script Date: 10/30/2014 17:17:06 ******/
ALTER TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng] ADD  CONSTRAINT [DF__tbl_HuiYua__BiLi__2F5AE495]  DEFAULT ((0)) FOR [BiLi]
GO
/****** Object:  Default [DF__tbl_HuiYua__JinE__304F08CE]    Script Date: 10/30/2014 17:17:06 ******/
ALTER TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng] ADD  CONSTRAINT [DF__tbl_HuiYua__JinE__304F08CE]  DEFAULT ((0)) FOR [JinE]
GO
/****** Object:  Default [DF__tbl_HuiYu__ShiJi__31432D07]    Script Date: 10/30/2014 17:17:06 ******/
ALTER TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng] ADD  CONSTRAINT [DF__tbl_HuiYu__ShiJi__31432D07]  DEFAULT (getdate()) FOR [ShiJian]
GO
/****** Object:  Default [DF__tbl_HuiYu__Statu__32375140]    Script Date: 10/30/2014 17:17:06 ******/
ALTER TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng] ADD  CONSTRAINT [DF__tbl_HuiYu__Statu__32375140]  DEFAULT ((0)) FOR [Status]
GO
/****** Object:  Default [DF__tbl_HuiYu__Zhuan__332B7579]    Script Date: 10/30/2014 17:17:06 ******/
ALTER TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng] ADD  CONSTRAINT [DF__tbl_HuiYu__Zhuan__332B7579]  DEFAULT (getdate()) FOR [ZhuanZhangShiJian]
GO
/****** Object:  Default [DF__tbl_HuiYu__Zhuan__341F99B2]    Script Date: 10/30/2014 17:17:06 ******/
ALTER TABLE [dbo].[tbl_HuiYuanXiaJiFenXiaoTiCheng] ADD  CONSTRAINT [DF__tbl_HuiYu__Zhuan__341F99B2]  DEFAULT ((0)) FOR [ZhuanZhangCaoZuoRenId]
GO



alter table tbl_JA_Sellers add CompanyJC varchar(50)
go

alter table tbl_JA_Sellers add CompanyName varchar(100)
go

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	获取会员下级分销提成-金额
-- =============================================
CREATE PROCEDURE proc_XiaJiFenXiaoTiCheng_GetJinE
	@HuiYuanId CHAR(36)--会员编号
	,@SuoYouYongJinJinE MONEY OUTPUT--所有下级分销佣金金额
	,@YiShenQingYongJinJinE MONEY OUTPUT--已申请下级分销佣金金额
	,@YiShenQingJinE MONEY OUTPUT--已申请提成金额
	,@YiShenPiYongJinJinE MONEY OUTPUT--已审批下级分销佣金金额
	,@YiShenPiJinE MONEY OUTPUT--已审批提成金额
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	SET @RetCode=0
	SET @SuoYouYongJinJinE=0
	SET @YiShenQingYongJinJinE=0
	SET @YiShenQingJinE=0
	SET @YiShenPiYongJinJinE=0
	SET @YiShenPiJinE=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	SELECT @SuoYouYongJinJinE=ISNULL(SUM(DingDanJinE-DaiLiShangJinE),0) FROM view_FenSiJiaoYi WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId AND DingDanStatus IN(2,3,4,5) AND FuKuanStatus IN(1)

	SELECT 	@YiShenQingYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT @YiShenQingJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT 	@YiShenPiYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)

	SELECT @YiShenPiJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)	

	SET @RetCode=1
	RETURN @RetCode	
END
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	下级分销提成-申请
-- =============================================
CREATE PROCEDURE proc_XiaJiFenXiaoTiCheng_C
	@TiChengId CHAR(36)--提成编号
	,@HuiYuanId CHAR(36)--会员编号
	,@YongJinJinE MONEY--申请提成的佣金金额
	,@BiLi MONEY--此次申请提成的比例
	,@JinE MONEY--此次申请提成金额
	,@ShiJian DATETIME--申请时间
	,@Status TINYINT--申请状态
	,@RetCode INT OUTPUT--OUTPUT CODE 
AS
BEGIN
	SET @RetCode=0
	DECLARE @SuoYouYongJinJinE MONEY--所有下级分销的佣金金额
	DECLARE @YiShenQingYongJinJinE MONEY--已经申请提成的佣金金额
	DECLARE @YiShenQingJinE MONEY--已申请提成金额
	DECLARE @YiShenPiYongJinJinE MONEY--已审批下级分销佣金金额
	DECLARE @YiShenPiJinE MONEY--已审批提成金额
	DECLARE @TempRetCode INT 
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	--获取下级分销金额信息
	EXEC proc_XiaJiFenXiaoTiCheng_GetJinE @HuiYuanId=@HuiYuanId,@SuoYouYongJinJinE=@SuoYouYongJinJinE OUTPUT
		,@YiShenQingYongJinJinE=@YiShenQingYongJinJinE OUTPUT,@YiShenQingJinE=@YiShenQingJinE OUTPUT
		,@YiShenPiYongJinJinE=@YiShenPiYongJinJinE OUTPUT,@YiShenPiJinE=@YiShenPiJinE OUTPUT
		,@RetCode=@TempRetCode OUTPUT

	IF(@SuoYouYongJinJinE<@YiShenQingYongJinJinE+@YongJinJinE)	
	BEGIN
		--此次申请提成的佣金金额大于可以申请提成的佣金金额
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	INSERT INTO [tbl_HuiYuanXiaJiFenXiaoTiCheng]([TiChengId],[HuiYuanId],[YongJinJinE]
		,[BiLi],[JinE],[ShiJian]
		,[Status],[ZhuanZhangShiJian],[ZhuanZhangCaoZuoRenId])
	VALUES(@TiChengId,@HuiYuanId,@YongJinJinE
		,@BiLi,@JinE,@ShiJian
		,@Status,@ShiJian,0)		
	
	SET @RetCode=1
	RETURN @RetCode
END
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	会员下级分销提成-设置状态
-- =============================================
CREATE PROCEDURE proc_XiaJiFenXiaoTiCheng_SheZhiStatus
	@TiChengId CHAR(36)--提成编号
	,@Status TINYINT--状态
	,@CaoZuoRenId CHAR(36)--操作人编号
	,@CaoZuoShiJian DATETIME--操作时间
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	SET @RetCode=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE TiChengId=@TiChengId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	UPDATE tbl_HuiYuanXiaJiFenXiaoTiCheng SET [Status]=@Status WHERE TiChengId=@TiChengId
	
	IF(@Status=2)
	BEGIN
		UPDATE tbl_HuiYuanXiaJiFenXiaoTiCheng SET ZhuanZhangShiJian=@CaoZuoShiJian,ZhuanZhangCaoZuoRenId=CAST(@CaoZuoRenId AS INT) WHERE TiChengId=@TiChengId
	END

	SET @RetCode=1
	RETURN @RetCode	
END
GO


alter table tbl_TravelArticle add SortRule int
go 

ALTER TABLE dbo.tbl_HuiYuanXiaJiFenXiaoTiCheng ADD
	JiaoYiHao nvarchar(50) NOT NULL CONSTRAINT DF_tbl_HuiYuanXiaJiFenXiaoTiCheng_JiaoYiHao DEFAULT ''
GO
DECLARE @v sql_variant 
SET @v = N'交易号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_HuiYuanXiaJiFenXiaoTiCheng', N'COLUMN', N'JiaoYiHao'
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	下级分销提成-申请
-- =============================================
ALTER PROCEDURE [dbo].[proc_XiaJiFenXiaoTiCheng_C]
	@TiChengId CHAR(36)--提成编号
	,@HuiYuanId CHAR(36)--会员编号
	,@YongJinJinE MONEY--申请提成的佣金金额
	,@BiLi MONEY--此次申请提成的比例
	,@JinE MONEY--此次申请提成金额
	,@ShiJian DATETIME--申请时间
	,@Status TINYINT--申请状态
	,@RetCode INT OUTPUT--OUTPUT CODE 
	,@JiaoYiHao NVARCHAR(50) OUTPUT--OUTPUT CODE 交易号
AS
BEGIN
	SET @RetCode=0
	DECLARE @SuoYouYongJinJinE MONEY--所有下级分销的佣金金额
	DECLARE @YiShenQingYongJinJinE MONEY--已经申请提成的佣金金额
	DECLARE @YiShenQingJinE MONEY--已申请提成金额
	DECLARE @YiShenPiYongJinJinE MONEY--已审批下级分销佣金金额
	DECLARE @YiShenPiJinE MONEY--已审批提成金额
	DECLARE @TempRetCode INT 
	DECLARE @IdentityId INT
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	--获取下级分销金额信息
	EXEC proc_XiaJiFenXiaoTiCheng_GetJinE @HuiYuanId=@HuiYuanId,@SuoYouYongJinJinE=@SuoYouYongJinJinE OUTPUT
		,@YiShenQingYongJinJinE=@YiShenQingYongJinJinE OUTPUT,@YiShenQingJinE=@YiShenQingJinE OUTPUT
		,@YiShenPiYongJinJinE=@YiShenPiYongJinJinE OUTPUT,@YiShenPiJinE=@YiShenPiJinE OUTPUT
		,@RetCode=@TempRetCode OUTPUT

	IF(@SuoYouYongJinJinE<@YiShenQingYongJinJinE+@YongJinJinE)	
	BEGIN
		--此次申请提成的佣金金额大于可以申请提成的佣金金额
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	INSERT INTO [tbl_HuiYuanXiaJiFenXiaoTiCheng]([TiChengId],[HuiYuanId],[YongJinJinE]
		,[BiLi],[JinE],[ShiJian]
		,[Status],[ZhuanZhangShiJian],[ZhuanZhangCaoZuoRenId]
		,[JiaoYiHao])
	VALUES(@TiChengId,@HuiYuanId,@YongJinJinE
		,@BiLi,@JinE,@ShiJian
		,@Status,@ShiJian,0
		,'')
	SET @IdentityId=SCOPE_IDENTITY()
		
	SET @JiaoYiHao='JLO'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
	UPDATE [tbl_HuiYuanXiaJiFenXiaoTiCheng] SET [JiaoYiHao]=@JiaoYiHao WHERE [TiChengId]=@TiChengId
	
	SET @RetCode=1
	RETURN @RetCode
END
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-03
-- Description:	分销奖励申请信息
-- =============================================
CREATE VIEW [dbo].[view_HuiYuanXiaJiFenXiaoTiCheng]
AS
SELECT A.[TiChengId]
	,A.[HuiYuanId]
	,A.[YongJinJinE]
	,A.[BiLi]
	,A.[JinE]
	,A.[ShiJian]
	,A.[Status]
	,A.[ZhuanZhangShiJian]
	,A.[ZhuanZhangCaoZuoRenId]
	,A.[IdentityId]
	,A.[JiaoYiHao]
	,B.Account AS HuiYuanYongHuMing
	,B.MemberName AS HuiYuanXingMing
FROM [tbl_HuiYuanXiaJiFenXiaoTiCheng] AS A INNER JOIN tbl_Member AS B
ON A.HuiYuanId=B.MemberID
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	会员下级分销提成-设置状态
-- =============================================
ALTER PROCEDURE [dbo].[proc_XiaJiFenXiaoTiCheng_SheZhiStatus]
	@TiChengId CHAR(36)--提成编号
	,@Status TINYINT--状态
	,@CaoZuoRenId CHAR(36)--操作人编号
	,@CaoZuoShiJian DATETIME--操作时间
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	SET @RetCode=0
	DECLARE @YuanStatus TINYINT--原状态
	
	IF NOT EXISTS(SELECT 1 FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE TiChengId=@TiChengId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	SELECT @YuanStatus=[Status] FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE TiChengId=@TiChengId
	
	IF(@YuanStatus=@Status)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF(@YuanStatus NOT IN(0))
	BEGIN
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	UPDATE tbl_HuiYuanXiaJiFenXiaoTiCheng SET [Status]=@Status WHERE TiChengId=@TiChengId
	
	IF(@Status=2)
	BEGIN
		UPDATE tbl_HuiYuanXiaJiFenXiaoTiCheng SET ZhuanZhangShiJian=@CaoZuoShiJian,ZhuanZhangCaoZuoRenId=CAST(@CaoZuoRenId AS INT) WHERE TiChengId=@TiChengId
	END

	SET @RetCode=1
	RETURN @RetCode	
END
GO

/*用户增加推广编号 [tbl_Member].[TuiGuangId] 2014-10-04 汪奇志*/
ALTER TABLE dbo.tbl_Member ADD
	TuiGuangId char(36) NOT NULL CONSTRAINT DF_tbl_Member_TuiGuangId DEFAULT NEWID()
GO
DECLARE @v sql_variant 
SET @v = N'推广编号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_Member', N'COLUMN', N'TuiGuangId'
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝交易信息
-- =============================================
ALTER VIEW [dbo].[view_FenSiJiaoYi]
AS
--线路订单
SELECT A.OrderId AS DingDanId--订单编号
	,A.IssueTime AS XiaDanShiJian--下单时间
	,A.OperatorId AS XianDanRenId--下单人编号
	,A.JinE AS DingDanJinE--订单金额
	,A.Status AS DingDanStatus--订单状态
	,A.FuKuanStatus AS FuKuanStatus--付款状态
	,A.AgencyId AS DaiLiShangId--代理商编号
	,A.AgencyJinE AS DaiLiShangJinE--代理商金额
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号
	,(SELECT TOP 1 A1.Name FROM tbl_XianLuTourOrderYouKe AS A1 WHERE A1.OrderId=A.OrderId) AS KeRenName--客人姓名
	,C.RouteName AS CPName--产品名称
	,(CASE D.RouteType WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END) AS DingDanLeiXing--订单类型
	,E.MemberName AS XiaDanRenName--下单人姓名
FROM tbl_XianLuTourOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_XianLu AS C
ON A.XianLuId=C.XianLuId LEFT OUTER JOIN tbl_SysArea AS D
ON C.AreaId=D.ID LEFT OUTER JOIN tbl_Member AS E
ON A.OperatorId=E.MemberID

UNION ALL
--商城订单
SELECT A.OrderID AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.ContactID AS XiaDanRenId
	,ISNULL(A.OrderPrice,0) AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,A.SupplierMoney AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.ProductName AS CPName
	,3 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_ShangChengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.ContactID=B.MemberID LEFT OUTER JOIN tbl_ShangChengChanPin AS C
ON A.ProductId=C.ProductID LEFT OUTER JOIN tbl_Member AS D
ON A.ContactID=D.MemberID

UNION ALL
--门票订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.Price AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,A.AgencyJinE AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.EnName AS CPName
	,4 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_ScenicAreaOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_ScenicTickets AS C
ON A.TicketsId=C.TicketsId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID

UNION ALL
--酒店订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.TotalAmount AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PaymentState AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.HotelName AS CPName
	,5 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_HotelOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_Hotel AS C
ON A.HotelId=C.HotelId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID

UNION ALL
--签证订单
SELECT A.DingDanId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.XiaDanRenId  AS XianDanRenId
	,A.JinE AS DingDanJinE
	,A.DingDanStatus AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrXingMing AS KeRenName
	,C.[Name] AS CPName
	,6 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_QianZhengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.XiaDanRenId=B.MemberID LEFT OUTER JOIN tbl_QianZheng AS C
ON A.QianZhengId=C.QianZhengId LEFT OUTER JOIN tbl_Member AS D
ON A.XiaDanRenId=D.MemberID

UNION ALL
--团购订单
SELECT CAST(A.OrderId AS CHAR(36)) AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.PeopleID AS XiaDanRenId
	,A.OrderPrice AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,0 AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.PeopleName AS KeRenName
	,C.ProductName AS CPName
	,7 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_TuanGouDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.PeopleID=B.MemberID LEFT OUTER JOIN tbl_TuanGouChanPin AS C
ON A.ProductID=C.Id LEFT OUTER JOIN tbl_Member AS D
ON A.PeopleID=D.MemberID

UNION ALL
--租车订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,ISNULL(A.ZuJin,0) AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrName AS KeRenName
	,C.CarName AS CPName
	,8 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
FROM tbl_JA_ZuCheOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_JA_ZuCheInfo AS C
ON A.ZuCheID=C.ZuCheID LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID
GO

/*商城商品剩余数量ISNULL处理*/
GO
ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT SupplierName  FROM [tbl_Supplier] where ID=a.GYSid ) as SupplierName
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,(a.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       ,a.Unit,a.IsTrue
  FROM tbl_ShangChengChanPin as a

GO



/****** 对象:  Table [dbo].[tbl_JA_DanDuZuTuan]    脚本日期: 11/06/2014 09:38:52 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tbl_JA_DanDuZuTuan](
	[CarMoney] [money] NULL,
	[ZaoCanMoney] [money] NULL,
	[WuCanMoney] [money] NULL,
	[WanCanMoney] [money] NULL,
	[RSYiWai] [money] NULL,
	[JTYiWai] [money] NULL,
	[DaoYouMoney] [money] NULL
) ON [PRIMARY]


ALTER TABLE dbo.tbl_JA_Account ADD
	MingXiId char(36) NOT NULL CONSTRAINT DF_tbl_JA_Account_MingXiId DEFAULT newid(),
	ApiJiaoYiHao nvarchar(255) NULL
GO
DECLARE @v sql_variant 
SET @v = N'明细编号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_JA_Account', N'COLUMN', N'MingXiId'
GO
DECLARE @v sql_variant 
SET @v = N'Api交易号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_JA_Account', N'COLUMN', N'ApiJiaoYiHao'
GO



UPDATE tbl_JA_Account SET [OrderType]=0 WHERE [OrderType] IS NULL
GO
ALTER TABLE tbl_JA_Account
ADD CONSTRAINT DF__tbl_JA_Account__OrderType__00000000 DEFAULT(0) FOR OrderType;
GO
ALTER TABLE tbl_JA_Account 
ALTER COLUMN [OrderType] INT NOT NULL
GO

UPDATE tbl_Member SET TotalMoney=0 WHERE TotalMoney IS NULL
GO
ALTER TABLE tbl_Member
ADD CONSTRAINT DF__tbl_Member__TotalMoney__00000000 DEFAULT(0) for TotalMoney;
GO
ALTER TABLE tbl_Member 
ALTER COLUMN TotalMoney MONEY NOT NULL
GO


GO
/****** Object:  Table [dbo].[tbl_YuE]    Script Date: 11/06/2014 16:00:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tbl_YuE](
	[EEBaoYuE] [money] NOT NULL,
	[KuaiQianYuE] [money] NOT NULL,
	[YuE] [money] NOT NULL
) ON [PRIMARY]
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'E额宝余额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_YuE', @level2type=N'COLUMN',@level2name=N'EEBaoYuE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'快钱余额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_YuE', @level2type=N'COLUMN',@level2name=N'KuaiQianYuE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'账户余额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_YuE', @level2type=N'COLUMN',@level2name=N'YuE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'系统余额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_YuE'
GO
/****** Object:  Table [dbo].[tbl_DingDanFanLi]    Script Date: 11/06/2014 16:00:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_DingDanFanLi](
	[FanLiId] [char](36) NOT NULL,
	[HuiYuanId] [char](36) NOT NULL,
	[HuiYuanDaiLiShangId] [char](36) NOT NULL,
	[DingDanId] [char](36) NOT NULL,
	[DingDanLeiXing] [tinyint] NOT NULL,
	[DingDanJinE] [money] NOT NULL,
	[FenXiaoJinE] [money] NOT NULL,
	[FanLiJinE] [money] NOT NULL,
	[FanLiJiaoYiHao] [nvarchar](255) NULL,
	[IdentityId] [int] IDENTITY(1,1) NOT NULL,
	[IssueTime] [datetime] NOT NULL,
	[HuiYuanYuE] [money] NOT NULL,
	[YuE] [money] NOT NULL,
 CONSTRAINT [PK_TBL_DINGDANFANLI] PRIMARY KEY CLUSTERED 
(
	[FanLiId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'FanLiId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'会员编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'HuiYuanId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'会员代理商编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'HuiYuanDaiLiShangId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'订单编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'DingDanId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'订单类型' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'DingDanLeiXing'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'订单金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'DingDanJinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'分销金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'FenXiaoJinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'FanLiJinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利交易号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'FanLiJiaoYiHao'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'自增编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'IdentityId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'IssueTime'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'会员余额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'HuiYuanYuE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'余额（系统）' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi', @level2type=N'COLUMN',@level2name=N'YuE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'订单返利信息' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_DingDanFanLi'
GO
/****** Object:  Table [dbo].[tbl_TuiGuangLaiYuan]    Script Date: 11/06/2014 16:00:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_TuiGuangLaiYuan](
	[XinXiId] [char](36) NOT NULL,
	[TuiGuangId] [char](36) NOT NULL,
	[IssueTime] [datetime] NOT NULL,
	[LaiYuan] [nvarchar](255) NULL,
 CONSTRAINT [PK_TBL_TUIGUANGLAIYUAN] PRIMARY KEY CLUSTERED 
(
	[XinXiId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'信息编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangLaiYuan', @level2type=N'COLUMN',@level2name=N'XinXiId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'推广编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangLaiYuan', @level2type=N'COLUMN',@level2name=N'TuiGuangId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'操作时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangLaiYuan', @level2type=N'COLUMN',@level2name=N'IssueTime'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'来源地址' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangLaiYuan', @level2type=N'COLUMN',@level2name=N'LaiYuan'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'推广来源信息' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangLaiYuan'
GO
/****** Object:  Table [dbo].[tbl_TuiGuangFanLiBiLi]    Script Date: 11/06/2014 16:00:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[tbl_TuiGuangFanLiBiLi](
	[IdentityId] [int] IDENTITY(1,1) NOT NULL,
	[JinE] [money] NOT NULL,
	[BiLi] [money] NOT NULL,
	[IssueTime] [datetime] NOT NULL,
 CONSTRAINT [PK_TBL_TUIGUANGFANLIBILI] PRIMARY KEY CLUSTERED 
(
	[IdentityId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'自增编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLiBiLi', @level2type=N'COLUMN',@level2name=N'IdentityId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLiBiLi', @level2type=N'COLUMN',@level2name=N'JinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'比例' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLiBiLi', @level2type=N'COLUMN',@level2name=N'BiLi'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'操作时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLiBiLi', @level2type=N'COLUMN',@level2name=N'IssueTime'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'推广返利比例信息' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLiBiLi'
GO
/****** Object:  Table [dbo].[tbl_TuiGuangFanLi]    Script Date: 11/06/2014 16:00:36 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_TuiGuangFanLi](
	[FanLiId] [char](36) NOT NULL,
	[IdentityId] [int] IDENTITY(1,1) NOT NULL,
	[TuiGuangId] [char](36) NOT NULL,
	[DingDanId] [char](36) NOT NULL,
	[DingDanLeiXing] [tinyint] NOT NULL,
	[XiaDanRenId] [char](36) NOT NULL,
	[FanLiBiLi] [money] NOT NULL,
	[IssueTime] [datetime] NOT NULL,
	[DingDanJinE] [money] NOT NULL,
	[FanLiJinE] [money] NOT NULL,
	[FanLiStatus] [tinyint] NOT NULL,
	[FanLiShiJian] [datetime] NOT NULL,
	[FanLiJiaoYiHao] [nvarchar](255) NULL,
 CONSTRAINT [PK_TBL_TUIGUANGFANLI] PRIMARY KEY CLUSTERED 
(
	[FanLiId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'FanLiId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'自增编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'IdentityId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'推广编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'TuiGuangId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'订单编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'DingDanId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'订单类型' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'DingDanLeiXing'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'下单人编号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'XiaDanRenId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利比例' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'FanLiBiLi'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'操作时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'IssueTime'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'订单金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'DingDanJinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利金额' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'FanLiJinE'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利状态' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'FanLiStatus'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'FanLiShiJian'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'返利交易号' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi', @level2type=N'COLUMN',@level2name=N'FanLiJiaoYiHao'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'推广返利信息' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_TuiGuangFanLi'
GO
/****** Object:  Default [DF__tbl_DingD__HuiYu__46FD63FC]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__HuiYu__46FD63FC]  DEFAULT ('') FOR [HuiYuanId]
GO
/****** Object:  Default [DF__tbl_DingD__HuiYu__47F18835]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__HuiYu__47F18835]  DEFAULT ('') FOR [HuiYuanDaiLiShangId]
GO
/****** Object:  Default [DF__tbl_DingD__DingD__48E5AC6E]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__DingD__48E5AC6E]  DEFAULT ('') FOR [DingDanId]
GO
/****** Object:  Default [DF__tbl_DingD__DingD__49D9D0A7]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__DingD__49D9D0A7]  DEFAULT ((0)) FOR [DingDanLeiXing]
GO
/****** Object:  Default [DF__tbl_DingD__DingD__4ACDF4E0]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__DingD__4ACDF4E0]  DEFAULT ((0)) FOR [DingDanJinE]
GO
/****** Object:  Default [DF__tbl_DingD__FenXi__4BC21919]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__FenXi__4BC21919]  DEFAULT ((0)) FOR [FenXiaoJinE]
GO
/****** Object:  Default [DF__tbl_DingD__FanLi__4CB63D52]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__FanLi__4CB63D52]  DEFAULT ((0)) FOR [FanLiJinE]
GO
/****** Object:  Default [DF__tbl_DingD__Issue__4DAA618B]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__Issue__4DAA618B]  DEFAULT (getdate()) FOR [IssueTime]
GO
/****** Object:  Default [DF__tbl_DingD__HuiYu__4E9E85C4]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingD__HuiYu__4E9E85C4]  DEFAULT ((0)) FOR [HuiYuanYuE]
GO
/****** Object:  Default [DF__tbl_DingDan__YuE__4F92A9FD]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_DingDanFanLi] ADD  CONSTRAINT [DF__tbl_DingDan__YuE__4F92A9FD]  DEFAULT ((0)) FOR [YuE]
GO
/****** Object:  Default [DF__tbl_TuiGu__TuiGu__6E4C3B47]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__TuiGu__6E4C3B47]  DEFAULT ('') FOR [TuiGuangId]
GO
/****** Object:  Default [DF__tbl_TuiGu__DingD__6F405F80]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__DingD__6F405F80]  DEFAULT ('') FOR [DingDanId]
GO
/****** Object:  Default [DF__tbl_TuiGu__DingD__703483B9]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__DingD__703483B9]  DEFAULT ((0)) FOR [DingDanLeiXing]
GO
/****** Object:  Default [DF__tbl_TuiGu__XiaDa__7128A7F2]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__XiaDa__7128A7F2]  DEFAULT ('') FOR [XiaDanRenId]
GO
/****** Object:  Default [DF__tbl_TuiGu__FanLi__721CCC2B]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__FanLi__721CCC2B]  DEFAULT ((0)) FOR [FanLiBiLi]
GO
/****** Object:  Default [DF__tbl_TuiGu__Issue__7310F064]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__Issue__7310F064]  DEFAULT (getdate()) FOR [IssueTime]
GO
/****** Object:  Default [DF__tbl_TuiGu__DingD__7405149D]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__DingD__7405149D]  DEFAULT ((0)) FOR [DingDanJinE]
GO
/****** Object:  Default [DF__tbl_TuiGu__FanLi__74F938D6]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__FanLi__74F938D6]  DEFAULT ((0)) FOR [FanLiJinE]
GO
/****** Object:  Default [DF__tbl_TuiGu__FanLi__75ED5D0F]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__FanLi__75ED5D0F]  DEFAULT ((0)) FOR [FanLiStatus]
GO
/****** Object:  Default [DF__tbl_TuiGu__FanLi__76E18148]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLi] ADD  CONSTRAINT [DF__tbl_TuiGu__FanLi__76E18148]  DEFAULT (getdate()) FOR [FanLiShiJian]
GO
/****** Object:  Default [DF__tbl_TuiGua__JinE__5398450B]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLiBiLi] ADD  CONSTRAINT [DF__tbl_TuiGua__JinE__5398450B]  DEFAULT ((0)) FOR [JinE]
GO
/****** Object:  Default [DF__tbl_TuiGua__BiLi__548C6944]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLiBiLi] ADD  CONSTRAINT [DF__tbl_TuiGua__BiLi__548C6944]  DEFAULT ((0)) FOR [BiLi]
GO
/****** Object:  Default [DF__tbl_TuiGu__Issue__55808D7D]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangFanLiBiLi] ADD  CONSTRAINT [DF__tbl_TuiGu__Issue__55808D7D]  DEFAULT (getdate()) FOR [IssueTime]
GO
/****** Object:  Default [DF__tbl_TuiGu__TuiGu__4826925F]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangLaiYuan] ADD  CONSTRAINT [DF__tbl_TuiGu__TuiGu__4826925F]  DEFAULT ('') FOR [TuiGuangId]
GO
/****** Object:  Default [DF__tbl_TuiGu__Issue__491AB698]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_TuiGuangLaiYuan] ADD  CONSTRAINT [DF__tbl_TuiGu__Issue__491AB698]  DEFAULT (getdate()) FOR [IssueTime]
GO
/****** Object:  Default [DF__tbl_YuE__EEBaoYu__2690946A]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_YuE] ADD  CONSTRAINT [DF__tbl_YuE__EEBaoYu__2690946A]  DEFAULT ((0)) FOR [EEBaoYuE]
GO
/****** Object:  Default [DF__tbl_YuE__KuaiQia__2784B8A3]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_YuE] ADD  CONSTRAINT [DF__tbl_YuE__KuaiQia__2784B8A3]  DEFAULT ((0)) FOR [KuaiQianYuE]
GO
/****** Object:  Default [DF__tbl_YuE__YuE__2878DCDC]    Script Date: 11/06/2014 16:00:36 ******/
ALTER TABLE [dbo].[tbl_YuE] ADD  CONSTRAINT [DF__tbl_YuE__YuE__2878DCDC]  DEFAULT ((0)) FOR [YuE]
GO


GO
/****** Object:  View [dbo].[view_TuiGuangFanLi]    Script Date: 11/06/2014 16:02:56 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-05
-- Description:	返联盟推广返利信息
-- =============================================
CREATE VIEW [dbo].[view_TuiGuangFanLi]
AS
--返联盟推广返利-线路
SELECT A.[FanLiId]
	,A.[IdentityId]
	,A.[TuiGuangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[XiaDanRenId]
	,A.[FanLiBiLi]
	,A.[IssueTime]
	,A.[DingDanJinE]
	,A.[FanLiJinE]
	,A.[FanLiStatus]
	,A.[FanLiShiJian]
	,A.FanLiJiaoYiHao
	,B.IssueTime AS XiaDanShiJian--下单时间
	,B.Status AS DingDanStatus--订单状态
	,B.FuKuanStatus AS DingDanFuKuanStatus--付款状态
	,(SELECT A1.MemberName FROM tbl_Member AS A1 WHERE A1.MemberId=A.XiaDanRenId) AS XiaDanRenName--下单人姓名
	,C.MemberName AS TuiGuangRenName--推广人姓名
	,C.MemberID AS TuiGuangRenHuiYuanId--推广人会员编号
	,B.AgencyId AS DingDanDaiLiShangId--订单代理商编号
	,D.WebsiteName AS DingDanDaiLiShangWangZhanName--订单代理商网站名称
	,E.RouteName AS CPName--产品名称
FROM tbl_TuiGuangFanLi AS A INNER JOIN tbl_XianLuTourOrder AS B
ON A.DingDanId=B.OrderId INNER JOIN tbl_Member AS C
ON A.TuiGuangId=C.TuiGuangId LEFT OUTER JOIN tbl_JA_Sellers AS D
ON B.AgencyId =D.Id LEFT OUTER JOIN tbl_XianLu AS E
ON B.XianLuId=E.XianLuId
WHERE A.DingDanLeiXing IN(0,1,2)

UNION ALL
--返联盟推广返利-商城
SELECT A.[FanLiId]
	,A.[IdentityId]
	,A.[TuiGuangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[XiaDanRenId]
	,A.[FanLiBiLi]
	,A.[IssueTime]
	,A.[DingDanJinE]
	,A.[FanLiJinE]
	,A.[FanLiStatus]
	,A.[FanLiShiJian]
	,A.FanLiJiaoYiHao
	,B.IssueTime AS XiaDanShiJian
	,B.OrderState AS DingDanStatus
	,B.PayState AS DingDanFuKuanStatus
	,(SELECT A1.MemberName FROM tbl_Member AS A1 WHERE A1.MemberId=A.XiaDanRenId) AS XiaDanRenName
	,C.MemberName AS TuiGuangRenName
	,C.MemberID AS TuiGuangRenHuiYuanId--推广人会员编号
	,B.SupplierID AS DingDanDaiLiShangId
	,D.WebsiteName AS DingDanDaiLiShangWangZhanName
	,E.ProductName AS CPName
FROM tbl_TuiGuangFanLi AS A INNER JOIN tbl_ShangChengDingDan AS B
ON A.DingDanId=B.OrderId INNER JOIN tbl_Member AS C
ON A.TuiGuangId=C.TuiGuangId LEFT OUTER JOIN tbl_JA_Sellers AS D
ON B.SupplierID =D.Id LEFT OUTER JOIN tbl_ShangChengChanPin AS E
ON B.ProductId=E.ProductId
WHERE A.DingDanLeiXing IN(3)

UNION ALL
--返联盟推广返利-门票
SELECT A.[FanLiId]
	,A.[IdentityId]
	,A.[TuiGuangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[XiaDanRenId]
	,A.[FanLiBiLi]
	,A.[IssueTime]
	,A.[DingDanJinE]
	,A.[FanLiJinE]
	,A.[FanLiStatus]
	,A.[FanLiShiJian]
	,A.FanLiJiaoYiHao
	,B.IssueTime AS XiaDanShiJian
	,B.Status AS DingDanStatus
	,B.FuKuanStatus AS DingDanFuKuanStatus
	,(SELECT A1.MemberName FROM tbl_Member AS A1 WHERE A1.MemberId=A.XiaDanRenId) AS XiaDanRenName
	,C.MemberName AS TuiGuangRenName
	,C.MemberID AS TuiGuangRenHuiYuanId--推广人会员编号
	,B.SellerID AS DingDanDaiLiShangId
	,D.WebsiteName AS DingDanDaiLiShangWangZhanName
	,E.EnName AS CPName
FROM tbl_TuiGuangFanLi AS A INNER JOIN tbl_ScenicAreaOrder AS B
ON A.DingDanId=B.OrderId INNER JOIN tbl_Member AS C
ON A.TuiGuangId=C.TuiGuangId LEFT OUTER JOIN tbl_JA_Sellers AS D
ON B.SellerID =D.Id LEFT OUTER JOIN tbl_ScenicTickets AS E
ON B.TicketsId=E.TicketsId
WHERE A.DingDanLeiXing IN(4)

UNION ALL
--返联盟推广返利-酒店
SELECT A.[FanLiId]
	,A.[IdentityId]
	,A.[TuiGuangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[XiaDanRenId]
	,A.[FanLiBiLi]
	,A.[IssueTime]
	,A.[DingDanJinE]
	,A.[FanLiJinE]
	,A.[FanLiStatus]
	,A.[FanLiShiJian]
	,A.FanLiJiaoYiHao
	,B.IssueTime AS XiaDanShiJian
	,B.OrderState AS DingDanStatus
	,B.PaymentState AS DingDanFuKuanStatus
	,(SELECT A1.MemberName FROM tbl_Member AS A1 WHERE A1.MemberId=A.XiaDanRenId) AS XiaDanRenName
	,C.MemberName AS TuiGuangRenName
	,C.MemberID AS TuiGuangRenHuiYuanId--推广人会员编号
	,B.SellerID AS DingDanDaiLiShangId
	,D.WebsiteName AS DingDanDaiLiShangWangZhanName
	,E.HotelName AS CPName
FROM tbl_TuiGuangFanLi AS A INNER JOIN tbl_HotelOrder AS B
ON A.DingDanId=B.OrderId INNER JOIN tbl_Member AS C
ON A.TuiGuangId=C.TuiGuangId LEFT OUTER JOIN tbl_JA_Sellers AS D
ON B.SellerID =D.Id LEFT OUTER JOIN tbl_Hotel AS E
ON B.HotelId=E.HotelId
WHERE A.DingDanLeiXing IN(5)

UNION ALL
--返联盟推广返利-签证
SELECT A.[FanLiId]
	,A.[IdentityId]
	,A.[TuiGuangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[XiaDanRenId]
	,A.[FanLiBiLi]
	,A.[IssueTime]
	,A.[DingDanJinE]
	,A.[FanLiJinE]
	,A.[FanLiStatus]
	,A.[FanLiShiJian]
	,A.FanLiJiaoYiHao
	,B.IssueTime AS XiaDanShiJian
	,B.DingDanStatus AS DingDanStatus
	,B.FuKuanStatus AS DingDanFuKuanStatus
	,(SELECT A1.MemberName FROM tbl_Member AS A1 WHERE A1.MemberId=A.XiaDanRenId) AS XiaDanRenName
	,C.MemberName AS TuiGuangRenName
	,C.MemberID AS TuiGuangRenHuiYuanId--推广人会员编号
	,B.AgencyId AS DingDanDaiLiShangId
	,D.WebsiteName AS DingDanDaiLiShangWangZhanName
	,E.[Name] AS CPName
FROM tbl_TuiGuangFanLi AS A INNER JOIN tbl_QianZhengDingDan AS B
ON A.DingDanId=B.DingDanId INNER JOIN tbl_Member AS C
ON A.TuiGuangId=C.TuiGuangId LEFT OUTER JOIN tbl_JA_Sellers AS D
ON B.AgencyId =D.Id LEFT OUTER JOIN tbl_QianZheng AS E
ON B.QianZhengId=E.QianZhengId
WHERE A.DingDanLeiXing IN(6)

UNION ALL
--返联盟推广返利-团购
SELECT A.[FanLiId]
	,A.[IdentityId]
	,A.[TuiGuangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[XiaDanRenId]
	,A.[FanLiBiLi]
	,A.[IssueTime]
	,A.[DingDanJinE]
	,A.[FanLiJinE]
	,A.[FanLiStatus]
	,A.[FanLiShiJian]
	,A.FanLiJiaoYiHao
	,B.IssueTime AS XiaDanShiJian
	,B.OrderState AS DingDanStatus
	,B.PayState AS DingDanFuKuanStatus
	,(SELECT A1.MemberName FROM tbl_Member AS A1 WHERE A1.MemberId=A.XiaDanRenId) AS XiaDanRenName
	,C.MemberName AS TuiGuangRenName
	,C.MemberID AS TuiGuangRenHuiYuanId--推广人会员编号
	,B.SupplierID AS DingDanDaiLiShangId
	,D.WebsiteName AS DingDanDaiLiShangWangZhanName
	,E.ProductName AS CPName
FROM tbl_TuiGuangFanLi AS A INNER JOIN tbl_TuanGouDingDan AS B
ON A.DingDanId=CAST(B.OrderId AS CHAR(36)) INNER JOIN tbl_Member AS C
ON A.TuiGuangId=C.TuiGuangId LEFT OUTER JOIN tbl_JA_Sellers AS D
ON B.SupplierID =D.Id LEFT OUTER JOIN tbl_TuanGouChanPin AS E
ON B.ProductID=E.Id
WHERE A.DingDanLeiXing IN(7)

UNION ALL
--返联盟推广返利-租车
SELECT A.[FanLiId]
	,A.[IdentityId]
	,A.[TuiGuangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[XiaDanRenId]
	,A.[FanLiBiLi]
	,A.[IssueTime]
	,A.[DingDanJinE]
	,A.[FanLiJinE]
	,A.[FanLiStatus]
	,A.[FanLiShiJian]
	,A.FanLiJiaoYiHao
	,B.IssueTime AS XiaDanShiJian
	,B.Status AS DingDanStatus
	,B.FuKuanStatus AS DingDanFuKuanStatus
	,(SELECT A1.MemberName FROM tbl_Member AS A1 WHERE A1.MemberId=A.XiaDanRenId) AS XiaDanRenName
	,C.MemberName AS TuiGuangRenName
	,C.MemberID AS TuiGuangRenHuiYuanId--推广人会员编号
	,B.AgencyId AS DingDanDaiLiShangId
	,D.WebsiteName AS DingDanDaiLiShangWangZhanName
	,E.CarName AS CPName
FROM tbl_TuiGuangFanLi AS A INNER JOIN tbl_JA_ZuCheOrder AS B
ON A.DingDanId=B.OrderId INNER JOIN tbl_Member AS C
ON A.TuiGuangId=C.TuiGuangId LEFT OUTER JOIN tbl_JA_Sellers AS D
ON B.AgencyId =D.Id LEFT OUTER JOIN tbl_JA_ZuCheInfo AS E
ON B.ZuCheID=E.ZuCheID
WHERE A.DingDanLeiXing IN(8)
GO
/****** Object:  View [dbo].[view_DingDanFanLi]    Script Date: 11/06/2014 16:02:56 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-06
-- Description:	订单返利
-- =============================================
CREATE VIEW [dbo].[view_DingDanFanLi]
AS
SELECT A.[FanLiId]
	,A.[HuiYuanId]
	,A.[HuiYuanDaiLiShangId]
	,A.[DingDanId]
	,A.[DingDanLeiXing]
	,A.[DingDanJinE]
	,A.[FenXiaoJinE]
	,A.[FanLiJinE]
	,A.[FanLiJiaoYiHao]
	,A.[IdentityId]
	,A.[IssueTime]
	,A.[HuiYuanYuE]
	,A.[YuE]
	,B.MemberName AS HuiYuanName
	,B.Account AS HuiYuanYongHuMing
	,(SELECT A1.WebsiteName FROM tbl_JA_Sellers AS A1 WHERE A1.MemberId=A.[HuiYuanDaiLiShangId]) AS HuiYuanDaiLiShangWangZhanName
	
FROM [tbl_DingDanFanLi] AS A INNER JOIN tbl_Member AS B
ON A.HuiYuanId=B.MemberId
GO
/****** Object:  View [dbo].[view_JiaoYiMingXi]    Script Date: 11/06/2014 16:02:56 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-06
-- Description:	交易明细(支付流水)
-- =============================================
CREATE VIEW [dbo].[view_JiaoYiMingXi]
AS
SELECT A.MingXiId AS MingXiId
	,A.ApiJiaoYiHao AS ApiJiaoYiHao
	,A.UserId AS HuiYuanId
	,A.TransactionID AS JiaoYiHao
	,A.Amounts AS JiaoYiJinE
	,A.balance AS HuiYuanEYuE
	,A.TransactionTime AS JiaoYiShiJian
	,A.TransactionWay AS ZhiFuFangShi
	,A.TransactionCate AS JiaoYiLeiBie
	,A.TransactionState AS JiaoYiStatus
	,A.TransactionDesc AS JiaoYiMiaoShu
	,A.OrderID AS DingDanId
	,A.OrderType AS DingDanLeiXing
	,B.MemberName AS HuiYuanName
	,B.Account AS HuiYuanYongHuMing
FROM tbl_JA_Account AS A INNER JOIN tbl_Member AS B
ON A.UserId=B.MemberId
GO

GO
/****** Object:  StoredProcedure [dbo].[proc_DingDanFanLi_C]    Script Date: 11/06/2014 16:04:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-06
-- Description:	订单返利新增
-- =============================================
CREATE PROCEDURE [dbo].[proc_DingDanFanLi_C]
	@FanLiId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@DingDanJinE MONEY
	,@FenXiaoJinE MONEY
	,@FanLiJinE MONEY
	,@IssueTime DATETIME
	,@FanLiJiaoYiHao NVARCHAR(50) OUTPUT
	,@RetCode INT OUTPUT
AS
BEGIN
	SEt @RetCode=0
	DECLARE @HuiYuanYuE MONEY
	DECLARE @EEBaoYuE MONEY
	DECLARE @YuE MONEY
	DECLARE @IdentityId INT
	DECLARE @HuiYuanDaiLiShangId CHAR(36)
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	SELECT @HuiYuanYuE=ISNULL(TotalMoney,0) FROM tbl_Member WHERE MemberId=@HuiYuanId
	SELECT @EEBaoYuE=ISNULL(EEBaoYuE,0),@YuE=ISNULL(YuE,0) FROM tbl_YuE
	SELECT @HuiYuanDaiLiShangId=ID FROM tbl_JA_Sellers WHERE MemberId=@HuiYuanId
	
	INSERT INTO [tbl_DingDanFanLi]([FanLiId],[HuiYuanId],[HuiYuanDaiLiShangId]
		,[DingDanId],[DingDanLeiXing],[DingDanJinE]
		,[FenXiaoJinE],[FanLiJinE],[FanLiJiaoYiHao]
		,[IssueTime],[HuiYuanYuE],[YuE])
	VALUES(@FanLiid,@HuiYuanId,@HuiYuanDaiLiShangId
		,@DingDanId,@DingDanLeiXIng,@DingDanJinE
		,@FenXiaoJinE,@FanLiJinE,''
		,@IssueTime,@HuiYuanYuE+@FanLiJinE,@YuE-@FanLiJinE)
		
	SET @IdentityId=SCOPE_IDENTITY()
		
	SET @FanLiJiaoYiHao='DDFL'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
	
	UPDATE [tbl_DingDanFanLi] SET [FanLiJiaoYiHao]=@FanLiJiaoYiHao WHERE FanLiId=@FanLiId
	
	SET @RetCode=1
	RETURN @RetCode
END
GO
/****** Object:  StoredProcedure [dbo].[proc_FanLianMengTuiGuangFanLi_C]    Script Date: 11/06/2014 16:04:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-04
-- Description:	返联盟推广新增
-- =============================================
CREATE PROCEDURE [dbo].[proc_FanLianMengTuiGuangFanLi_C]
	@FanLiId CHAR(36)
	,@TuiGuangId CHAR(36)
	,@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@XiaDanRenId CHAR(36)
	,@FanLiBiLi MONEY
	,@IssueTime DATETIME
	,@RetCode INT OUTPUT
AS
BEGIN	
	SET @RetCode=0
	SET @FanLiBiLi=0	
	DECLARE @DingDanJinE MONEY
	DECLARE @IdentityId INT
	DECLARE @FanLiJiaoYiHao NVARCHAR(255)
	DECLARE @TuiGuangRenHuiYuanId CHAR(36)
	SET @DingDanJinE=0
	
	IF(@DingDanLeiXing IN(0,1,2))
	BEGIN
		--线路订单
		IF NOT EXISTS(SELECT 1 FROM tbl_XianLuTourOrder WHERE OrderId=@DingDanId)
		BEGIN
			SET @RetCode=-99
			RETURN @RetCode
		END
		
		SELECT @DingDanJinE=ISNULL(JinE,0) FROM tbl_XianLuTourOrder WHERE OrderId=@DingDanId
	END
	
	IF(@DingDanLeiXing IN(3))
	BEGIN
		--商城订单
		IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@DingDanId)
		BEGIN
			SET @RetCode=-99
			RETURN @RetCode
		END
		SELECT @DingDanJinE=ISNULL(OrderPrice,0) FROM tbl_ShangChengDingDan WHERE OrderId=@DingDanId
	END
	
	IF(@DingDanLeiXing IN(4))
	BEGIN
		--门票订单
		IF NOT EXISTS(SELECT 1 FROM tbl_ScenicAreaOrder WHERE OrderID=@DingDanId)
		BEGIN
			SET @RetCode=-99
			RETURN @RetCode
		END
		
		SELECT @DingDanJinE=ISNULL(Price,0) FROM tbl_ScenicAreaOrder WHERE OrderId=@DingDanId
	END
	
	IF(@DingDanLeiXing IN(5))
	BEGIN
		--酒店订单
		IF NOT EXISTS(SELECT 1 FROM tbl_HotelOrder WHERE OrderID=@DingDanId)
		BEGIN
			SET @RetCode=-99
			RETURN @RetCode
		END
		
		SELECT @DingDanJinE=ISNULL(TotalAmount,0) FROM tbl_HotelOrder WHERE OrderId=@DingDanId
	END
	
	IF(@DingDanLeiXing IN(6))
	BEGIN
		--签证订单
		IF NOT EXISTS(SELECT 1 FROM tbl_QianZhengDingDan WHERE DingDanId=@DingDanId)
		BEGIN
			SET @RetCode=-99
			RETURN @RetCode
		END
		
		SELECT @DingDanJinE=ISNULL(JinE,0) FROM tbl_QianZhengDingDan WHERE DingDanId=@DingDanId
	END
	
	IF(@DingDanLeiXing IN(7))
	BEGIN
		--团购订单
		IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE CAST(OrderId AS CHAR(36))=@DingDanId)
		BEGIN
			SET @RetCode=-99
			RETURN @RetCode
		END
		
		SELECT @DingDanJinE=ISNULL(OrderPrice,0) FROM tbl_TuanGouDingDan WHERE CAST(OrderId AS CHAR(36))=@DingDanId
	END
	
	IF(@DingDanLeiXing IN(8))
	BEGIN
		--租车订单
		IF NOT EXISTS(SELECT 1 FROM tbl_JA_ZuCheOrder WHERE OrderID=@DingDanId)
		BEGIN
			SET @RetCode=-99
			RETURN @RetCode
		END
		
		SELECT @DingDanJinE=ISNULL(ZuJin,0) FROM tbl_JA_ZuCheOrder WHERE OrderID=@DingDanId
	END	
	
	IF(@DingDanJinE=0)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	SELECT TOP 1 @FanLiBiLi=BiLi FROM tbl_TuiGuangFanLiBiLi WHERE JinE<@DingDanJinE ORDER BY JinE DESC
	
	IF(@FanLiBiLi=0)
	BEGIN
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE TuiGuangId=@TuiGuangId)
	BEGIN
		SET @RetCode=-96
		RETURN @RetCode
	END	
	
	SELECT @TuiGuangRenHuiYuanId=MemberId FROM tbl_Member WHERE TuiGuangId=@TuiGuangId
	
	IF(@TuiGuangRenHuiYuanId=@XiaDanRenId)
	BEGIN
		SET @RetCode=-95
		RETURN @RetCode
	END
	
	INSERT INTO [tbl_TuiGuangFanLi]([FanLiId],[TuiGuangId],[DingDanId]
		,[DingDanLeiXing],[XiaDanRenId],[FanLiBiLi]
		,[IssueTime],[DingDanJinE],[FanLiJinE]
		,[FanLiStatus],[FanLiShiJian])
	VALUES(@FanLiId,@TuiGuangId,@DingDanId
		,@DingDanLeiXing,@XiaDanRenId,@FanLiBiLi
		,@IssueTime,@DingDanJinE,@DingDanJinE*@FanLiBiLi
		,0,@IssueTime)
		
	SET @IdentityId=SCOPE_IDENTITY()
	SET @FanLiJiaoYiHao='FLMTG'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
	
	UPDATE [tbl_TuiGuangFanLi] SET [FanLiJiaoYiHao]=@FanLiJiaoYiHao WHERE [FanLiId]=@FanLiId
	
	SET @RetCode=1
	RETURN @RetCode
END
GO
/****** Object:  StoredProcedure [dbo].[proc_JiaoYiMingXi_C]    Script Date: 11/06/2014 16:04:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-06
-- Description:	交易明细写入
-- =============================================
CREATE PROCEDURE [dbo].[proc_JiaoYiMingXi_C]
	@MingXiId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@JiaoYiHao NVARCHAR(255)
	,@JiaoYiJinE MONEY
	,@JiaoYiShiJian DATETIME
	,@ZhiFuFangShi TINYINT
	,@JiaoYiLeiBie TINYINT
	,@JiaoYiStatus TINYINT
	,@JiaoYiMiaoShu NVARCHAR(255)
	,@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@ApiJiaoYiHao NVARCHAR(255)
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YongHuYuE MONEY
	DECLARE @errorcount INT
	SET @errorcount=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	BEGIN TRAN
	
	SELECT @YongHuYuE=ISNULL(TotalMoney,0) FROM tbl_Member WHERE MemberID=@HuiYuanId
	
	IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
	BEGIN
		IF(@JiaoYiLeiBie IN(0))--充值
		BEGIN
			SET @YongHuYuE=@YongHuYuE+@JiaoYiJinE
			UPDATE tbl_Member SET TotalMoney=@YongHuYuE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@ZhiFuFangShi=1 AND @JiaoYiStatus=1)--E额宝
	BEGIN
		IF(@JiaoYiLeiBie IN(0,3,4,5,6))
		BEGIN
			SET @YongHuYuE=@YongHuYuE+@JiaoYiJinE
			UPDATE tbl_Member SET TotalMoney=@YongHuYuE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@JiaoYiLeiBie IN(1,2)) 
		BEGIN
			SET @YongHuYuE=@YongHuYuE-@JiaoYiJinE
			UPDATE tbl_Member SET TotalMoney=@YongHuYuE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@errorcount=0)
	BEGIN
		INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		VALUES(@HuiYuanId,@JiaoYiHao,@JiaoYiJinE
			,@YongHuYuE,@JiaoYiShiJian,@ZhiFuFangShi
			,@JiaoYiLeiBie,@JiaoYiStatus,@JiaoYiMiaoShu
			,@DingDanId,@DingDanLeiXIng,''
			,@MingXiId,@ApiJiaoYiHao)
		SET @errorcount=@errorcount+@@ERROR
	END
	
	IF(@errorcount=0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM tbl_YuE)
		BEGIN
			INSERT INTO tbl_YuE(EEBaoYuE,KuaiQianYuE,YuE)VALUES(0,0,0)
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
		BEGIN
			IF(@JiaoYiLeiBie IN(0,2))
			BEGIN
				UPDATE tbl_YuE SET KuaiQianYuE=KuaiQianYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
		END
		
		IF(@ZhiFuFangSHi=1 AND @JiaoYiStatus=1)--E额宝
		BEGIN
			IF(@JiaoYiLeiBie IN(2))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
			
			IF(@JiaoYiLeiBie IN(1,3,4,5,6))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
		END
	END
	
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO
/****** Object:  StoredProcedure [dbo].[proc_FanLianMengTuiGuangFanLi_ShiZhiStatus]    Script Date: 11/06/2014 16:04:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-05
-- Description:	返联盟推广返利状态设置
-- =============================================
CREATE PROCEDURE [dbo].[proc_FanLianMengTuiGuangFanLi_ShiZhiStatus]
	@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@FanLiStatus TINYINT
	,@FanLiShiJian DATETIME
	,@RetCode INT OUTPUT
	,@FanLiId CHAR(36) OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YuanFanLiStatus TINYINT
	DECLARE @COUNT INT
	
	SELECT @COUNT=COUNT(*) FROM tbl_TuiGuangFanLi WHERE DingDanId=@DingDanId AND DingDanLeiXing=@DingDanLeiXing

	IF(@COUNT<>1)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END	
	
	IF(@DingDanLeiXing IN(0,1,2))
	BEGIN
		SELECT @YuanFanLiStatus=FanLiStatus,@FanLiId=FanLiId FROM tbl_TuiGuangFanLi WHERE DingDanId=@DingDanId AND DingDanLeiXing IN(0,1,2)
	END
	ELSE
	BEGIN
		SELECT @YuanFanLiStatus=FanLiStatus,@FanLiId=FanLiId FROM tbl_TuiGuangFanLi WHERE DingDanId=@DingDanId AND DingDanLeiXing=@DingDanLeiXing
	END	

	IF(@YuanFanLiStatus=1)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END	
	
	UPDATE tbl_TuiGuangFanLi SET FanLiStatus=@FanLiStatus,FanLiShiJian=@FanLiShiJian WHERE FanLiId=@FanLiId
	
	SET @RetCode=1
	RETURN @RetCode
END
GO


ALTER TABLE dbo.tbl_PayMents ADD
	ZengZhiId char(36) NOT NULL CONSTRAINT DF_tbl_PayMents_ZengZhiId DEFAULT NEWID(),
	JiaoYiHao nvarchar(50) NULL,
	Status tinyint NOT NULL CONSTRAINT DF_tbl_PayMents_Status DEFAULT 0
GO
DECLARE @v sql_variant 
SET @v = N'增值编号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_PayMents', N'COLUMN', N'ZengZhiId'
GO
DECLARE @v sql_variant 
SET @v = N'增值交易号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_PayMents', N'COLUMN', N'JiaoYiHao'
GO
DECLARE @v sql_variant 
SET @v = N'状态'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_PayMents', N'COLUMN', N'Status'
GO


UPDATE tbl_PayMents SET Account=0 WHERE Account IS NULL
UPDATE tbl_PayMents SET InterestRate=0 WHERE InterestRate IS NULL
UPDATE tbl_PayMents SET DayInCome=0 WHERE DayInCome IS NULL
UPDATE tbl_PayMents SET DealDate=GETDATE() WHERE DealDate IS NULL
UPDATE tbl_PayMents SET JiaoYiHao='YEZZ'+CONVERT(VARCHAR(8),DealDate,112)+dbo.fn_PadLeft(PayId,'0',5)
GO

ALTER TABLE tbl_PayMents 
ALTER COLUMN Account MONEY NOT NULL
GO
ALTER TABLE tbl_PayMents
ADD CONSTRAINT DF__tbl_PayMents__Account__00000000 DEFAULT(0) FOR Account
GO

ALTER TABLE tbl_PayMents 
ALTER COLUMN InterestRate MONEY NOT NULL
GO
ALTER TABLE tbl_PayMents
ADD CONSTRAINT DF__tbl_PayMents__InterestRate__00000000 DEFAULT(0) FOR InterestRate
GO

ALTER TABLE tbl_PayMents 
ALTER COLUMN DayInCome MONEY NOT NULL
GO
ALTER TABLE tbl_PayMents
ADD CONSTRAINT DF__tbl_PayMents__DayInCome__00000000 DEFAULT(0) FOR DayInCome
GO

ALTER TABLE tbl_PayMents 
ALTER COLUMN DealDate DATETIME NOT NULL
GO
ALTER TABLE tbl_PayMents
ADD CONSTRAINT DF__tbl_PayMents__DealDate__00000000 DEFAULT(GETDATE()) FOR DealDate
GO

-- =============================================
-- Author:		
-- Create date: 2014-11-06
-- Description:	余额宝增值
-- =============================================  
ALTER PROC [dbo].[Proc_Add_Payments]    
AS 
BEGIN  
	declare @Rate decimal(18,4)  
	declare @dayCount int 
	  
	if Exists(Select 1 From sysObjects Where Name ='tbl_InterestRate' And Type In ('S','U'))
	----判断利率是否设置，是否大于0，如果没设置或者利率小于0，则不执行  
	select @rate=isnull(interest,0) from tbl_InterestRate  
	select @dayCount=Count(0) from tbl_payments where datediff(day,DealDate,getdate())=0  

	---如果当天没有执行收益,则生成收益记录,避免重复记录
	if @rate>0 and @dayCount=0
	begin
		---每天定时执行，写入收益记录表
		insert into tbl_payments([MemID],[Account],[InterestRate]
			,[DayInCome],[DealDate],[ZengZhiId]
			,[JiaoYiHao],[Status])
		select memberID,TotalMoney,@rate
			,TotalMoney*@rate as DayInCome,getdate(),NEWID()
			,'',0
		from tbl_member where totalMoney>0
		  
		/*---更新用户表 总金额=总金额+每日收益  
		update a set a.TotalMoney=a.TotalMoney+isnull(b.dayIncome,0)  
		from tbl_member a  inner join tbl_payments b 
		on a.memberID=b.MemID where a.totalMoney>0 and datediff(day,b.DealDate,getdate())=0 */
	end 
	
	--写交易明细记录
	DECLARE @TEMP TABLE(ZengZhiId CHAR(36),IdentityId INT IDENTITY)
	DECLARE @COUNT INT
	
	INSERT INTO @TEMP(ZengZhiId)
	SELECT ZengZhiId FROM tbl_payments
	WHERE [Status]=0
	
	SELECT @COUNT=COUNT(*) FROM @TEMP
	
	DECLARE @i INT
	SET @i=1
	
	WHILE(@i<=@COUNT)
	BEGIN
	
		DECLARE @ZengZhiId CHAR(36)
		DECLARE @HuiYuanId CHAR(36)
		DECLARE @JiaoYiJinE MONEY
		DECLARE @JiaoYiShiJian DATETIME
		DECLARE @ZhiFuFangShi TINYINT
		DECLARE @JiaoYiLeiBie TINYINT
		DECLARE @JiaoYiStatus TINYINT
		DECLARE @JiaoYiHao NVARCHAR(50)
		DECLARE @DingDanLeiXing TINYINT
		DECLARE @TempRetCode INT
		DECLARE @MingXiId CHAR(36)
		
		SET @JiaoYiShiJian=GETDATE()
		SET @ZhiFuFangShi=1
		SET @JiaoYiLeiBie=6
		SET @JiaoYiStatus=1
		SET @DingDanLeiXing=12
		SET @MingXiId=NEWID()
		
		SELECT @ZengZhiId=ZengZhiId FROM @TEMP WHERE IdentityId=@i
		UPDATE tbl_PayMents SET JiaoYiHao='YEZZ'+CONVERT(VARCHAR(8),DealDate,112)+dbo.fn_PadLeft(PayId,'0',5) WHERE ZengZhiId=@ZengZhiId
		SELECT @HuiYuanId=[MemID],@JiaoYiJinE=[DayInCome],@JiaoYiHao=[JiaoYiHao] FROM tbl_payments WHERE ZengZhiId=@ZengZhiId
		
		IF(@JiaoYiJinE>0)
		BEGIN
			EXEC proc_JiaoYiMingXi_C @MingXiId=@MingXiId
				,@HuiYuanId=@HuiYuanId
				,@JiaoYiHao=@JiaoYiHao
				,@JiaoYiJinE=@JiaoYiJinE
				,@JiaoYiShiJian=@JiaoYiShiJian
				,@ZhiFuFangShi=@ZhiFuFangSHi
				,@JiaoYiLeiBie=@JiaoYiLeiBie
				,@JiaoYiStatus=@JiaoYiStatus
				,@JiaoYiMiaoShu='余额宝增值'
				,@DingDanId=@ZengZhiId
				,@DingDanLeiXing=@DingDanLeiXing
				,@ApiJiaoYiHao=''
				,@RetCode=@TempRetCode OUTPUT			
		END	
		
		UPDATE tbl_payments SET [Status]=1 WHERE ZengZhiId=@ZengZhiId
		SET @i=@i+1
	END	
END 
GO


alter table tbl_TravelArticle add JiBie tinyint
go 


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		邹磊<Author,,Name>
-- Create date: 2014-09-22<Create Date,,>
-- Description:	提现申请<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_JA_ApplyTiXian_ADD] 
	@ApplyStatus tinyint,
	@BankNum varchar(25),
    @JinE money,
	@KaiHuBank varchar(100),
	@KaiHuName varchar(50),
	@TiXianStatus tinyint,
	@TiXianTime  datetime,
    @UserId char(36),
    @BeiZhu nvarchar(250),
	@Result int output
    
AS
BEGIN 
	declare @error int
	set @error=0
	declare @LiuShuiHiao int , @TransactionID varchar(50),@TotalMoney money
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_JA_ApplyTiXian]
	SET @TransactionID='TX'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	begin transaction
	
	INSERT INTO [tbl_JA_ApplyTiXian](
	[UserId],[KaiHuBank],[KaiHuName],[BankNum],[JinE],[TiXianStatus],[TiXianTime],[ApplyStatus],[BeiZhu],[TransactionID]
	)VALUES(
	@UserId,@KaiHuBank,@KaiHuName,@BankNum,@JinE,@TiXianStatus,@TiXianTime,@ApplyStatus,@BeiZhu,@TransactionID
	)
    select @TotalMoney=TotalMoney from tbl_Member where MemberID=@UserId
    set @TotalMoney=@TotalMoney-@JinE
    update tbl_Member set TotalMoney=@TotalMoney where MemberID=@UserId
	set @error=@error+@@error

if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result

END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER TABLE tbl_JA_Account 
ALTER COLUMN Amounts MONEY NOT NULL
GO

ALTER TABLE tbl_JA_Account 
ALTER COLUMN balance MONEY NOT NULL
GO

ALTER TABLE dbo.tbl_JA_ApplyTiXian ADD
	TiXianId char(36) NOT NULL CONSTRAINT DF_tbl_JA_ApplyTiXian_TiXianId DEFAULT NEWID()
GO
DECLARE @v sql_variant 
SET @v = N'提现编号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tbl_JA_ApplyTiXian', N'COLUMN', N'TiXianId'
GO

ALTER TABLE tbl_JA_ApplyTiXian 
ALTER COLUMN TiXianStatus TINYINT NOT NULL
GO
ALTER TABLE tbl_JA_ApplyTiXian
ADD CONSTRAINT DF__tbl_JA_ApplyTiXian__TiXianStatus__00000000 DEFAULT(0) FOR TiXianStatus
GO

ALTER TABLE tbl_JA_ApplyTiXian 
ALTER COLUMN ApplyStatus TINYINT NOT NULL
GO
ALTER TABLE tbl_JA_ApplyTiXian
ADD CONSTRAINT DF__tbl_JA_ApplyTiXian__ApplyStatus__00000000 DEFAULT(0) FOR ApplyStatus
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-06
-- Description:	交易明细写入
-- =============================================
ALTER PROCEDURE [dbo].[proc_JiaoYiMingXi_C]
	@MingXiId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@JiaoYiHao NVARCHAR(255)
	,@JiaoYiJinE MONEY
	,@JiaoYiShiJian DATETIME
	,@ZhiFuFangShi TINYINT
	,@JiaoYiLeiBie TINYINT
	,@JiaoYiStatus TINYINT
	,@JiaoYiMiaoShu NVARCHAR(255)
	,@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@ApiJiaoYiHao NVARCHAR(255)
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YongHuYuE MONEY
	DECLARE @errorcount INT
	SET @errorcount=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	BEGIN TRAN	
	
	IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
	BEGIN
		IF(@JiaoYiLeiBie IN(0))--充值
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney+@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@ZhiFuFangShi=1 AND @JiaoYiStatus=1)--E额宝
	BEGIN
		IF(@JiaoYiLeiBie IN(0,3,4,5,6))
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney+@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@JiaoYiLeiBie IN(1,2)) 
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney-@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@ZhiFuFangShi=1 AND @JiaoYiStatus=2)
	BEGIN
		IF(@JiaoYiLeiBie IN(1)) 
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney-@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR		
		END
	END
	
	SELECT @YongHuYuE=ISNULL(TotalMoney,0) FROM tbl_Member WHERE MemberID=@HuiYuanId
	
	IF(@errorcount=0)
	BEGIN
		INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		VALUES(@HuiYuanId,@JiaoYiHao,@JiaoYiJinE
			,@YongHuYuE,@JiaoYiShiJian,@ZhiFuFangShi
			,@JiaoYiLeiBie,@JiaoYiStatus,@JiaoYiMiaoShu
			,@DingDanId,@DingDanLeiXIng,''
			,@MingXiId,@ApiJiaoYiHao)
		SET @errorcount=@errorcount+@@ERROR
	END
	
	IF(@errorcount=0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM tbl_YuE)
		BEGIN
			INSERT INTO tbl_YuE(EEBaoYuE,KuaiQianYuE,YuE)VALUES(0,0,0)
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
		BEGIN
			IF(@JiaoYiLeiBie IN(0,2))
			BEGIN
				UPDATE tbl_YuE SET KuaiQianYuE=KuaiQianYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
		END
		
		IF(@ZhiFuFangSHi=1 AND @JiaoYiStatus=1)--E额宝
		BEGIN
			IF(@JiaoYiLeiBie IN(2))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
			
			IF(@JiaoYiLeiBie IN(1,3,4,5,6))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
		END
	END
	
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-07
-- Description:	交易明细状态变更
-- =============================================
CREATE PROCEDURE [dbo].[proc_JiaoYiMingXi_SheZhiStatus]
	@HuiYuanId CHAR(36)
	,@ZhiFuFangShi TINYINT
	,@JiaoYiLeiBie TINYINT
	,@JiaoYiStatus TINYINT
	,@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @COUNT INT
	DECLARE @MingXiId CHAR(36)
	DECLARE @YuanJiaoYiStatus TINYINT
	DECLARE @JiaoYiJinE MONEY
	
	SELECT @COUNT=COUNT(*) FROM tbl_JA_Account WHERE OrderID=@DingDanId AND OrderType=@DingDanLeiXIng AND TransactionWay=@ZhiFuFangShi AND TransactionCate=@JiaoYiLeiBie AND UserId=@HuiYuanId
	
	IF (@COUNT<>1)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END	
	
	SELECT @MingXiId=MingXiId FROM tbl_JA_Account WHERE OrderID=@DingDanId AND OrderType=@DingDanLeiXIng AND TransactionWay=@ZhiFuFangShi AND TransactionCate=@JiaoYiLeiBie AND UserId=@HuiYuanId

	SELECT @YuanJiaoYiStatus=TransactionState,@JiaoYiJinE=Amounts FROM tbl_JA_Account WHERE MingXiId=@MingXiId
	
	IF(@YuanJiaoYiStatus<>2)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF(@JiaoYiStatus NOT IN(0,1))
	BEGIN
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	IF(@JiaoYiLeiBie<>1 AND @ZhiFuFangShi<>1 AND @DingDanLeiXing<>13)
	BEGIN
		SET @RetCode=-96
		RETURN @RetCode
	END	
	
	UPDATE tbl_JA_Account SET TransactionState=@JiaoYiStatus WHERE MingXiId=@MingXiId
	
	IF(@JiaoYiStatus=0)--交易失败
	BEGIN
		UPDATE tbl_Member SET TotalMoney=TotalMoney+@JiaoYiJinE WHERE MemberID=@HuiYuanId
	END
	
	IF(@JiaoYiStatus=1)--交易成功
	BEGIN
		UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@JiaoYiJinE
		UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
	END
	
	SET @RetCode=1
	RETURN @RetCode
END
GO

-- =============================================
-- Author:		邹磊<Author,,Name>
-- Create date: 2014-09-22<Create Date,,>
-- Description:	提现申请<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_JA_ApplyTiXian_ADD] 
	@ApplyStatus tinyint,
	@BankNum varchar(25),
    @JinE money,
	@KaiHuBank varchar(100),
	@KaiHuName varchar(50),
	@TiXianStatus tinyint,
	@TiXianTime  datetime,
    @UserId char(36),
    @BeiZhu nvarchar(250),
	@Result int output
    ,@TiXianId CHAR(36)
AS
BEGIN 
	DECLARE @error int
	SET @error=0
	SET @Result=0
	DECLARE @IdentityId INT
	DECLARE @TiXianJiaoYiHao NVARCHAR(50)
	DECLARE @YuE MONEY
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@UserId)
	BEGIN
		SET @Result=-99
		RETURN @Result 
	END
	
	
	SELECT @YuE=ISNULL(TotalMoney,0) FROM tbl_Member WHERE MemberId=@UserId
	
	IF(@YuE<@JinE)
	BEGIN
		SET @Result=-98
		RETURN @Result
	END
	
	INSERT INTO [tbl_JA_ApplyTiXian]([UserId],[KaiHuBank],[KaiHuName]
		,[BankNum],[JinE],[TiXianStatus]
		,[TiXianTime],[ApplyStatus],[ShenHeBeiZhu]
		,[BeiZhu],[TransactionID],[TiXianId])
	VALUES(@UserId,@KaiHuBank,@KaiHuName
		,@BankNum,@JinE,@TiXianStatus
		,@TiXianTime,@ApplyStatus,''
		,@BeiZhu,'',@TiXianId)
	SET @IdentityId=SCOPE_IDENTITY()
	
	SET @TiXianJiaoYiHao='TX'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
		
	UPDATE [tbl_JA_ApplyTiXian] SET [TransactionID]=@TiXianJiaoYiHao WHERE TiXianId=@TiXianId
	
	--UPDATE tbl_Member SET TotalMoney=TotalMoney-@JinE WHERE MemberId=@UserId
	--余额处理通过交易明细方法处理
	
	SET @Result=1
	
	RETURN @Result
END
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-06
-- Description:	交易明细写入
-- =============================================
ALTER PROCEDURE [dbo].[proc_JiaoYiMingXi_C]
	@MingXiId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@JiaoYiHao NVARCHAR(255)
	,@JiaoYiJinE MONEY
	,@JiaoYiShiJian DATETIME
	,@ZhiFuFangShi TINYINT
	,@JiaoYiLeiBie TINYINT
	,@JiaoYiStatus TINYINT
	,@JiaoYiMiaoShu NVARCHAR(255)
	,@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@ApiJiaoYiHao NVARCHAR(255)
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YongHuYuE MONEY
	DECLARE @errorcount INT
	SET @errorcount=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	BEGIN TRAN	
	
	IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
	BEGIN
		IF(@JiaoYiLeiBie IN(0))--充值
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney+@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@ZhiFuFangShi=1 AND @JiaoYiStatus=1)--E额宝
	BEGIN
		IF(@JiaoYiLeiBie IN(0,3,4,5,6))
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney+@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@JiaoYiLeiBie IN(1,2)) 
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney-@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@ZhiFuFangShi=1 AND @JiaoYiStatus=2)
	BEGIN
		IF(@JiaoYiLeiBie IN(1)) 
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney-@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR		
		END
	END
	
	SELECT @YongHuYuE=ISNULL(TotalMoney,0) FROM tbl_Member WHERE MemberID=@HuiYuanId
	
	IF(@errorcount=0)
	BEGIN
		INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		VALUES(@HuiYuanId,@JiaoYiHao,@JiaoYiJinE
			,@YongHuYuE,@JiaoYiShiJian,@ZhiFuFangShi
			,@JiaoYiLeiBie,@JiaoYiStatus,@JiaoYiMiaoShu
			,@DingDanId,@DingDanLeiXIng,''
			,@MingXiId,@ApiJiaoYiHao)
		SET @errorcount=@errorcount+@@ERROR
	END
	
	IF(@errorcount=0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM tbl_YuE)
		BEGIN
			INSERT INTO tbl_YuE(EEBaoYuE,KuaiQianYuE,YuE)VALUES(0,0,0)
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
		BEGIN
			IF(@JiaoYiLeiBie IN(0,2))
			BEGIN
				UPDATE tbl_YuE SET KuaiQianYuE=KuaiQianYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
		END
		
		IF(@ZhiFuFangSHi=1 AND @JiaoYiStatus=1)--E额宝
		BEGIN
			IF(@JiaoYiLeiBie IN(2))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
			
			IF(@JiaoYiLeiBie IN(1,3,4,5,6))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE
				SET @errorcount=@errorcount+@@ERROR
			END
		END
	END
	
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

ALTER TABLE dbo.tmp_tbl_ChongZhi ADD
	IdentityId int NOT NULL IDENTITY (1, 1)
GO
DECLARE @v sql_variant 
SET @v = N'自增编号'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tmp_tbl_ChongZhi', N'COLUMN', N'IdentityId'
GO

ALTER TABLE dbo.tmp_tbl_ChongZhi ADD
	ZhiFuFangShi int NOT NULL CONSTRAINT DF_tmp_tbl_ChongZhi_ZhiFuFangShi DEFAULT -1
GO
DECLARE @v sql_variant 
SET @v = N'支付方式'
EXECUTE sp_addextendedproperty N'MS_Description', @v, N'SCHEMA', N'dbo', N'TABLE', N'tmp_tbl_ChongZhi', N'COLUMN', N'ZhiFuFangShi'
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-10
-- Description:	充值新增
-- =============================================
CREATE PROCEDURE proc_ChongZhi_C
	@DingDanId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@JinE MONEY
	,@Issuetime DATETIME
	,@ZhiFuStatus TINYINT
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @IdentityId INT
	DECLARE @ChongZhiJiaoYiHao NVARCHAR(255)
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	INSERT INTO [tmp_tbl_ChongZhi]([OrderID],[OrderCode],[OperatorID]
		,[OptMoney],[Issuetime],[PayState]
		,[ZhiFuFangShi])
	VALUES(@DingDanId,'',@HuiYuanID
		,@JinE,@IssueTime,@ZhiFuStatus
		,-1)
	SET @IdentityId=SCOPE_IDENTITY()
	SET @ChongZhiJiaoYiHao='CZ'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
		
	UPDATE [tmp_tbl_ChongZhi] SET [OrderCode]=@ChongZhiJiaoYiHao WHERE [OrderID]=@DingDanId 
	
	SET @RetCode=1
	RETURN @RetCode
END
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-10
-- Description:	充值设置状态
-- =============================================
CREATE PROCEDURE proc_ChongZhi_SheZhiStatus
	@DingDanId CHAR(36)
	,@ZhiFuStatus TINYINT
	,@ZhiFuFangShi TINYINT
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	
	IF NOT EXISTS(SELECT 1 FROM [tmp_tbl_ChongZhi] WHERE OrderId=@DingDanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	UPDATE tmp_tbl_ChongZhi SET PayState =@ZhiFuStatus,ZhiFuFangShi=@ZhiFuFangShi WHERE OrderId=@DingDanId
	
	SET @RetCode=1
	RETURN @RetCode
END
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-10
-- Description:	充值记录
-- =============================================
CREATE VIEW [dbo].[view_ChongZhi]
AS
SELECT A.[OrderID] AS DingDanId
	,A.[OrderCode] AS JiaoYiHao
	,A.[OperatorID] AS HuiYuanId
	,A.[OptMoney] AS JinE
	,A.[Issuetime] AS IssueTime
	,A.[PayState] AS ZhiFuStatus
	,A.[ZhiFuFangShi] AS ZhiFuFangShi
	,B.MemberName AS HuiYuanName
	,B.Account AS HuiYuanYongHuMing
FROM [tmp_tbl_ChongZhi] AS A INNER JOIN tbl_Member AS B
ON A.OperatorId =B.MemberId
GO


-- =============================================
-- Author:		
-- Create date: 2014-11-06
-- Description:	余额宝增值
-- =============================================  
ALTER PROC [dbo].[Proc_Add_Payments]    
AS 
BEGIN  
	declare @Rate decimal(18,4)  
	declare @dayCount int 
	  
	if Exists(Select 1 From sysObjects Where Name ='tbl_InterestRate' And Type In ('S','U'))
	----判断利率是否设置，是否大于0，如果没设置或者利率小于0，则不执行  
	select @rate=isnull(interest,0) from tbl_InterestRate  
	select @dayCount=Count(0) from tbl_payments where datediff(day,DealDate,getdate())=0  

	---如果当天没有执行收益,则生成收益记录,避免重复记录
	if @rate>0 and @dayCount=0
	begin
		---每天定时执行，写入收益记录表
		insert into tbl_payments([MemID],[Account],[InterestRate]
			,[DayInCome],[DealDate],[ZengZhiId]
			,[JiaoYiHao],[Status])
		select memberID,TotalMoney,@rate
			,TotalMoney*@rate as DayInCome,getdate(),NEWID()
			,'',0
		from tbl_member where totalMoney>0
		  
		/*---更新用户表 总金额=总金额+每日收益  
		update a set a.TotalMoney=a.TotalMoney+isnull(b.dayIncome,0)  
		from tbl_member a  inner join tbl_payments b 
		on a.memberID=b.MemID where a.totalMoney>0 and datediff(day,b.DealDate,getdate())=0 */
	end 
	
	--写交易明细记录
	DECLARE @TEMP TABLE(ZengZhiId CHAR(36),IdentityId INT IDENTITY)
	DECLARE @COUNT INT
	
	INSERT INTO @TEMP(ZengZhiId)
	SELECT ZengZhiId FROM tbl_payments
	WHERE [Status]=0
	
	SELECT @COUNT=COUNT(*) FROM @TEMP
	
	DECLARE @i INT
	SET @i=1
	
	WHILE(@i<=@COUNT)
	BEGIN
	
		DECLARE @ZengZhiId CHAR(36)
		DECLARE @HuiYuanId CHAR(36)
		DECLARE @JiaoYiJinE MONEY
		DECLARE @JiaoYiShiJian DATETIME
		DECLARE @ZhiFuFangShi TINYINT
		DECLARE @JiaoYiLeiBie TINYINT
		DECLARE @JiaoYiStatus TINYINT
		DECLARE @JiaoYiHao NVARCHAR(50)
		DECLARE @DingDanLeiXing TINYINT
		DECLARE @TempRetCode INT
		DECLARE @MingXiId CHAR(36)
		
		SET @JiaoYiShiJian=GETDATE()
		SET @ZhiFuFangShi=1
		SET @JiaoYiLeiBie=6
		SET @JiaoYiStatus=1
		SET @DingDanLeiXing=12
		SET @MingXiId=NEWID()
		
		SELECT @ZengZhiId=ZengZhiId FROM @TEMP WHERE IdentityId=@i
		UPDATE tbl_PayMents SET JiaoYiHao='YEZZ'+CONVERT(VARCHAR(8),DealDate,112)+dbo.fn_PadLeft(PayId,'0',5) WHERE ZengZhiId=@ZengZhiId
		SELECT @HuiYuanId=[MemID],@JiaoYiJinE=[DayInCome],@JiaoYiHao=[JiaoYiHao] FROM tbl_payments WHERE ZengZhiId=@ZengZhiId
		
		IF(@JiaoYiJinE>0)
		BEGIN
			EXEC proc_JiaoYiMingXi_C @MingXiId=@MingXiId
				,@HuiYuanId=@HuiYuanId
				,@JiaoYiHao=@JiaoYiHao
				,@JiaoYiJinE=@JiaoYiJinE
				,@JiaoYiShiJian=@JiaoYiShiJian
				,@ZhiFuFangShi=@ZhiFuFangSHi
				,@JiaoYiLeiBie=@JiaoYiLeiBie
				,@JiaoYiStatus=@JiaoYiStatus
				,@JiaoYiMiaoShu=''
				,@DingDanId=@ZengZhiId
				,@DingDanLeiXing=@DingDanLeiXing
				,@ApiJiaoYiHao=''
				,@RetCode=@TempRetCode OUTPUT			
		END	
		
		UPDATE tbl_payments SET [Status]=1 WHERE ZengZhiId=@ZengZhiId
		SET @i=@i+1
	END	
END 
GO


--同步订单付款状态枚举值
UPDATE tbl_ShangChengDingDan SET PayState=0 WHERE PayState=1
UPDATE tbl_ShangChengDingDan SET PayState=1 WHERE PayState=2
GO
UPDATE tbl_HotelOrder SET PaymentState=0 WHERE PaymentState=1
UPDATE tbl_HotelOrder SET PaymentState=1 WHERE PaymentState=2
GO
UPDATE tbl_TuanGouDingDan SET PayState=0 WHERE PayState=1
UPDATE tbl_TuanGouDingDan SET PayState=1 WHERE PayState=2
GO
UPDATE tmp_tbl_ChongZhi SET PayState=0 WHERE PayState=1
UPDATE tmp_tbl_ChongZhi SET PayState=1 WHERE PayState=2
GO

--同步交易明细支付方式枚举值
UPDATE tbl_ja_account set transactionway=0 WHERE  LEN(transactionid)=12
UPDATE tbl_ja_account set transactionway=1 WHERE  LEN(transactionid)<>12
GO


/****** 对象:  Table [dbo].[tbl_ZiZuTuan]    脚本日期: 11/11/2014 15:35:08 ******/
CREATE TABLE [dbo].[tbl_ZiZuTuan](
	[ZuTuanId] [char](36) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[XDRId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[RenShu] [int] NULL,
	[CarMoney] [money] NULL,
	[ZaoCanNum] [int] NULL,
	[ZaoCanJia] [money] NULL,
	[WuCanNum] [int] NULL,
	[WuCanJia] [money] NULL,
	[WanCanNum] [int] NULL,
	[WanCanJia] [money] NULL,
	[CanWuJia] [money] NULL,
	[BaoXian] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	[BXJiaGe] [money] NULL,
	[BaoXianDay] [int] NULL,
	[DaoYouNum] [int] NULL,
	[DaoYouMoney] [money] NULL,
	[ZCMoney] [money] NULL,
	[ZongMOney] [money] NULL,
	[ChuFaTime] [datetime] NULL,
	[IssueTime] [datetime] NULL,
	[XianLuId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[XianLuName] [varchar](200) COLLATE Chinese_PRC_CI_AS NULL,
	[TourId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[CRJiage] [money] NOT NULL,
	[ETJiage] [money] NULL,
	[UserType] [tinyint] NULL,
	[OrderCode] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
 CONSTRAINT [PK_tbl_ZiZuTuan] PRIMARY KEY CLUSTERED 
(
	[ZuTuanId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'自组团Id' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'ZuTuanId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'下单人id' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'XDRId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'成团人数' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'RenShu'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'车辆人均' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'CarMoney'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'早餐数' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'ZaoCanNum'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'早餐价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'ZaoCanJia'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'午餐数' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'WuCanNum'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'午餐价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'WuCanJia'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'晚餐数' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'WanCanNum'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'晚餐价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'WanCanJia'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'餐费人均价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'CanWuJia'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'保险方式（人身，交通）' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'BaoXian'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'保险价格（一天）' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'BXJiaGe'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'保险天数' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'BaoXianDay'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'导游数' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'DaoYouNum'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'导游人均' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'DaoYouMoney'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'租车总价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'ZCMoney'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'总价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'ZongMOney'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'出发时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'ChuFaTime'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'下单时间' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'IssueTime'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'线路id' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'XianLuId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'成人价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'CRJiage'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'儿童价' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'ETJiage'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'会员类型' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuan', @level2type=N'COLUMN',@level2name=N'UserType'
GO


/****** 对象:  Table [dbo].[tbl_ZiZuTuanXingCheng]    脚本日期: 11/11/2014 15:35:47 ******/
CREATE TABLE [dbo].[tbl_ZiZuTuanXingCheng](
	[OrderId] [int] IDENTITY(1,1) NOT NULL,
	[ZiZuTuanId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[ZucheId] [char](36) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[CheNum] [int] NULL,
	[QiDian] [varchar](150) COLLATE Chinese_PRC_CI_AS NULL,
	[ZhongDian] [varchar](150) COLLATE Chinese_PRC_CI_AS NULL,
	[FeiYong] [money] NULL,
	[GongLiShu] [numeric](10, 3) NOT NULL,
 CONSTRAINT [PK_tbl_ZiZuTuanXingCheng] PRIMARY KEY CLUSTERED 
(
	[OrderId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'主id' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'OrderId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'自组团id' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'ZiZuTuanId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'车辆id' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'ZucheId'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'租车数量' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'CheNum'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'起点' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'QiDian'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'终点' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'ZhongDian'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'费用' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'FeiYong'
GO
EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'公里数' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'tbl_ZiZuTuanXingCheng', @level2type=N'COLUMN',@level2name=N'GongLiShu'
GO



/****** 对象:  StoredProcedure [dbo].[proc_JA_ZiZuTuan_ADD]    脚本日期: 11/11/2014 15:36:02 ******/
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[proc_JA_ZiZuTuan_ADD] 

@ZuTuanId char(36),
	@XDRId char(36),
    @RenShu int,
	@CarMoney money,
	@ZaoCanNum int,
	@ZaoCanJia money,
	@WuCanNum  int,
    @WuCanJia money,
    @WanCanNum int,
	@WanCanJia money
    ,@CanWuJia money
      ,@BaoXian varchar(50)
      ,@BXJiaGe money
      ,@BaoXianDay int
      ,@DaoYouNum int
      ,@DaoYouMoney money
      ,@ZCMoney money
      ,@ZongMOney money
      ,@ChuFaTime datetime
      ,@IssueTime datetime
      ,@XianLuId char(36)
      ,@XianLuName varchar(200)
      ,@TourId char(36)
      ,@CRJiage money
      ,@ETJiage money
      ,@UserType tinyint,
       @Result int output
AS
DECLARE @error int
	SET @error=0
	SET @Result=0
	declare @LiuShuiHiao int,@OrderCode varchar(50)
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_ZiZuTuan]
	SET @OrderCode='ZT'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)	
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@XDRId)
	BEGIN
		SET @Result=-99
		RETURN @Result 
	END
	
	INSERT INTO [tbl_ZiZuTuan]([ZuTuanId]
      ,[XDRId]
      ,[RenShu]
      ,[CarMoney]
      ,[ZaoCanNum]
      ,[ZaoCanJia]
      ,[WuCanNum]
      ,[WuCanJia]
      ,[WanCanNum]
      ,[WanCanJia]
      ,[CanWuJia]
      ,[BaoXian]
      ,[BXJiaGe]
      ,[BaoXianDay]
      ,[DaoYouNum]
      ,[DaoYouMoney]
      ,[ZCMoney]
      ,[ZongMOney]
      ,[ChuFaTime]
      ,[IssueTime]
      ,[XianLuId]
      ,[XianLuName]
      ,[TourId]
      ,[CRJiage]
      ,[ETJiage]
      ,[UserType]
      ,[OrderCode])
	VALUES(@ZuTuanId
      ,@XDRId
      ,@RenShu
      ,@CarMoney
      ,@ZaoCanNum
      ,@ZaoCanJia
      ,@WuCanNum
      ,@WuCanJia
      ,@WanCanNum
      ,@WanCanJia
      ,@CanWuJia
      ,@BaoXian
      ,@BXJiaGe
      ,@BaoXianDay
      ,@DaoYouNum
      ,@DaoYouMoney
      ,@ZCMoney
      ,@ZongMOney
      ,@ChuFaTime
      ,@IssueTime
      ,@XianLuId
      ,@XianLuName
      ,@TourId
      ,@CRJiage
      ,@ETJiage
      ,@UserType
      ,@OrderCode)	
	SET @Result=1
	
	RETURN @Result

GO




alter table tbl_ZiZuTuan add OrderState tinyint default 0
go 



alter table tbl_JA_DanDuZuTuan add MSCarMoney money
go 
alter table tbl_JA_DanDuZuTuan add MSZaoCanMoney money
go 
alter table tbl_JA_DanDuZuTuan add MSWuCanMoney money
go 
alter table tbl_JA_DanDuZuTuan add MSWanCanMoney money
go 
alter table tbl_JA_DanDuZuTuan add MSRSYiWai money
go 
alter table tbl_JA_DanDuZuTuan add MSJTYiWai money
go 
alter table tbl_JA_DanDuZuTuan add MSDaoYouMoney money
go 


ALTER TABLE dbo.tbl_XianLu ADD
	XianLuZT int NOT NULL CONSTRAINT DF_tbl_XianLu_XianLuZT DEFAULT 0
GO
ALTER VIEW [dbo].[view_XianLu]
AS
SELECT   A.XianLuId, A.AreaId, A.RouteName, A.TianShu, A.DepProvinceId, A.DepCityId, A.ArrProvinceId, A.ArrCityId, A.JiHuaRenShu, A.SCJCR, A.SCJET, A.JSJCR, 
                      A.JSJET, A.TingTianShu, A.ChuFaJiaoTong, A.FanChengJiaoTong, A.JiHeFangShi, A.TeSe, A.TeSeFilePath, A.TuJing, A.QianZheng, A.QianZhengFilePath, 
                      A.GuanZhuShu, A.LxrName, A.LxrTelephone, A.LxrQQ, A.LxrMobile, A.Description, A.Keywords, A.OperatorId, A.IssueTime, A.LatestId, A.LatestTime, 
                      A.Line_Source, A.LineType, A.IdentityId, A.AreaName, A.InterfaceID, B.TourId, B.LDate, B.RDate, B.Status,
                          (SELECT     AVG(ManYiDu) AS ManYiDu
                            FROM          dbo.tbl_XianLuDianPing
                            WHERE      (XianLuId = A.XianLuId)) AS ManYiDu,
                          (SELECT     COUNT(1) AS Expr1
                            FROM          dbo.tbl_XianLuDianPing AS tbl_XianLuDianPing_1
                            WHERE      (XianLuId = A.XianLuId)) AS DianPingShu, B.JSJCR AS JSJCR1, B.JSJET AS JSJET1, A.CFCS,A.xianluzt
FROM         dbo.tbl_XianLu AS A LEFT OUTER JOIN
                      dbo.view_XianLuTour_ZuiJinFaBan AS B ON A.XianLuId = B.XianLuId
GO



alter table tbl_JA_DanDuZuTuan alter column ZaoCanMoney varchar(200)
alter table tbl_JA_DanDuZuTuan alter column WuCanMoney varchar(200)
alter table tbl_JA_DanDuZuTuan alter column WanCanMoney varchar(200)
alter table tbl_JA_DanDuZuTuan alter column RSYiWai varchar(200)
alter table tbl_JA_DanDuZuTuan alter column JTYiWai varchar(200)
alter table tbl_JA_DanDuZuTuan alter column MSZaoCanMoney varchar(200)
alter table tbl_JA_DanDuZuTuan alter column MSWuCanMoney varchar(200)
alter table tbl_JA_DanDuZuTuan alter column MSWanCanMoney varchar(200)
alter table tbl_JA_DanDuZuTuan alter column MSRSYiWai varchar(200)
alter table tbl_JA_DanDuZuTuan alter column MSJTYiWai varchar(200)




alter table tbl_ZiZuTuan add RSBXJiaGe money
go 
alter table tbl_ZiZuTuan add JTBXJiaGe money
go 
alter table tbl_ZiZuTuan add AgencyId char(36)
go 
alter table tbl_ZiZuTuan add AgencyJinE money
go 
alter table tbl_ZiZuTuan add ETAgencyJinE money
go 
alter table tbl_ZiZuTuan add ZongJinE money
go 



ALTER PROCEDURE [dbo].[proc_JA_ZiZuTuan_ADD] 
	 

@ZuTuanId char(36),
	@XDRId char(36),
    @RenShu int,
	@CarMoney money,
	@ZaoCanNum int,
	@ZaoCanJia money,
	@WuCanNum  int,
    @WuCanJia money,
    @WanCanNum int,
	@WanCanJia money
    ,@CanWuJia money
      ,@BaoXian varchar(50)
      ,@BXJiaGe money
      ,@BaoXianDay int
      ,@DaoYouNum int
      ,@DaoYouMoney money
      ,@ZCMoney money
      ,@ZongMOney money
      ,@ChuFaTime datetime
      ,@IssueTime datetime
      ,@XianLuId char(36)
      ,@XianLuName varchar(200)
      ,@TourId char(36)
      ,@CRJiage money
      ,@ETJiage money
      ,@UserType tinyint,
      @RSBXJiaGe money,
      @JTBXJiaGe money,
      @AgencyId char(36),
      @AgencyJinE money,
      @ETAgencyJinE money,
       @Result int output
AS
DECLARE @error int
	SET @error=0
	SET @Result=0
	declare @LiuShuiHiao int,@OrderCode varchar(50)
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_ZiZuTuan]
	SET @OrderCode='ZT'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)	
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@XDRId)
	BEGIN
		SET @Result=-99
		RETURN @Result 
	END
	
	INSERT INTO [tbl_ZiZuTuan]([ZuTuanId]
      ,[XDRId]
      ,[RenShu]
      ,[CarMoney]
      ,[ZaoCanNum]
      ,[ZaoCanJia]
      ,[WuCanNum]
      ,[WuCanJia]
      ,[WanCanNum]
      ,[WanCanJia]
      ,[CanWuJia]
      ,[BaoXian]
      ,[BXJiaGe]
      ,[BaoXianDay]
      ,[DaoYouNum]
      ,[DaoYouMoney]
      ,[ZCMoney]
      ,[ZongMOney]
      ,[ChuFaTime]
      ,[IssueTime]
      ,[XianLuId]
      ,[XianLuName]
      ,[TourId]
      ,[CRJiage]
      ,[ETJiage]
      ,[UserType],
      [RSBXJiaGe],
      [JTBXJiaGe],
      [AgencyId],
      [AgencyJinE],
      [ETAgencyJinE],
      [ZongJinE]
      ,[OrderCode])
	VALUES(@ZuTuanId
      ,@XDRId
      ,@RenShu
      ,@CarMoney
      ,@ZaoCanNum
      ,@ZaoCanJia
      ,@WuCanNum
      ,@WuCanJia
      ,@WanCanNum
      ,@WanCanJia
      ,@CanWuJia
      ,@BaoXian
      ,@BXJiaGe
      ,@BaoXianDay
      ,@DaoYouNum
      ,@DaoYouMoney
      ,@ZCMoney
      ,@ZongMOney
      ,@ChuFaTime
      ,@IssueTime
      ,@XianLuId
      ,@XianLuName
      ,@TourId
      ,@CRJiage
      ,@ETJiage
      ,@UserType
      ,@RSBXJiaGe,
      @JTBXJiaGe,
      @AgencyId,
      @AgencyJinE,
      @ETAgencyJinE,
      @CRJiage*@RenShu,
      @OrderCode)	
	SET @Result=1
	
	RETURN @Result

GO

alter table tbl_JA_ZuCheInfo add IsIndex tinyint default 0
go 
update tbl_JA_ZuCheInfo SET IsIndex=0
go

alter table tbl_ScenicArea add IsIndex tinyint default 0
go 

update tbl_ScenicArea SET IsIndex=0
GO


alter table tbl_Hotel add IsIndex tinyint default 0
go 

update tbl_Hotel SET IsIndex=0
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[view_Hotel2]
AS
SELECT     A.HotelId, A.HotelCode, A.IsIndex, A.HotelName, A.HotelNameEn, A.Latitude, A.Longitude, A.ServiceTel, A.ProvinceId, A.CityId, A.CountyId, A.Address, 
                      A.EnAddress, A.Star, A.PostalCode, A.OpenDate, A.Fitment, A.RoomQuantity, A.Floor, A.LongDesc, A.Transport, A.AdditionalCost, A.Status, A.IssueTime, 
                      A.IsDelete, A.IsHot, A.IsRecommend, A.CityCode, A.InterfaceId,
                          (SELECT     B.RoomTypeId, B.HotelId, B.RoomName, B.TotalNumber, B.RoomType, B.RoomArea, B.Floor, B.BedType, B.BedHeight, B.BedWidth, 
                                                   B.MaxGuestNum, B.IsSmoking, B.IsInternet, B.IsInternetPrice, B.Orientation, B.IsBreakfast, B.IsBreakfastPrice, B.IsWindow, B.IsAddBed, 
                                                   B.IsAddBedPrice, B.Payment, B.[Desc], B.IssueTime, B.OperatorId, B.SortId, B.RoomStatus, B.BedTypeDescription, C.AmountPrice, 
                                                   C.PreferentialPrice, C.SettlementPrice
                            FROM          tbl_HotelRoomType AS B LEFT JOIN
                                                   tbl_HotelRoomRate AS C ON B.RoomTypeId = C.RoomTypeId AND datediff(day, C.StartDate, getdate()) >= 0 AND datediff(day, C.EndDate, 
                                                   getdate()) <= 0
                            WHERE      B.HotelId = A.HotelId AND B.IsDelete = '0' FOR xml raw, root('Root')) AS HotelRoomType,
                          (SELECT     D .ImgId, D .HotelId, D .ImgCategory, D .FilePath, D .[Desc], D .IssueTime, D .OperatorId
                            FROM          tbl_HotelImg AS D
                            WHERE      D .HotelId = A.HotelId FOR xml raw, root('Root')) AS HotelImg/*		as HotelLandMark	*/ ,
                          (SELECT     A1.HotelId, A1.LandMarkId,
                                                       (SELECT     Name
                                                         FROM          tbl_SysDiBiao
                                                         WHERE      Id = A1.LandMarkId) AS Por
                            FROM          tbl_HotelLandMark AS A1
                            WHERE      A1.HotelId = A.HotelId FOR XML RAW, ROOT('Root')) AS HotelLandMark, A.Mobile, A.JieSuanType
FROM         tbl_Hotel AS A
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


DELETE  FROM  tbl_ZiZuTuan
DELETE  FROM  tbl_ZiZuTuanXingCheng
GO

alter table tbl_TuanGouChanPin add IsIndex tinyint not null default 0
go 

alter table tbl_QianZheng add IsIndex tinyint not null default 0
go 


GO
/****** 对象:  StoredProcedure [dbo].[Proc_Add_Payments]    脚本日期: 11/19/2014 09:29:26 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		
-- Create date: 2014-11-06
-- Description:	余额宝增值
-- =============================================  
ALTER PROC [dbo].[Proc_Add_Payments]    
AS
BEGIN  
	declare @Rate decimal(18,4)  
	declare @dayCount int 
	  
	if Exists(Select 1 From sysObjects Where Name ='tbl_InterestRate' And Type In ('S','U'))
	----判断利率是否设置，是否大于0，如果没设置或者利率小于0，则不执行  
	select @rate=isnull(interest,0) from tbl_InterestRate  
	select @dayCount=Count(0) from tbl_payments where datediff(day,DealDate,getdate())=0  

	---如果当天没有执行收益,则生成收益记录,避免重复记录
	if @rate>0 and @dayCount=0
	begin
		---每天定时执行，写入收益记录表
		insert into tbl_payments([MemID],[Account],[InterestRate]
			,[DayInCome],[DealDate],[ZengZhiId]
			,[JiaoYiHao],[Status])
		select memberID,TotalMoney,@rate
			,TotalMoney*@rate as DayInCome,getdate(),NEWID()
			,'',0
		from tbl_member where totalMoney>0
		  
		/*---更新用户表 总金额=总金额+每日收益  
		update a set a.TotalMoney=a.TotalMoney+isnull(b.dayIncome,0)  
		from tbl_member a  inner join tbl_payments b 
		on a.memberID=b.MemID where a.totalMoney>0 and datediff(day,b.DealDate,getdate())=0 */
	end 
--	
--	--写交易明细记录
--	DECLARE @TEMP TABLE(ZengZhiId CHAR(36),IdentityId INT IDENTITY)
--	DECLARE @COUNT INT
--	
--	INSERT INTO @TEMP(ZengZhiId)
--	SELECT ZengZhiId FROM tbl_payments
--	WHERE [Status]=0
--	
--	SELECT @COUNT=COUNT(*) FROM @TEMP
--	
--	DECLARE @i INT
--	SET @i=1
--	
--	WHILE(@i<=@COUNT)
--	BEGIN
--	
--		DECLARE @ZengZhiId CHAR(36)
--		DECLARE @HuiYuanId CHAR(36)
--		DECLARE @JiaoYiJinE MONEY
--		DECLARE @JiaoYiShiJian DATETIME
--		DECLARE @ZhiFuFangShi TINYINT
--		DECLARE @JiaoYiLeiBie TINYINT
--		DECLARE @JiaoYiStatus TINYINT
--		DECLARE @JiaoYiHao NVARCHAR(50)
--		DECLARE @DingDanLeiXing TINYINT
--		DECLARE @TempRetCode INT
--		DECLARE @MingXiId CHAR(36)
--		
--		SET @JiaoYiShiJian=GETDATE()
--		SET @ZhiFuFangShi=1
--		SET @JiaoYiLeiBie=6
--		SET @JiaoYiStatus=1
--		SET @DingDanLeiXing=12
--		SET @MingXiId=NEWID()
--		
--		SELECT @ZengZhiId=ZengZhiId FROM @TEMP WHERE IdentityId=@i
--		UPDATE tbl_PayMents SET JiaoYiHao='YEZZ'+CONVERT(VARCHAR(8),DealDate,112)+dbo.fn_PadLeft(PayId,'0',5) WHERE ZengZhiId=@ZengZhiId
--		SELECT @HuiYuanId=[MemID],@JiaoYiJinE=[DayInCome],@JiaoYiHao=[JiaoYiHao] FROM tbl_payments WHERE ZengZhiId=@ZengZhiId
--		
--		IF(@JiaoYiJinE>0)
--		BEGIN
--			EXEC proc_JiaoYiMingXi_C @MingXiId=@MingXiId
--				,@HuiYuanId=@HuiYuanId
--				,@JiaoYiHao=@JiaoYiHao
--				,@JiaoYiJinE=@JiaoYiJinE
--				,@JiaoYiShiJian=@JiaoYiShiJian
--				,@ZhiFuFangShi=@ZhiFuFangSHi
--				,@JiaoYiLeiBie=@JiaoYiLeiBie
--				,@JiaoYiStatus=@JiaoYiStatus
--				,@JiaoYiMiaoShu=''
--				,@DingDanId=@ZengZhiId
--				,@DingDanLeiXing=@DingDanLeiXing
--				,@ApiJiaoYiHao=''
--				,@RetCode=@TempRetCode OUTPUT			
--		END	
--		
--		UPDATE tbl_payments SET [Status]=1 WHERE ZengZhiId=@ZengZhiId
--		SET @i=@i+1
--	END	
END
GO


GO
/****** 对象:  View [dbo].[View_TuanGou]    脚本日期: 11/19/2014 14:40:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_TuanGou]
AS
SELECT     dbo.tbl_TuanGouChanPin.*,
(select count(OrderID) from dbo.tbl_TuanGouDingDan 
where ProductID =dbo.tbl_TuanGouChanPin.ID) as Salevolume
FROM         dbo.tbl_TuanGouChanPin
GO

-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-09
-- Description:	写入商城订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangChengDingDan_Insert]
		@OrderID  CHAR(36)
	   ,@ProductID CHAR(36)
	   ,@ProductNum INT
	   ,@OrderCode NVARCHAR(50) OUTPUT
	   ,@OrderPrice  MONEY
	   ,@OrderState TINYINT
	   ,@PayState TINYINT
	   ,@ContactID CHAR(36)
	   ,@ContactName NVARCHAR(50)
	   ,@ContactPhone NVARCHAR(50)
	   ,@IssueTime DATETIME
	   ,@Remark NVARCHAR(MAX)
	   ,@AddressID INT
	   ,@ProvinceID INT
	   ,@CityID INT
	   ,@DistrictID INT
	   ,@AddressInfo NVARCHAR(255)
	   ,@UserID CHAR(36)
	   ,@UserName NVARCHAR(50)
	   ,@IsDefault CHAR(1)
	   ,@SupplierID CHAR(36)
	   ,@SupplierMoney MONEY
	   ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
    DECLARE @Address INT
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0
	SET @Address=@AddressID
 	DECLARE @ShengYu INT
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ShangChengDingDan
	SET @OrderCode='SC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	SELECT @ShengYu=stocknum FROM dbo.view_ShangCheng WHERE ProductID=@ProductID

 IF(@shengyu<@ProductNum)
 BEGIN
	SET @RetCode=-99
	RETURN @RetCode
 END
 BEGIN TRAN
 IF(@AddressID=0)
 BEGIN
	 --写入地址信息
	 IF(@IsDefault=0)
		 BEGIN
			INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
	  ELSE
		  BEGIN
		  UPDATE tbl_DiZhi SET IsDefault=0 WHERE UserID=@UserID
		  INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
		  SET @Address=@@IDENTITY
 END
 ELSE
 BEGIN
		UPDATE tbl_DiZhi SET ProvinceID=@ProvinceID,CityID=@CityID,DistrictID=@DistrictID,AddressInfo=@AddressInfo WHERE AddressID=@AddressID
 END
  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_ShangChengDingDan (OrderID ,ProductID ,ProductNum ,OrderCode ,OrderPrice ,OrderState ,PayState ,ContactID ,ContactName ,ContactPhone ,IssueTime ,Remark,ProvinceID,CityID,DistrictID,AddressInfo,SupplierID,SupplierMoney)
		 VALUES (@OrderID ,@ProductID ,@ProductNum ,@OrderCode ,@OrderPrice ,@OrderState ,@PayState ,@ContactID ,@ContactName ,@ContactPhone ,@IssueTime ,@Remark,@ProvinceID,@CityID,@DistrictID,@AddressInfo,@SupplierID,@SupplierMoney)
		 
 
	   
	   
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO


/****** 对象:  View [dbo].[View_DingDan]    脚本日期: 11/24/2014 14:19:35 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT     a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT     b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT     c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT     d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT     e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT     f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT     g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID
FROM         tbl_ShangChengDingDan AS g
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝信息
-- =============================================
ALTER VIEW [dbo].[view_FenSi]
AS
SELECT A.MemberID AS HuiYuanId
	,A.Account AS HuiYuanYongHuMing
	,A.MemberName AS HuiYuanXingMing
	,A.ShangJiDaiLiShangId
	,A.ShangJiDaiLiShangHuiYuanId
	,A.RegisterTime
	,B.WebsiteName AS ShangJiDaiLiShangWangZhanName
	,B.WebSite AS ShangJiDaiLiShangYuMing
	,C.WebsiteName AS HuiYuanWangZhanName
	,C.WebSite AS HuiYuanYuMing
	,A.RegisterTime AS ZhuCeShiJian
	,A.ValidDate AS DaoQiShiJian
	,A.Mobile AS HuiYuanShouJi
FROM tbl_Member AS A LEFT OUTER JOIN tbl_JA_Sellers AS B
ON A.ShangJiDaiLiShangId=B.Id AND A.ShangJiDaiLiShangHuiYuanId=B.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS C
ON A.MemberId=C.MemberID

GO




alter table tbl_JA_DanDuZuTuan add DXRS int not null default 0
go 
alter table tbl_JA_DanDuZuTuan add CXRS int not null default 0
go 
alter table tbl_JA_DanDuZuTuan add CJRS int not null default 0
go 

alter table tbl_JA_DanDuZuTuan add DiPeiDaoYou money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add MSDiPeiDaoYou money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add DXDiPeiDaoYou money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add MSDXDiPeiDaoYou money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add DXDaoYouMoney money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add MSDXDaoYouMoney money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add CJDiPeiDaoYou money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add MSCJDiPeiDaoYou money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add CJDaoYouMoney money not null default 0
go 
alter table tbl_JA_DanDuZuTuan add MSCJDaoYouMoney money not null default 0
go 

alter table tbl_ZiZuTuan add ChengTuanNum int not null default 0
go
alter table tbl_ZiZuTuan add ErTongNum int not null default 0
go 
alter table tbl_ZiZuTuan add DiPeiDaoYouNum int not null default 0
go 
alter table tbl_ZiZuTuan add DiPeiRJJia money not null default 0
go 
alter table tbl_ZiZuTuan add QuanPeiRJJia money not null default 0
go 

alter table tbl_ZiZuTuan add HangBanId varchar(50)
go 




ALTER PROCEDURE [dbo].[proc_JA_ZiZuTuan_ADD] 
	 

@ZuTuanId char(36),
	@XDRId char(36),
    @RenShu int,
	@CarMoney money,
	@ZaoCanNum int,
	@ZaoCanJia money,
	@WuCanNum  int,
    @WuCanJia money,
    @WanCanNum int,
	@WanCanJia money
    ,@CanWuJia money
      ,@BaoXian varchar(50)
      ,@BXJiaGe money
      ,@BaoXianDay int
      ,@DaoYouNum int
      ,@DaoYouMoney money
      ,@ZCMoney money
      ,@ZongMOney money
      ,@ChuFaTime datetime
      ,@IssueTime datetime
      ,@XianLuId char(36)
      ,@XianLuName varchar(200)
      ,@TourId char(36)
      ,@CRJiage money
      ,@ETJiage money
      ,@UserType tinyint,
      @RSBXJiaGe money,
      @JTBXJiaGe money,
      @AgencyId char(36),
      @AgencyJinE money,
      @ETAgencyJinE money,
      @ChengTuanNum int,
      @ErTongNum int,
      @DiPeiDaoYouNum int,
      @DiPeiRJJia money,
      @QuanPeiRJJia money,
      @HangBanId varchar(50),
       @Result int output
AS
DECLARE @error int
	SET @error=0
	SET @Result=0
	declare @LiuShuiHiao int,@OrderCode varchar(50)
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_ZiZuTuan]
	SET @OrderCode='ZT'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)	
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@XDRId)
	BEGIN
		SET @Result=-99
		RETURN @Result 
	END
	
	INSERT INTO [tbl_ZiZuTuan]([ZuTuanId]
      ,[XDRId]
      ,[RenShu]
      ,[CarMoney]
      ,[ZaoCanNum]
      ,[ZaoCanJia]
      ,[WuCanNum]
      ,[WuCanJia]
      ,[WanCanNum]
      ,[WanCanJia]
      ,[CanWuJia]
      ,[BaoXian]
      ,[BXJiaGe]
      ,[BaoXianDay]
      ,[DaoYouNum]
      ,[DaoYouMoney]
      ,[ZCMoney]
      ,[ZongMOney]
      ,[ChuFaTime]
      ,[IssueTime]
      ,[XianLuId]
      ,[XianLuName]
      ,[TourId]
      ,[CRJiage]
      ,[ETJiage]
      ,[UserType],
      [RSBXJiaGe],
      [JTBXJiaGe],
      [AgencyId],
      [AgencyJinE],
      [ETAgencyJinE],
      [ZongJinE],
      [ChengTuanNum],
      [ErTongNum],
      [DiPeiDaoYouNum],
      [DiPeiRJJia],
      [QuanPeiRJJia],
      [HangBanId]
      ,[OrderCode])
	VALUES(@ZuTuanId
      ,@XDRId
      ,@RenShu
      ,@CarMoney
      ,@ZaoCanNum
      ,@ZaoCanJia
      ,@WuCanNum
      ,@WuCanJia
      ,@WanCanNum
      ,@WanCanJia
      ,@CanWuJia
      ,@BaoXian
      ,@BXJiaGe
      ,@BaoXianDay
      ,@DaoYouNum
      ,@DaoYouMoney
      ,@ZCMoney
      ,@ZongMOney
      ,@ChuFaTime
      ,@IssueTime
      ,@XianLuId
      ,@XianLuName
      ,@TourId
      ,@CRJiage
      ,@ETJiage
      ,@UserType
      ,@RSBXJiaGe,
      @JTBXJiaGe,
      @AgencyId,
      @AgencyJinE,
      @ETAgencyJinE,
      @CRJiage*@RenShu+@ETJiage*@ErTongNum,
      @ChengTuanNum,
      @ErTongNum,
      @DiPeiDaoYouNum,
      @DiPeiRJJia,
      @QuanPeiRJJia,
      @HangBanId,
      @OrderCode)	
	SET @Result=1
	
	RETURN @Result

Go


--粉丝交易相关调整 2014-12-04
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝信息
-- =============================================
ALTER VIEW [dbo].[view_FenSi]
AS
SELECT A.MemberID AS HuiYuanId--会员编号
	,A.Account AS HuiYuanYongHuMing
	,A.MemberName AS HuiYuanXingMing
	,A.ShangJiDaiLiShangId--会员上级代理商编号
	,A.ShangJiDaiLiShangHuiYuanId--会员上级代理商会员编号
	,A.RegisterTime
	,B.WebsiteName AS ShangJiDaiLiShangWangZhanName--会员上级代理商网站名称
	,B.WebSite AS ShangJiDaiLiShangYuMing--会员上级代理商域名
	,C.WebsiteName AS HuiYuanWangZhanName--会员代理网站名称
	,C.WebSite AS HuiYuanYuMing--会员代理商域名
	,A.RegisterTime AS ZhuCeShiJian
	,A.ValidDate AS DaoQiShiJian
	,A.Mobile AS HuiYuanShouJi
	,C.Id AS HuiYuanDaiLiShangId--会员代理商编号
FROM tbl_Member AS A LEFT OUTER JOIN tbl_JA_Sellers AS B
ON A.ShangJiDaiLiShangId=B.Id AND A.ShangJiDaiLiShangHuiYuanId=B.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS C
ON A.MemberId=C.MemberID
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝交易信息
-- =============================================
ALTER VIEW [dbo].[view_FenSiJiaoYi]
AS
--线路订单
SELECT A.OrderId AS DingDanId--订单编号
	,A.IssueTime AS XiaDanShiJian--下单时间
	,A.OperatorId AS XianDanRenId--下单人编号
	,A.JinE AS DingDanJinE--订单金额
	,A.Status AS DingDanStatus--订单状态
	,A.FuKuanStatus AS FuKuanStatus--付款状态
	,A.AgencyId AS DaiLiShangId--代理商编号
	,A.AgencyJinE AS DaiLiShangJinE--代理商金额
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号
	,(SELECT TOP 1 A1.Name FROM tbl_XianLuTourOrderYouKe AS A1 WHERE A1.OrderId=A.OrderId) AS KeRenName--客人姓名
	,C.RouteName AS CPName--产品名称
	,(CASE D.RouteType WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END) AS DingDanLeiXing--订单类型
	,E.MemberName AS XiaDanRenName--下单人姓名
	,F.MemberId AS DaiLiShangHuiYuanId--代理商会员编号
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
FROM tbl_XianLuTourOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_XianLu AS C
ON A.XianLuId=C.XianLuId LEFT OUTER JOIN tbl_SysArea AS D
ON C.AreaId=D.ID LEFT OUTER JOIN tbl_Member AS E
ON A.OperatorId=E.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId

UNION ALL
--商城订单
SELECT A.OrderID AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.ContactID AS XiaDanRenId
	,ISNULL(A.OrderPrice,0) AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,A.SupplierMoney AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.ProductName AS CPName
	,3 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
FROM tbl_ShangChengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.ContactID=B.MemberID LEFT OUTER JOIN tbl_ShangChengChanPin AS C
ON A.ProductId=C.ProductID LEFT OUTER JOIN tbl_Member AS D
ON A.ContactID=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SupplierID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId

UNION ALL
--门票订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.Price AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,A.AgencyJinE AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.EnName AS CPName
	,4 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
FROM tbl_ScenicAreaOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_ScenicTickets AS C
ON A.TicketsId=C.TicketsId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SellerID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId

UNION ALL
--酒店订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.TotalAmount AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PaymentState AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.HotelName AS CPName
	,5 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
FROM tbl_HotelOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_Hotel AS C
ON A.HotelId=C.HotelId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SellerID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId

UNION ALL
--签证订单
SELECT A.DingDanId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.XiaDanRenId  AS XianDanRenId
	,A.JinE AS DingDanJinE
	,A.DingDanStatus AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrXingMing AS KeRenName
	,C.[Name] AS CPName
	,6 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
FROM tbl_QianZhengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.XiaDanRenId=B.MemberID LEFT OUTER JOIN tbl_QianZheng AS C
ON A.QianZhengId=C.QianZhengId LEFT OUTER JOIN tbl_Member AS D
ON A.XiaDanRenId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId

UNION ALL
--团购订单
SELECT CAST(A.OrderId AS CHAR(36)) AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.PeopleID AS XiaDanRenId
	,A.OrderPrice AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,0 AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.PeopleName AS KeRenName
	,C.ProductName AS CPName
	,7 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
FROM tbl_TuanGouDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.PeopleID=B.MemberID LEFT OUTER JOIN tbl_TuanGouChanPin AS C
ON A.ProductID=C.Id LEFT OUTER JOIN tbl_Member AS D
ON A.PeopleID=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SupplierID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId

UNION ALL
--租车订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,ISNULL(A.ZuJin,0) AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrName AS KeRenName
	,C.CarName AS CPName
	,8 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
FROM tbl_JA_ZuCheOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_JA_ZuCheInfo AS C
ON A.ZuCheID=C.ZuCheID LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId

GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	获取会员下级分销提成-金额
-- =============================================
ALTER PROCEDURE [dbo].[proc_XiaJiFenXiaoTiCheng_GetJinE]
	@HuiYuanId CHAR(36)--会员编号
	,@SuoYouYongJinJinE MONEY OUTPUT--所有下级分销佣金金额
	,@YiShenQingYongJinJinE MONEY OUTPUT--已申请下级分销佣金金额
	,@YiShenQingJinE MONEY OUTPUT--已申请提成金额
	,@YiShenPiYongJinJinE MONEY OUTPUT--已审批下级分销佣金金额
	,@YiShenPiJinE MONEY OUTPUT--已审批提成金额
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	SET @RetCode=0
	SET @SuoYouYongJinJinE=0
	SET @YiShenQingYongJinJinE=0
	SET @YiShenQingJinE=0
	SET @YiShenPiYongJinJinE=0
	SET @YiShenPiJinE=0
	DECLARE @HuiYuanDaiLiShangId CHAR(36)
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId)
	BEGIN
		--会员不是代理商
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	SELECT @HuiYuanDaiLiShangId=ID FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId
	
	SELECT @SuoYouYongJinJinE=ISNULL(SUM(DingDanJinE-DaiLiShangJinE),0) FROM view_FenSiJiaoYi WHERE DaiLiShangShangJiDaiLiShangHuiYuanId=@HuiYuanId AND DingDanStatus IN(2,3,4,5) AND FuKuanStatus IN(1)

	SELECT 	@YiShenQingYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT @YiShenQingJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT 	@YiShenPiYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)

	SELECT @YiShenPiJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)	

	SET @RetCode=1
	RETURN @RetCode	
END
GO


--旅游圈S--
alter table tbl_XianLu
alter column InterfaceID NVARCHAR(50)
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	写入线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- 1.2014-08-05 刘树超 tbl_XianLuTourTraffice 添加航班信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLu_Insert]
	 @XianLuId CHAR(36)--线路编号
	,@AreaName NVARCHAR(50)
	,@InterfaceID NVARCHAR(50) 
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" SYRS="" TrafficId="" JSJCR="" JSJET="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>
	,@Line_Source  TINYINT
	,@LineType TINYINT 
	,@TourTraffice NVARCHAR(MAX)
	,@CFCS NVARCHAR(50)
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	INSERT INTO [tbl_XianLu]([XianLuId],[AreaId],[RouteName]
		,[TianShu],[DepProvinceId],[DepCityId]
		,[ArrProvinceId],[ArrCityId],[JiHuaRenShu]
		,[SCJCR],[SCJET],[JSJCR]
		,[JSJET],[TingTianShu],[ChuFaJiaoTong]
		,[FanChengJiaoTong],[JiHeFangShi],[TeSe]
		,[TeSeFilePath],[TuJing],[QianZheng]
		,[QianZhengFilePath],[GuanZhuShu],[LxrName]
		,[LxrTelephone],[LxrQQ],[LxrMobile]
		,[Description],[Keywords],[OperatorId]
		,[IssueTime],[LatestId],[LatestTime],[AreaName],[InterfaceID],[Line_Source],[LineType],[CFCS])
	VALUES (@XianLuId,@AreaId,@RouteName
		,@TianShu,@DepProvinceId,@DepCityId
		,@ArrProvinceId,@ArrCityId,@JiHuaRenShu
		,@SCJCR,@SCJET,@JSJCR
		,@JSJET,@TingTianShu,@ChuFaJiaoTong
		,@FanChengJiaoTong,@JiHeFangShi,@TeSe
		,@TeSeFilePath,@TuJing,@QianZheng
		,@QianZhengFilePath,@GuanZhuShu,@LxrName
		,@LxrTelephone,@LxrQQ,@LxrMobile
		,@Description,@Keywords,@OperatorId
		,@IssueTime,@LatestId,@LatestTime,@AreaName,@InterfaceID,@Line_Source,@LineType,@CFCS)
	SET @errorcount=@errorcount+@@ERROR

		IF(@errorcount=0 AND @TourTraffice IS NOT NULL AND LEN(@TourTraffice)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourTraffice
		INSERT INTO tbl_XianLuTourTraffice(XianLuId,TrafficId,Traffic_01
			,Traffic_02)
		SELECT @XianLuId,T.TrafficId,T.Traffic_01,T.Traffic_02
		FROM OPENXML(@hdoc,'/root/info')
		WITH(TrafficId NVARCHAR(60),Traffic_01 NVARCHAR(100),Traffic_02 NVARCHAR(100)) AS T
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
		INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
			,[ZhuSu],[YongCan],[XingCheng]
			,[FilePath])
		SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
			,A.[ZhuSu],A.[YongCan],A.[XingCheng]
			,A.[FilePath]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
		INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi],[ZengSongXiangMu],[QiTaShiXiang])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi],A.[ZengSongXiangMu],A.[QiTaShiXiang]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX),[ZengSongXiangMu] VARCHAR(MAX),[QiTaShiXiang] NVARCHAR(MAX)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
		INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
		SELECT @XianLuId,A.[ZhuTiId]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([ZhuTiId] INT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
		INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
		SELECT @XianLuId,A.[Status]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([Status] TINYINT) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TourXml IS NOT NULL AND LEN(@TourXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml
		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR]
			,[JSJET],[SYRS],[TrafficId],[CRSCJ],[ETSCJ])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],A.[JSJCR]
			,A.[JSJET],A.[SYRS],A.[TrafficId],A.[CRSCJ],A.[ETSCJ]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[JSJCR] MONEY,[JSJET] MONEY,[SYRS]INT,[TrafficId] NVARCHAR(50),[CRSCJ] MONEY,[ETSCJ] MONEY ) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
		INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
		SELECT @XianLuId,A.FilePath,A.MiaoShu
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO


/****** 对象:  Index [IX_tbl_SysArea]    脚本日期: 04/03/2015 10:40:51 ******/
IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[dbo].[tbl_SysArea]') AND name = N'IX_tbl_SysArea')
DROP INDEX [IX_tbl_SysArea] ON [dbo].[tbl_SysArea] WITH ( ONLINE = OFF )

/****** 对象:  Index [IX_tbl_SysArea]    脚本日期: 04/03/2015 10:40:54 ******/
CREATE UNIQUE NONCLUSTERED INDEX [IX_tbl_SysArea] ON [dbo].[tbl_SysArea] 
(
	[AreaName] ASC,[RouteType] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
GO

insert into tbl_SysArea(AreaName,RouteType) values('中部地区',3)
insert into tbl_SysArea(AreaName,RouteType) values('东南地区',3)
insert into tbl_SysArea(AreaName,RouteType) values('东北地区',3)
insert into tbl_SysArea(AreaName,RouteType) values('西南地区',3)
insert into tbl_SysArea(AreaName,RouteType) values('华东地区',3)
insert into tbl_SysArea(AreaName,RouteType) values('西部地区',3)
insert into tbl_SysArea(AreaName,RouteType) values('华北地区',3)

insert into tbl_SysArea(AreaName,RouteType) values('中部地区',1)
insert into tbl_SysArea(AreaName,RouteType) values('东南地区',1)
insert into tbl_SysArea(AreaName,RouteType) values('东北地区',1)
insert into tbl_SysArea(AreaName,RouteType) values('西南地区',1)
insert into tbl_SysArea(AreaName,RouteType) values('华东地区',1)
insert into tbl_SysArea(AreaName,RouteType) values('西部地区',1)
insert into tbl_SysArea(AreaName,RouteType) values('华北地区',1)
	
insert into tbl_SysArea(AreaName,RouteType) values('海岛',2)
insert into tbl_SysArea(AreaName,RouteType) values('港澳台',2)
insert into tbl_SysArea(AreaName,RouteType) values('欧洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('澳洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('日韩',2)
insert into tbl_SysArea(AreaName,RouteType) values('东南亚',2)
insert into tbl_SysArea(AreaName,RouteType) values('南亚',2)
insert into tbl_SysArea(AreaName,RouteType) values('邮轮',2)
insert into tbl_SysArea(AreaName,RouteType) values('中东非洲',2)
insert into tbl_SysArea(AreaName,RouteType) values('美洲',2)


--旅游圈E--


GO
/****** 对象:  Table [dbo].[tbl_Seller_ShangCheng]    脚本日期: 12/08/2014 09:44:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_Seller_ShangCheng](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[MemberId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[ProductId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[ProductStatus] [int] NULL,
 CONSTRAINT [PK_tbl_Seller_ShangCheng] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO


alter table tbl_SysAdv add AgencyId char(36)
go


alter table tbl_ZiZuTuan add FuKuanStatus tinyint not null default 0
go

alter table tbl_JA_Sellers add NavNum int not null  default 0
go



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[View_DaiLiChanPin]
AS
SELECT     a.Id, 
           a.MemberId,
           a.ProductId, 
           a.ProductStatus,
           b.TypeID, 
           b.ProductName,
           b.ProductNum,
           b.MarketPrice, 
           b.SalePrice,
           b.ContentService,
           b.UnContentService, 
           b.UseRule,
           b.NoticeKnow,
           b.ProductionDate, 
           b.EffectDate,
           b.ShelfDate,
           b.IssueTime, 
           b.Remark,
           b.ModelDesc,
           b.ColorDesc, 
           b.StylesDesc,
           b.MailWay,
           b.GYSid, 
           b.Unit,
           b.IsTrue,
           (SELECT SupplierName  FROM [tbl_Supplier] where ID=b.GYSid ) as SupplierName,
           (SELECT c.ParentID FROM dbo.tbl_ShangChengLeiBie AS c WHERE c.TypeID=b.TypeID ) AS ParentID,
           (SELECT c.TypeName FROM tbl_ShangChengLeiBie AS c WHERE c.TypeID=b.TypeID  )AS TypeName,
           (b.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=b.ProductID)) AS StockNum,
           (SELECT * FROM tbl_ShangChengTuPian AS c WHERE c.ProductID=b.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
FROM         dbo.tbl_Seller_ShangCheng as a LEFT OUTER JOIN
                      dbo.tbl_ShangChengChanPin as b ON a.ProductId = b.ProductID

GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT     a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT     b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT     c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT     d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT     e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT     f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT     g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID
FROM         tbl_ShangChengDingDan AS g
UNION ALL
SELECT     h.ZongJinE AS JinE, h.OrderState AS OrderStatus, h.OrderCode AS OrderCode, h.XDRId AS XDRId, h.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRMoblie, h.IssueTime AS IssueTime,
                          h.XianLuName AS OrderName, '成人:'+CAST(h.ChengTuanNum AS varchar(30)) + '人，儿童:'+CAST(h.ErTongNum AS varchar(30))+'人' AS OrderNum, h.AgencyJinE AS AgencyJinE, 
                      h.AgencyId AS AgencyId, 9 AS OrderType,CAST(h.XianLuId AS varchar(36)) as ProductID
FROM         tbl_ZiZuTuan AS h
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

INSERT INTO tbl_Webmaster (Username,Password,MD5Password,Realname,Telephone,Fax,Mobile,IsEnable,IsAdmin,CreateTime,LeiXing,GysId,[Permissions]) SELECT a.Account,a.PassWord,a.MD5Password,a.MemberName,a.Contact,a.Fax,a.Mobile,1,0,GETDATE(),2,b.ID,'104,508' from tbl_Member as a right join tbl_JA_Sellers as b ON a.MemberID = b.MemberID WHERE a.UserType IN(3,4,5) AND a.Account NOT IN ( SELECT Username from tbl_Webmaster)

GO


UPDATE tbl_SysAdv SET AgencyId='-1' WHERE AgencyId is null



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT   CAST(a.OrderId AS varchar(36)) as OrderId,  a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT   CAST(b.DingDanId AS varchar(36)) as OrderId,  b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT  CAST(c.OrderID AS varchar(36)) as OrderId,   c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT   CAST(d.OrderId AS varchar(36)) as OrderId,  d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT   CAST(e.OrderId AS varchar(36)) as OrderId,  e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT  CAST(f.OrderId AS varchar(36)) as OrderId,   f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT  CAST(g.OrderID AS varchar(36)) as OrderId,   g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID
FROM         tbl_ShangChengDingDan AS g
UNION ALL
SELECT  CAST(h.ZuTuanId AS varchar(36)) as OrderId,   h.ZongJinE AS JinE, h.OrderState AS OrderStatus, h.OrderCode AS OrderCode, h.XDRId AS XDRId, h.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRMoblie, h.IssueTime AS IssueTime,
                          h.XianLuName AS OrderName, '成人:'+CAST(h.ChengTuanNum AS varchar(30)) + '人，儿童:'+CAST(h.ErTongNum AS varchar(30))+'人' AS OrderNum, h.AgencyJinE AS AgencyJinE, 
                      h.AgencyId AS AgencyId, 9 AS OrderType,CAST(h.XianLuId AS varchar(36)) as ProductID
FROM         tbl_ZiZuTuan AS h
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





-------------------------------
----------WAP日志开始----------
-------------------------------




alter table tbl_JA_ZuCheOrder add OrderSite tinyint default 0 not null 
go 


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[view_JA_ZuCheOrder]
AS
SELECT     dbo.tbl_JA_ZuCheOrder.OrderId, 
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_JA_ZuCheOrder.OperatorId ) as UserType,
dbo.tbl_JA_ZuCheOrder.ZuCheID, dbo.tbl_JA_ZuCheOrder.ZuCheType, dbo.tbl_JA_ZuCheOrder.CarType, 
                      dbo.tbl_JA_ZuCheOrder.GongLiShu, dbo.tbl_JA_ZuCheOrder.ZuCheTianShu, dbo.tbl_JA_ZuCheOrder.ZuJin, dbo.tbl_JA_ZuCheOrder.Status, 
                      dbo.tbl_JA_ZuCheOrder.FuKuanStatus, dbo.tbl_JA_ZuCheOrder.LDate, dbo.tbl_JA_ZuCheOrder.XiaDanBeiZhu, dbo.tbl_JA_ZuCheOrder.LxrName, 
                      dbo.tbl_JA_ZuCheOrder.LxrTelephone, dbo.tbl_JA_ZuCheOrder.OperatorId, dbo.tbl_JA_ZuCheOrder.IssueTime, dbo.tbl_JA_ZuCheOrder.TuanGouId, 
                      dbo.tbl_JA_ZuCheOrder.OrderCode, dbo.tbl_JA_ZuCheInfo.CarName, dbo.tbl_JA_ZuCheOrder.EDate, dbo.tbl_JA_ZuCheOrder.Number, 
                      dbo.tbl_JA_ZuCheOrder.YuDingRName, dbo.tbl_JA_ZuCheOrder.YuDingRTelephone, dbo.tbl_JA_ZuCheOrder.AgencyJinE, 
                      dbo.tbl_JA_ZuCheOrder.AgencyId,dbo.tbl_JA_ZuCheOrder.OrderSite
FROM         dbo.tbl_JA_ZuCheOrder INNER JOIN
                      dbo.tbl_JA_ZuCheInfo ON dbo.tbl_JA_ZuCheOrder.ZuCheID = dbo.tbl_JA_ZuCheInfo.ZuCheID
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




ALTER PROCEDURE [dbo].[proc_JA_ZuCheOrder_ADD] 
	@OrderId char(36),
@OrderCode varchar(50) OUTPUT,
@ZuCheID char(36),
@ZuCheType int,
@CarType int,
@GongLiShu numeric(10,3),
@ZuCheTianShu int,
@ZuJin money,
@Status tinyint,
@FuKuanStatus tinyint,
@LDate datetime,
@XiaDanBeiZhu nvarchar(MAX),
@LxrName nvarchar(50),
@LxrTelephone nvarchar(100),
@OperatorId char(36),
@IssueTime datetime,
@TuanGouId char(36),
@ZuCheXingCheng xml,
@EDate datetime,
@Number int,
@YuDingRName nvarchar(50),
@YuDingRTelephone nvarchar(100),
@AgencyId char(36),
@AgencyJinE money,
@OrderSite tinyint,
@Result int output
AS
BEGIN TRANSACTION
	declare @ErrorNum int
	set @ErrorNum=0
	
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_JA_ZuCheOrder]
	SET @OrderCode='ZC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)	

	INSERT INTO [tbl_JA_ZuCheOrder](
	[OrderId],[OrderCode],[ZuCheID],[ZuCheType],[CarType],[GongLiShu],[ZuCheTianShu],[ZuJin],[Status],[FuKuanStatus],[LDate],[XiaDanBeiZhu],[LxrName],[LxrTelephone],[OperatorId],[IssueTime],[TuanGouId],[EDate],[Number],[YuDingRName],[YuDingRTelephone],AgencyId,AgencyJinE,OrderSite
	)VALUES(
	@OrderId,@OrderCode,@ZuCheID,@ZuCheType,@CarType,@GongLiShu,@ZuCheTianShu,@ZuJin,@Status,@FuKuanStatus,@LDate,@XiaDanBeiZhu,@LxrName,@LxrTelephone,@OperatorId,@IssueTime,@TuanGouId,@EDate,@Number,@YuDingRName,@YuDingRTelephone,@AgencyId,@AgencyJinE,@OrderSite
	)
	set @ErrorNum=@@error
	if(@ZuCheXingCheng is not null)
	BEGIN
		declare @i int
		exec sp_xml_preparedocument @i output,@ZuCheXingCheng
		set @ErrorNum=@ErrorNum+@@error
		INSERT INTO tbl_JA_ZuCheXingCheng(OrderId,LPlace,EPlace,GongLiShu)
		select @OrderId,LPlace,EPlace,GongLiShu from openxml(@i,'/root/info')
		with(OrderId char(36),LPlace nvarchar(255),EPlace nvarchar(255),GongLiShu numeric(10,3))
		set @ErrorNum=@ErrorNum+@@error
		
		exec sp_xml_removedocument @i
		set @ErrorNum=@ErrorNum+@@error
	END
	if(@ErrorNum=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end

Go


-- 团购订单来源
alter table tbl_TuanGouDingDan add OrderSite tinyint default 0 not null 
go 




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		邹磊
-- Create date: 2015-01-09
-- Description:	写入团购订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_TuanGouDingDan_Insert]
	 @ProductID INT
	,@OrderCode NVARCHAR(50) OUTPUT
	,@ProductNum INT
	,@OrderPrice MONEY
	,@PeopleID CHAR(36)
	,@PeopleName NVARCHAR(50)
	,@PeopleMobile NVARCHAR(50)
	,@IssueTime DATETIME
	,@OrderState TINYINT
	,@PayState TINYINT
    ,@Peopleaddress nvarchar(255)
	,@SupplierID CHAR(36)
    ,@OrderSite tinyint
	,@RetCode INT OUTPUT--OUTPUT CODE
	,@OrderID INT OUTPUT
AS
BEGIN
	DECLARE @errorcount INT
	SET @errorcount=0
 
 BEGIN TRAN
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_TuanGouDingDan
	SET @OrderCode='TG'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)

  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_TuanGouDingDan (ProductID ,OrderCode ,ProductNum ,OrderPrice ,PeopleID ,PeopleName ,PeopleMobile ,IssueTime ,OrderState ,PayState ,SupplierID ,Peopleaddress,OrderSite)     VALUES (@ProductID ,@OrderCode ,@ProductNum ,@OrderPrice ,@PeopleID ,@PeopleName ,@PeopleMobile ,@IssueTime ,@OrderState ,@PayState ,@SupplierID ,@Peopleaddress,@OrderSite)
	SET @OrderID=@@IDENTITY
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_TuanGouOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_TuanGouChanPin AS p WHERE p.ID=s.ProductID ) as ProductName
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,PeopleID
      ,PeopleName
      ,PeopleMobile
      ,IssueTime
      ,SupplierID
      ,Peopleaddress,
OrderSite
  FROM tbl_TuanGouDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

--团购订单来源结束


--酒店订单来源

alter table tbl_HotelOrder add OrderSite tinyint default 0 not null 
go 



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* 新增订单所属单位*/
ALTER VIEW [dbo].[view_HotelOrder]
AS
SELECT     OrderId, HotelId,
                          (SELECT     HotelName
                            FROM          dbo.tbl_Hotel
                            WHERE      (HotelId = dbo.tbl_HotelOrder.HotelId)) AS HotelName,
(SELECT     Star
                            FROM          dbo.tbl_Hotel
                            WHERE      (HotelId = dbo.tbl_HotelOrder.HotelId)) AS Star, RoomTypeId,
                          (SELECT     RoomName
                            FROM          dbo.tbl_HotelRoomType
                            WHERE      (RoomTypeId = dbo.tbl_HotelOrder.RoomTypeId)) AS RoomName, OrderCode, RoomCount, CheckInDate, CheckOutDate, TotalAmount, 
                      ContactName, ContactMobile, Remark, PaymentType, PaymentState, OrderState, Source, OperatorId,
                          (SELECT     MemberName
                            FROM          dbo.tbl_Member
                            WHERE      (MemberID = dbo.tbl_HotelOrder.OperatorId)) AS OperatorName,
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as UserType,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as OperatorMobile,
 IssueTime, JiaGeId, DanJia, BuyCompanyName, SellerID, 
                      AgencyJinE,OrderSite
FROM         dbo.tbl_HotelOrder
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- 新增订单所属单位
-- =============================================
ALTER PROCEDURE [dbo].[proc_HotelOrder_Add]
@OrderId char(36),
@HotelId char(36),
@RoomTypeId char(36),
@OrderCode varchar(50) OUTPUT,
@RoomCount int,
@CheckInDate datetime,
@CheckOutDate datetime,
@TotalAmount money,
@ContactName nvarchar(50),
@ContactMobile nvarchar(50),
@Remark nvarchar(max),
@PaymentType tinyint,
@PaymentState tinyint,
@OrderState tinyint,
@Source tinyint,
@OperatorId char(36),
@OrderSite tinyint,
@Result int output
,@JiaGeId INT
,@DanJia MONEY
,@BuyCompanyName nvarchar(100)=''
AS
BEGIN
	DECLARE @error INT
	SET @error=0
	
	if exists(select 1 from tbl_Hotel where HotelId=@HotelId and (IsDelete='1' or Status=1))
	begin
		set @Result=-1 --酒店已删除或下架
		return @Result
	end

	if exists(select 1 from tbl_HotelRoomType where RoomTypeId=@RoomTypeId and (IsDelete='1' or RoomStatus=1))
	begin
		set @Result=-2 --房型已删除或下架
		return @Result
	end

	/*declare @days int
	declare @i int
	select @days=datediff(day,@CheckInDate,@CheckOutDate)
	set @i=0
	while(@i<=@days)
	begin
		--dateadd(day,@i,getdate())
		
		if not exists(select 1 from tbl_HotelRoomRate 
					  where RoomTypeId=@RoomTypeId 
					  and datediff(day,StartDate,dateadd(day,@i,getdate()))>=0 
			          and datediff(day,EndDate,dateadd(day,@i,getdate()))<=0 )
		begin
			 set @Result=-3 --入住时间段存在错误价格信息
			 break 
		end		

		set @i=@i+1
	end


	declare @orderRoomCount int
	select @orderRoomCount=sum(RoomCount) from tbl_HotelOrder 
	where HotelId=@HotelId and RoomTypeId=@RoomTypeId and OrderState in (0,3,4)

	declare @TotalRoomCount int
	select @TotalRoomCount=TotalNumber from tbl_HotelRoomType 
	where HotelId=@HotelId and RoomTypeId=@RoomTypeId*/

--	if(@TotalRoomCount<@orderRoomCount+@RoomCount)
--	begin
--		set @Result=-4	--订单预订房间数超过房型最大房间数
--		return @Result
--	end

	DECLARE @ShuLiang INT
	DECLARE @YiYuDingShuLiang INT

	SELECT @ShuLiang=ShuLiang FROM tbl_HotelRoomRate WHERE RoomRateId=@JiaGeId
	SELECT @YiYuDingShuLiang=ISNULL(SUM(A1.RoomCount),0) FROM tbl_HotelOrder AS A1 WHERE A1.JiaGeId=@JiaGeId AND A1.OrderState IN(0,3,4,5)
	IF(@YiYuDingShuLiang+@RoomCount>@ShuLiang)
	BEGIN
		SET @Result=-99
		RETURN @Result
	END	

	BEGIN TRANSACTION
	
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_HotelOrder]
	SET @OrderCode='JD'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	set @OrderState=4

	INSERT INTO tbl_HotelOrder(OrderId,HotelId,RoomTypeId,OrderCode,RoomCount,
	CheckInDate,CheckOutDate,TotalAmount,ContactName,ContactMobile,Remark
	,PaymentType,PaymentState,OrderState,Source,OperatorId,IssueTime,JiaGeId
	,DanJia,BuyCompanyName,OrderSite)
	VALUES(@OrderId,@HotelId,@RoomTypeId,@OrderCode,@RoomCount,@CheckInDate,
	@CheckOutDate,@TotalAmount,@ContactName,@ContactMobile,@Remark,
	@PaymentType,@PaymentState,@OrderState,@Source,@OperatorId,getdate(),@JiaGeId
	,@DanJia,@BuyCompanyName,@OrderSite)
	SET @error=@error+@@ERROR
	
	IF(@error=0)
	BEGIN
		SET @Result=1
		COMMIT TRANSACTION
	END
	ELSE
	BEGIN
		SET @Result=0
		ROLLBACK TRANSACTION
	END
	return @Result
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


---酒店订单来源结束




--线路订单来源开始

alter table tbl_XianLuTourOrder add OrderSite tinyint default 0 not null 
go 





SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* =============================================
 Author:		汪奇志
 Create date: 2013-03-23
 Description:线路订单信息业务实体
 =============================================*/
ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId,
                          (SELECT     UserType
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS UserType,
                          (SELECT     MemberName
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS MemberName,
                          (SELECT     Mobile
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS Mobile,
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p
                            WHERE      (ID = B.AreaId)) AS RouteType, A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JinE, A.FuKuanStatus, 
                      A.LDate, A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, 
                      A.IssueTime, A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source, B.SCJCR, B.SCJET, B.JSJCR, B.JSJET, 
                      A.Traffice,A.OrderSite
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go


-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-15
-- Description:	写入订单信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
    ,@OrderSite tinyint
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号

	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@YiShouRenShu=SYRS FROM [tbl_XianLuTour] WHERE TourId=@TourId 
	
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=[JiHuaRenShu] FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId

	IF(@YiShouRenShu<@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice,[OrderSite])
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice,@OrderSite
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc
	
	IF(@errorcount=0)
		BEGIN
			UPDATE dbo.tbl_XianLuTour SET SYRS=SYRS-@ChengRenShu-@ErTongShu WHERE TourId=@TourId
			SET @errorcount=@errorcount+@@ERROR
		END
	
	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END




--线路订单来源结束




-- 门票订单来源开始
alter table tbl_ScenicAreaOrder add OrderSite tinyint default 0 not null 
go 




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* 新增订单所属单位*/
ALTER VIEW [dbo].[view_ScenicAreaOrder]
AS
SELECT     A.OrderId, A.OrderCode, A.ScenicId, A.TicketsId, A.Price, A.Num, A.Status, A.Source, A.FuKuanStatus, A.OperatorId, A.IssueTime, A.ChuFaRiQi, 
                      A.AgencyJinE, A.SellerID, A.ContactName, A.ContactTel, A.Remark, B.ScenicName, C.TypeName, A.BuyCompanyName, A.OperatorName,A.OrderSite,
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as UserType,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=A.OperatorId ) as OperatorMobile
FROM         dbo.tbl_ScenicAreaOrder AS A INNER JOIN
                      dbo.tbl_ScenicArea AS B ON A.ScenicId = B.ScenicId INNER JOIN
                      dbo.tbl_ScenicTickets AS C ON A.TicketsId = C.TicketsId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- 新增订单所属单位
-- =============================================
ALTER proc [dbo].[proc_ScenicAreaOrder_Add]
@OrderId char(36),
@ScenicId char(36),
@TicketsId char(36),
@Price decimal(18,0),
@Num int,
@Status tinyint,
@Source tinyint,
@FuKuanStatus tinyint,
@OperatorId char(36),
@ContactName NVARCHAR(255),
@ContactTel NVARCHAR(255),
@Remark NVARCHAR(max),
@OrderSite tinyint,
@Result int output,
@BuyCompanyName nvarchar(100)=''
,@OrderCode nvarchar(50) OUTPUT
as
begin
	declare @error int
	set @error=0
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ScenicAreaOrder
	SET @OrderCode=CONVERT(VARCHAR(8),GETDATE(),112)+'J'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	SELECT @YiShouRenShu=SUM([Num]) FROM [tbl_ScenicAreaOrder] WHERE [TicketsId]=@TicketsId AND [Status] IN(0,3,4,5)
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)
	set @Status =4
	SELECT @JiHuaRenShu=[Number] FROM [tbl_ScenicTickets] WHERE [TicketsId]=@TicketsId
	IF(@JiHuaRenShu<@YiShouRenShu+@Num)
	BEGIN
		SET @Result=0
		return @Result
	END
	
	INSERT INTO tbl_ScenicAreaOrder
           (OrderId,OrderCode,ScenicId,TicketsId,Price,Num,Status,Source,FuKuanStatus,OperatorId,IssueTime,ContactName,ContactTel,Remark,BuyCompanyName,OrderSite)
     VALUES
           (@OrderId,@OrderCode,@ScenicId,@TicketsId,@Price,@Num,@Status,@Source,@FuKuanStatus,@OperatorId,getdate(),@ContactName,@ContactTel,@Remark,@BuyCompanyName,@OrderSite)

	if(1 = 1)
	begin
		set @Result=1
	end
	else
	begin
		set @Result=0
	end

	return @Result
end
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






--门票订单来源结束



--商城订单来源开始

alter table tbl_ShangChengDingDan add OrderSite tinyint default 0 not null 
go 




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_ShangChengOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_ShangChengChanPin AS p WHERE p.ProductID=s.ProductID ) as ProductName
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,ContactID
      ,ContactName
      ,ContactPhone
,(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as UserType
,(SELECT MemberName  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorName
,(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorMobile
      ,IssueTime
      ,Remark
      ,ProvinceID
      ,(SELECT [GYSid] FROM tbl_ShangChengChanPin chanpin WHERE chanpin.ProductID=s.ProductID )AS  GYSid
      ,(SELECT [Name] FROM tbl_SysProvince prov WHERE prov.ID=s.ProvinceID )AS  ProvinceName
      ,CityID
      ,(SELECT [Name] FROM tbl_SysCity city WHERE city.ID=s.CityID ) as CityName 
      ,DistrictID
      ,(SELECT [Name] FROM tbl_SysDistrict dist WHERE dist.ID=s.DistrictID) AS DistrictName
      ,Addressinfo
      ,SupplierID
      ,SupplierMoney
      ,OrderSite
  FROM tbl_ShangChengDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-09
-- Description:	写入商城订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangChengDingDan_Insert]
		@OrderID  CHAR(36)
	   ,@ProductID CHAR(36)
	   ,@ProductNum INT
	   ,@OrderCode NVARCHAR(50) OUTPUT
	   ,@OrderPrice  MONEY
	   ,@OrderState TINYINT
	   ,@PayState TINYINT
	   ,@ContactID CHAR(36)
	   ,@ContactName NVARCHAR(50)
	   ,@ContactPhone NVARCHAR(50)
	   ,@IssueTime DATETIME
	   ,@Remark NVARCHAR(MAX)
	   ,@AddressID INT
	   ,@ProvinceID INT
	   ,@CityID INT
	   ,@DistrictID INT
	   ,@AddressInfo NVARCHAR(255)
	   ,@UserID CHAR(36)
	   ,@UserName NVARCHAR(50)
	   ,@IsDefault CHAR(1)
	   ,@SupplierID CHAR(36)
       ,@OrderSite tinyint
	   ,@SupplierMoney MONEY
	   ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
    DECLARE @Address INT
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0
	SET @Address=@AddressID
 	DECLARE @ShengYu INT
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ShangChengDingDan
	SET @OrderCode='SC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	SELECT @ShengYu=stocknum FROM dbo.view_ShangCheng WHERE ProductID=@ProductID

 IF(@shengyu<@ProductNum)
 BEGIN
	SET @RetCode=-99
	RETURN @RetCode
 END
 BEGIN TRAN
 IF(@AddressID=0)
 BEGIN
	 --写入地址信息
	 IF(@IsDefault=0)
		 BEGIN
			INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
	  ELSE
		  BEGIN
		  UPDATE tbl_DiZhi SET IsDefault=0 WHERE UserID=@UserID
		  INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
		  SET @Address=@@IDENTITY
 END
 ELSE
 BEGIN
		UPDATE tbl_DiZhi SET ProvinceID=@ProvinceID,CityID=@CityID,DistrictID=@DistrictID,AddressInfo=@AddressInfo WHERE AddressID=@AddressID
 END
  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_ShangChengDingDan (OrderID ,ProductID ,ProductNum ,OrderCode ,OrderPrice ,OrderState ,PayState ,ContactID ,ContactName ,ContactPhone ,IssueTime ,Remark,ProvinceID,CityID,DistrictID,AddressInfo,SupplierID,SupplierMoney,OrderSite)
		 VALUES (@OrderID ,@ProductID ,@ProductNum ,@OrderCode ,@OrderPrice ,@OrderState ,@PayState ,@ContactID ,@ContactName ,@ContactPhone ,@IssueTime ,@Remark,@ProvinceID,@CityID,@DistrictID,@AddressInfo,@SupplierID,@SupplierMoney,@OrderSite)
		 
 
	   
	   
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



--商城订单来源结束



-------------------------------------------------------------机票相关-------------------------------------------------------------

DROP VIEW view_dingdan
GO
IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_TBL_JIPIAOCANGWEI_REFERENCE_TBL_JIPIAOHANGBAN]') AND parent_object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoCangWei]'))
ALTER TABLE [dbo].[tbl_JiPiaoCangWei] DROP CONSTRAINT [FK_TBL_JIPIAOCANGWEI_REFERENCE_TBL_JIPIAOHANGBAN]
GO
IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_TBL_JIPIAOCHENGJIREN_REFERENCE_TBL_JIPIAODINGDAN]') AND parent_object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoChengJiRen]'))
ALTER TABLE [dbo].[tbl_JiPiaoChengJiRen] DROP CONSTRAINT [FK_TBL_JIPIAOCHENGJIREN_REFERENCE_TBL_JIPIAODINGDAN]
GO
IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_TBL_JIPIAODINGDAN_REFERENCE_TBL_JIPIAOHANGBAN]') AND parent_object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoDingDan]'))
ALTER TABLE [dbo].[tbl_JiPiaoDingDan] DROP CONSTRAINT [FK_TBL_JIPIAODINGDAN_REFERENCE_TBL_JIPIAOHANGBAN]
GO

GO
/****** 对象:  Table [dbo].[tbl_JiPiaoCangWei]    脚本日期: 04/03/2015 10:11:17 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoCangWei]') AND type in (N'U'))
DROP TABLE [dbo].[tbl_JiPiaoCangWei]
GO
/****** 对象:  Table [dbo].[tbl_JiPiaoChengJiRen]    脚本日期: 04/03/2015 10:11:17 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoChengJiRen]') AND type in (N'U'))
DROP TABLE [dbo].[tbl_JiPiaoChengJiRen]
GO
/****** 对象:  Table [dbo].[tbl_JiPiaoDingDan]    脚本日期: 04/03/2015 10:11:17 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoDingDan]') AND type in (N'U'))
DROP TABLE [dbo].[tbl_JiPiaoDingDan]
GO
/****** 对象:  Table [dbo].[tbl_JiPiaoHangBan]    脚本日期: 04/03/2015 10:11:17 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoHangBan]') AND type in (N'U'))
DROP TABLE [dbo].[tbl_JiPiaoHangBan]
GO
/****** 对象:  Table [dbo].[tbl_JiPiaoHangKongGongSi]    脚本日期: 04/03/2015 10:11:17 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoHangKongGongSi]') AND type in (N'U'))
DROP TABLE [dbo].[tbl_JiPiaoHangKongGongSi]
GO
/****** 对象:  Table [dbo].[tbl_JiPiaoSanZiMa]    脚本日期: 04/03/2015 10:11:17 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tbl_JiPiaoSanZiMa]') AND type in (N'U'))
DROP TABLE [dbo].[tbl_JiPiaoSanZiMa]
GO

/*==============================================================*/
/* Table: tbl_JiPiaoDingDan                                     */
/*==============================================================*/
create table tbl_JiPiaoDingDan (
   DingDanId            char(36)             not null,
   ApiDingDanId         nvarchar(50)         not null default '',
   GongPiaoShangId      nvarchar(50)         not null default '',
   ZhengCeId            nvarchar(50)         not null default '',
   CangWei              nvarchar(50)         not null default '',
   HangBanHao           nvarchar(50)         not null default '',
   ChuFaChengShiSanZiMa nvarchar(50)         not null default '',
   DaoDaChengShiSanZiMa nvarchar(50)         not null default '',
   ChuFaRiQi            datetime             not null default getdate(),
   CaiGouFanDian        money                not null default 0,
   ShiFuDaYinXingChengDan int                  not null default 0,
   ZhengCeLeiXing       int                  not null default 0,
   HangXianLeiXing      int                  not null default 0,
   XiaDanShiJian        datetime             not null default getdate(),
   DingDanStatus        int                  not null default 101,
   FuKuanStatus         int                  not null default 0,
   FuKuanShiJian        datetime             not null default getdate(),
   PNR                  nvarchar(50)         null,
   KeHuYouHuiDian       money                not null default 0,
   JingXiaoShangLiRunDian money                not null default 0,
   JinE                 money                not null default 0,
   JingXiaoShangLiRun   money                not null default 0,
   QiFeiShiJian         nvarchar(50)         null,
   DaoDaShiJian         nvarchar(50)         null,
   PiaoMianJiaGe        money                not null default 0,
   ShuiFeiJinE          money                not null default 0,
   DingPiaoRenShu       int                  not null default 0,
   ChengRenDingDanId    char(36)             not null default '',
   ErTongDingDanId      char(36)             not null default '',
   HuiYuanId            char(36)             not null default '',
   ShiFouShanChu        char(1)              not null default '0',
   IdentityId           int                  identity,
   JiaoYiHao            nvarchar(50)         not null default '',
   ChengKeLeiXing       int                  not null default 0,
   ApiJieShouFangShi    int                  not null default 0,
   ShiFouYunXuGengHuanPnr int                  not null default 0,
   ShiFouZiDongDaiKou   int                  not null default 0,
   XiangApiFuKuanStatus int                  not null default 0,
   XiangApiFuKuanShiJian datetime             not null default '0',
   constraint PK_TBL_JIPIAODINGDAN primary key (DingDanId)
)
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机票订单信息',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订单编号（系统）',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'DingDanId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订单编号（API）',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ApiDingDanId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '供票商ID (加密码)',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'GongPiaoShangId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '政策ID',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ZhengCeId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '舱位',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'CangWei'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '航班号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'HangBanHao'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '出发城市三字码',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ChuFaChengShiSanZiMa'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '到达城市三字码',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'DaoDaChengShiSanZiMa'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '出发日期',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ChuFaRiQi'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '采购返点',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'CaiGouFanDian'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '是否打印行程单',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ShiFuDaYinXingChengDan'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '政策类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ZhengCeLeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '航线类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'HangXianLeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '下单时间',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'XiaDanShiJian'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订单状态',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'DingDanStatus'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '付款状态',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'FuKuanStatus'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '付款时间',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'FuKuanShiJian'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   'Pnr编码',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'PNR'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '给客户的优惠点',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'KeHuYouHuiDian'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '经销商的利润点',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'JingXiaoShangLiRunDian'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订单金额（包含基建燃油费）',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'JinE'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '经销商的利润',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'JingXiaoShangLiRun'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '起飞时间',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'QiFeiShiJian'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '到达时间',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'DaoDaShiJian'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '票面价格',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'PiaoMianJiaGe'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '税费金额（机场建设费+燃油费）',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ShuiFeiJinE'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订票人数',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'DingPiaoRenShu'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '成人订单编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ChengRenDingDanId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '儿童订单编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ErTongDingDanId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '会员编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'HuiYuanId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '是否删除',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ShiFouShanChu'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '自增编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'IdentityId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '交易号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'JiaoYiHao'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '乘客类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ChengKeLeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   'API接收方式',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ApiJieShouFangShi'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '是否允许更换PNR出票',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ShiFouYunXuGengHuanPnr'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '是否自动代扣',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'ShiFouZiDongDaiKou'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '向API付款状态（系统向接口的支付状态）',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'XiangApiFuKuanStatus'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '向API付款时间（系统向接口的支付时间）',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDan', 'column', 'XiangApiFuKuanShiJian'
go
if exists (select 1
   from sys.sysreferences r join sys.sysobjects o on (o.id = r.constid and o.type = 'F')
   where r.fkeyid = object_id('tbl_JiPiaoDingDanXiangGuan') and o.name = 'FK_TBL_JIPI_REFERENCE_TBL_JIPI')
alter table tbl_JiPiaoDingDanXiangGuan
   drop constraint FK_TBL_JIPI_REFERENCE_TBL_JIPI
go


/*==============================================================*/
/* Table: tbl_JiPiaoDingDanXiangGuan                            */
/*==============================================================*/
create table tbl_JiPiaoDingDanXiangGuan (
   DingDanId            char(36)             not null,
   LeiXing              nvarchar(50)         not null,
   JSON                 nvarchar(max)        null,
   constraint PK_TBL_JIPIAODINGDANXIANGGUAN primary key (DingDanId, LeiXing)
)
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机票订单相关信息',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanXiangGuan'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订单编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanXiangGuan', 'column', 'DingDanId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '信息类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanXiangGuan', 'column', 'LeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '信息内容JSON',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanXiangGuan', 'column', 'JSON'
go

alter table tbl_JiPiaoDingDanXiangGuan
   add constraint FK_TBL_JIPI_REFERENCE_TBL_JIPI foreign key (DingDanId)
      references tbl_JiPiaoDingDan (DingDanId)
go
if exists (select 1
   from sys.sysreferences r join sys.sysobjects o on (o.id = r.constid and o.type = 'F')
   where r.fkeyid = object_id('tbl_JiPiaoDingDanChengKe') and o.name = 'FK_TBL_JIPI_REFERENCE_TBL_JIPI')
alter table tbl_JiPiaoDingDanChengKe
   drop constraint FK_TBL_JIPI_REFERENCE_TBL_JIPI
go


/*==============================================================*/
/* Table: tbl_JiPiaoDingDanChengKe                              */
/*==============================================================*/
create table tbl_JiPiaoDingDanChengKe (
   ChengKeId            char(36)             not null,
   XingMing             nvarchar(50)         not null default '',
   ZhengJianHao         nvarchar(50)         not null default '',
   ZhengJianLeiXing     int                  not null default 0,
   ChengKeLeiXing       int                  not null default 0,
   ChuShengRiQi         datetime             not null default getdate(),
   IdentityId           int                  identity,
   DingDanId            char(36)             not null,
   constraint PK_TBL_JIPIAODINGDANCHENGKE primary key (ChengKeId)
)
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机票订单乘客信息',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '乘客编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'ChengKeId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '乘客姓名',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'XingMing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '证件号码',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'ZhengJianHao'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '证件类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'ZhengJianLeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '乘客类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'ChengKeLeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '出生日期',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'ChuShengRiQi'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '自增编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'IdentityId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订单编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanChengKe', 'column', 'DingDanId'
go

alter table tbl_JiPiaoDingDanChengKe
   add constraint FK_TBL_JIPI_REFERENCE_TBL_JIPI foreign key (DingDanId)
      references tbl_JiPiaoDingDan (DingDanId)
go

/*==============================================================*/
/* Table: tbl_JiPiaoHangKongGongSi                              */
/*==============================================================*/
create table tbl_JiPiaoHangKongGongSi (
   IdentityId           int                  identity,
   Code                 nvarchar(50)         not null,
   Name                 nvarchar(50)         not null,
   constraint PK_TBL_JIPIAOHANGKONGGONGSI primary key (IdentityId)
)
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机票航空公司信息',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoHangKongGongSi'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '自增编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoHangKongGongSi', 'column', 'IdentityId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '代码',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoHangKongGongSi', 'column', 'Code'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '名称',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoHangKongGongSi', 'column', 'Name'
go

/*==============================================================*/
/* Table: tbl_JiPiaoSanZiMa                                     */
/*==============================================================*/
create table tbl_JiPiaoSanZiMa (
   IdentityId           int                  identity,
   Code                 nvarchar(50)         not null,
   ShengFenName         nvarchar(50)         null,
   ChengShiName         nvarchar(50)         not null,
   JiChangName          nvarchar(50)         null,
   PY1                  nvarchar(50)         null,
   PY2                  nvarchar(50)         null,
   PY3                  nvarchar(10)         null,
   IsReMen              char(1)              not null default '0',
   PaiXuId              int                  not null default 0,
   constraint PK_TBL_JIPIAOSANZIMA primary key (IdentityId)
)
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机票城市三字码信息',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '自增编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'IdentityId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '三字码',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'Code'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '省份名称',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'ShengFenName'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '城市名称',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'ChengShiName'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机场名称',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'JiChangName'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '全拼',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'PY1'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '简拼',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'PY2'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '首字母',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'PY3'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '是否热门',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'IsReMen'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '排序编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoSanZiMa', 'column', 'PaiXuId'
go

/*==============================================================*/
/* Table: tbl_JiPiaoNotify                                      */
/*==============================================================*/
create table tbl_JiPiaoNotify (
   NotifyId             char(36)             not null,
   URL                  nvarchar(max)        null,
   LeiXing              nvarchar(50)         null,
   JSON                 nvarchar(max)        null,
   IssueTime            datetime             not null default getdate(),
   GuanLianLeiXing      nvarchar(50)         null,
   GuanLianId           char(36)             null,
   HandlerRetCode       nvarchar(50)         not null default '0',
   constraint PK_TBL_JIPIAONOTIFY primary key (NotifyId)
)
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机票通知相关信息',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '通知编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'NotifyId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   'URL',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'URL'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '通知类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'LeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   'JSON',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'JSON'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '通知时间',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'IssueTime'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '关联类型',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'GuanLianLeiXing'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '关联编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'GuanLianId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '处理结果',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoNotify', 'column', 'HandlerRetCode'
go


/*==============================================================*/
/* Table: tbl_JiPiaoDingDanErTongPnr                            */
/*==============================================================*/
create table tbl_JiPiaoDingDanErTongPnr (
   IdentityId           int                  identity,
   DingDanId            char(36)             not null,
   Pnr                  nvarchar(50)         null,
   PnrInfo              nvarchar(MAX)        null,
   constraint PK_TBL_JIPIAODINGDANERTONGPNR primary key (IdentityId)
)
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '机票订单儿童PNR信息',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanErTongPnr'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '自增编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanErTongPnr', 'column', 'IdentityId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   '订单编号',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanErTongPnr', 'column', 'DingDanId'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   'Pnr',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanErTongPnr', 'column', 'Pnr'
go

declare @CurrentUser sysname
select @CurrentUser = user_name()
execute sp_addextendedproperty 'MS_Description', 
   'PnrInfo',
   'user', @CurrentUser, 'table', 'tbl_JiPiaoDingDanErTongPnr', 'column', 'PnrInfo'
go




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[View_DingDan]
AS
SELECT   CAST(a.OrderId AS varchar(36)) as OrderId,  a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT   CAST(b.DingDanId AS varchar(36)) as OrderId,  b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT  CAST(c.OrderID AS varchar(36)) as OrderId,   c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT   CAST(d.OrderId AS varchar(36)) as OrderId,  d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT   CAST(e.OrderId AS varchar(36)) as OrderId,  e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT  CAST(f.OrderId AS varchar(36)) as OrderId,   f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT  CAST(g.OrderID AS varchar(36)) as OrderId,   g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID
FROM         tbl_ShangChengDingDan AS g
UNION ALL
SELECT  CAST(h.ZuTuanId AS varchar(36)) as OrderId,   h.ZongJinE AS JinE, h.OrderState AS OrderStatus, h.OrderCode AS OrderCode, h.XDRId AS XDRId, h.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRMoblie, h.IssueTime AS IssueTime,
                          h.XianLuName AS OrderName, '成人:'+CAST(h.ChengTuanNum AS varchar(30)) + '人，儿童:'+CAST(h.ErTongNum AS varchar(30))+'人' AS OrderNum, h.AgencyJinE AS AgencyJinE, 
                      h.AgencyId AS AgencyId, 9 AS OrderType,CAST(h.XianLuId AS varchar(36)) as ProductID
FROM         tbl_ZiZuTuan AS h
UNION ALL
SELECT  CAST(j.DingDanId AS varchar(36)) as OrderId,   j.JinE AS JinE, j.DingDanStatus AS OrderStatus, j.JiaoYiHao AS OrderCode, j.HuiYuanId AS XDRId, j.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRMoblie, j.XiaDanShiJian AS IssueTime,
                          j.ChuFaChengShiSanZiMa +' - ' + j.DaoDaChengShiSanZiMa AS OrderName, CAST(j.DingPiaoRenShu AS varchar(30)) AS OrderNum, 0 AS AgencyJinE, 
                      '' AS AgencyId, 10 AS OrderType,'' as ProductID
FROM         tbl_JiPiaoDingDan AS j
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[proc_JiPiaoDingDan_C]
	@DingDanId CHAR(36)
	,@ApiDingDanId CHAR(36)
	,@GongPiaoShangId NVARCHAR(50)
	,@ZhengCeId NVARCHAR(50)
	,@CangWei NVARCHAR(50)
	,@HangBanHao NVARCHAR(50)
	,@ChuFaChengShiSanZiMa NVARCHAR(50)
	,@DaoDaChengShiSanZiMa NVARCHAR(50)
	,@ChuFaRiQi DATETIME
	,@CaiGouFanDian MONEY
	,@ShiFuDaYinXingChengDan INT
	,@ZhengCeLeiXing INT
	,@HangXianLeiXing INT
	,@XiaDanShiJian DATETIME
	,@DingDanStatus INT
	,@FuKuanStatus INT
	,@FuKuanShiJian DATETIME
	,@PNR NVARCHAR(50)
	,@KeHuYouHuiDian MONEY
	,@JingXiaoShangLiRunDian MONEY
	,@JinE MONEY
	,@JingXiaoShangLiRun MONEY
	,@QiFeiShiJian NVARCHAR(50)
	,@DaoDaShiJian NVARCHAR(50)
	,@PiaoMianJiaGe MONEY
	,@ShuiFeiJinE MONEY
	,@DingPiaoRenShu INT
	,@ChengRenDingDanId CHAR(36)
	,@ErTongDingDanId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@ChengKeXml NVARCHAR(MAX)
	,@ChengKeLeiXing INT
	,@ApiJieShouFangShi INT
	,@ShiFouYunXuGengHuanPnr INT
	,@ShiFouZiDongDaiKou INT
	,@XiangApiFuKuanStatus INT
	,@XiangApiFuKuanShiJian DATETIME
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @hdoc INT
	DECLARE @errorcount INT
	DECLARE @IdentityId INT
	DECLARE @JiaoYiHao NVARCHAR(255)
	
	SET @errorcount=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	BEGIN TRAN
	
	INSERT INTO [tbl_JiPiaoDingDan]([DingDanId],[ApiDingDanId],[GongPiaoShangId]
		,[ZhengCeId],[CangWei],[HangBanHao]
		,[ChuFaChengShiSanZiMa],[DaoDaChengShiSanZiMa],[ChuFaRiQi]
		,[CaiGouFanDian],[ShiFuDaYinXingChengDan],[ZhengCeLeiXing]
		,[HangXianLeiXing],[XiaDanShiJian],[DingDanStatus]
		,[FuKuanStatus],[FuKuanShiJian],[PNR],[KeHuYouHuiDian]
		,[JingXiaoShangLiRunDian],[JinE],[JingXiaoShangLiRun]
		,[QiFeiShiJian],[DaoDaShiJian],[PiaoMianJiaGe]
		,[ShuiFeiJinE],[DingPiaoRenShu],[ChengRenDingDanId],[ErTongDingDanId]
		,[HuiYuanId],[ShiFouShanChu],[JiaoYiHao]
		,[ChengKeLeiXing],[ApiJieShouFangShi],[ShiFouYunXuGengHuanPnr]
		,[ShiFouZiDongDaiKou],[XiangApiFuKuanStatus],[XiangApiFuKuanShiJian])
	VALUES(@DingDanId,@ApiDingDanId,@GongPiaoShangId
		,@ZhengCeId,@CangWei,@HangBanHao
		,@ChuFaChengShiSanZiMa,@DaoDaChengShiSanZiMa,@ChuFaRiQi
		,@CaiGouFanDian,@ShiFuDaYinXingChengDan,@ZhengCeLeiXing
		,@HangXianLeiXing,@XiaDanShiJian,@DingDanStatus
		,@FuKuanStatus,@FuKuanShiJian,@PNR,@KeHuYouHuiDian
		,@JingXiaoShangLiRunDian,@JinE,@JingXiaoShangLiRun
		,@QiFeiShiJian,@DaoDaShiJian,@PiaoMianJiaGe
		,@ShuiFeiJinE,@DingPiaoRenShu,@ChengRenDingDanId,@ErTongDingDanId
		,@HuiYuanId,'0',''
		,@ChengKeLeiXing,@ApiJieShouFangShi,@ShiFouYunXuGengHuanPnr
		,@ShiFouZiDongDaiKou,@XiangApiFuKuanStatus,@XiangApiFuKuanShiJian)
	SET @errorcount=@errorcount+@@ERROR
	SET @IdentityId=SCOPE_IDENTITY()
	
	SET @JiaoYiHao='JP'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
	
	UPDATE [tbl_JiPiaoDingDan] SET [JiaoYiHao]=@JiaoYiHao WHERE DingDanId=@DingDanId
	SET @errorcount=@errorcount+@@ERROR
		
	IF(@errorcount=0 AND @ChengKeXml IS NOT NULL AND LEN(@ChengKeXml)>0)
	BEGIN
		EXEC sp_xml_preparedocument @hdoc OUTPUT,@ChengKeXml	
		INSERT INTO [tbl_JiPiaoDingDanChengKe]([ChengKeId],[XingMing],[ZhengJianHao]
			,[ZhengJianLeiXing],[ChengKeLeiXing],[ChuShengRiQi]
			,[DingDanId])
		SELECT [ChengKeId],[XingMing],[ZhengJianHao]
			,[ZhengJianLeiXing],[ChengKeLeiXing],[ChuShengRiQi]
			,@DingDanId
		FROM OPENXML(@hdoc,'/root/info',3)
			WITH([ChengKeId] CHAR(36),[XingMing] NVARCHAR(50),[ZhengJianHao] NVARCHAR(50)
			,[ZhengJianLeiXing] INT,[ChengKeLeiXing] INT,[ChuShengRiQi] DATETIME)	
		SET @errorcount=@errorcount+@@ERROR
		EXEC sp_xml_removedocument @hdoc
	END
	
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN	
	
	SET @RetCode=1
	RETURN @RetCode	
END
GO
CREATE PROCEDURE [dbo].[proc_JiPiaoDingDan_D]
	@DingDanId CHAR(36)
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YuanFuKuanStatus INT
	DECLARE @YuanDingDanStatus INT
	DECLARE @YuanXiangApiFuKuanStatus INT
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	SELECT @YuanDingDanStatus=DingDanStatus,@YuanFuKuanStatus=FuKuanStatus,@YuanXiangApiFuKuanStatus=XiangApiFuKuanStatus FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId
	
	IF(@YuanFuKuanStatus=1)--已付款
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF(@YuanXiangApiFuKuanStatus=1)--已向API付款
	BEGIN
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	UPDATE tbl_JiPiaoDingDan SET ShiFouShanChu='1' WHERE DingDanId=@DingDanId
	
	SET @RetCode=1
	RETURN @RetCode
END
go
CREATE PROCEDURE [dbo].[proc_JiPiaoDingDan_SheZhiDingDanStatus] 
	@DingDanId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@DingDanStatus INT
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YuanDingDanStatus INT
	DECLARE @YuanFuKuanStatus INT
	DECLARE @YuanXiangApiFuKuanStatus INT
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId AND HuiYuanId=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	SELECT @YuanDingDanStatus=DingDanStatus,@YuanFuKuanStatus=FuKuanStatus,@YuanXiangApiFuKuanStatus=XiangApiFuKuanStatus FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId

	--验证相关状态信息	
	IF(@DingDanStatus=2)--出票成功
	BEGIN
		IF(@YuanFuKuanStatus<>1)--原订单付款状态不等于已付款
		BEGIN
			SET @RetCode=-98
			RETURN @RetCode
		END
	END
	--待补充其它验证

	UPDATE tbl_JiPiaoDingDan SET DingDanStatus=@DingDanStatus WHERE DingDanId=@DingDanId	
	
	SET @RetCode=1
	RETURN @RetCode
END
go
CREATE PROCEDURE [dbo].[proc_JiPiaoDingDan_SheZhiFuKuanStatus]
	@DingDanId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@FuKuanStatus INT
	,@FuKuanShiJian DATETIME
	,@DingDanStatus INT--传NULL值不变更订单状态
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YuanFuKuanStatus INT
	DECLARE @ErTongDingDanId CHAR(36)
	DECLARE @ChengKeLeiXing INT
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId AND HuiYuanId=@HuiYuanId AND ShiFouShanChu='0')
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END	
	
	SELECT @YuanFuKuanStatus=FuKuanStatus,@ErTongDingDanId=ErTongDingDanId,@ChengKeLeiXing=ChengKeLeiXing FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId
	
	IF(@YuanFuKuanStatus=1)--已支付
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF(@ChengKeLeiXing=1)
	BEGIN
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	UPDATE tbl_JiPiaoDingDan SET FuKuanStatus=@FuKuanStatus,FuKuanShiJian=@FuKuanShiJian WHERE DingDanId=@DingDanId

	IF(@DingDanStatus IS NOT NULL)
	BEGIN
		UPDATE tbl_JiPiaoDingDan SET DingDanStatus=@DingDanStatus WHERE DingDanId=@DingDanId
	END
	
	IF(@ErTongDingDanId IS NOT NULl AND LEN(@ErTongDingDanId)>0)
	BEGIN
		UPDATE tbl_JiPiaoDingDan SET FuKuanStatus=@FuKuanStatus,FuKuanShiJian=@FuKuanShiJian WHERE DingDanId=@ErTongDingDanId
		
		IF(@DingDanStatus IS NOT NULL)
		BEGIN
			UPDATE tbl_JiPiaoDingDan SET DingDanStatus=@DingDanStatus WHERE DingDanId=@ErTongDingDanId
		END	
	END
		
	SET @RetCode=1
	RETURN @RetCode	
	
END
go
CREATE PROCEDURE [dbo].[proc_JiPiaoDingDan_SheZhiXiangApiFuKuanStatus]
	@DingDanId CHAR(36)
	,@XiangApiFuKuanStatus INT
	,@XiangApiFuKuanShiJian DATETIME
	,@DingDanStatus INT--传NULL值不变更订单状态
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YuanXiangApiFuKuanStatus INT
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId AND ShiFouShanChu='0')
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END	
	
	SELECT @YuanXiangApiFuKuanStatus=XiangApiFuKuanStatus FROM tbl_JiPiaoDingDan WHERE DingDanId=@DingDanId
	
	IF(@YuanXiangApiFuKuanStatus=1)--已支付
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	UPDATE tbl_JiPiaoDingDan SET XiangApiFuKuanStatus=@XiangApiFuKuanStatus,XiangApiFuKuanShiJian=@XiangApiFuKuanShiJian WHERE DingDanId=@DingDanId

	IF(@DingDanStatus IS NOT NULL)
	BEGIN
		UPDATE tbl_JiPiaoDingDan SET DingDanStatus=@DingDanStatus WHERE DingDanId=@DingDanId
	END
		
	SET @RetCode=1
	RETURN @RetCode	
	
END
GO
CREATE TABLE tbl_WeiXinBind(
	 id   int  IDENTITY(1,1) NOT NULL PRIMARY KEY,
	 OpenID   nvarchar (50)  NOT NULL,
	 MemberID   char (36) NOT NULL,
	 MemberName   nvarchar (50) NOT NULL,
	 AccountNum   nvarchar (50) NOT NULL,
	 ShopUrl   nvarchar (200)  NOT NULL,
	 BindTime   datetime  NOT NULL,
	 NickName   nvarchar (20) NULL
	 )
GO
	 
	 
	 
	 
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_TuanGou]
AS
SELECT     dbo.tbl_TuanGouChanPin.*,
(select SUM(ProductNum) from dbo.tbl_TuanGouDingDan 
where ProductID =dbo.tbl_TuanGouChanPin.ID) as Salevolume,
(select COUNT(OrderID) from dbo.tbl_TuanGouDingDan 
where ProductID =dbo.tbl_TuanGouChanPin.ID) as GouMaiRenShu
FROM         dbo.tbl_TuanGouChanPin
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

alter table tbl_TuanGouChanPin add ProductSort int default 0 not null 
go 

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_TuanGou]
AS
SELECT     dbo.tbl_TuanGouChanPin.*,
(select SUM(ProductNum) from dbo.tbl_TuanGouDingDan 
where ProductID =dbo.tbl_TuanGouChanPin.ID) as Salevolume,
(select COUNT(OrderID) from dbo.tbl_TuanGouDingDan 
where ProductID =dbo.tbl_TuanGouChanPin.ID) as GouMaiRenShu
from tbl_TuanGouChanPin
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_JiFen](
	[DuiHuanId] [char](36) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[DuiHuanJinE] [int] NULL,
	[ShengYuJinE] [decimal] NULL,
	[IssueTime] [datetime] NULL,
	[UserId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[DuiHuanStatus] [int] NULL,
 CONSTRAINT [PK_tbl_JiFen] PRIMARY KEY CLUSTERED 
(
	[DuiHuanId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO

--添加线路新增“其他事项，赠送项目”

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	修改线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLu_Update]
	 @XianLuId CHAR(36)--线路编号
	,@InterfaceID NVARCHAR(50)
	,@AreaName NVARCHAR(255)
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>

	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	UPDATE [tbl_XianLu] SET [AreaId]=@AreaId,[RouteName]=@RouteName,[TianShu]=@TianShu
		,[DepProvinceId]=@DepProvinceId,[DepCityId]=@DepCityId,[ArrProvinceId]=@ArrProvinceId
		,[ArrCityId]=@ArrCityId,[JiHuaRenShu]=@JiHuaRenShu,[SCJCR]=@SCJCR
		,[SCJET]=@SCJET,[JSJCR]=@JSJCR,[JSJET]=@JSJET
		,[TingTianShu]=@TingTianShu,[ChuFaJiaoTong]=@ChuFaJiaoTong,[FanChengJiaoTong]=@FanChengJiaoTong
		,[JiHeFangShi]=@JiHeFangShi,[TeSe]=@TeSe,[TeSeFilePath]=@TeSeFilePath
		,[TuJing]=@TuJing,[QianZheng]=@QianZheng,[QianZhengFilePath]=@QianZhengFilePath
		,[GuanZhuShu]=[GuanZhuShu],[LxrName]=@LxrName,[LxrTelephone]=@LxrTelephone
		,[LxrQQ]=@LxrQQ,[LxrMobile]=@LxrMobile,[Description]=@Description
		,[Keywords]=@Keywords,[LatestId]=@LatestId,[LatestTime]=@LatestTime
		,[InterfaceID]=@InterfaceID,[AreaName]=@AreaName
	WHERE [XianLuId]=@XianLuId

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuXingCheng] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
			INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
				,[ZhuSu],[YongCan],[XingCheng]
				,[FilePath])
			SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
				,A.[ZhuSu],A.[YongCan],A.[XingCheng]
				,A.[FilePath]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END		
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuFuWu] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
			INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi],[ZengSongXiangMu],[QiTaShiXiang])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi],A.[ZengSongXiangMu],A.[QiTaShiXiang]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX),[ZengSongXiangMu] VARCHAR(MAX),[QiTaShiXiang] NVARCHAR(MAX)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuTi] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
			INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
			SELECT @XianLuId,A.[ZhuTiId]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([ZhuTiId] INT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuangTai] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
			INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
			SELECT @XianLuId,A.[Status]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([Status] TINYINT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0 AND @TourXml IS NOT NULL AND LEN(@TourXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml

		UPDATE [tbl_XianLuTour] SET [LDate]=B.LDate,[RDate]=B.RDate,[SYRS]=b.SYRS
		FROM [tbl_XianLuTour] AS A INNER JOIN (SELECT [TourId],[LDate],[RDate],[Status],[SYRS] FROM OPENXML(@hdoc,'/root/info') WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[SYRS] INT)) AS B
		ON A.TourId=B.TourId
		WHERE A.XianLuId=@XianLuId
		SET @errorcount=@errorcount+@@ERROR

		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR]
			,[JSJET])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],@JSJCR
			,@JSJET
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT) AS A
		WHERE A.TourId NOT IN(SELECT TourId FROM [tbl_XianLuTour] AS B WHERE B.XianLuId=@XianLuId)
		SET @errorcount=@errorcount+@@ERROR

		DELETE FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId 
		AND [TourId] NOT IN(SELECT A.[TourId] FROM OPENXML(@hdoc,'/root/info') WITH([TourId] CHAR(36)) AS A) 
		AND [TourId] NOT IN(SELECT A.[TourId] FROM [tbl_XianLuTourOrder] AS A WHERE A.XianLuId=@XianLuId)
		SET @errorcount=@errorcount+@@ERROR

		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuTeSeFile] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
			INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
			SELECT @XianLuId,A.FilePath,A.MiaoShu
			FROM OPENXML(@hdoc,'/root/info')
			WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO
-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-14
-- Description:	修改线路产品信息，返回1成功，其它失败
-- History:
-- 1.2013-12-10 汪奇志 [tbl_XianLuTour].[JSJCR]、[tbl_XianLuTour].[JSJET]
-- =============================================
CREATE PROCEDURE [dbo].[proc_XianLu_OutUpdate]
	 @XianLuId CHAR(36)--线路编号
	,@InterfaceID NVARCHAR(50)
	,@AreaName NVARCHAR(255)
	,@AreaId INT--线路区域
	,@RouteName NVARCHAR(255)--线路名称
	,@TianShu INT--行程天数
	,@DepProvinceId INT--出发地省份编号
	,@DepCityId INT--出发地城市编号
	,@ArrProvinceId INT--目的地省份编号
	,@ArrCityId INT--目的地城市编号
	,@JiHuaRenShu INT--计划人数
	,@SCJCR MONEY--市场价-成人
	,@SCJET MONEY--市场价-儿童
	,@JSJCR MONEY--结算价-成人
	,@JSJET MONEY--结算价-儿童
	,@TingTianShu INT--提前X天报名
	,@ChuFaJiaoTong NVARCHAR(255)--出发交通
	,@FanChengJiaoTong NVARCHAR(255)--返程交通
	,@JiHeFangShi NVARCHAR(255)--集合方式
	,@TeSe NVARCHAR(MAX)--特色描述文字
	,@TeSeFilePath NVARCHAR(255)--特色描述图片
	,@TuJing NVARCHAR(255)--途径
	,@QianZheng NVARCHAR(MAX)--签证资料
	,@QianZhengFilePath NVARCHAR(255)--签证说明
	,@GuanZhuShu INT--关注数
	,@LxrName NVARCHAR(255)--联系人姓名
	,@LxrTelephone NVARCHAR(255)--联系人电话
	,@LxrQQ NVARCHAR(255)--联系人QQ
	,@LxrMobile NVARCHAR(255)--联系人手机
	,@Description NVARCHAR(255)--description
	,@Keywords NVARCHAR(255)--keywords
	,@OperatorId INT--发布人编号
	,@IssueTime DATETIME--发布时间
	,@LatestId INT--修改人编号
	,@LatestTime DATETIME--修改时间
	,@XingChengXML NVARCHAR(MAX)--行程XML:<root><info QuJian="" JiaoTong="" ZhuSu="" YongCan="" XingCheng="" FilePath="" /></root>
	,@FuWuXml NVARCHAR(MAX)--服务标准XML:<root><info FuWuBiaoZhun="" BuHanXiangMu="" GouWuAnPai="" ErTongAnPai="" ZiFeiXiangMu="" ZhuYiShiXiang="" WenXinTiXing="" BaoMingXuZhi=""/></root>
	,@ZhuTiXml NVARCHAR(MAX)--主题XML:<root><info ZhuTiId="" /></root>
	,@ZhuangTaiXml NVARCHAR(MAX)--状态XML:<root><info Status="" /></root>
	,@TourXml NVARCHAR(MAX)--发班XML:<root><info TourId="" LDate="" RDate="" Status="" /></root>
	,@TeSeFileXml NVARCHAR(MAX)--特色图片XML:<root><info FilePath="" MiaoShu="" /></root>
	,@TourTraffice NVARCHAR(MAX)--航班
	,@CFCS NVARCHAR(50)--出发城市
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0

	BEGIN TRAN

	UPDATE [tbl_XianLu] SET [AreaId]=@AreaId,[RouteName]=@RouteName,[TianShu]=@TianShu
		,[DepProvinceId]=@DepProvinceId,[DepCityId]=@DepCityId,[ArrProvinceId]=@ArrProvinceId
		,[ArrCityId]=@ArrCityId,[JiHuaRenShu]=@JiHuaRenShu,[SCJCR]=@SCJCR
		,[SCJET]=@SCJET,[JSJCR]=@JSJCR,[JSJET]=@JSJET
		,[TingTianShu]=@TingTianShu,[ChuFaJiaoTong]=@ChuFaJiaoTong,[FanChengJiaoTong]=@FanChengJiaoTong
		,[JiHeFangShi]=@JiHeFangShi,[TeSe]=@TeSe,[TeSeFilePath]=@TeSeFilePath
		,[TuJing]=@TuJing,[QianZheng]=@QianZheng,[QianZhengFilePath]=@QianZhengFilePath
		,[GuanZhuShu]=[GuanZhuShu],[LxrName]=@LxrName,[LxrTelephone]=@LxrTelephone
		,[LxrQQ]=@LxrQQ,[LxrMobile]=@LxrMobile,[Description]=@Description
		,[Keywords]=@Keywords,[LatestId]=@LatestId,[LatestTime]=@LatestTime
		,[InterfaceID]=@InterfaceID,[AreaName]=@AreaName,[CFCS]=@CFCS
	WHERE [XianLuId]=@XianLuId

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuXingCheng] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @XingChengXML IS NOT NULL AND LEN(@XingChengXML)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@XingChengXML
			INSERT INTO [tbl_XianLuXingCheng]([XianLuId],[QuJian],[JiaoTong]
				,[ZhuSu],[YongCan],[XingCheng]
				,[FilePath])
			SELECT @XianLuId,A.[QuJian],A.[JiaoTong]
				,A.[ZhuSu],A.[YongCan],A.[XingCheng]
				,A.[FilePath]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([QuJian] NVARCHAR(255),[JiaoTong] NVARCHAR(255),[ZhuSu] NVARCHAR(255),[YongCan] NVARCHAR(255),[XingCheng] NVARCHAR(MAX),[FilePath] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END		
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuFuWu] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @FuWuXml IS NOT NULL AND LEN(@FuWuXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@FuWuXMl
			INSERT INTO [tbl_XianLuFuWu]([XianLuId],[FuWuBiaoZhun],[BuHanXiangMu]
			,[GouWuAnPai],[ErTongAnPai],[ZiFeiXiangMu]
			,[ZhuYiShiXiang],[WenXinTiXing],[BaoMingXuZhi],[ZengSongXiangMu],[QiTaShiXiang])
		SELECT @XianLuId,A.[FuWuBiaoZhun],A.[BuHanXiangMu]
			,A.[GouWuAnPai],A.[ErTongAnPai],A.[ZiFeiXiangMu]
			,A.[ZhuYiShiXiang],A.[WenXinTiXing],A.[BaoMingXuZhi],A.[ZengSongXiangMu],A.[QiTaShiXiang]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([FuWuBiaoZhun] NVARCHAR(MAX),[BuHanXiangMu] NVARCHAR(MAX),[GouWuAnPai] NVARCHAR(MAX),[ErTongAnPai] NVARCHAR(MAX),[ZiFeiXiangMu] NVARCHAR(MAX),[ZhuYiShiXiang] NVARCHAR(MAX),[WenXinTiXing] NVARCHAR(MAX),[BaoMingXuZhi] NVARCHAR(MAX),[ZengSongXiangMu] VARCHAR(MAX),[QiTaShiXiang] NVARCHAR(MAX)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuTi] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuTiXml IS NOT NULL AND LEN(@ZhuTiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuTiXml
			INSERT INTO [tbl_XianLuZhuTi]([XianLuId],[ZhuTiId])
			SELECT @XianLuId,A.[ZhuTiId]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([ZhuTiId] INT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuZhuangTai] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @ZhuangTaiXml IS NOT NULL AND LEN(@ZhuangTaiXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@ZhuangTaiXml
			INSERT INTO [tbl_XianLuZhuangTai]([XianLuId],[Status])
			SELECT @XianLuId,A.[Status]
			FROM OPENXML(@hdoc,'/root/info')
			WITH([Status] TINYINT) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@TourXml IS NOT NULL AND LEN(@TourXml)>0)
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourXml

		INSERT INTO [tbl_XianLuTour]([TourId],[XianLuId],[LDate]
			,[RDate],[Status],[JSJCR],[JSJET],[SYRS],[TrafficId],[CRSCJ],[ETSCJ])
		SELECT A.[TourId],@XianLuId,A.[LDate]
			,A.[RDate],A.[Status],A.[JSJCR],A.[JSJET],A.[SYRS],A.[TrafficId],A.[CRSCJ],A.[ETSCJ]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([TourId] CHAR(36),[LDate] DATETIME,[RDate] DATETIME,[Status] TINYINT,[JSJCR] MONEY,[JSJET] MONEY,[SYRS] INT,[TrafficId] NVARCHAR(50),[CRSCJ] MONEY,[ETSCJ] MONEY) AS A
		
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount=0)
	BEGIN
		DELETE FROM [tbl_XianLuTeSeFile] WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @TeSeFileXml IS NOT NULL AND LEN(@TeSeFileXml)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TeSeFileXml
			INSERT INTO [tbl_XianLuTeSeFile]([XianLuId],[FilePath],[MiaoShu])
			SELECT @XianLuId,A.FilePath,A.MiaoShu
			FROM OPENXML(@hdoc,'/root/info')
			WITH([FilePath] NVARCHAR(255),[MiaoShu] NVARCHAR(255)) AS A
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END
	IF(@errorcount=0)
	BEGIN
		DELETE FROM tbl_XianLuTourTraffice WHERE [XianLuId]=@XianLuId
		SET @errorcount=@errorcount+@@ERROR
		IF(@errorcount=0 AND @TourTraffice IS NOT NULL AND LEN(@TourTraffice)>0)
		BEGIN
			EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@TourTraffice
			 
			INSERT INTO tbl_XianLuTourTraffice(XianLuId,TrafficId,Traffic_01
				,Traffic_02)
			SELECT @XianLuId,T.TrafficId,T.Traffic_01,T.Traffic_02
			FROM OPENXML(@hdoc,'/root/info')
			WITH(TrafficId NVARCHAR(60),Traffic_01 NVARCHAR(100),Traffic_02 NVARCHAR(100)) AS T
			SET @errorcount=@errorcount+@@ERROR
			EXECUTE sp_xml_removedocument @hdoc
		END
	END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode
END
GO

-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_SQL_TASK]
	
AS
update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=1 and areaname=[tbl_XianLu].areaname)
where line_source=1
and areaname in (select areaname from tbl_sysarea where RouteType=1)



update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=3 and areaname=[tbl_XianLu].areaname)
where line_source=1
and areaname in (select areaname from tbl_sysarea where RouteType=3)



update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=2 and areaname=[tbl_XianLu].areaname)
where line_source=3
and areaname in (select areaname from tbl_sysarea where RouteType=2)



update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=2 and areaname=[tbl_XianLu].areaname)
where line_source=4
and areaname in (select areaname from tbl_sysarea where RouteType=2)



update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=1 and areaname=[tbl_XianLu].areaname)
where line_source=5
and areaname in (select areaname from tbl_sysarea where RouteType=1)



update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=2 and areaname=[tbl_XianLu].areaname)
where line_source=5
and areaname in (select areaname from tbl_sysarea where RouteType=2)



update
 [tbl_XianLu]
set areaid=(select top 1 id from tbl_sysarea where RouteType=3 and areaname=[tbl_XianLu].areaname)
where line_source=5
and areaname in (select areaname from tbl_sysarea where RouteType=3)



update [tbl_XianLu]
set cfcs=replace(cfcs,'市区','')



UPDATE  dbo.tbl_XianLu
SET     DepCityId = ISNULL(( SELECT TOP 1
                                    C.ID
                             FROM   dbo.tbl_SysCity C
                                    INNER JOIN dbo.tbl_SysProvince P ON C.ProvinceId = P.ID
                             WHERE  P.[Name] + C.[Name] LIKE '%' + CFCS + '%'
                           ), 0)
WHERE   DepCityId <= 0

UPDATE  dbo.tbl_XianLu
SET     DepProvinceId = (select top 1 ProvinceId from tbl_SysCity where tbl_SysCity.id=DepCityId)
WHERE    DepCityId<>0
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_JiangLiBi](
	[DingDanId] [char](36) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[OrderType] [int] NULL,
	[JiangLiBiLi] [decimal](18, 2) NULL,
 CONSTRAINT [PK_tbl_JiangLiBi] PRIMARY KEY CLUSTERED 
(
	[DingDanId] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝交易信息
-- =============================================
ALTER VIEW [dbo].[view_FenSiJiaoYi]
AS
--线路订单
SELECT A.OrderId AS DingDanId--订单编号
	,A.IssueTime AS XiaDanShiJian--下单时间
	,A.OperatorId AS XianDanRenId--下单人编号
	,A.JinE AS DingDanJinE--订单金额
	,A.Status AS DingDanStatus--订单状态
	,A.FuKuanStatus AS FuKuanStatus--付款状态
	,A.AgencyId AS DaiLiShangId--代理商编号
	,A.AgencyJinE AS DaiLiShangJinE--代理商金额
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号
	,(SELECT TOP 1 A1.Name FROM tbl_XianLuTourOrderYouKe AS A1 WHERE A1.OrderId=A.OrderId) AS KeRenName--客人姓名
	,C.RouteName AS CPName--产品名称
	,(CASE D.RouteType WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END) AS DingDanLeiXing--订单类型
	,E.MemberName AS XiaDanRenName--下单人姓名
	,F.MemberId AS DaiLiShangHuiYuanId--代理商会员编号
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_XianLuTourOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_XianLu AS C
ON A.XianLuId=C.XianLuId LEFT OUTER JOIN tbl_SysArea AS D
ON C.AreaId=D.ID LEFT OUTER JOIN tbl_Member AS E
ON A.OperatorId=E.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--商城订单
SELECT A.OrderID AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.ContactID AS XiaDanRenId
	,ISNULL(A.OrderPrice,0) AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,A.SupplierMoney AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.ProductName AS CPName
	,3 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_ShangChengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.ContactID=B.MemberID LEFT OUTER JOIN tbl_ShangChengChanPin AS C
ON A.ProductId=C.ProductID LEFT OUTER JOIN tbl_Member AS D
ON A.ContactID=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SupplierID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--门票订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.Price AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,A.AgencyJinE AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.EnName AS CPName
	,4 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_ScenicAreaOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_ScenicTickets AS C
ON A.TicketsId=C.TicketsId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SellerID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--酒店订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.TotalAmount AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PaymentState AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.HotelName AS CPName
	,5 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_HotelOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_Hotel AS C
ON A.HotelId=C.HotelId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SellerID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--签证订单
SELECT A.DingDanId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.XiaDanRenId  AS XianDanRenId
	,A.JinE AS DingDanJinE
	,A.DingDanStatus AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrXingMing AS KeRenName
	,C.[Name] AS CPName
	,6 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_QianZhengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.XiaDanRenId=B.MemberID LEFT OUTER JOIN tbl_QianZheng AS C
ON A.QianZhengId=C.QianZhengId LEFT OUTER JOIN tbl_Member AS D
ON A.XiaDanRenId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.DingDanId = H.DingDanId

UNION ALL
--团购订单
SELECT CAST(A.OrderId AS CHAR(36)) AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.PeopleID AS XiaDanRenId
	,A.OrderPrice AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,0 AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.PeopleName AS KeRenName
	,C.ProductName AS CPName
	,7 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_TuanGouDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.PeopleID=B.MemberID LEFT OUTER JOIN tbl_TuanGouChanPin AS C
ON A.ProductID=C.Id LEFT OUTER JOIN tbl_Member AS D
ON A.PeopleID=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SupplierID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--租车订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,ISNULL(A.ZuJin,0) AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrName AS KeRenName
	,C.CarName AS CPName
	,8 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_JA_ZuCheOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_JA_ZuCheInfo AS C
ON A.ZuCheID=C.ZuCheID LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO



set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go



-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	获取会员下级分销提成-金额
-- =============================================
ALTER PROCEDURE [dbo].[proc_XiaJiFenXiaoTiCheng_GetJinE]
	@HuiYuanId CHAR(36)--会员编号
	,@SuoYouYongJinJinE MONEY OUTPUT--所有下级分销佣金金额
	,@YiShenQingYongJinJinE MONEY OUTPUT--已申请下级分销佣金金额
	,@YiShenQingJinE MONEY OUTPUT--已申请提成金额
	,@YiShenPiYongJinJinE MONEY OUTPUT--已审批下级分销佣金金额
	,@YiShenPiJinE MONEY OUTPUT--已审批提成金额
	,@RetCode INT OUTPUT--OUTPUT CODE
    ,@ZongJinE money output --总共奖励金额
AS
BEGIN
	SET @RetCode=0
	SET @SuoYouYongJinJinE=0
	SET @YiShenQingYongJinJinE=0
	SET @YiShenQingJinE=0
	SET @YiShenPiYongJinJinE=0
	SET @YiShenPiJinE=0
    set @ZongJinE =0
	DECLARE @HuiYuanDaiLiShangId CHAR(36)
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId)
	BEGIN
		--会员不是代理商
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	SELECT @HuiYuanDaiLiShangId=ID FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId
	
	SELECT @SuoYouYongJinJinE=ISNULL(SUM(DingDanJinE-DaiLiShangJinE),0) FROM view_FenSiJiaoYi WHERE DaiLiShangShangJiDaiLiShangHuiYuanId=@HuiYuanId AND DingDanStatus IN(2,3,4,5) AND FuKuanStatus IN(1)

	SELECT 	@YiShenQingYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT @YiShenQingJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT 	@YiShenPiYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)

	SELECT @YiShenPiJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)	
    select @ZongJinE=ISNULL(sum((DingDanJinE - DaiLiShangJinE)*JiangLiBiLi),0) from view_FenSiJiaoYi where DaiLiShangShangJiDaiLiShangHuiYuanId =@HuiYuanId and DingDanStatus in(4,5)

	SET @RetCode=1
	RETURN @RetCode	
END

GO


set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
go



-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	下级分销提成-申请
-- =============================================
ALTER PROCEDURE [dbo].[proc_XiaJiFenXiaoTiCheng_C]
	@TiChengId CHAR(36)--提成编号
	,@HuiYuanId CHAR(36)--会员编号
	,@YongJinJinE MONEY--申请提成的佣金金额
	,@BiLi MONEY--此次申请提成的比例
	,@JinE MONEY--此次申请提成金额
	,@ShiJian DATETIME--申请时间
	,@Status TINYINT--申请状态
	,@RetCode INT OUTPUT--OUTPUT CODE 
	,@JiaoYiHao NVARCHAR(50) OUTPUT--OUTPUT CODE 交易号
AS
BEGIN
	SET @RetCode=0
	DECLARE @SuoYouYongJinJinE MONEY--所有下级分销的佣金金额
	DECLARE @YiShenQingYongJinJinE MONEY--已经申请提成的佣金金额
	DECLARE @YiShenQingJinE MONEY--已申请提成金额
	DECLARE @YiShenPiYongJinJinE MONEY--已审批下级分销佣金金额
	DECLARE @YiShenPiJinE MONEY--已审批提成金额
    DECLARE @ZongJinE MONEY--已审批提成金额
	DECLARE @TempRetCode INT 
	DECLARE @IdentityId INT
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	--获取下级分销金额信息
	EXEC proc_XiaJiFenXiaoTiCheng_GetJinE @HuiYuanId=@HuiYuanId,@SuoYouYongJinJinE=@SuoYouYongJinJinE OUTPUT
		,@YiShenQingYongJinJinE=@YiShenQingYongJinJinE OUTPUT,@YiShenQingJinE=@YiShenQingJinE OUTPUT
		,@YiShenPiYongJinJinE=@YiShenPiYongJinJinE OUTPUT,@YiShenPiJinE=@YiShenPiJinE OUTPUT
		,@RetCode=@TempRetCode OUTPUT,@ZongJinE=@ZongJinE output 

	IF(@SuoYouYongJinJinE<@YiShenQingYongJinJinE+@YongJinJinE)	
	BEGIN
		--此次申请提成的佣金金额大于可以申请提成的佣金金额
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	INSERT INTO [tbl_HuiYuanXiaJiFenXiaoTiCheng]([TiChengId],[HuiYuanId],[YongJinJinE]
		,[BiLi],[JinE],[ShiJian]
		,[Status],[ZhuanZhangShiJian],[ZhuanZhangCaoZuoRenId]
		,[JiaoYiHao])
	VALUES(@TiChengId,@HuiYuanId,@YongJinJinE
		,@BiLi,@JinE,@ShiJian
		,@Status,@ShiJian,0
		,'')
	SET @IdentityId=SCOPE_IDENTITY()
		
	SET @JiaoYiHao='JLO'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
	UPDATE [tbl_HuiYuanXiaJiFenXiaoTiCheng] SET [JiaoYiHao]=@JiaoYiHao WHERE [TiChengId]=@TiChengId
	
	SET @RetCode=1
	RETURN @RetCode
END


GO


alter table tbl_JA_ZuCheInfo add ProductSort int default 0 not null 
go 
alter table tbl_XianLu add ProductSort int default 0 not null 
go 
alter table tbl_Hotel add ProductSort int default 0 not null 
go 
alter table tbl_ScenicArea add ProductSort int default 0 not null 
go 
alter table tbl_ShangChengChanPin add ProductSort int default 0 not null 
go 


SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER VIEW [dbo].[view_XianLu]
AS
SELECT   A.XianLuId, A.AreaId, A.RouteName, A.TianShu, A.DepProvinceId, A.DepCityId, A.ArrProvinceId, A.ArrCityId, A.JiHuaRenShu, A.SCJCR, A.SCJET, A.JSJCR, 
                      A.JSJET, A.TingTianShu, A.ChuFaJiaoTong, A.FanChengJiaoTong, A.JiHeFangShi, A.TeSe, A.TeSeFilePath, A.TuJing, A.QianZheng, A.QianZhengFilePath, 
                      A.GuanZhuShu, A.LxrName, A.LxrTelephone, A.LxrQQ, A.LxrMobile, A.Description, A.Keywords, A.OperatorId, A.IssueTime, A.LatestId, A.LatestTime, 
                      A.Line_Source, A.LineType, A.IdentityId, A.AreaName, A.InterfaceID, B.TourId, B.LDate, B.RDate, B.Status,
                          (SELECT     AVG(ManYiDu) AS ManYiDu
                            FROM          dbo.tbl_XianLuDianPing
                            WHERE      (XianLuId = A.XianLuId)) AS ManYiDu,
                          (SELECT     COUNT(1) AS Expr1
                            FROM          dbo.tbl_XianLuDianPing AS tbl_XianLuDianPing_1
                            WHERE      (XianLuId = A.XianLuId)) AS DianPingShu, B.JSJCR AS JSJCR1, B.JSJET AS JSJET1, A.CFCS,A.xianluzt,A.ProductSort
FROM         dbo.tbl_XianLu AS A LEFT OUTER JOIN
                      dbo.view_XianLuTour_ZuiJinFaBan AS B ON A.XianLuId = B.XianLuId
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT SupplierName  FROM [tbl_Supplier] where ID=a.GYSid ) as SupplierName
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,(a.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       ,a.Unit,a.IsTrue,a.ProductSort
  FROM tbl_ShangChengChanPin as a
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-29
-- Description:	粉丝交易信息
-- =============================================
ALTER VIEW [dbo].[view_FenSiJiaoYi]
AS
--线路订单
SELECT A.OrderId AS DingDanId--订单编号
	,A.IssueTime AS XiaDanShiJian--下单时间
	,A.OperatorId AS XianDanRenId--下单人编号
	,A.JinE AS DingDanJinE--订单金额
	,A.Status AS DingDanStatus--订单状态
	,A.FuKuanStatus AS FuKuanStatus--付款状态
	,A.AgencyId AS DaiLiShangId--代理商编号
	,A.AgencyJinE AS DaiLiShangJinE--代理商金额
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号
	,(SELECT TOP 1 A1.Name FROM tbl_XianLuTourOrderYouKe AS A1 WHERE A1.OrderId=A.OrderId) AS KeRenName--客人姓名
	,C.RouteName AS CPName--产品名称
	,(CASE D.RouteType WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END) AS DingDanLeiXing--订单类型
	,E.MemberName AS XiaDanRenName--下单人姓名
	,F.MemberId AS DaiLiShangHuiYuanId--代理商会员编号
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_XianLuTourOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_XianLu AS C
ON A.XianLuId=C.XianLuId LEFT OUTER JOIN tbl_SysArea AS D
ON C.AreaId=D.ID LEFT OUTER JOIN tbl_Member AS E
ON A.OperatorId=E.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--商城订单
SELECT A.OrderID AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.ContactID AS XiaDanRenId
	,ISNULL(A.OrderPrice,0) AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,A.SupplierMoney AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.ProductName AS CPName
	,3 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_ShangChengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.ContactID=B.MemberID LEFT OUTER JOIN tbl_ShangChengChanPin AS C
ON A.ProductId=C.ProductID LEFT OUTER JOIN tbl_Member AS D
ON A.ContactID=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SupplierID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--门票订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.Price AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,A.AgencyJinE AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.EnName AS CPName
	,4 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_ScenicAreaOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_ScenicTickets AS C
ON A.TicketsId=C.TicketsId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SellerID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--酒店订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,A.TotalAmount AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PaymentState AS FuKuanStatus
	,A.SellerID AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.ContactName AS KeRenName
	,C.HotelName AS CPName
	,5 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_HotelOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_Hotel AS C
ON A.HotelId=C.HotelId LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SellerID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId

UNION ALL
--签证订单
SELECT A.DingDanId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.XiaDanRenId  AS XianDanRenId
	,A.JinE AS DingDanJinE
	,A.DingDanStatus AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrXingMing AS KeRenName
	,C.[Name] AS CPName
	,6 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_QianZhengDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.XiaDanRenId=B.MemberID LEFT OUTER JOIN tbl_QianZheng AS C
ON A.QianZhengId=C.QianZhengId LEFT OUTER JOIN tbl_Member AS D
ON A.XiaDanRenId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.DingDanId = H.DingDanId

UNION ALL
--团购订单
SELECT CAST(A.OrderId AS CHAR(36)) AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.PeopleID AS XiaDanRenId
	,A.OrderPrice AS DingDanJinE
	,A.OrderState AS DingDanStatus
	,A.PayState AS FuKuanStatus
	,A.SupplierID AS DaiLiShangId
	,0 AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.PeopleName AS KeRenName
	,C.ProductName AS CPName
	,7 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_TuanGouDingDan AS A LEFT OUTER JOIN tbl_Member AS B
ON A.PeopleID=B.MemberID LEFT OUTER JOIN tbl_TuanGouChanPin AS C
ON A.ProductID=C.Id LEFT OUTER JOIN tbl_Member AS D
ON A.PeopleID=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.SupplierID=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
Cast(A.OrderId as char(36)) = H.DingDanId

UNION ALL
--租车订单
SELECT A.OrderId AS DingDanId
	,A.IssueTime AS XiaDanShiJian
	,A.OperatorId AS XiaDanRenId
	,ISNULL(A.ZuJin,0) AS DingDanJinE
	,A.Status AS DingDanStatus
	,A.FuKuanStatus AS FuKuanStatus
	,A.AgencyId AS DaiLiShangId
	,ISNULL(A.AgencyJinE,0) AS DaiLiShangJinE
	,B.ShangJiDaiLiShangId--下单人上级代理商编号
	,B.ShangJiDaiLiShangHuiYuanId--下单人上级代理商会员编号	
	,A.LxrName AS KeRenName
	,C.CarName AS CPName
	,8 AS DingDanLeiXing
	,D.MemberName AS XiaDanRenName
	,F.MemberId AS DaiLiShangHuiYuanId
	,G.ShangJiDaiLiShangId AS DaiLiShangShangJiDaiLiShangId--代理商上级代理商编号
	,G.ShangJiDaiLiShangHuiYuanId AS DaiLiShangShangJiDaiLiShangHuiYuanId--代理商上级代理商会员编号
    ,H.JiangLiBiLi
FROM tbl_JA_ZuCheOrder AS A LEFT OUTER JOIN tbl_Member AS B
ON A.OperatorId=B.MemberID LEFT OUTER JOIN tbl_JA_ZuCheInfo AS C
ON A.ZuCheID=C.ZuCheID LEFT OUTER JOIN tbl_Member AS D
ON A.OperatorId=D.MemberID LEFT OUTER JOIN tbl_JA_Sellers AS F
ON A.AgencyId=F.Id LEFT OUTER JOIN tbl_Member AS G
ON F.MemberId=G.MemberId LEFT OUTER JOIN tbl_JiangLiBi as H ON
A.OrderId = H.DingDanId
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

--酒店价格表优化

alter table tbl_hotelroomrate add citycode varchar(3)
GO
update tbl_hotelroomrate
set citycode=(select top 1 citycode from tbl_Hotel where tbl_Hotel.hotelid=tbl_hotelroomrate.hotelid)
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	获取会员下级分销提成-金额
-- =============================================
ALTER PROCEDURE [dbo].[proc_XiaJiFenXiaoTiCheng_GetJinE]
	@HuiYuanId CHAR(36)--会员编号
	,@SuoYouYongJinJinE MONEY OUTPUT--所有下级分销佣金金额
	,@YiShenQingYongJinJinE MONEY OUTPUT--已申请下级分销佣金金额
	,@YiShenQingJinE MONEY OUTPUT--已申请提成金额
	,@YiShenPiYongJinJinE MONEY OUTPUT--已审批下级分销佣金金额
	,@YiShenPiJinE MONEY OUTPUT--已审批提成金额
	,@RetCode INT OUTPUT--OUTPUT CODE
    ,@ZongJinE money output --总共奖励金额
AS
BEGIN
	SET @RetCode=0
	SET @SuoYouYongJinJinE=0
	SET @YiShenQingYongJinJinE=0
	SET @YiShenQingJinE=0
	SET @YiShenPiYongJinJinE=0
	SET @YiShenPiJinE=0
    set @ZongJinE =0
	DECLARE @HuiYuanDaiLiShangId CHAR(36)
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId)
	BEGIN
		--会员不是代理商
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	SELECT @HuiYuanDaiLiShangId=ID FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId
	
	SELECT @SuoYouYongJinJinE=ISNULL(SUM(DingDanJinE-DaiLiShangJinE),0) FROM view_FenSiJiaoYi WHERE DaiLiShangShangJiDaiLiShangHuiYuanId=@HuiYuanId AND DingDanStatus IN(2,3,4,5) AND FuKuanStatus IN(1)

	SELECT 	@YiShenQingYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT @YiShenQingJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT 	@YiShenPiYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)

	SELECT @YiShenPiJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)	
    select @ZongJinE=ISNULL(sum((DingDanJinE - DaiLiShangJinE)*JiangLiBiLi),0) from view_FenSiJiaoYi where DaiLiShangShangJiDaiLiShangHuiYuanId =@HuiYuanId and DingDanStatus in(4,5) and DingDanLeiXing not in(7)

	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		王磊
-- Create date: 2013-04-19
-- Description:	酒店价格的增加
-- -1:开始时间已存在价格
-- -2:结束时间已存在价格
--  1:成功
--  0:失败
-- =============================================
ALTER PROC [dbo].[proc_HotelRoomRate_Add]
@HotelId char(36),
@RoomTypeId char(36),
@AmountPrice money,
@PreferentialPrice money,
@SettlementPrice money,
@StartDate datetime,
@EndDate datetime,
@Reason nvarchar(255),
@OperatorId int,
@Result int output
,@ShuLiang INT
,@ShengYuShuLiang int
as
begin
	declare @error int
	set @error=0
	declare @citycode varchar(20)
	--开始时间已存在价格
	if exists(select 1 from tbl_HotelRoomRate where RoomTypeId=@RoomTypeId and (@StartDate<=EndDate) and (@StartDate>=StartDate))
	begin
		set @Result=-1
		return @Result
	end

	--结束时间已存在价格
	if exists(select 1 from tbl_HotelRoomRate where RoomTypeId=@RoomTypeId and  (@EndDate<=EndDate) and (@EndDate>=StartDate))
	begin
		set @Result=-2
		return @Result
	end	
    
    select @citycode =CityCode  from tbl_Hotel where HotelId=@HotelId
	INSERT INTO tbl_HotelRoomRate
           (HotelId,RoomTypeId,AmountPrice,PreferentialPrice,SettlementPrice
           ,StartDate,EndDate,Reason,IssueTime,OperatorId,ShuLiang,ShengYuShuLiang,citycode)
	VALUES(@HotelId,@RoomTypeId,@AmountPrice,@PreferentialPrice,@SettlementPrice,
           @StartDate,@EndDate,@Reason,getdate(),@OperatorId,@ShuLiang,@ShengYuShuLiang,@citycode)
	set @error=@error+@@error

	if(@error=0)
	begin
		set @Result=1
	end
	else
	begin
		set @Result=0
	end
	
	return @Result
end
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[proc_Hotel_Update]
@HotelId char(36),
@HotelName nvarchar(255),
@HotelNameEn nvarchar(255),
@Latitude varchar(20),
@Longitude varchar(20),
@ServiceTel nvarchar(50),
@ProvinceId int,
@CityId int,
@CountyId int,
@Address nvarchar(255),
@EnAddress nvarchar(255),
@Star tinyint,
@PostalCode varchar(15),
@OpenDate varchar(50),
@Fitment varchar(50),
@RoomQuantity int,
@Floor nvarchar(50),
@LongDesc nvarchar(max),
@Transport nvarchar(255),
@AdditionalCost varchar(255),
@Status tinyint,
@IsHot char(1),
@IsRecommend char(1),
@CityCode varchar(5),
@HotelLandMark xml,
@Result int output,
@Mobile NVARCHAR(50),
@JieSuanType char(1)
as
begin
	declare @error int
	set @error=0
	BEGIN TRANSACTION

	UPDATE tbl_Hotel
	SET HotelName = @HotelName,HotelNameEn = @HotelNameEn
      ,Latitude = @Latitude,Longitude = @Longitude,ServiceTel = @ServiceTel
      ,ProvinceId = @ProvinceId,CityId = @CityId,CountyId = @CountyId
      ,Address = @Address,EnAddress = @EnAddress,Star = @Star,PostalCode = @PostalCode
      ,OpenDate = @OpenDate,Fitment = @Fitment,RoomQuantity = @RoomQuantity
      ,[Floor] = @Floor,LongDesc = @LongDesc,Transport = @Transport
	  ,AdditionalCost = @AdditionalCost,Status = @Status,IsHot=@IsHot
	  ,IsRecommend=@IsRecommend,CityCode=@CityCode,Mobile=@Mobile,JieSuanType=@JieSuanType
	WHERE HotelId = @HotelId
    update  tbl_HotelRoomRate set citycode=@CityCode where HotelId = @HotelId
	set @error=@error+@@error

	delete from tbl_HotelLandMark where HotelId=@HotelId
	set @error=@error+@@error

	if(@HotelLandMark is not null)
	begin
		declare @i int
		exec sp_xml_preparedocument @i output,@HotelLandMark
		set @error=@error+@@error

		INSERT INTO tbl_HotelLandMark(HotelId,LandMarkId)
		select @HotelId,LandMarkId from openxml(@i,'/Root/HotelLandMark')
		with(LandMarkId int)
		set @error=@error+@@error
		
		exec sp_xml_removedocument @i
		set @error=@error+@@error
	end

	if(@error=0)
	begin
		set @Result=1
		commit transaction
	end
	else
	begin
		set @Result=0
		rollback transaction
	end
	
	return @Result
end
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-10-31
-- Description:	获取会员下级分销提成-金额
-- =============================================
ALTER PROCEDURE [dbo].[proc_XiaJiFenXiaoTiCheng_GetJinE]
	@HuiYuanId CHAR(36)--会员编号
	,@SuoYouYongJinJinE MONEY OUTPUT--所有下级分销佣金金额
	,@YiShenQingYongJinJinE MONEY OUTPUT--已申请下级分销佣金金额
	,@YiShenQingJinE MONEY OUTPUT--已申请提成金额
	,@YiShenPiYongJinJinE MONEY OUTPUT--已审批下级分销佣金金额
	,@YiShenPiJinE MONEY OUTPUT--已审批提成金额
	,@RetCode INT OUTPUT--OUTPUT CODE
    ,@ZongJinE money output --总共奖励金额
AS
BEGIN
	SET @RetCode=0
	SET @SuoYouYongJinJinE=0
	SET @YiShenQingYongJinJinE=0
	SET @YiShenQingJinE=0
	SET @YiShenPiYongJinJinE=0
	SET @YiShenPiJinE=0
    set @ZongJinE =0
	DECLARE @HuiYuanDaiLiShangId CHAR(36)
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		--无该用户
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE ShangJiDaiLiShangHuiYuanId=@HuiYuanId)
	BEGIN
		--无下级分销用户
		SET @RetCode=-98
		RETURN @RetCode
	END
	
	IF NOT EXISTS(SELECT 1 FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId)
	BEGIN
		--会员不是代理商
		SET @RetCode=-97
		RETURN @RetCode
	END
	
	SELECT @HuiYuanDaiLiShangId=ID FROM tbl_JA_Sellers WHERE MemberID=@HuiYuanId
	
	SELECT @SuoYouYongJinJinE=ISNULL(SUM(DingDanJinE-DaiLiShangJinE),0) FROM view_FenSiJiaoYi WHERE DaiLiShangShangJiDaiLiShangHuiYuanId=@HuiYuanId AND DingDanStatus IN(2,3,4,5) AND FuKuanStatus IN(1)

	SELECT 	@YiShenQingYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT @YiShenQingJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(0,2)

	SELECT 	@YiShenPiYongJinJinE=ISNULL(SUM(YongJinJinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)

	SELECT @YiShenPiJinE=ISNULL(SUM(JinE),0) FROM tbl_HuiYuanXiaJiFenXiaoTiCheng WHERE HuiYuanId=@HuiYuanId AND Status IN(2)	
    select @ZongJinE=ISNULL(sum((DingDanJinE - DaiLiShangJinE)*JiangLiBiLi),0) from view_FenSiJiaoYi where DaiLiShangShangJiDaiLiShangHuiYuanId =@HuiYuanId and DingDanStatus in(4,5) and DingDanLeiXing not in(7)

	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT   CAST(a.OrderId AS varchar(36)) as OrderId,  a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT   CAST(b.DingDanId AS varchar(36)) as OrderId,  b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT  CAST(c.OrderID AS varchar(36)) as OrderId,   c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT   CAST(d.OrderId AS varchar(36)) as OrderId,  d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT   CAST(e.OrderId AS varchar(36)) as OrderId,  e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT  CAST(f.OrderId AS varchar(36)) as OrderId,   f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT  CAST(g.OrderID AS varchar(36)) as OrderId,   g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID
FROM         tbl_ShangChengDingDan AS g
UNION ALL
SELECT  CAST(h.ZuTuanId AS varchar(36)) as OrderId,   h.ZongJinE AS JinE, h.OrderState AS OrderStatus, h.OrderCode AS OrderCode, h.XDRId AS XDRId, h.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRMoblie, h.IssueTime AS IssueTime,
                          h.XianLuName AS OrderName, '成人:'+CAST(h.ChengTuanNum AS varchar(30)) + '人，儿童:'+CAST(h.ErTongNum AS varchar(30))+'人' AS OrderNum, h.AgencyJinE AS AgencyJinE, 
                      h.AgencyId AS AgencyId, 9 AS OrderType,CAST(h.XianLuId AS varchar(36)) as ProductID
FROM         tbl_ZiZuTuan AS h
UNION ALL
SELECT  CAST(j.DingDanId AS varchar(36)) as OrderId,   j.JinE+j.ShuiFeiJinE AS JinE, j.DingDanStatus AS OrderStatus, j.JiaoYiHao AS OrderCode, j.HuiYuanId AS XDRId, j.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRMoblie, j.XiaDanShiJian AS IssueTime,
                          j.ChuFaChengShiSanZiMa +' - ' + j.DaoDaChengShiSanZiMa AS OrderName, CAST(j.DingPiaoRenShu AS varchar(30)) AS OrderNum, 0 AS AgencyJinE, 
                      '' AS AgencyId, 10 AS OrderType,'' as ProductID
FROM         tbl_JiPiaoDingDan AS j
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT   CAST(a.OrderId AS varchar(36)) as OrderId,  a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID,a.LDate as ChuFaShiJian,a.EDate as HuiGuiShiJian,(CASE WHEN a.Status=1 THEN 1 WHEN a.Status=2 THEN 2 WHEN a.Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT   CAST(b.DingDanId AS varchar(36)) as OrderId,  b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID,b.YuDingShiJian as ChuFaShiJian,b.YuDingShiJian as HuiGuiShiJian,(CASE WHEN b.DingDanStatus=1 THEN 1 WHEN b.DingDanStatus=2 THEN 2 WHEN b.DingDanStatus=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT  CAST(c.OrderID AS varchar(36)) as OrderId,   c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID,c.IssueTime as ChuFaShiJian,c.IssueTime as HuiGuiShiJian,(CASE WHEN c.OrderState=1 THEN 1 WHEN c.OrderState=2 THEN 2 WHEN c.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT   CAST(d.OrderId AS varchar(36)) as OrderId,  d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID,d.LDate as ChuFaShiJian,d.LDate as HuiGuiShiJian,(CASE WHEN d .Status=1 THEN 1 WHEN d .Status=2 THEN 2 WHEN d .Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT   CAST(e.OrderId AS varchar(36)) as OrderId,  e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID,e.CheckInDate as ChuFaShiJian,e.CheckOutDate as HuiGuiShiJian,(CASE WHEN e.OrderState=1 THEN 1 WHEN e.OrderState=2 THEN 2 WHEN e.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT  CAST(f.OrderId AS varchar(36)) as OrderId,   f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID,f.ChuFaRiQi as ChuFaShiJian,f.ChuFaRiQi as HuiGuiShiJian,(CASE WHEN f.Status=1 THEN 1 WHEN f.Status=2 THEN 2 WHEN f.Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT  CAST(g.OrderID AS varchar(36)) as OrderId,   g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID,g.IssueTime as ChuFaShiJian,g.IssueTime as HuiGuiShiJian,(CASE WHEN g.OrderState=1 THEN 1 WHEN g.OrderState=2 THEN 2 WHEN g.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ShangChengDingDan AS g
UNION ALL
SELECT  CAST(h.ZuTuanId AS varchar(36)) as OrderId,   h.ZongJinE AS JinE, h.OrderState AS OrderStatus, h.OrderCode AS OrderCode, h.XDRId AS XDRId, h.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRMoblie, h.IssueTime AS IssueTime,
                          h.XianLuName AS OrderName, '成人:'+CAST(h.ChengTuanNum AS varchar(30)) + '人，儿童:'+CAST(h.ErTongNum AS varchar(30))+'人' AS OrderNum, h.AgencyJinE AS AgencyJinE, 
                      h.AgencyId AS AgencyId, 9 AS OrderType,CAST(h.XianLuId AS varchar(36)) as ProductID,h.ChuFaTime as ChuFaShiJian,h.ChuFaTime as HuiGuiShiJian,(CASE WHEN h.OrderState=1 THEN 1 WHEN h.OrderState=2 THEN 2 WHEN h.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ZiZuTuan AS h
UNION ALL
SELECT  CAST(j.DingDanId AS varchar(36)) as OrderId,   j.JinE+j.ShuiFeiJinE AS JinE, j.DingDanStatus AS OrderStatus, j.ApiDingDanId AS OrderCode, j.HuiYuanId AS XDRId, j.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRMoblie, j.XiaDanShiJian AS IssueTime,
                          j.ChuFaChengShiSanZiMa +' - ' + j.DaoDaChengShiSanZiMa AS OrderName, CAST(j.DingPiaoRenShu AS varchar(30)) AS OrderNum, 0 AS AgencyJinE, 
                      '' AS AgencyId, 10 AS OrderType,'' as ProductID,j.QiFeiShiJian as ChuFaShiJian,j.DaoDaShiJian as HuiGuiShiJian,(CASE WHEN j.DingDanStatus=0 THEN 1 ELSE 0 END) as ChuLiZT
FROM         tbl_JiPiaoDingDan AS j
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT   CAST(a.OrderId AS varchar(36)) as OrderId,  a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID,a.LDate as ChuFaShiJian,a.EDate as HuiGuiShiJian,(CASE WHEN a.Status=1 THEN 1 WHEN a.Status=2 THEN 2 WHEN a.Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT   CAST(b.DingDanId AS varchar(36)) as OrderId,  b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID,b.YuDingShiJian as ChuFaShiJian,b.YuDingShiJian as HuiGuiShiJian,(CASE WHEN b.DingDanStatus=1 THEN 1 WHEN b.DingDanStatus=2 THEN 2 WHEN b.DingDanStatus=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT  CAST(c.OrderID AS varchar(36)) as OrderId,   c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID,c.IssueTime as ChuFaShiJian,c.IssueTime as HuiGuiShiJian,(CASE WHEN c.OrderState=1 THEN 1 WHEN c.OrderState=2 THEN 2 WHEN c.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT   CAST(d.OrderId AS varchar(36)) as OrderId,  d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID,d.LDate as ChuFaShiJian,d.LDate as HuiGuiShiJian,(CASE WHEN d .Status=1 THEN 1 WHEN d .Status=2 THEN 2 WHEN d .Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT   CAST(e.OrderId AS varchar(36)) as OrderId,  e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID,e.CheckInDate as ChuFaShiJian,e.CheckOutDate as HuiGuiShiJian,(CASE WHEN e.OrderState=1 THEN 1 WHEN e.OrderState=2 THEN 2 WHEN e.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT  CAST(f.OrderId AS varchar(36)) as OrderId,   f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.TicketsId AS varchar(36)) as ProductID,f.ChuFaRiQi as ChuFaShiJian,f.ChuFaRiQi as HuiGuiShiJian,(CASE WHEN f.Status=1 THEN 1 WHEN f.Status=2 THEN 2 WHEN f.Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT  CAST(g.OrderID AS varchar(36)) as OrderId,   g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID,g.IssueTime as ChuFaShiJian,g.IssueTime as HuiGuiShiJian,(CASE WHEN g.OrderState=1 THEN 1 WHEN g.OrderState=2 THEN 2 WHEN g.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ShangChengDingDan AS g
UNION ALL
SELECT  CAST(h.ZuTuanId AS varchar(36)) as OrderId,   h.ZongJinE AS JinE, h.OrderState AS OrderStatus, h.OrderCode AS OrderCode, h.XDRId AS XDRId, h.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRMoblie, h.IssueTime AS IssueTime,
                          h.XianLuName AS OrderName, '成人:'+CAST(h.ChengTuanNum AS varchar(30)) + '人，儿童:'+CAST(h.ErTongNum AS varchar(30))+'人' AS OrderNum, h.AgencyJinE AS AgencyJinE, 
                      h.AgencyId AS AgencyId, 9 AS OrderType,CAST(h.XianLuId AS varchar(36)) as ProductID,h.ChuFaTime as ChuFaShiJian,h.ChuFaTime as HuiGuiShiJian,(CASE WHEN h.OrderState=1 THEN 1 WHEN h.OrderState=2 THEN 2 WHEN h.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ZiZuTuan AS h
UNION ALL
SELECT  CAST(j.DingDanId AS varchar(36)) as OrderId,   j.JinE AS JinE, j.DingDanStatus AS OrderStatus, j.ApiDingDanId AS OrderCode, j.HuiYuanId AS XDRId, j.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRMoblie, j.XiaDanShiJian AS IssueTime,
                          j.ChuFaChengShiSanZiMa +' - ' + j.DaoDaChengShiSanZiMa AS OrderName, CAST(j.DingPiaoRenShu AS varchar(30)) AS OrderNum, 0 AS AgencyJinE, 
                      '' AS AgencyId, 10 AS OrderType,'' as ProductID,j.QiFeiShiJian as ChuFaShiJian,j.DaoDaShiJian as HuiGuiShiJian,(CASE WHEN j.DingDanStatus=0 THEN 1 ELSE 0 END) as ChuLiZT
FROM         tbl_JiPiaoDingDan AS j
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
SET ANSI_PADDING ON
GO
CREATE TABLE [dbo].[tbl_Seller_TuanGou](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[MemberId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[ProductId] [char](36) COLLATE Chinese_PRC_CI_AS NULL,
	[ProductStatus] [int] NULL,
 CONSTRAINT [PK_tbl_Seller_TuanGou] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO
SET ANSI_PADDING OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[View_DaiLiTuanGou]
AS
SELECT     a.Id, 
           a.MemberId,
           a.ProductId, 
           a.ProductStatus,
           b.SaleType, 
           b.ProductName,
           b.ProductType,
           b.SimpleInfo, 
           b.DetailInfo,
           b.MarketPrice,
           b.GroupPrice, 
           b.ProductNum,
           b.ValiDate,
           b.IssueTime, 
           b.OperatorID,
           b.OperatorName,
           b.SupplierID, 
           b.ProductImg,
           b.XianShiWeiZhi,
           b.IsIndex, 
           b.ProductSort,
           (SELECT SupplierName  FROM [tbl_Supplier] where ID=b.SupplierID ) as SupplierName,
           (b.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_TuanGouDingDan AS c WHERE c.ProductID=b.ID)) AS StockNum
FROM         dbo.tbl_Seller_TuanGou as a LEFT OUTER JOIN
                      dbo.tbl_TuanGouChanPin as b ON a.ProductId = b.ID

GO

CREATE TABLE [tbl_HuiYouYouJi](
	[YouJiId] [char](36)  NOT NULL PRIMARY KEY,
	[HuiYuanId] [char](36)  NULL,
	[YouJiTitle] [nvarchar](50) NULL,
	[YouJiContent] [nvarchar](max)  NULL,
	[IssueTime] [datetime] NULL,
	[YouJiLeiXing] [tinyint]  DEFAULT ((0)),
	[ShiPinLink] [nvarchar](200)  NULL,
	[WeiXinMa] [varchar](6)  NULL
) 
GO
 
CREATE VIEW view_YouJi
AS
SELECT a.*,b.MemberName AS HuiYuanName FROM tbl_HuiYouYouJi AS a LEFT JOIN dbo.tbl_Member AS b ON a.HuiYuanId =b.MemberID

GO

ALTER VIEW [dbo].[view_YouJi]
AS
SELECT a.*,b.MemberName AS HuiYuanName FROM tbl_HuiYouYouJi AS a 

LEFT JOIN ( 

SELECT c.MemberName AS  MemberName,c.MemberID  FROM tbl_Member c
 
 UNION
 
 SELECT d.Username,CONVERT(CHAR(36),d.Id) FROM dbo.tbl_Webmaster  d) AS b
 
 ON a.HuiYuanId =b.MemberID
GO







alter table [tbl_JA_Sellers] add SupplierType tinyint default 0 not null 
go 
alter table [tbl_JA_Sellers] add CardPath nvarchar(255)
go 
alter table [tbl_JA_Sellers] add AccountPaht nvarchar(255)
go 
alter table [tbl_JA_Sellers] add VisitPath nvarchar(255)
go 
alter table [tbl_JA_Sellers] add OtherPath nvarchar(255)
go 
alter table [tbl_JA_Sellers] add FormPath nvarchar(255)
go 
alter table [tbl_JA_Sellers] add Qualifications nvarchar(50)
go 




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER view [dbo].[view_ShangCheng]
as
SELECT a.ProductID 
      ,a.TypeID 
      ,a.GYSid
      ,(SELECT MemberName FROM tbl_Member WHERE tbl_Member.MemberID =(SELECT tbl_JA_Sellers.MemberID FROM tbl_JA_Sellers where ID=a.GYSid) ) as SupplierName
      ,(SELECT b.ParentID FROM dbo.tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID ) AS ParentID
      ,(SELECT b.TypeName FROM tbl_ShangChengLeiBie AS b WHERE b.TypeID=a.TypeID  )AS TypeName
      ,a.ProductName 
      ,a.ProductNum 
      ,a.MarketPrice 
      ,a.SalePrice 
      ,a.ContentService 
      ,a.UnContentService 
      ,a.UseRule 
      ,a.NoticeKnow 
      ,a.ProductionDate 
      ,a.EffectDate 
      ,a.ShelfDate 
      ,a.IssueTime 
      ,a.Remark 
      ,a.ModelDesc 
      ,a.ColorDesc 
      ,a.StylesDesc 
      ,a.MailWay 
      ,(a.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=a.ProductID)) AS StockNum
      ,(SELECT * FROM tbl_ShangChengTuPian AS b WHERE b.ProductID=a.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
       ,a.Unit,a.IsTrue,a.ProductSort
  FROM tbl_ShangChengChanPin as a
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DaiLiTuanGou]
AS
SELECT     a.Id, 
           a.MemberId,
           a.ProductId, 
           a.ProductStatus,
           b.SaleType, 
           b.ProductName,
           b.ProductType,
           b.SimpleInfo, 
           b.DetailInfo,
           b.MarketPrice,
           b.GroupPrice, 
           b.ProductNum,
           b.ValiDate,
           b.IssueTime, 
           b.OperatorID,
           b.OperatorName,
           b.SupplierID, 
           b.ProductImg,
           b.XianShiWeiZhi,
           b.IsIndex, 
           b.ProductSort,
(SELECT MemberName FROM tbl_Member WHERE tbl_Member.MemberID =(SELECT tbl_JA_Sellers.MemberID FROM tbl_JA_Sellers where ID=b.SupplierID ) ) as SupplierName,
           (b.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_TuanGouDingDan AS c WHERE c.ProductID=b.ID)) AS StockNum
FROM         dbo.tbl_Seller_TuanGou as a LEFT OUTER JOIN
                      dbo.tbl_TuanGouChanPin as b ON a.ProductId = b.ID
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DaiLiChanPin]
AS
SELECT     a.Id, 
           a.MemberId,
           a.ProductId, 
           a.ProductStatus,
           b.TypeID, 
           b.ProductName,
           b.ProductNum,
           b.MarketPrice, 
           b.SalePrice,
           b.ContentService,
           b.UnContentService, 
           b.UseRule,
           b.NoticeKnow,
           b.ProductionDate, 
           b.EffectDate,
           b.ShelfDate,
           b.IssueTime, 
           b.Remark,
           b.ModelDesc,
           b.ColorDesc, 
           b.StylesDesc,
           b.MailWay,
           b.GYSid, 
           b.Unit,
           b.IsTrue,
          (SELECT MemberName FROM tbl_Member WHERE tbl_Member.MemberID =(SELECT tbl_JA_Sellers.MemberID FROM tbl_JA_Sellers where ID=b.GYSid ) ) as SupplierName,
           (SELECT c.ParentID FROM dbo.tbl_ShangChengLeiBie AS c WHERE c.TypeID=b.TypeID ) AS ParentID,
           (SELECT c.TypeName FROM tbl_ShangChengLeiBie AS c WHERE c.TypeID=b.TypeID  )AS TypeName,
           (b.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=b.ProductID)) AS StockNum,
           (SELECT * FROM tbl_ShangChengTuPian AS c WHERE c.ProductID=b.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
FROM         dbo.tbl_Seller_ShangCheng as a LEFT OUTER JOIN
                      dbo.tbl_ShangChengChanPin as b ON a.ProductId = b.ProductID
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




/*增加两个字段*/
alter table tbl_Supplier add MemberId char(36)
go 
alter table tbl_Supplier add DaiLiId char(36)
go 

/*同步供应商在原系统中的会员id和代理商id*/
UPDATE tbl_Supplier SET MemberId=m.MemberID,DaiLiId=m.seid from tbl_Supplier as n,(SELECT c.ID,c.MemberID,d.ID as seid FROM (SELECT a.ID,b.MemberID FROM tbl_Supplier as a,tbl_Member as b where a.SuppName='G'+b.Account) as c, tbl_JA_Sellers as d WHERE c.MemberID=d.MemberID)as m WHERE m.ID=n.ID
go
/*同步产生的电话号码，后需用到
15895587753,18768119111,15657127907,13913529954,13588833915,15888888888,15899556622,13112345678,13588166404,13232661818,13958066139,18736036040,15268625398
*/

/*增加了会员和代理商之后执行*/
UPDATE tbl_Supplier SET MemberId=m.MemberID,DaiLiId=m.seid from tbl_Supplier as n,(SELECT c.ID,c.MemberID,d.ID as seid FROM (SELECT a.ID,b.MemberID FROM tbl_Supplier as a,tbl_Member as b where a.ContactMobile=b.Account) as c, tbl_JA_Sellers as d WHERE c.MemberID=d.MemberID)as m WHERE m.ID=n.ID
go

/*更新由供应商生成的会员信息*/
UPDATE tbl_Member SET Address=b.SuppAddress,Contact=b.ContactPhone,qq=b.ContactQQ,Email=b.ContactMail from tbl_Member as a, tbl_Supplier as b WHERE a.Account= b.ContactMobile and b.ContactMobile IN('15895587753','18768119111','15657127907','13913529954','13588833915','15888888888','15899556622','13112345678','13588166404','13232661818','13958066139','18736036040','15268625398')
go
/*更新由供应商生成的代理信息*/
UPDATE tbl_JA_Sellers SET MapX=b.MapX,MapY=b.MapY,SupplierType=b.SupplierType,CardPath=b.CardPath,AccountPaht=b.AccountPaht,VisitPath=b.VisitPath,OtherPath=b.OtherPath,FormPath=b.FormPath, tbl_JA_Sellers.WebsiteName=b.SupplierName,Qualifications=b.Qualifications from tbl_JA_Sellers as a,tbl_Supplier as b, tbl_Member as c WHERE a.MemberID=c.MemberID AND c.Mobile=b.ContactMobile AND b.ContactMobile IN ('15895587753','18768119111','15657127907','13913529954','13588833915','15888888888','15899556622','13112345678','13588166404','13232661818','13958066139','18736036040','15268625398')
go
/*更新商城产品表的供应商id*/
UPDATE tbl_ShangChengChanPin SET GYSid=b.DaiLiId from tbl_ShangChengChanPin as a, tbl_Supplier as b WHERE a.GYSid=b.ID
go
/*更新团购产品表的供应商id*/
UPDATE tbl_TuanGouChanPin SET SupplierID=b.DaiLiId from tbl_TuanGouChanPin as a, tbl_Supplier as b WHERE a.SupplierID=b.DaiLiId
go
/*删除供应商表*/
DROP TABLE tbl_Supplier
go
/*处理几条有问题数据,需要对照数据库确认*/
update tbl_TuanGouChanPin set SupplierID='617b4f08-4dc3-4dd0-8c1a-5c6b9d1a9619' where SupplierID='7c2331c7-e702-4297-a64e-532372d32646'
update tbl_TuanGouChanPin set SupplierID='8a4845b8-693d-4ac1-a70e-63475a2810b4' where SupplierID='45d770d4-1ce7-4cda-b3c3-0668aa02deae'
GO



--增加两个字段记录原发团日期的市场价格  保证更新接口价格之后 原订单的市场价格不受影响

GO
ALTER TABLE dbo.tbl_XianLuTourOrder ADD
	SCJCR money NOT NULL CONSTRAINT DF_tbl_XianLuTourOrder_SCJCR DEFAULT 0,
	SCJET money NOT NULL CONSTRAINT DF_tbl_XianLuTourOrder_SCJET DEFAULT 0
GO


--更新视图 从新获取市场价格
ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId,A.SCJCR,A.SCJET,A.JSJCR,A.JSJER AS JSJET,
                           (SELECT     UserType
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS UserType,
						   (SELECT     MemberName
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS MemberName,
                          (SELECT     Mobile
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS Mobile,
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p
                            WHERE      (ID = B.AreaId)) AS RouteType, A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JinE, A.FuKuanStatus, 
                      A.LDate, A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, 
                      A.IssueTime, A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source,
                      A.Traffice,A.OrderSite
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
GO

--更新新增字段市场价

update dbo.tbl_XianLuTourOrder  
set  tbl_XianLuTourOrder.SCJCR=tbl_XianLuTour.CRSCJ,tbl_XianLuTourOrder.SCJET=tbl_XianLuTour.ETSCJ
from tbl_XianLuTourOrder
inner join dbo.tbl_XianLuTour on tbl_XianLuTour.tourid = tbl_XianLuTourOrder.tourid

--更新存储过程
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2013-03-15
-- Description:	写入订单信息
-- =============================================
ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
    ,@OrderSite TINYINT
    ,@SCJCR MONEY
    ,@SCJET MONEY
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号

	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@YiShouRenShu=SYRS FROM [tbl_XianLuTour] WHERE TourId=@TourId 
	
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=[JiHuaRenShu] FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId

	IF(@YiShouRenShu<@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice,[OrderSite],SCJCR,SCJET)
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice,@OrderSite,@SCJCR,@SCJET
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc
	
	IF(@errorcount=0)
		BEGIN
			UPDATE dbo.tbl_XianLuTour SET SYRS=SYRS-@ChengRenShu-@ErTongShu WHERE TourId=@TourId
			SET @errorcount=@errorcount+@@ERROR
		END
	
	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END




--线路订单来源结束
GO



--增加线下收款记录
alter table tbl_YuE add XianXia money default 0
go 



SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

-- =============================================
-- Author:		汪奇志
-- Create date: 2014-11-06
-- Description:	交易明细写入
-- =============================================
ALTER PROCEDURE [dbo].[proc_JiaoYiMingXi_C]
	@MingXiId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@JiaoYiHao NVARCHAR(255)
	,@JiaoYiJinE MONEY
	,@JiaoYiShiJian DATETIME
	,@ZhiFuFangShi TINYINT
	,@JiaoYiLeiBie TINYINT
	,@JiaoYiStatus TINYINT
	,@JiaoYiMiaoShu NVARCHAR(255)
	,@DingDanId CHAR(36)
	,@DingDanLeiXing TINYINT
	,@ApiJiaoYiHao NVARCHAR(255)
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @YongHuYuE MONEY
	DECLARE @errorcount INT
	SET @errorcount=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberId=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	BEGIN TRAN	
	
	IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
	BEGIN
		IF(@JiaoYiLeiBie IN(0))--充值
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney+@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@ZhiFuFangShi=1 AND @JiaoYiStatus=1)--E额宝
	BEGIN
		IF(@JiaoYiLeiBie IN(0,3,4,5,6))
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney+@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@JiaoYiLeiBie IN(1,2)) 
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney-@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR
		END
	END
	
	IF(@ZhiFuFangShi=1 AND @JiaoYiStatus=2)
	BEGIN
		IF(@JiaoYiLeiBie IN(1)) 
		BEGIN
			UPDATE tbl_Member SET TotalMoney=TotalMoney-@JiaoYiJinE WHERE MemberID=@HuiYuanId
			SET @errorcount=@errorcount+@@ERROR		
		END
	END
	
	SELECT @YongHuYuE=ISNULL(TotalMoney,0) FROM tbl_Member WHERE MemberID=@HuiYuanId
	
	IF(@errorcount=0)
	BEGIN
		INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		VALUES(@HuiYuanId,@JiaoYiHao,@JiaoYiJinE
			,@YongHuYuE,@JiaoYiShiJian,@ZhiFuFangShi
			,@JiaoYiLeiBie,@JiaoYiStatus,@JiaoYiMiaoShu
			,@DingDanId,@DingDanLeiXIng,''
			,@MingXiId,@ApiJiaoYiHao)
		SET @errorcount=@errorcount+@@ERROR
	END
	
	IF(@errorcount=0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM tbl_YuE)
		BEGIN
			INSERT INTO tbl_YuE(EEBaoYuE,KuaiQianYuE,YuE,XianXia)VALUES(0,0,0,0)
			SET @errorcount=@errorcount+@@ERROR
		END
		
		IF(@ZhiFuFangShi=0 AND @JiaoYiStatus=1)--快钱
		BEGIN
			IF(@JiaoYiLeiBie IN(0,2))
			BEGIN
				UPDATE tbl_YuE SET KuaiQianYuE=KuaiQianYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE+XianXia
				SET @errorcount=@errorcount+@@ERROR
			END
		END
       
        IF(@ZhiFuFangShi=2 and @JiaoYiStatus=1)--线下付款		
         BEGIN 
            IF(@JiaoYiLeiBie IN(2))
			BEGIN
				UPDATE tbl_YuE SET XianXia=XianXia+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
                UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE+XianXia
				SET @errorcount=@errorcount+@@ERROR
			END
         END 

		IF(@ZhiFuFangSHi=1 AND @JiaoYiStatus=1)--E额宝
		BEGIN
			IF(@JiaoYiLeiBie IN(2))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE+@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE+XianXia
				SET @errorcount=@errorcount+@@ERROR
			END
			
			IF(@JiaoYiLeiBie IN(1,3,4,5,6))
			BEGIN
				UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@JiaoYiJinE
				SET @errorcount=@errorcount+@@ERROR
				UPDATE tbl_YuE SET YuE=KuaiQianYuE+EEBaoYuE+XianXia
				SET @errorcount=@errorcount+@@ERROR
			END
		END
	END
	
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO





/****** 对象:  Table [dbo].[tbl_GYS_Seller]    脚本日期: 09/16/2015 15:52:39 ******/
CREATE TABLE [dbo].[tbl_GYS_Seller](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[GYSId] [varchar](36) COLLATE Chinese_PRC_CI_AS NULL,
	[DaiLiId] [varchar](36) COLLATE Chinese_PRC_CI_AS NULL,
 CONSTRAINT [PK_tbl_GYS_Seller] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX  = OFF, IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]

GO






/****** 对象:  StoredProcedure [dbo].[proc_FenRun]    脚本日期: 09/18/2015 15:10:19 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       SELECT @JiaoYiLi = CONVERT(decimal(10,4),V)/100 from tbl_KV WHERE K='JiaoYiLv'
       if(len(@GYSId)>10)
       BEGIN
         if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId)--判断代理商是否为供应商活着代理商为供应商的二级代理
         BEGIN--如果是，则返润
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
         ELSE--如果不是
         BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
       SELECT @JiaoYiLi = CONVERT(decimal(10,4),V)/100 from tbl_KV WHERE K='JiaoYiLv'
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId)--判断代理商是否为供应商活着代理商为供应商的二级代理
       BEGIN--如果是，则返润
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         
       END
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)-@JiaoYiJinE+@FenXiaoJinE
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@ChengBen
			,@YongHuYuE+@ChengBen,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@ChengBen-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO



alter table tbl_GYS_Seller add LeiXing int default 0
go 

 
ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
    ,@OrderSite tinyint
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号
	DECLARE @SCJCR MONEY
	DECLARE @SCJET MONEY
	
	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@SCJCR=CRSCJ,@SCJET=ETSCJ FROM [tbl_XianLuTour] WHERE [TourId]=@TourId
	SELECT @YiShouRenShu=SUM([ChengRenShu]+[ErTongShu]) FROM [tbl_XianLuTourOrder] WHERE [TourId]=@TourId AND [Status] IN(0,3,4,5)
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=SYRS FROM [tbl_XianLuTour] WHERE [TourId]=@TourId

	IF(@JiHuaRenShu<@YiShouRenShu+@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice,[OrderSite],[SCJCR],[SCJET])
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice,@OrderSite,@SCJCR,@SCJET
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc
	
	IF(@errorcount=0)
		BEGIN
			UPDATE dbo.tbl_XianLuTour SET SYRS=SYRS-@ChengRenShu-@ErTongShu WHERE TourId=@TourId
			SET @errorcount=@errorcount+@@ERROR
		END
	
	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END




--线路订单来源结束

--增加字段 记录交易时候订单的单价
 GO
ALTER TABLE dbo.tbl_XianLuTourOrder ADD
	JiaoYiCR money NOT NULL CONSTRAINT DF_tbl_XianLuTourOrder_JiaoYiCR DEFAULT 0,
	JiaoYiET money NOT NULL CONSTRAINT DF_tbl_XianLuTourOrder_JiaoYiET DEFAULT 0
GO


 ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
    ,@OrderSite TINYINT
    ,@JiaoYiCR	MONEY
    ,@JiaoYiET	MONEY
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号
	DECLARE @SCJCR MONEY
	DECLARE @SCJET MONEY
	
	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@SCJCR=CRSCJ,@SCJET=ETSCJ FROM [tbl_XianLuTour] WHERE [TourId]=@TourId
	SELECT @YiShouRenShu=SUM([ChengRenShu]+[ErTongShu]) FROM [tbl_XianLuTourOrder] WHERE [TourId]=@TourId AND [Status] IN(0,3,4,5)
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=SYRS FROM [tbl_XianLuTour] WHERE [TourId]=@TourId

	IF(@JiHuaRenShu<@YiShouRenShu+@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice,[OrderSite],[SCJCR],[SCJET],[JiaoYiCR],[JiaoYiET])
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice,@OrderSite,@SCJCR,@SCJET,@JiaoYiCR,@JiaoYiET
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc
	
	IF(@errorcount=0)
		BEGIN
			UPDATE dbo.tbl_XianLuTour SET SYRS=SYRS-@ChengRenShu-@ErTongShu WHERE TourId=@TourId
			SET @errorcount=@errorcount+@@ERROR
		END
	
	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END




--线路订单来源结束
GO
ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId,A.SCJCR,A.SCJET,A.JSJCR,A.JSJER AS JSJET,
                           (SELECT     UserType
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS UserType,
						   (SELECT     MemberName
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS MemberName,
                          (SELECT     Mobile
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS Mobile,
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p
                            WHERE      (ID = B.AreaId)) AS RouteType, A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JinE, A.FuKuanStatus, 
                      A.LDate, A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, 
                      A.IssueTime, A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source,
                      A.Traffice,A.OrderSite,a.JiaoYiCR,a.JiaoYiET
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
                      
                      
GO


ALTER TABLE dbo.tbl_XianLuTourOrder ADD
	WebSiteCR money NOT NULL  DEFAULT 0,
	WebSiteET money NOT NULL  DEFAULT 0


GO
ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId,A.SCJCR,A.SCJET,A.JSJCR,A.JSJER AS JSJET,
                           (SELECT     UserType
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS UserType,
						   (SELECT     MemberName
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS MemberName,
                          (SELECT     Mobile
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS Mobile,
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p
                            WHERE      (ID = B.AreaId)) AS RouteType, A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JinE, A.FuKuanStatus, 
                      A.LDate, A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, 
                      A.IssueTime, A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source,
                      A.Traffice,A.OrderSite,a.JiaoYiCR,a.JiaoYiET,a.WebSiteCR,a.WebSiteET
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
GO
                      
                      
ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JSJCR MONEY--成人价
	,@JSJER MONEY--儿童价
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
    ,@OrderSite TINYINT
    ,@JiaoYiCR	MONEY
    ,@JiaoYiET	MONEY
    ,@WebSiteCR	MONEY
    ,@WebSiteET	MONEY
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号
	DECLARE @SCJCR MONEY
	DECLARE @SCJET MONEY
	
	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status],@SCJCR=CRSCJ,@SCJET=ETSCJ FROM [tbl_XianLuTour] WHERE [TourId]=@TourId
	SELECT @YiShouRenShu=SUM([ChengRenShu]+[ErTongShu]) FROM [tbl_XianLuTourOrder] WHERE [TourId]=@TourId AND [Status] IN(0,3,4,5)
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=SYRS FROM [tbl_XianLuTour] WHERE [TourId]=@TourId

	IF(@JiHuaRenShu<@YiShouRenShu+@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JSJCR],[JSJER]
		,[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice,[OrderSite],[SCJCR],[SCJET],[JiaoYiCR],[JiaoYiET],WebSiteCR
		,WebSiteET)
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JSJCR,@JSJER
		,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice,@OrderSite,@SCJCR,@SCJET,@JiaoYiCR,@JiaoYiET,@WebSiteCR,@WebSiteET
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc
	
	IF(@errorcount=0)
		BEGIN
			UPDATE dbo.tbl_XianLuTour SET SYRS=SYRS-@ChengRenShu-@ErTongShu WHERE TourId=@TourId
			SET @errorcount=@errorcount+@@ERROR
		END
	
	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END

GO

ALTER PROCEDURE [dbo].[proc_XianLuOrder_Insert]
	 @OrderId CHAR(36)--订单编号
	,@XianLuId CHAR(36)--线路编号
	,@TourId CHAR(36)--团队编号
	,@OrderCode NVARCHAR(50) OUTPUT--OUTPUT 订单号
	,@Status TINYINT--订单状态
	,@ChengRenShu INT--成人数
	,@ErTongShu INT--儿童数
	,@JinE MONEY--合同金额
	,@FuKuanStatus TINYINT--付款状态
	,@LDate DATETIME--出发日期
	,@QiTaBeiZhu NVARCHAR(MAX)--其它要求
	,@XiaDanBeiZhu NVARCHAR(MAX)--下单备注
	,@LxrXml NVARCHAR(MAX)--联系人MXL:<root><info LxrName="" LxrTelephone="" LxrGender="" LxrZhengJianType="" LxrZhengJianCode="" /></root>
	,@OperatorId CHAR(36)--下单人
	,@IssueTime DATETIME--下单时间
	,@YouKeXml NVARCHAR(MAX)--游客XML:<root><info YouKeId="" Name="" Telephone="" Mobile="" Gender="" LeiXing="" IdCode="" ZhengJianType="" ZhengJianCode="" BeiZhu="" /></root>
	,@TuanGouId CHAR(36)--团购编号
	,@AgencyId CHAR(36)
	,@AgencyJinE MONEY
	,@Traffice NVARCHAR(50)
    ,@OrderSite TINYINT
    ,@JiaoYiCR	MONEY
    ,@JiaoYiET	MONEY
    ,@WebSiteCR	MONEY
    ,@WebSiteET	MONEY
	,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	DECLARE @YiShouRenShu INT--已收人数
	DECLARE @JiHuaRenShu INT--计划人数
	DECLARE @ShouKeZhuangTai TINYINT--收客状态
	DECLARE @LiuShuiHiao INT--流水号
	
	SET @errorcount=0

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLu] WHERE [XianLuId]=@XianLuId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END

	IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTour] WHERE [XianLuId]=@XianLuId AND [TourId]=@TourId)
	BEGIN
		SET @RetCode=-98
		RETURN @RetCode
	END

	SELECT @LDate=[LDate],@ShouKeZhuangTai=[Status] FROM [tbl_XianLuTour] WHERE [TourId]=@TourId
	SELECT @YiShouRenShu=SUM([ChengRenShu]+[ErTongShu]) FROM [tbl_XianLuTourOrder] WHERE [TourId]=@TourId AND [Status] IN(0,3,4,5)
	SET @YiShouRenShu=ISNULL(@YiShouRenShu,0)

	SELECT @JiHuaRenShu=SYRS FROM [tbl_XianLuTour] WHERE [TourId]=@TourId

	IF(@JiHuaRenShu<@YiShouRenShu+@ChengRenShu+@ErTongShu)
	BEGIN
		SET @RetCode=-97
		RETURn @RetCode
	END

	IF(@ShouKeZhuangTai<>0)
	BEGIN
		SET @RetCode=-96
		RETURn @RetCode
	END

	IF(@TuanGouId IS NOT NULL AND LEN(@TuanGouId)>0)
	BEGIN
		IF NOT EXISTS(SELECT 1 FROM [tbl_XianLuTuanGou] WHERE [TuanGouId]=@TuanGouId AND [XianLuId]=@XianLuId)
		BEGIN
			SET @RetCode=-94
			RETURN @RetCode
		END
	END

	SELECT @LiuShuiHiao=COUNT(*)+1 FROM [tbl_XianLuTourOrder]
	SET @OrderCode='XL'+CONVERT(VARCHAR(8),GETDATE(),112)+'8'+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	BEGIN TRAN

	EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@LxrXml
	INSERT INTO [tbl_XianLuTourOrder]([OrderId],[XianLuId],[TourId]
		,[OrderCode],[Status],[ChengRenShu]
		,[ErTongShu],[JinE],[FuKuanStatus],[LDate]
		,[QiTaBeiZhu],[XiaDanBeiZhu],[LxrName]
		,[LxrTelephone],[LxrGender],[LxrZhengJianType]
		,[LxrZhengJianCode],[OperatorId],[IssueTime]
		,[TuanGouId],[AgencyId],[AgencyJinE],Traffice,[OrderSite],[JiaoYiCR],[JiaoYiET],WebSiteCR
		,WebSiteET)
	SELECT @OrderId,@XianLuId,@TourId
		,@OrderCode,@Status,@ChengRenShu
		,@ErTongShu,@JinE,@FuKuanStatus,@LDate
		,@QiTaBeiZhu,@XiaDanBeiZhu,A.LxrName
		,A.LxrTelephone,A.LxrGender,A.LxrZhengJianType
		,A.LxrZhengJianCode,@OperatorId,@IssueTime
		,@TuanGouId,@AgencyId,@AgencyJinE,@Traffice,@OrderSite,@JiaoYiCR,@JiaoYiET,@WebSiteCR,@WebSiteET
	FROM OPENXML(@hdoc,'/root/info')
	WITH(LxrName NVARCHAR(255),LxrTelephone NVARCHAR(255),LxrGender TINYINT,LxrZhengJianType TINYINT,LxrZhengJianCode NVARCHAR(255)) AS A
	SET @errorcount=@errorcount+@@ERROR
	EXECUTE sp_xml_removedocument @hdoc
	
	IF(@errorcount=0)
		BEGIN
			UPDATE dbo.tbl_XianLuTour SET SYRS=SYRS-@ChengRenShu-@ErTongShu WHERE TourId=@TourId
			SET @errorcount=@errorcount+@@ERROR
		END
	
	IF(@errorcount=0 AND @YouKeXml IS NOT NULL AND LEN(@YouKeXml)>0)
	BEGIN
		EXECUTE sp_xml_preparedocument @hdoc OUTPUT,@YouKeXml
		INSERT INTO [tbl_XianLuTourOrderYouKe]([OrderId],[YouKeId],[Name]
			,[Telephone],[Mobile],[Gender]
			,[LeiXing],[IdCode],[ZhengJianType]
			,[ZhengJianCode],[BeiZhu])
		SELECT @OrderId,A.[YouKeId],A.[Name]
			,A.[Telephone],A.[Mobile],A.[Gender]
			,A.[LeiXing],A.[IdCode],A.[ZhengJianType]
			,A.[ZhengJianCode],A.[BeiZhu]
		FROM OPENXML(@hdoc,'/root/info')
		WITH([YouKeId] CHAR(36),[Name] NVARCHAR(255),[Telephone] NVARCHAR(255),[Mobile] NVARCHAR(255),[Gender] TINYINT,[LeiXing] TINYINT,[IdCode] NVARCHAR(255),[ZhengJianType] TINYINT,[ZhengJianCode] NVARCHAR(255),[BeiZhu] NVARCHAR(255)) AS A
		SET @errorcount=@errorcount+@@ERROR
		EXECUTE sp_xml_removedocument @hdoc
	END

	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END




--线路订单来源结束
GO

ALTER VIEW [dbo].[view_XianLuTourOrder]
AS
SELECT     A.OrderId,
						   (SELECT     UserType
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS UserType,
						   (SELECT     MemberName
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS MemberName,
                           (SELECT     Mobile
                            FROM          dbo.tbl_Member AS p
                            WHERE      (MemberID = A.OperatorId)) AS Mobile,
                           (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p
                            WHERE      (ID = B.AreaId)) AS RouteType, A.XianLuId, A.TourId, A.OrderCode, A.Status, A.ChengRenShu, A.ErTongShu, A.JinE, A.FuKuanStatus, 
                      A.LDate, A.QiTaBeiZhu, A.XiaDanBeiZhu, A.LxrName, A.LxrTelephone, A.LxrGender, A.LxrZhengJianType, A.LxrZhengJianCode, A.OperatorId, 
                      A.IssueTime, A.TuanGouId, A.AdpStatus, A.AgencyId, A.AgencyJinE, A.ApiOrderId, B.RouteName, B.Line_Source,
                      A.Traffice,A.OrderSite,a.JiaoYiCR,a.JiaoYiET,a.WebSiteCR,a.WebSiteET
FROM         dbo.tbl_XianLuTourOrder AS A INNER JOIN
                      dbo.tbl_XianLu AS B ON A.XianLuId = B.XianLuId
GO

 
ALTER TABLE dbo.tbl_XianLuTourOrder
	DROP COLUMN JSJCR, JSJER, SCJCR, SCJET
GO






SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DingDan]
AS
SELECT   CAST(a.OrderId AS varchar(36)) as OrderId,  a.ZuJin AS JinE, a.Status AS OrderStatus, a.OrderCode AS OrderCode, a.OperatorId AS XDRId, a.FuKuanStatus AS FuKuanStatus, 
                      a.XiaDanBeiZhu AS BeiZhu, a.LxrName AS LXRName, a.LxrTelephone AS LXRMoblie, a.IssueTime AS IssueTime,
                          (SELECT     p.CarName
                            FROM          dbo.tbl_JA_ZuCheInfo AS p
                            WHERE      p.ZuCheID = a.ZuCheID) + ' —— ' + CASE a.ZuCheType WHEN 1 THEN '同城往返 ' ELSE '单接单送' END AS OrderName, 
                      CAST(a.Number AS varchar(30)) + '辆' AS OrderNum, a.AgencyJinE AS AgencyJinE, a.AgencyId AS AgencyId, 8 AS OrderType,CAST(a.ZuCheID AS varchar(36)) as ProductID,a.LDate as ChuFaShiJian,a.EDate as HuiGuiShiJian,(CASE WHEN a.Status=1 THEN 1 WHEN a.Status=2 THEN 2 WHEN a.Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_JA_ZuCheOrder AS a
UNION ALL
SELECT   CAST(b.DingDanId AS varchar(36)) as OrderId,  b.JinE AS JinE, b.DingDanStatus AS OrderStatus, b.DingDanHao AS OrderCode, b.XiaDanRenId AS XDRId, b.FuKuanStatus AS FuKuanStatus, 
                      b.BeiZhu AS BeiZhu, b.LxrXingMing AS LXRName, b.LxrDianHua AS LXRMoblie, b.IssueTime AS IssueTime,
                          (SELECT     p.[Name]
                            FROM          dbo.tbl_QianZheng AS p
                            WHERE      p.QianZhengId = b.QianZhengId) AS OrderName, CAST(b.YuDingShuLiang AS varchar(30)) + '张' AS OrderNum, 
                      b.AgencyJinE AS AgencyJinE, b.AgencyId AS AgencyId, 6 AS OrderType,CAST(b.QianZhengId AS varchar(36)) as ProductID,b.YuDingShiJian as ChuFaShiJian,b.YuDingShiJian as HuiGuiShiJian,(CASE WHEN b.DingDanStatus=1 THEN 1 WHEN b.DingDanStatus=2 THEN 2 WHEN b.DingDanStatus=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_QianZhengDingDan AS b
UNION ALL
SELECT  CAST(c.OrderID AS varchar(36)) as OrderId,   c.OrderPrice AS JinE, c.OrderState AS OrderStatus, c.OrderCode AS OrderCode, c.PeopleID AS XDRId, c.PayState AS FuKuanStatus, '' AS BeiZhu, 
                      c.PeopleName AS LXRName, c.PeopleMobile AS LXRMoblie, c.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_TuanGouChanPin AS p
                            WHERE      p.ID = c.ProductID) AS OrderName, CAST(c.ProductNum AS varchar(30)) + '份' AS OrderNum, 0 AS AgencyJinE, c.SupplierID AS AgencyId, 
                      7 AS OrderType,CAST(c.ProductID AS varchar(36)) as ProductID,c.IssueTime as ChuFaShiJian,c.IssueTime as HuiGuiShiJian,(CASE WHEN c.OrderState=1 THEN 1 WHEN c.OrderState=2 THEN 2 WHEN c.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_TuanGouDingDan AS c
UNION ALL
SELECT   CAST(d.OrderId AS varchar(36)) as OrderId,  d .JinE AS JinE, d .Status AS OrderStatus, d .OrderCode AS OrderCode, d .OperatorId AS XDRId, d .FuKuanStatus AS FuKuanStatus, 
                      d .XiaDanBeiZhu AS BeiZhu, d .LxrName AS LXRName, d .LxrTelephone AS LXRMoblie, d .IssueTime AS IssueTime,
                          (SELECT     p.RouteName
                            FROM          tbl_XianLu AS p
                            WHERE      p.XianLuId = d .XianLuId) AS OrderName, CAST(d .ChengRenShu AS varchar(10)) + '成人' + CAST(d .ErTongShu AS varchar(10)) 
                      + '儿童' AS OrderNum, d .AgencyJinE AS AgencyJinE, d .AgencyId AS AgencyId, CASE
                          (SELECT     RouteType
                            FROM          dbo.tbl_SysArea AS p, dbo.tbl_XianLu AS t
                            WHERE      t .AreaId = p.ID AND t .XianLuId = d .XianLuId) 
                      WHEN 1 THEN 0 WHEN 2 THEN 2 ELSE 1 END AS OrderType,CAST(d.XianLuId AS varchar(36)) as ProductID,d.LDate as ChuFaShiJian,d.LDate as HuiGuiShiJian,(CASE WHEN d .Status=1 THEN 1 WHEN d .Status=2 THEN 2 WHEN d .Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_XianLuTourOrder AS d
UNION ALL
SELECT   CAST(e.OrderId AS varchar(36)) as OrderId,  e.TotalAmount AS JinE, e.OrderState AS OrderStatus, e.OrderCode AS OrderCode, e.OperatorId AS XDRId, e.PaymentState AS FuKuanStatus, 
                      e.Remark AS BeiZhu, e.ContactName AS LXRName, e.ContactMobile AS LXRMoblie, e.IssueTime AS IssueTime,
                          (SELECT     p.HotelName
                            FROM          tbl_Hotel AS p
                            WHERE      p.HotelId = e.HotelId) + ' —— ' +
                          (SELECT     p.RoomName
                            FROM          dbo.tbl_HotelRoomType AS p
                            WHERE      p.RoomTypeId = e.RoomTypeId) AS OrderName, CAST(e.RoomCount AS varchar(30)) + '间' AS OrderNum, e.AgencyJinE AS AgencyJinE, 
                      e.SellerID AS AgencyId, 5 AS OrderType,CAST(e.HotelId AS varchar(36)) as ProductID,e.CheckInDate as ChuFaShiJian,e.CheckOutDate as HuiGuiShiJian,(CASE WHEN e.OrderState=1 THEN 1 WHEN e.OrderState=2 THEN 2 WHEN e.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_HotelOrder AS e
UNION ALL
SELECT  CAST(f.OrderId AS varchar(36)) as OrderId,   f.Price AS JinE, f.Status AS OrderStatus, f.OrderCode AS OrderCode, f.OperatorId AS XDRId, f.FuKuanStatus AS FuKuanStatus, f.Remark AS BeiZhu, 
                      f.ContactName AS LXRName, f.ContactTel AS LXRMoblie, f.IssueTime AS IssueTime,
                          (SELECT     p.ScenicName
                            FROM          tbl_ScenicArea AS p
                            WHERE      p.ScenicId = f.ScenicId) + ' —— ' +
                          (SELECT     p.EnName
                            FROM          dbo.tbl_ScenicTickets AS p
                            WHERE      p.TicketsId = f.TicketsId) AS OrderName, CAST(f.Num AS varchar(30)) + '份' AS OrderNum, f.AgencyJinE AS AgencyJinE, 
                      f.SellerID AS AgencyId, 4 AS OrderType,CAST(f.ScenicId AS varchar(36)) as ProductID,f.ChuFaRiQi as ChuFaShiJian,f.ChuFaRiQi as HuiGuiShiJian,(CASE WHEN f.Status=1 THEN 1 WHEN f.Status=2 THEN 2 WHEN f.Status=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ScenicAreaOrder AS f
UNION ALL
SELECT  CAST(g.OrderID AS varchar(36)) as OrderId,   g.OrderPrice AS JinE, g.OrderState AS OrderStatus, g.OrderCode AS OrderCode, g.ContactID AS XDRId, g.PayState AS FuKuanStatus, 
                      g.Remark AS BeiZhu, g.ContactName AS LXRName, g.ContactPhone AS LXRMoblie, g.IssueTime AS IssueTime,
                          (SELECT     p.ProductName
                            FROM          tbl_ShangChengChanPin AS p
                            WHERE      p.ProductID = g.ProductID) AS OrderName, CAST(g.ProductNum AS varchar(30)) + '份' AS OrderNum, g.SupplierMoney AS AgencyJinE, 
                      g.SupplierID AS AgencyId, 3 AS OrderType,CAST(g.ProductID AS varchar(36)) as ProductID,g.IssueTime as ChuFaShiJian,g.IssueTime as HuiGuiShiJian,(CASE WHEN g.OrderState=1 THEN 1 WHEN g.OrderState=2 THEN 2 WHEN g.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ShangChengDingDan AS g
UNION ALL
SELECT  CAST(h.ZuTuanId AS varchar(36)) as OrderId,   h.ZongJinE AS JinE, h.OrderState AS OrderStatus, h.OrderCode AS OrderCode, h.XDRId AS XDRId, h.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = h.XDRId ) AS LXRMoblie, h.IssueTime AS IssueTime,
                          h.XianLuName AS OrderName, '成人:'+CAST(h.ChengTuanNum AS varchar(30)) + '人，儿童:'+CAST(h.ErTongNum AS varchar(30))+'人' AS OrderNum, h.AgencyJinE AS AgencyJinE, 
                      h.AgencyId AS AgencyId, 9 AS OrderType,CAST(h.XianLuId AS varchar(36)) as ProductID,h.ChuFaTime as ChuFaShiJian,h.ChuFaTime as HuiGuiShiJian,(CASE WHEN h.OrderState=1 THEN 1 WHEN h.OrderState=2 THEN 2 WHEN h.OrderState=3 THEN 3 ELSE 0 END) as ChuLiZT
FROM         tbl_ZiZuTuan AS h
UNION ALL
SELECT  CAST(j.DingDanId AS varchar(36)) as OrderId,   j.JinE AS JinE, j.DingDanStatus AS OrderStatus, j.ApiDingDanId AS OrderCode, j.HuiYuanId AS XDRId, j.FuKuanStatus AS FuKuanStatus, 
                      '' AS BeiZhu, (SELECT m.MemberName
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRName,
 (SELECT m.Mobile
 from tbl_Member as m where m.MemberID = j.HuiYuanId ) AS LXRMoblie, j.XiaDanShiJian AS IssueTime,
                          j.ChuFaChengShiSanZiMa +' - ' + j.DaoDaChengShiSanZiMa AS OrderName, CAST(j.DingPiaoRenShu AS varchar(30)) AS OrderNum, 0 AS AgencyJinE, 
                      '' AS AgencyId, 10 AS OrderType,'' as ProductID,j.QiFeiShiJian as ChuFaShiJian,j.DaoDaShiJian as HuiGuiShiJian,(CASE WHEN j.DingDanStatus=0 THEN 1 ELSE 0 END) as ChuLiZT
FROM         tbl_JiPiaoDingDan AS j
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


/*增加是否开启总代理配置*/
alter table tbl_JA_Sellers add IsZDaiLi int  default 0 not null
go 


/*特约的id，默认为0, 当时的平台交易率*/
alter table tbl_TuanGouDingDan add ISTeYue VARCHAR(36)  default 0 not null
go 
alter table tbl_TuanGouDingDan add JiaoYiLv DECIMAL(10,4)  default 1 not null
go 



set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		邹磊
-- Create date: 2015-01-09
-- Description:	写入团购订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_TuanGouDingDan_Insert]
	 @ProductID INT
	,@OrderCode NVARCHAR(50) OUTPUT
	,@ProductNum INT
	,@OrderPrice MONEY
	,@PeopleID CHAR(36)
	,@PeopleName NVARCHAR(50)
	,@PeopleMobile NVARCHAR(50)
	,@IssueTime DATETIME
	,@OrderState TINYINT
	,@PayState TINYINT
    ,@Peopleaddress nvarchar(255)
	,@SupplierID CHAR(36)
    ,@OrderSite tinyint
	,@RetCode INT OUTPUT--OUTPUT CODE
	,@OrderID INT OUTPUT
AS
BEGIN
	DECLARE @errorcount INT
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    declare @gysid char(36)--供应商id
    declare @isTeyue CHAR(36) --如果是特约代理商则填写代理商id，如不是则填写0
    SELECT @JiaoYiLi = CONVERT(decimal(10,4),V) from tbl_KV WHERE K='JiaoYiLv'
    SELECT @gysid= SupplierID from tbl_TuanGouChanPin where ID=@ProductID
    IF EXISTS(select 1 from tbl_GYS_Seller where GYSId=@gysid and DaiLiId=@SupplierID and LeiXing=1)
    BEGIN
      SET @isTeyue = @SupplierID
    END
    ELSE
    BEGIN
       SET @isTeyue = '0'
    END    



	SET @errorcount=0
 
 BEGIN TRAN
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_TuanGouDingDan
	SET @OrderCode='TG'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)

  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_TuanGouDingDan (ProductID ,OrderCode ,ProductNum ,OrderPrice ,PeopleID ,PeopleName ,PeopleMobile ,IssueTime ,OrderState ,PayState ,SupplierID ,Peopleaddress,OrderSite,ISTeYue,JiaoYiLv)     VALUES (@ProductID ,@OrderCode ,@ProductNum ,@OrderPrice ,@PeopleID ,@PeopleName ,@PeopleMobile ,@IssueTime ,@OrderState ,@PayState ,@SupplierID ,@Peopleaddress,@OrderSite,@isTeyue,@JiaoYiLi)
	SET @OrderID=@@IDENTITY
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END

GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_TuanGouOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_TuanGouChanPin AS p WHERE p.ID=s.ProductID ) as ProductName
      ,(SELECT p.SupplierID  FROM  tbl_TuanGouChanPin AS p WHERE p.ID=s.ProductID ) as ProductGYSId
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,PeopleID
      ,PeopleName
      ,PeopleMobile
      ,IssueTime
      ,SupplierID
      ,Peopleaddress,
OrderSite,s.ISTeYue
  FROM tbl_TuanGouDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




/*特约的id，默认为0, 当时的平台交易率*/
alter table tbl_ShangChengDingDan add ISTeYue VARCHAR(36)  default 0 not null
go 
alter table tbl_ShangChengDingDan add JiaoYiLv DECIMAL(10,4)  default 1 not null
go 




set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:		刘树超
-- Create date: 2014-07-09
-- Description:	写入商城订单
-- =============================================
ALTER PROCEDURE [dbo].[proc_ShangChengDingDan_Insert]
		@OrderID  CHAR(36)
	   ,@ProductID CHAR(36)
	   ,@ProductNum INT
	   ,@OrderCode NVARCHAR(50) OUTPUT
	   ,@OrderPrice  MONEY
	   ,@OrderState TINYINT
	   ,@PayState TINYINT
	   ,@ContactID CHAR(36)
	   ,@ContactName NVARCHAR(50)
	   ,@ContactPhone NVARCHAR(50)
	   ,@IssueTime DATETIME
	   ,@Remark NVARCHAR(MAX)
	   ,@AddressID INT
	   ,@ProvinceID INT
	   ,@CityID INT
	   ,@DistrictID INT
	   ,@AddressInfo NVARCHAR(255)
	   ,@UserID CHAR(36)
	   ,@UserName NVARCHAR(50)
	   ,@IsDefault CHAR(1)
	   ,@SupplierID CHAR(36)
       ,@OrderSite tinyint
	   ,@SupplierMoney MONEY
	   ,@RetCode INT OUTPUT--OUTPUT CODE
AS
BEGIN
    DECLARE @Address INT
	DECLARE @errorcount INT
	DECLARE @hdoc INT
	SET @errorcount=0
	SET @Address=@AddressID
 	DECLARE @ShengYu INT
	declare @LiuShuiHiao int
	SELECT @LiuShuiHiao=COUNT(*)+1 FROM tbl_ShangChengDingDan
	SET @OrderCode='SC'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@LiuShuiHiao,'0',4)
	SELECT @ShengYu=stocknum FROM dbo.view_ShangCheng WHERE ProductID=@ProductID

    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    declare @gysid char(36)--供应商id
    declare @isTeyue CHAR(36) --如果是特约代理商则填写代理商id，如不是则填写0
    SELECT @JiaoYiLi = CONVERT(decimal(10,4),V) from tbl_KV WHERE K='JiaoYiLv'
    SELECT @gysid= GYSid from tbl_ShangChengChanPin where ProductID =@ProductID
    IF EXISTS(select 1 from tbl_GYS_Seller where GYSId=@gysid and DaiLiId=@SupplierID and LeiXing=0)
    BEGIN
      SET @isTeyue = @SupplierID
    END
    ELSE
    BEGIN
       SET @isTeyue = '0'
    END    

    

 IF(@shengyu<@ProductNum)
 BEGIN
	SET @RetCode=-99
	RETURN @RetCode
 END
 BEGIN TRAN
 IF(@AddressID=0)
 BEGIN
	 --写入地址信息
	 IF(@IsDefault=0)
		 BEGIN
			INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
	  ELSE
		  BEGIN
		  UPDATE tbl_DiZhi SET IsDefault=0 WHERE UserID=@UserID
		  INSERT INTO  tbl_DiZhi (ProvinceID,CityID,DistrictID,AddressInfo,UserID,UserName,IssueTime,IsDelete,IsDefault)
			 VALUES(@ProvinceID,@CityID,@DistrictID,@AddressInfo,@UserID,@UserName,GETDATE(),0,@IsDefault)
			 SET @errorcount=@errorcount+@@ERROR
		  END
		  SET @Address=@@IDENTITY
 END
 ELSE
 BEGIN
		UPDATE tbl_DiZhi SET ProvinceID=@ProvinceID,CityID=@CityID,DistrictID=@DistrictID,AddressInfo=@AddressInfo WHERE AddressID=@AddressID
 END
  --写入订单信息
  IF(@errorcount=0)
	begin
 		INSERT INTO tbl_ShangChengDingDan (OrderID ,ProductID ,ProductNum ,OrderCode ,OrderPrice ,OrderState ,PayState ,ContactID ,ContactName ,ContactPhone ,IssueTime ,Remark,ProvinceID,CityID,DistrictID,AddressInfo,SupplierID,SupplierMoney,OrderSite,ISTeYue,JiaoYiLv)
		 VALUES (@OrderID ,@ProductID ,@ProductNum ,@OrderCode ,@OrderPrice ,@OrderState ,@PayState ,@ContactID ,@ContactName ,@ContactPhone ,@IssueTime ,@Remark,@ProvinceID,@CityID,@DistrictID,@AddressInfo,@SupplierID,@SupplierMoney,@OrderSite,@isTeyue,@JiaoYiLi)
		 
 
	   
	   
	END
	
     
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END

	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END

GO





SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_ShangChengOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_ShangChengChanPin AS p WHERE p.ProductID=s.ProductID ) as ProductName
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,ContactID
      ,ContactName
      ,ContactPhone
,(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as UserType
,(SELECT MemberName  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorName
,(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorMobile
      ,IssueTime
      ,Remark
      ,ProvinceID
      ,(SELECT [GYSid] FROM tbl_ShangChengChanPin chanpin WHERE chanpin.ProductID=s.ProductID )AS  GYSid
      ,(SELECT [Name] FROM tbl_SysProvince prov WHERE prov.ID=s.ProvinceID )AS  ProvinceName
      ,CityID
      ,(SELECT [Name] FROM tbl_SysCity city WHERE city.ID=s.CityID ) as CityName 
      ,DistrictID
      ,(SELECT [Name] FROM tbl_SysDistrict dist WHERE dist.ID=s.DistrictID) AS DistrictName
      ,Addressinfo
      ,SupplierID
      ,SupplierMoney
      ,OrderSite,
      s.ISTeYue
  FROM tbl_ShangChengDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_ShangChengOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_ShangChengChanPin AS p WHERE p.ProductID=s.ProductID ) as ProductName
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,ContactID
      ,ContactName
      ,ContactPhone
,(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as UserType
,(SELECT MemberName  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorName
,(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=s.ContactID ) as OperatorMobile
      ,IssueTime
      ,Remark
      ,ProvinceID
      ,(SELECT [GYSid] FROM tbl_ShangChengChanPin chanpin WHERE chanpin.ProductID=s.ProductID )AS  GYSid
      ,(SELECT SalePrice FROM tbl_ShangChengChanPin chanpin WHERE chanpin.ProductID=s.ProductID )AS  SalePrice
      ,(SELECT [Name] FROM tbl_SysProvince prov WHERE prov.ID=s.ProvinceID )AS  ProvinceName
      ,CityID
      ,(SELECT [Name] FROM tbl_SysCity city WHERE city.ID=s.CityID ) as CityName 
      ,DistrictID
      ,(SELECT [Name] FROM tbl_SysDistrict dist WHERE dist.ID=s.DistrictID) AS DistrictName
      ,Addressinfo
      ,SupplierID
      ,SupplierMoney
      ,OrderSite,
      s.ISTeYue,s.JiaoYiLv
  FROM tbl_ShangChengDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO






SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_TuanGouOrder]
AS
SELECT
	  (SELECT ProductName  FROM  tbl_TuanGouChanPin AS p WHERE p.ID=s.ProductID ) as ProductName
      ,(SELECT p.SupplierID  FROM  tbl_TuanGouChanPin AS p WHERE p.ID=s.ProductID ) as ProductGYSId
	  ,OrderID
      ,ProductID
      ,ProductNum
      ,OrderCode
      ,OrderPrice
      ,OrderState
      ,PayState
      ,PeopleID
      ,PeopleName
      ,PeopleMobile
      ,IssueTime
      ,SupplierID
      ,Peopleaddress,
OrderSite,s.ISTeYue,s.JiaoYiLv
  FROM tbl_TuanGouDingDan AS s
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO





/*商城排序*/
alter table [tbl_Seller_ShangCheng] add PSort int  default 1 not null
go 




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER VIEW [dbo].[View_DaiLiChanPin]
AS
SELECT     a.Id, 
           a.MemberId,
           a.ProductId, 
           a.ProductStatus,
           a.PSort,
           b.TypeID, 
           b.ProductName,
           b.ProductNum,
           b.MarketPrice, 
           b.SalePrice,
           b.ContentService,
           b.UnContentService, 
           b.UseRule,
           b.NoticeKnow,
           b.ProductionDate, 
           b.EffectDate,
           b.ShelfDate,
           b.IssueTime, 
           b.Remark,
           b.ModelDesc,
           b.ColorDesc, 
           b.StylesDesc,
           b.MailWay,
           b.GYSid, 
           b.Unit,
           b.IsTrue,
          (SELECT MemberName FROM tbl_Member WHERE tbl_Member.MemberID =(SELECT tbl_JA_Sellers.MemberID FROM tbl_JA_Sellers where ID=b.GYSid ) ) as SupplierName,
           (SELECT c.ParentID FROM dbo.tbl_ShangChengLeiBie AS c WHERE c.TypeID=b.TypeID ) AS ParentID,
           (SELECT c.TypeName FROM tbl_ShangChengLeiBie AS c WHERE c.TypeID=b.TypeID  )AS TypeName,
           (b.ProductNum- (SELECT ISNULL(sum(ProductNum),0) FROM tbl_ShangChengDingDan AS c WHERE c.ProductID=b.ProductID)) AS StockNum,
           (SELECT * FROM tbl_ShangChengTuPian AS c WHERE c.ProductID=b.ProductID FOR XML RAW, ROOT('Root'))AS ProductImgs
FROM         dbo.tbl_Seller_ShangCheng as a LEFT OUTER JOIN
                      dbo.tbl_ShangChengChanPin as b ON a.ProductId = b.ProductID
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



UPDATE tbl_TuanGouChanPin set SupplierID='dc99f4fe-6690-4b65-8e9d-c9336077cdf7' where SupplierID='-1'
GO



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@JiaoYiLi=CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       if(len(@GYSId)>10)
       BEGIN
         if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId)--判断代理商是否为供应商活着代理商为供应商的二级代理
         BEGIN--如果是，则返润
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
         ELSE--如果不是
         BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney,@JiaoYiLi= CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId)--判断代理商是否为供应商活着代理商为供应商的二级代理
       BEGIN--如果是，则返润
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         
       END
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)-@JiaoYiJinE+@FenXiaoJinE
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@ChengBen
			,@YongHuYuE+@ChengBen,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@ChengBen-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

/*酒店入住日程*/
alter table tbl_HotelOrder add HotelXC varchar(max)
go 



SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

/* 新增订单所属单位*/
ALTER VIEW [dbo].[view_HotelOrder]
AS
SELECT     OrderId, HotelId,
                          (SELECT     HotelName
                            FROM          dbo.tbl_Hotel
                            WHERE      (HotelId = dbo.tbl_HotelOrder.HotelId)) AS HotelName,
(SELECT     Star
                            FROM          dbo.tbl_Hotel
                            WHERE      (HotelId = dbo.tbl_HotelOrder.HotelId)) AS Star, RoomTypeId,
                          (SELECT     RoomName
                            FROM          dbo.tbl_HotelRoomType
                            WHERE      (RoomTypeId = dbo.tbl_HotelOrder.RoomTypeId)) AS RoomName, OrderCode, RoomCount, CheckInDate, CheckOutDate, TotalAmount, 
                      ContactName, ContactMobile, Remark, PaymentType, PaymentState, OrderState, Source, OperatorId,
                          (SELECT     MemberName
                            FROM          dbo.tbl_Member
                            WHERE      (MemberID = dbo.tbl_HotelOrder.OperatorId)) AS OperatorName,
(SELECT UserType  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as UserType,
(SELECT Mobile  FROM  dbo.tbl_Member AS p WHERE p.MemberID=dbo.tbl_HotelOrder.OperatorId ) as OperatorMobile,
 IssueTime, JiaGeId, DanJia, BuyCompanyName, SellerID, 
                      AgencyJinE,OrderSite,HotelXC
FROM         dbo.tbl_HotelOrder
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@JiaoYiLi=CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       if(len(@GYSId)>10)
       BEGIN
         if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=1)--判断代理商是否为供应商活着代理商为供应商的二级代理
         BEGIN--如果是，则返润
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
         ELSE--如果不是
         BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney,@JiaoYiLi= CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=0)--判断代理商是否为供应商活着代理商为供应商的二级代理
       BEGIN--如果是，则返润
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         
       END
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)-@JiaoYiJinE+@FenXiaoJinE
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@ChengBen
			,@YongHuYuE+@ChengBen,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@ChengBen-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@JiaoYiLi=CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       if(len(@GYSId)>10)
       BEGIN
         if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=1)--判断代理商是否为供应商活着代理商为供应商的二级代理
         BEGIN--如果是，则返润
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
         ELSE--如果不是
         BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney,@JiaoYiLi= CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=0)--判断代理商是否为供应商活着代理商为供应商的二级代理
       BEGIN--如果是，则返润
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给代理商发放分销利润 
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         
         if(@DaiLiId<>-1)
          BEGIN
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           END
       END
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)-@JiaoYiJinE+@FenXiaoJinE
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@ChengBen
			,@YongHuYuE+@ChengBen,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@ChengBen-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@JiaoYiLi=CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       if(len(@GYSId)>10)
       BEGIN
         if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=1)--判断代理商是否为供应商活着代理商为供应商的二级代理
         BEGIN--如果是，则返润
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
         ELSE--如果不是
         BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         END
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney,@JiaoYiLi= CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=0)--判断代理商是否为供应商活着代理商为供应商的二级代理
       BEGIN--如果是，则返润
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给代理商发放分销利润 
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         
         if(@DaiLiId<>'-1')
          BEGIN
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           END
       END
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)-@JiaoYiJinE+@FenXiaoJinE
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@ChengBen
			,@YongHuYuE+@ChengBen,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@ChengBen-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END
GO

SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO




set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@JiaoYiLi=CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       if(len(@GYSId)>10)
       BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney,@JiaoYiLi= CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=0)--判断代理商是否为供应商活着代理商为供应商的特约代理
       BEGIN--如果是，则返润给供应商
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给代理商发放分销利润 
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE)
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         
         if(@DaiLiId<>'-1')
          BEGIN
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           END
       END
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)-(@JiaoYiJinE-@FenXiaoJinE)
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@ChengBen
			,@YongHuYuE+@ChengBen,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@ChengBen-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END






set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@JiaoYiLi=CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       if(len(@GYSId)>10)
       BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney,@JiaoYiLi= CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=0)--判断代理商是否为供应商活着代理商为供应商的特约代理
       BEGIN--如果是，则返润给供应商
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给供应商发放交易金额
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE)
			,@YongHuYuE+@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE),GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')

       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         
         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@ChengBen
			,@YongHuYuE+@ChengBen,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
   
         if(@DaiLiId<>'-1')
          BEGIN
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           END
       END
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)-(@JiaoYiJinE-@FenXiaoJinE)
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@ChengBen-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END





set ANSI_NULLS ON
set QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Author:邹磊		<Author,,Name>
-- Create date:2015-9-17 <Create Date,,>
-- Description:交易完成，交易金额分成	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[proc_FenRun]
	 @OrderId CHAR(36)
	,@OrderLeiBie int
    ,@RetCode INT OUTPUT
AS
BEGIN
    SET @RetCode=0
	DECLARE @GYSId char(36)--供应商id
    DECLARE @DaiLiId char(36)--代理商id
	DECLARE @JiaoYiJinE MONEY--交易金额
    DECLARE @ChengBen MONEY--成本价
	DECLARE @errorcount INT
    DECLARE @ProductId char(36)--产品id
    DECLARE @JiaoYiLi DECIMAL(10,4)--平台交易费
    DECLARE @MemberId CHAR(36)--会员id
    DECLARE @DaiLiMemberId char(36) --代理商会员id 只用户商城订单
    DECLARE @DaiLiYongHuYuE char(36) --代理商会员余额 只用户商城订单
    DECLARE @OrderCode NVARCHAR(50) --订单交易号
    DECLARE @YongHuYuE MONEY --用户余额
    DECLARE @FenXiaoJinE MONEY --分销金额
    DECLARE @ProductNum int --交易数量
	SET @errorcount=0
	BEGIN TRAN
    if(@OrderLeiBie=6)
    BEGIN
       IF NOT EXISTS(SELECT 1 FROM tbl_TuanGouDingDan WHERE OrderID=@OrderId)--判断是否存在该团购订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@ProductNum=ProductNum,@OrderCode=OrderCode,@JiaoYiLi=CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_TuanGouDingDan WHERE OrderID=@OrderId
       UPDATE tbl_TuanGouDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=SupplierID,@ChengBen=GroupPrice from tbl_TuanGouChanPin WHERE ID=@ProductId
       if(len(@GYSId)>10)
       BEGIN
           SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
           SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
           --更新供应商的E额宝余额
           UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId
        
           --更新总账户余额
           UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-@ChengBen+(@JiaoYiLi*@JiaoYiJinE)
           update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia
           --给供应商发放货款
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           --扣除供应商的平台交易费
           INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		   VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+@JiaoYiJinE-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
       END
    END
    if(@OrderLeiBie=1)--商城订单
    BEGIN
      IF NOT EXISTS(SELECT 1 FROM tbl_ShangChengDingDan WHERE OrderID=@OrderId)--判断是否存在该商城订单
       BEGIN 
        SET @RetCode=-99--不存在返回-99
        RETURN @RetCode
       END

       SELECT @DaiLiId=SupplierID,@ProductId=ProductID,@JiaoYiJinE=OrderPrice,@ProductNum=ProductNum, @OrderCode=OrderCode,@FenXiaoJinE=SupplierMoney,@JiaoYiLi= CONVERT(decimal(10,4),JiaoYiLv)/100 from tbl_ShangChengDingDan WHERE OrderID=@OrderId
       UPDATE tbl_ShangChengDingDan SET OrderState=5 WHERE OrderID=@OrderId
       SELECT @GYSId=GYSid,@ChengBen= SalePrice from tbl_ShangChengChanPin WHERE  ProductID =@ProductId
     
      if(len(@GYSId)>10)
       BEGIN

       if(@DaiLiId=@GYSId) or EXISTS(SELECT 1 FROM tbl_GYS_Seller WHERE GYSId=@GYSId and DaiLiId=@DaiLiId and LeiXing=0)--判断代理商是否为供应商活着代理商为供应商的特约代理
       BEGIN--如果是，则返润给供应商
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE) where MemberID=@MemberId      
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         
         --给供应商发放交易金额
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE)
			,@YongHuYuE+@JiaoYiJinE-(@JiaoYiLi*@JiaoYiJinE),GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')

         --给代理商发放分销利润 
         --INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
		--	,[balance],[TransactionTime],[TransactionWay]
		--	,[TransactionCate],[TransactionState],[TransactionDesc]
		--	,[OrderID],[OrderType],[TranUserId]
	--		,[MingXiId],[ApiJiaoYiHao])
	--	 VALUES(@MemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
	--		,@YongHuYuE,GETDATE(),1
	--		,7,1,''
	--		,@OrderId,@OrderLeiBie,''
	--		,newid(),'')
       END
       ELSE--如果不是
       BEGIN
         --供应商信息
         SELECT @MemberId=MemberID from tbl_JA_Sellers where ID=@GYSId
         SELECT @YongHuYuE=TotalMoney from tbl_Member where MemberID=@MemberId
         --更新供应商的E额宝余额
         UPDATE tbl_Member set TotalMoney=TotalMoney+(@ChengBen*@ProductNum)-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         --代理商信息
         SELECT @DaiLiMemberId=MemberID from tbl_JA_Sellers where ID=@DaiLiId
         UPDATE tbl_Member set TotalMoney=TotalMoney+@JiaoYiJinE-@FenXiaoJinE where MemberID=@DaiLiMemberId           SELECT @DaiLiYongHuYuE=TotalMoney from tbl_Member where MemberID=@DaiLiMemberId
         
         --给供应商发放货款
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,(@ChengBen*@ProductNum)-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+(@ChengBen*@ProductNum)-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,7,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
   
         if(len(@DaiLiId)>10 and @JiaoYiJinE-@FenXiaoJinE>0)
          BEGIN
         --给代理商发放分销利润
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@DaiLiMemberId,@OrderCode,@JiaoYiJinE-@FenXiaoJinE
			,@YongHuYuE,GETDATE(),1
			,9,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
           END
       END
         --更新供应商的E额宝余额
         --UPDATE tbl_Member set TotalMoney=TotalMoney+@ChengBen-@JiaoYiLi*@JiaoYiJinE where MemberID=@MemberId
         
         --更新总账户余额
         UPDATE tbl_YuE SET EEBaoYuE=EEBaoYuE-(@ChengBen*@ProductNum)+(@JiaoYiLi*@JiaoYiJinE)-(@JiaoYiJinE-@FenXiaoJinE)
         update tbl_YuE set YuE= EEBaoYuE+KuaiQianYuE+XianXia

         
         --扣除供应商的平台交易费
         INSERT INTO [tbl_JA_Account]([UserId],[TransactionID],[Amounts]
			,[balance],[TransactionTime],[TransactionWay]
			,[TransactionCate],[TransactionState],[TransactionDesc]
			,[OrderID],[OrderType],[TranUserId]
			,[MingXiId],[ApiJiaoYiHao])
		 VALUES(@MemberId,@OrderCode,-@JiaoYiLi*@JiaoYiJinE
			,@YongHuYuE+(@ChengBen*@ProductNum)-@JiaoYiLi*@JiaoYiJinE,GETDATE(),1
			,8,1,''
			,@OrderId,@OrderLeiBie,''
			,newid(),'')
    END
   END
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN
	SET @RetCode=1
	RETURN @RetCode	
END


---------------------------------------------2015-11-17记录购买时候舱位信息------------------------------------------------

ALTER TABLE dbo.tbl_JiPiaoDingDan ADD
	CangWeiInfo nvarchar(2000) NULL
	
GO

ALTER PROCEDURE [dbo].[proc_JiPiaoDingDan_C]
	@DingDanId CHAR(36)
	,@ApiDingDanId CHAR(36)
	,@GongPiaoShangId NVARCHAR(50)
	,@ZhengCeId NVARCHAR(50)
	,@CangWei NVARCHAR(50)
	,@HangBanHao NVARCHAR(50)
	,@ChuFaChengShiSanZiMa NVARCHAR(50)
	,@DaoDaChengShiSanZiMa NVARCHAR(50)
	,@ChuFaRiQi DATETIME
	,@CaiGouFanDian MONEY
	,@ShiFuDaYinXingChengDan INT
	,@ZhengCeLeiXing INT
	,@HangXianLeiXing INT
	,@XiaDanShiJian DATETIME
	,@DingDanStatus INT
	,@FuKuanStatus INT
	,@FuKuanShiJian DATETIME
	,@PNR NVARCHAR(50)
	,@KeHuYouHuiDian MONEY
	,@JingXiaoShangLiRunDian MONEY
	,@JinE MONEY
	,@JingXiaoShangLiRun MONEY
	,@QiFeiShiJian NVARCHAR(50)
	,@DaoDaShiJian NVARCHAR(50)
	,@PiaoMianJiaGe MONEY
	,@ShuiFeiJinE MONEY
	,@DingPiaoRenShu INT
	,@ChengRenDingDanId CHAR(36)
	,@ErTongDingDanId CHAR(36)
	,@HuiYuanId CHAR(36)
	,@ChengKeXml NVARCHAR(MAX)
	,@ChengKeLeiXing INT
	,@ApiJieShouFangShi INT
	,@ShiFouYunXuGengHuanPnr INT
	,@ShiFouZiDongDaiKou INT
	,@XiangApiFuKuanStatus INT
	,@XiangApiFuKuanShiJian DATETIME
	,@CangWeiInfo NVARCHAR(max)
	,@RetCode INT OUTPUT
AS
BEGIN
	SET @RetCode=0
	DECLARE @hdoc INT
	DECLARE @errorcount INT
	DECLARE @IdentityId INT
	DECLARE @JiaoYiHao NVARCHAR(255)
	
	SET @errorcount=0
	
	IF NOT EXISTS(SELECT 1 FROM tbl_Member WHERE MemberID=@HuiYuanId)
	BEGIN
		SET @RetCode=-99
		RETURN @RetCode
	END
	
	BEGIN TRAN
	
	INSERT INTO [tbl_JiPiaoDingDan]([DingDanId],[ApiDingDanId],[GongPiaoShangId]
		,[ZhengCeId],[CangWei],[HangBanHao]
		,[ChuFaChengShiSanZiMa],[DaoDaChengShiSanZiMa],[ChuFaRiQi]
		,[CaiGouFanDian],[ShiFuDaYinXingChengDan],[ZhengCeLeiXing]
		,[HangXianLeiXing],[XiaDanShiJian],[DingDanStatus]
		,[FuKuanStatus],[FuKuanShiJian],[PNR],[KeHuYouHuiDian]
		,[JingXiaoShangLiRunDian],[JinE],[JingXiaoShangLiRun]
		,[QiFeiShiJian],[DaoDaShiJian],[PiaoMianJiaGe]
		,[ShuiFeiJinE],[DingPiaoRenShu],[ChengRenDingDanId],[ErTongDingDanId]
		,[HuiYuanId],[ShiFouShanChu],[JiaoYiHao]
		,[ChengKeLeiXing],[ApiJieShouFangShi],[ShiFouYunXuGengHuanPnr]
		,[ShiFouZiDongDaiKou],[XiangApiFuKuanStatus],[XiangApiFuKuanShiJian],[CangWeiInfo])
	VALUES(@DingDanId,@ApiDingDanId,@GongPiaoShangId
		,@ZhengCeId,@CangWei,@HangBanHao
		,@ChuFaChengShiSanZiMa,@DaoDaChengShiSanZiMa,@ChuFaRiQi
		,@CaiGouFanDian,@ShiFuDaYinXingChengDan,@ZhengCeLeiXing
		,@HangXianLeiXing,@XiaDanShiJian,@DingDanStatus
		,@FuKuanStatus,@FuKuanShiJian,@PNR,@KeHuYouHuiDian
		,@JingXiaoShangLiRunDian,@JinE,@JingXiaoShangLiRun
		,@QiFeiShiJian,@DaoDaShiJian,@PiaoMianJiaGe
		,@ShuiFeiJinE,@DingPiaoRenShu,@ChengRenDingDanId,@ErTongDingDanId
		,@HuiYuanId,'0',''
		,@ChengKeLeiXing,@ApiJieShouFangShi,@ShiFouYunXuGengHuanPnr
		,@ShiFouZiDongDaiKou,@XiangApiFuKuanStatus,@XiangApiFuKuanShiJian,@CangWeiInfo)
	SET @errorcount=@errorcount+@@ERROR
	SET @IdentityId=SCOPE_IDENTITY()
	
	SET @JiaoYiHao='JP'+CONVERT(VARCHAR(8),GETDATE(),112)+dbo.fn_PadLeft(@IdentityId,'0',5)
	
	UPDATE [tbl_JiPiaoDingDan] SET [JiaoYiHao]=@JiaoYiHao WHERE DingDanId=@DingDanId
	SET @errorcount=@errorcount+@@ERROR
		
	IF(@errorcount=0 AND @ChengKeXml IS NOT NULL AND LEN(@ChengKeXml)>0)
	BEGIN
		EXEC sp_xml_preparedocument @hdoc OUTPUT,@ChengKeXml	
		INSERT INTO [tbl_JiPiaoDingDanChengKe]([ChengKeId],[XingMing],[ZhengJianHao]
			,[ZhengJianLeiXing],[ChengKeLeiXing],[ChuShengRiQi]
			,[DingDanId])
		SELECT [ChengKeId],[XingMing],[ZhengJianHao]
			,[ZhengJianLeiXing],[ChengKeLeiXing],[ChuShengRiQi]
			,@DingDanId
		FROM OPENXML(@hdoc,'/root/info',3)
			WITH([ChengKeId] CHAR(36),[XingMing] NVARCHAR(50),[ZhengJianHao] NVARCHAR(50)
			,[ZhengJianLeiXing] INT,[ChengKeLeiXing] INT,[ChuShengRiQi] DATETIME)	
		SET @errorcount=@errorcount+@@ERROR
		EXEC sp_xml_removedocument @hdoc
	END
	
	IF(@errorcount<>0)
	BEGIN
		ROLLBACK TRAN
		SET @RetCode=-100
		RETURN @RetCode
	END
	
	COMMIT TRAN	
	
	SET @RetCode=1
	RETURN @RetCode	
END
GO



-----------2015-11-26 16:00原版（把tbl_XianLuTour_ZuiJinFaBan换做view_XianLuTour_ZuiJinFaBan）------------------------
ALTER VIEW [dbo].[view_XianLu]
AS
--SELECT   A.XianLuId, A.AreaId, A.RouteName, A.TianShu, A.DepProvinceId, A.DepCityId, A.ArrProvinceId, A.ArrCityId, A.JiHuaRenShu, A.SCJCR, A.SCJET, A.JSJCR, 
--                      A.JSJET, A.TingTianShu, A.ChuFaJiaoTong, A.FanChengJiaoTong, A.JiHeFangShi, A.TeSe, A.TeSeFilePath, A.TuJing, A.QianZheng, A.QianZhengFilePath, 
--                      A.GuanZhuShu, A.LxrName, A.LxrTelephone, A.LxrQQ, A.LxrMobile, A.Description, A.Keywords, A.OperatorId, A.IssueTime, A.LatestId, A.LatestTime, 
--                      A.Line_Source, A.LineType, A.IdentityId, A.AreaName, A.InterfaceID, B.TourId, B.LDate, B.RDate, B.Status,
--                          (SELECT     AVG(ManYiDu) AS ManYiDu
--                            FROM          dbo.tbl_XianLuDianPing
--                            WHERE      (XianLuId = A.XianLuId)) AS ManYiDu,
--                          (SELECT     COUNT(1) AS Expr1
--                            FROM          dbo.tbl_XianLuDianPing AS tbl_XianLuDianPing_1
--                            WHERE      (XianLuId = A.XianLuId)) AS DianPingShu, B.JSJCR AS JSJCR1, B.JSJET AS JSJET1, A.CFCS,A.xianluzt,A.ProductSort
--FROM         dbo.tbl_XianLu AS A LEFT OUTER JOIN
--                      dbo.view_XianLuTour_ZuiJinFaBan AS B ON A.XianLuId = B.XianLuId


SELECT   A.XianLuId, A.AreaId, A.RouteName, A.TianShu, A.DepProvinceId, A.DepCityId, A.ArrProvinceId, A.ArrCityId, A.JiHuaRenShu, A.SCJCR, A.SCJET, A.JSJCR, 
                      A.JSJET, A.TingTianShu, A.ChuFaJiaoTong, A.FanChengJiaoTong, A.JiHeFangShi, A.TeSe, A.TeSeFilePath, A.TuJing, A.QianZheng, A.QianZhengFilePath, 
                      A.GuanZhuShu, A.LxrName, A.LxrTelephone, A.LxrQQ, A.LxrMobile, A.Description, A.Keywords, A.OperatorId, A.IssueTime, A.LatestId, A.LatestTime, 
                      A.Line_Source, A.LineType, A.IdentityId, A.AreaName, A.InterfaceID, B.TourId, B.LDate, B.RDate, B.Status,
                          0.0 AS ManYiDu,
                          0 AS DianPingShu, B.JSJCR AS JSJCR1, B.JSJET AS JSJET1, A.CFCS,A.xianluzt,A.ProductSort
FROM         dbo.tbl_XianLu AS A LEFT OUTER JOIN
                      dbo.tbl_XianLuTour_ZuiJinFaBan AS B ON A.XianLuId = B.XianLuId
GO


alter TABLE [dbo].[tbl_Sysarea]
	
	add [ImgPath] [nvarchar](250) NULL,
	 [AdvLink] [nvarchar](250) NULL,
	  [AdvTitle] [nvarchar](250) NULL
GO

INSERT INTO tbl_KV (K,V) VALUES ('JiPiaoXieYi','')
GO

alter table tbl_JA_Sellers ADD WapLogo nvarchar(250) NULL ;
GO
alter table tbl_JA_Sellers ADD WebLogo nvarchar(250) NULL ;
GO
